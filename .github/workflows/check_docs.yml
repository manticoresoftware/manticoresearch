name: ðŸ“– Check docs
run-name: ðŸ“– Check docs ${{ github.sha }}

on:
  pull_request:
    paths:
      - 'manual/**'
    branches:
      - master
      - maintenance-release
      - manticore-*

jobs:
  docs_check:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    container:
      image: manticoresearch/docs_autodeploy:latest
      env:
        CACHEB: "../cache"
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
        COMMIT_DIR: manual
        DOCS_ERRORS_DIR: build/docs/

        CI_COMMIT_SHA: ${{ github.sha }}
        FIRST_COMMIT: ${{ github.event.base_ref }}
        LAST_COMMIT: ${{ github.event.head_ref }}
    steps:
      - name: Install fresh git
        run: |
          echo 'APT::Key::Assert-Pubkey-Algo ">=rsa1024";' > /etc/apt/apt.conf.d/99weakkey-warning
          apt-get update --allow-releaseinfo-change
          add-apt-repository -y ppa:git-core/ppa
          apt-get update
          apt-get install -y git
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        run: |
          firstCommit="$FIRST_COMMIT~1"
          echo $firstCommit
          echo $LAST_COMMIT
          changed_files=$(git diff --name-only --diff-filter=d "$firstCommit" "$LAST_COMMIT")
          echo $changed_files
          echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
      - name: Get changed doc filepathes
        id: doc-filepathes
        run: |
          filepathes=""
          for file in ${{ steps.changed-files.outputs.changed_files }}; do
            echo "$file"
            case "$file" in 
              "$COMMIT_DIR/"*) 
                 echo "added" 
                 filepathes="$file $filepathes"
              ;;
             esac  
          done
          echo $filepathes
          echo "filepathes=$filepathes" >> $GITHUB_OUTPUT
      - name: Check docs
        run: |
          echo ${{ steps.doc-filepathes.outputs.filepathes }}
          docs_errors=$(php "/Deploy/check_docs_validity.php"  ${{ steps.doc-filepathes.outputs.filepathes }} "$COMMIT_DIR/" "$DOCS_ERRORS_DIR")
          echo $docs_errors
          if [ "$docs_errors" != "" ]; then
            exit 1
          fi
          echo "Doc check passed successfully "
          