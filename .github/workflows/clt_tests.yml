name: CLT tests 
on:
  workflow_call:
    inputs:
      docker_image:
        required: true
        type: string
        description: "Docker image to use for tests"
      artifact_name:
        required: false
        type: string
        description: "Name of the docker image artifact"
      repository:
        required: false
        type: string
        description: "Repository to checkout"
      ref:
        required: false
        type: string
        description: "Ref to checkout"
      continue_on_error:
        required: false
        type: boolean
        description: "Continue on error"
        default: false
    secrets:
      OPENAI_API_KEY:
        required: true
        description: "OpenAI API key for CLT tests"
      VOYAGE_API_KEY:
        required: true
        description: "Voyage API key for CLT tests"
      JINA_API_KEY:
        required: true
        description: "Jina API key for CLT tests"

jobs:
  clt:
    name: CLT
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    continue-on-error: ${{ inputs.continue_on_error }}
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
      JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: Buddy
            test_prefix: test/clt-tests/buddy/
          - name: Buddy-plugins
            test_prefix: test/clt-tests/buddy-plugins/
          - name: Bugs
            test_prefix: test/clt-tests/bugs/
          - name: Core
            test_prefix: test/clt-tests/core/
          - name: Data-manipulation
            test_prefix: test/clt-tests/data-manipulation/
          - name: Expected-errors
            test_prefix: test/clt-tests/expected-errors/
          - name: Fulltext-search
            test_prefix: test/clt-tests/fulltext-search/
          - name: Auto-embeddings
            test_prefix: test/clt-tests/ae/
            skip_if_no_api_keys: true
          - name: HTTP interface tests
            test_prefix: test/clt-tests/http-interface/
          - name: Indexer
            test_prefix: test/clt-tests/indexer/
          - name: Join
            test_prefix: test/clt-tests/join/
          - name: Kibana
            test_prefix: test/clt-tests/kibana/
          - name: mysqldump
            test_prefix: |-
              test/clt-tests/mysqldump/mysql/
              test/clt-tests/mysqldump/maria/
          - name: Performance
            test_prefix: test/clt-tests/performance/
          - name: Replication
            test_prefix: test/clt-tests/replication/
          - name: Sharding
            test_prefix: |-
              test/clt-tests/sharding/cluster/
              test/clt-tests/sharding/functional/
              test/clt-tests/sharding/replication/
              test/clt-tests/sharding/syntax/
          - name: Test-configuration
            test_prefix: test/clt-tests/test-configuration/
          - name: Vector-knn
            test_prefix: test/clt-tests/vector-knn/
              
    steps:
      - name: Check if auto-embeddings tests should be skipped
        if: matrix.test-suite.skip_if_no_api_keys == true
        run: |
          if [ -z "$OPENAI_API_KEY" ] && [ -z "$VOYAGE_API_KEY" ] && [ -z "$JINA_API_KEY" ]; then
            echo "SKIP_AE_TESTS=true" >> $GITHUB_ENV
            echo "Skipping auto-embeddings tests - no API keys available"
          else
            echo "SKIP_AE_TESTS=false" >> $GITHUB_ENV
          fi
      
      - name: Run CLT tests
        if: matrix.test-suite.skip_if_no_api_keys != true || env.SKIP_AE_TESTS != 'true'
        uses: manticoresoftware/clt@0.7.3
        with:
          artifact: ${{ inputs.artifact_name }}
          image: ${{ inputs.docker_image }}
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          test_prefix: ${{ matrix.test-suite.test_prefix }}
          comment_mode: failures
          run_args: "-e OPENAI_API_KEY -e VOYAGE_API_KEY -e JINA_API_KEY"
          ui_host: "https://clt.manticoresearch.com"
      
      - name: Skip auto-embeddings tests message
        if: matrix.test-suite.skip_if_no_api_keys == true && env.SKIP_AE_TESTS == 'true'
        run: echo "Auto-embeddings tests were skipped because no API keys (OPENAI_API_KEY, VOYAGE_API_KEY, JINA_API_KEY) are available"
