# -*- rpm-spec -*-
#
# template spec file for manticore
#

%if 0%{?fedora} >= 15 || 0%{?rhel} >= 7
%global with_systemd 1
%else
%global with_systemd 0
%endif

%define vertag		-release
%define manticore_user	manticore
%define manticore_group	manticore

BuildRoot:      @CPACK_RPM_DIRECTORY@/@CPACK_PACKAGE_FILE_NAME@@CPACK_RPM_PACKAGE_COMPONENT_PART_PATH@
Summary:        Manticore full-text search server
Name:           @CPACK_PACKAGE_NAME@
Version:        @CPACK_RPM_PACKAGE_VERSION@
Release:        @CPACK_RPM_PACKAGE_RELEASE@
License:        @CPACK_RPM_PACKAGE_LICENSE@
Group:          Applications/Text
Vendor:         @CPACK_PACKAGE_VENDOR@
URL:            http://manticoresearch.com
Packager:       Manticore Software Ltd.

%if %{with_systemd}
BuildRequires: systemd-units
%else
Requires(post): chkconfig
Requires(preun): chkconfig
Requires(preun): initscripts
%endif

@TMP_RPM_URL@
@TMP_RPM_REQUIRES@
@TMP_RPM_REQUIRES_PRE@
@TMP_RPM_REQUIRES_POST@
@TMP_RPM_REQUIRES_PREUN@
@TMP_RPM_REQUIRES_POSTUN@
@TMP_RPM_PROVIDES@
@TMP_RPM_OBSOLETES@
@TMP_RPM_CONFLICTS@
@TMP_RPM_AUTOPROV@
@TMP_RPM_AUTOREQ@
@TMP_RPM_AUTOREQPROV@
@TMP_RPM_BUILDARCH@
@TMP_RPM_PREFIXES@

%define _rpmdir @CPACK_RPM_DIRECTORY@
%define _rpmfilename @CPACK_RPM_FILE_NAME@
%define _unpackaged_files_terminate_build 0
%define _topdir @CPACK_RPM_DIRECTORY@
%define _scripts @SOURCE_DIR@/dist/rpm
%define _part @CPACK_RPM_PACKAGE_COMPONENT_PART_PATH@
# 0%{?fedora} 0%{?dist} 1%{?dist} %{dist}
@TMP_RPM_SPEC_INSTALL_POST@
@CPACK_RPM_SPEC_MORE_DEFINE@
@CPACK_RPM_COMPRESSION_TYPE_TMP@

%if "%{_part}" == "/bin"
%global isbin 1
%else
%global isbin 0
%endif

%description
Manticore is a full-text search server that adds many advanced features
on top of plain old text searching. Data can be fetched directly from
a database, or streamed in XML format. MySQL, PostgreSQL, SQL Server,
Oracle, and other databases are supported. Client programs can query
Sphinx either using native SphinxAPI library, or using regular MySQL
client programs and libraries via SQL-like SphinxQL interface.

# This is a shortcutted spec file generated by CMake RPM generator
# we skip _install step because CPack does that for us.
# We do only save CPack installed tree in _prepr
# and then restore it in build.
%prep
mv $RPM_BUILD_ROOT "@CPACK_TOPLEVEL_DIRECTORY@/tmpBBroot"

#p build

%install
if [ -e $RPM_BUILD_ROOT ];
then
  rm -rf $RPM_BUILD_ROOT
fi
mv "@CPACK_TOPLEVEL_DIRECTORY@/tmpBBroot" $RPM_BUILD_ROOT

%if %{with_systemd}
install -p -D -m 0644 %{_scripts}/searchd.service $RPM_BUILD_ROOT%{_unitdir}/searchd.service
install -d -m 0755 %{buildroot}/usr/lib/tmpfiles.d/
install -m 0644 %{_scripts}/searchd.conf %{buildroot}/usr/lib/tmpfiles.d/searchd.conf
%else
install -p -D -m 0755 %{_scripts}/%{name}.init $RPM_BUILD_ROOT%{_initrddir}/searchd
%endif

# Create /var/log/sphinx
mkdir -p $RPM_BUILD_ROOT%{_localstatedir}/log/manticore

# Create /var/run/sphinx
mkdir -p $RPM_BUILD_ROOT%{_localstatedir}/run/manticore

# Create /var/lib/sphinx
mkdir -p $RPM_BUILD_ROOT%{_localstatedir}/lib/manticore

# Create sphinx.conf
mkdir -p $RPM_BUILD_ROOT%{_sysconfdir}/sphinx
cp @BINARY_DIR@/sphinx-min.conf.dist \
    $RPM_BUILD_ROOT%{_sysconfdir}/sphinx/sphinx.conf

# Updates sphinx.conf paths
sed -i 'sX/var/log/searchd.pidX/var/run/manticore/searchd.pidXg' \
$RPM_BUILD_ROOT%{_sysconfdir}/sphinx/sphinx.conf

sed -i 'sX/var/log/X/var/log/manticore/Xg' \
$RPM_BUILD_ROOT%{_sysconfdir}/sphinx/sphinx.conf

sed -i 'sX/var/data/X/var/lib/manticore/Xg' \
$RPM_BUILD_ROOT%{_sysconfdir}/sphinx/sphinx.conf

# Create /etc/logrotate.d/manticore
mkdir -p $RPM_BUILD_ROOT%{_sysconfdir}/logrotate.d
cat > $RPM_BUILD_ROOT%{_sysconfdir}/logrotate.d/manticore << EOF
/var/log/manticore/*.log {
       weekly
       rotate 10
       copytruncate
       delaycompress
       compress
       notifempty
       missingok
}
EOF

%clean

%post
@RPM_SYMLINK_POSTINSTALL@
@CPACK_RPM_SPEC_POSTINSTALL@

# create user/group, and update permissions
groupadd -r %{manticore_group} 2>/dev/null || true
useradd -M -r -d /var/lib/sphinx -s /bin/bash -c "Manticore server" -g %{manticore_group} %{manticore_user} 2>/dev/null || true
usermod -g %{manticore_group} %{manticore_user} 2>/dev/null || true
chown -R %{manticore_user}:%{manticore_group} /var/lib/manticore /var/log/manticore /var/run/manticore
%systemd_post searchd.service
systemd-tmpfiles --create /usr/lib/tmpfiles.d/searchd.conf

# print some further pointers
echo
echo "Manticore installed!"
echo "Now create a full-text index, start the search daemon, and you're all set."
echo
echo "To manage indexes:"
echo "    editor %{_sysconfdir}/sphinx/sphinx.conf"
echo
echo "To rebuild all disk indexes:"
echo "    sudo -u manticore indexer --all --rotate"
echo
echo "To start/stop search daemon:"
%if %{with_systemd}
echo "    systemctl start/stop searchd"
%else
echo "    service searchd start/stop"
%endif
echo
echo "To query search daemon using MySQL client:"
echo "    mysql -h 0 -P 9306"
echo "    mysql> SELECT * FROM test1 WHERE MATCH('test');"
echo
echo "See the manual at /usr/share/doc/manticore-%{version} for details."
echo
echo "For commercial support please contact Manticore Software Ltd at"
echo "http://manticoresearch.com/contacts.html"
echo

%preun
@CPACK_RPM_SPEC_PREUNINSTALL@
%if %{with_systemd}
%systemd_preun searchd.service
%else
if [ "$1" = 0 ] ; then
    /sbin/service searchd stop >/dev/null 2>&1
    /sbin/chkconfig --del searchd
fi
%endif

%postun
@CPACK_RPM_SPEC_POSTUNINSTALL@
%if %{with_systemd}
%systemd_postun searchd.service
%endif


%files
%defattr(-,root,root,-)
@CPACK_RPM_INSTALL_FILES@
# absolute install
@CPACK_RPM_ABSOLUTE_INSTALL_FILES@
# user install
@CPACK_RPM_USER_INSTALL_FILES@

# additions
%if %{isbin}
%config(noreplace) %{_sysconfdir}/logrotate.d/manticore
%dir %{_localstatedir}/log/manticore
%dir %{_localstatedir}/run/manticore
%dir %{_localstatedir}/lib/manticore

%dir %{_sysconfdir}/sphinx
%config(noreplace) %{_sysconfdir}/sphinx/sphinx.conf

%if %{with_systemd}
%{_unitdir}/searchd.service
%else
%{_initrddir}/searchd
%endif

%if %{with_systemd}
/usr/lib/tmpfiles.d/searchd.conf
%endif
%endif

%changelog
@CPACK_RPM_SPEC_CHANGELOG@
