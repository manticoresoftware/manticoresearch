# 负载均衡

负载均衡在使用 [镜像](../../Creating_a_cluster/Remote_nodes/Mirroring.md) 的任何 [分布式表](../../Creating_a_table/Creating_a_distributed_table/Creating_a_distributed_table.md) 中默认开启。默认情况下，查询在镜像之间随机分配。您可以通过使用 [ha_strategy](../../Creating_a_cluster/Remote_nodes/Load_balancing.md) 来改变此行为。

## ha_strategy

```ini
ha_strategy = {random|nodeads|noerrors|roundrobin}
```

负载均衡的镜像选择策略是可选的，默认设置为 `random`。

用于镜像选择的策略，或者换句话说，在分布式表中选择特定的 [代理镜像](../../Creating_a_cluster/Remote_nodes/Mirroring.md#Agent-mirrors)，由此指令控制。本质上，此指令控制主节点如何在配置的镜像代理节点之间执行负载均衡。实施了以下策略：

### 简单随机均衡

<!-- example conf balancing 1 -->
默认的均衡模式是在镜像之间进行简单线性随机分配。这意味着为每个镜像分配相等的选择概率。这与轮询（RR）类似，但不强加严格的选择顺序。

<!-- intro -->
##### 例子：

<!-- request Example -->
```ini
ha_strategy = random
```
<!-- end -->

### 自适应随机均衡

默认的简单随机策略没有考虑镜像的状态、错误率，更重要的是，实际响应延迟。为了解决异构集群和代理节点负载的临时峰值，存在一组平衡策略，这些策略根据主节点观察到的实际查询延迟动态调整概率。

基于 **延迟加权概率** 的自适应策略如下工作：

1. 延迟统计以 ha_period_karma 秒为块累积。
2. 在每个 karma 期间重新计算一次延迟加权概率。
3. “死或活”标志在每个请求（包括 ping 请求）中调整一次。

起初，概率是相等的。在每一步，它们通过在上一个 karma 期间观察到的延迟的倒数进行缩放，然后重新归一化。例如，如果在主节点启动后的前 60 秒内，4 个镜像的延迟分别为 10 毫秒、5 毫秒、30 毫秒和 3 毫秒，则第一次调整步骤如下：

1. 初始百分比：0.25, 0.25, 0.25, 0.25。
2. 观察到的延迟：10 毫秒、5 毫秒、30 毫秒、3 毫秒。
3. 延迟的倒数：0.1, 0.2, 0.0333, 0.333。
4. 缩放后的百分比：0.025, 0.05, 0.008333, 0.0833。
5. 重新归一化的百分比：0.15, 0.30, 0.05, 0.50。

这意味着在下一个 karma 期间，第一个镜像被选择的概率为 15%，第二个为 30%，第三个（延迟最长的，30 毫秒）仅为 5%，而第四个最快的（3 毫秒）为 50%。在该期间之后，第二次调整步骤将再次更新这些概率，以此类推。

这个想法是，一旦 **观察到的延迟** 稳定，**延迟加权概率** 也将稳定。所有这些调整迭代旨在收敛到一个点，即平均延迟在所有镜像中大致相等。

<!-- example conf balancing 2 -->
#### nodeads
延迟加权概率，但选取时排除了“死”镜像。一个“死”镜像被定义为连续多次出现硬错误（例如网络故障，或没有回答等）的镜像。

<!-- intro -->
##### 例子：

<!-- request Example -->
```ini
ha_strategy = nodeads
```
<!-- end -->

<!-- example conf balancing 3 -->
#### noerrors

延迟加权概率，但选取时排除了错误/成功比例较差的镜像。

<!-- intro -->
##### 例子：

<!-- request Example -->

```ini
ha_strategy = noerrors
```
<!-- end -->

### 轮询均衡

<!-- example conf balancing 4 -->
简单的轮询选择，即选择列表中的第一个镜像，然后是第二个，然后是第三个，依此类推，直到到达列表中的最后一个镜像后重复该过程。与随机策略不同，RR 强加了严格的查询顺序（1, 2, 3, ..., N-1, N, 1, 2, 3, ...，依此类推），并 *保证* 不会向同一个镜像发送两个连续的查询。

<!-- intro -->
##### 例子：

<!-- request Example -->
```ini
ha_strategy = roundrobin
```
<!-- end -->

## 实例范围选项

### ha_period_karma

```ini
ha_period_karma = 2m
```

`ha_period_karma` 定义了代理镜像统计窗口的大小，单位为秒（或时间后缀）。可选，默认值为 60。

对于具有代理镜像的分布式表，服务器跟踪多个不同的每个镜像计数器。这些计数器随后用于故障转移和负载均衡。（服务器根据计数器选择最佳镜像。）计数器以 `ha_period_karma` 秒为块累积。

在开始一个新的块之后，主节点仍然可以使用前一个块的累积值，直到新的块填满一半。因此，任何以前的历史在最多 1.5 倍的 ha_period_karma 秒后停止影响镜像选择。

尽管最多使用 2 个块进行镜像选择，但实际上会存储多达 15 个最近的块以供仪器使用。可以使用 `SHOW AGENT STATUS` 语句检查它们。

### ha_ping_interval

```ini
ha_ping_interval = 3s
```

`ha_ping_interval` 指令定义了发送到代理镜像的 ping 之间的间隔，单位为毫秒（或带时间后缀）。此选项是可选的，默认值为 1000。
对于具有代理镜像的分布式表，服务器在空闲期间向所有镜像发送 ping 命令以跟踪它们的当前状态（它们是活着还是死去，网络往返时间等）。 ping之间的间隔由ha_ping_interval设置决定。

如果您想禁用 ping，请将 ha_ping_interval 设置为 0。

<!-- proofread -->

