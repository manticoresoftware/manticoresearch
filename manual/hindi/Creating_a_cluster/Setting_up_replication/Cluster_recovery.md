# क्लस्टर रिकवरी

यदि मैन्टिकोर खोज डेमन बिना किसी शेष नोड्स के अनुरोधों को सेवा देने के लिए बंद हो जाता है, तो रिकवरी आवश्यक है। प्रतिकृति के लिए उपयोग किए जाने वाले गलेरा पुस्तकालय के मल्टी-मास्टर स्वभाव के कारण, मैन्टिकोर प्रतिकृति क्लस्टर एकल तार्किक इकाई है जो इसके नोड्स और डेटा की स्थिरता, और पूरी क्लस्टर की स्थिति को बनाए रखता है। यह एक साथ कई नोड्स पर सुरक्षित लेखन की अनुमति देता है और क्लस्टर की अखंडता को सुनिश्चित करता है।

हालांकि, यह चुनौतियाँ भी प्रस्तुत करता है। चलिए कुछ परिदृश्यों का निरीक्षण करें, नोड्स A, B, और C के क्लस्टर का उपयोग करते हुए, ताकि देखा जा सके कि जब कुछ या सभी नोड्स अनुपलब्ध हो जाते हैं तो क्या किया जाना चाहिए।

### मामला 1

 जब नोड A बंद हो जाता है, तो अन्य नोड्स को "सामान्य शटडाउन" संदेश प्राप्त होता है। क्लस्टर का आकार कम हो जाता है, और एक कोरम पुन: गणना होती है।
 
नोड A को प्रारंभ करने पर, यह क्लस्टर में शामिल होता है और तब तक कोई लेखन लेनदेन नहीं करेगा जब तक कि यह क्लस्टर के साथ पूरी तरह से समन्वयित नहीं हो जाता। यदि दाता नोड्स B या C पर लेखन कैश (जिसे गलेरा क्लस्टर के [gcache.size](https://galeracluster.com/library/documentation/galera-parameters.html#gcache-size) के साथ नियंत्रित किया जा सकता है) में नोड A पर चूके गए सभी लेनदेन शामिल हैं, तो नोड A को एक तेज़ वृद्धि राज्य हस्तांतरण ([IST](https://galeracluster.com/library/documentation/state-transfer.html#state-transfer-ist)) प्राप्त होगा, یعنی केवल चूके गए लेनदेन का हस्तांतरण। यदि नहीं, तो एक स्नैपशॉट राज्य हस्तांतरण ([SST](https://galeracluster.com/library/documentation/state-transfer.html#state-transfer-sst)) होगा, जिसमें तालिका फ़ाइलों का हस्तांतरण शामिल है।

### मामला 2

उस परिदृश्य में जहाँ नोड्स A और B बंद हैं, क्लस्टर का आकार एक पर घट जाता है, नोड C लेखन लेनदेन संभालने के लिए प्राथमिक घटक बनता है। 

नोड्स A और B को फिर सामान्य रूप से प्रारंभ किया जा सकता है और वे स्टार्ट-अप के बाद क्लस्टर में शामिल होंगे। नोड C दाता के रूप में कार्य करता है, नोड्स A और B को राज्य हस्तांतरण प्रदान करता है।

### मामला 3

सभी नोड्स सामान्य रूप से बंद हैं और क्लस्टर बंद है।

अब समस्या है कि क्लस्टर को कैसे प्रारंभ करें। यह महत्वपूर्ण है कि searchd के साफ शटडाउन पर नोड्स अंतिम निष्पादित लेनदेन की संख्या क्लस्टर निर्देशिका [grastate.dat](../../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md) फ़ाइल में साथ ही `safe_to_bootstrap` फ्लैग लिखें। जो नोड आखिरी बार बंद हुआ उसे `safe_to_bootstrap: 1` विकल्प और सबसे उन्नत `seqno` संख्या होगी।

यह महत्वपूर्ण है कि यह नोड पहले प्रारंभ हो ताकि क्लस्टर का निर्माण हो सके। क्लस्टर को बूटस्ट्रैप करने के लिए इस नोड पर सर्वर को [--new-cluster](../../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md) फ्लैग के साथ प्रारंभ किया जाना चाहिए। लिनक्स पर आप `manticore_new_cluster` भी चला सकते हैं जो systemd के माध्यम से `--new-cluster` मोड में मैन्टिकोर प्रारंभ करेगा।

यदि कोई और नोड पहले प्रारंभ होता है और क्लस्टर को बूटस्ट्रैप करता है, तो सबसे उन्नत नोड उस क्लस्टर में शामिल होता है, पूरा SST करता है और उसे एक तालिका फ़ाइल प्राप्त होती है जहाँ कुछ लेनदेन तालिका फ़ाइलों के मुकाबले चूक गए हैं जो उसे पहले मिले थे। इसीलिए यह महत्वपूर्ण है कि सबसे पहले उस नोड को प्रारंभ किया जाए जो अंतिम बार बंद हुआ था, इसके पास [grastate.dat](../../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md) में `safe_to_bootstrap: 1` फ्लैग होना चाहिए।

### मामला 4

यदि एक क्रैश या नेटवर्क विफलता के कारण नोड A क्लस्टर से गायब हो जाता है, तो नोड्स B और C नोड A के साथ पुनः कनेक्ट करने का प्रयास करेंगे। विफलता के मामले में, वे नोड A को क्लस्टर से हटा देंगे। तीन में से दो नोड्स अभी भी चालू हैं, क्लस्टर अपने कोरम को बनाए रखता है और सामान्य रूप से कार्य करना जारी रखता है।

जब नोड A पुनः प्रारंभ होता है, तो यह स्वचालित रूप से क्लस्टर में शामिल हो जाएगा, जैसा कि [मामला 1](../../Creating_a_cluster/Setting_up_replication/Cluster_recovery.md#Case-1) में दर्शाया गया है।

### मामला 5

नोड्स A और B ऑफ़लाइन हो गए हैं। नोड C खुद से कोरम बनाना असमर्थ है क्योंकि 1 नोड कुल नोड्स (3) का आधा से कम है। इसके परिणामस्वरूप, नोड C पर क्लस्टर गैर-प्राथमिक स्थिति में स्थानांतरित हो जाता है और किसी भी लेखन लेनदेन को एक त्रुटि संदेश के साथ अस्वीकार करता है।

इसी बीच, नोड C अन्य नोड्स के कनेक्ट होने की प्रतीक्षा करता है और उनके साथ कनेक्ट करने का प्रयास भी करता है। यदि ऐसा होता है, और नेटवर्क बहाल होता है और नोड्स A और B ऑनलाइन वापस आ जाते हैं, तो क्लस्टर स्वचालित रूप से पुनः बनाई जाएगी। यदि नोड्स A और B सिर्फ अस्थायी रूप से नोड C से डिस्कनेक्ट हो गए हैं लेकिन एक-दूसरे के साथ अभी भी संचार कर सकते हैं, तो वे सामान्य रूप से कार्य करना जारी रखेंगे, क्योंकि वे अभी भी कोरम का निर्माण करते हैं।

<!-- उदाहरण मामला 5 -->
हालाँकि, यदि दोनों नोड्स A और B बिजली की विफलता के कारण क्रैश हो गए हैं या पुनः प्रारंभ हुए हैं, तो किसी को निम्नलिखित कमांड का उपयोग करके नोड C पर प्राथमिक घटक सक्रिय करना चाहिए:

<!-- शुरुआत -->
##### SQL:

<!-- अनुरोध SQL -->

```sql
SET CLUSTER posts GLOBAL 'pc.bootstrap' = 1
```
<!-- अनुरोध JSON -->

```json
POST /cli -d "
SET CLUSTER posts GLOBAL 'pc.bootstrap' = 1
"
```
<!-- अंत -->

इस कमांड को निष्पादित करने से पहले यह महत्वपूर्ण है कि आप पुष्टि करें कि अन्य नोड्स वास्तव में अप्राप्य हैं। अन्यथा, एक विभाजित-मस्तिष्क परिदृश्य उत्पन्न हो सकता है और अलग क्लस्टर बन सकते हैं।

### मामला 6

सभी नोड्स क्रैश हो चुके हैं। इस स्थिति में, क्लस्टर निर्देशिका में [grastate.dat](../../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md) फ़ाइल अपडेट नहीं हुई है और इसमें मान्य `seqno` अनुक्रम संख्या मौजूद नहीं है।

यदि ऐसा होता है, तो किसी को सबसे हालिया डेटा वाले नोड को ढूंढना होगा और उस पर [--new-cluster-force](../../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md) कमांड लाइन कुंजी का उपयोग करके सर्वर प्रारंभ करना होगा। सभी अन्य नोड्स सामान्य रूप से प्रारंभ होंगे, जैसा कि [मामला 3](../../Creating_a_cluster/Setting_up_replication/Cluster_recovery.md#Case-3) में वर्णित है।
लिनक्स पर, आप `manticore_new_cluster --force` कमांड का भी उपयोग कर सकते हैं, जो systemd के माध्यम से मैन्टिकोर को `--new-cluster-force` मोड में प्रारंभ करेगा।

### मामला 7

स्प्लिट-ब्रेन क्लस्टर को नॉन-प्राइमरी स्थिति में परिवर्तित कर सकता है। उदाहरण के लिए, दो जोड़े नोड्स से मिलकर बने एक क्लस्टर पर विचार करें जो विभिन्न डेटा केंद्रों में स्थित हैं (चार), जैसे। यदि एक नेटवर्क विफलता डेटा केंद्रों के बीच के संबंध को बाधित कर देती है, तो स्प्लिट-ब्रेन होता है क्योंकि प्रत्येक नोड्स के समूह में बिल्कुल आधा क्वोरम होता है। परिणामस्वरूप, दोनों समूह लिखित लेनदेन को संभालना बंद कर देते हैं, क्योंकि गलेड़ा पुनरावृत्ति मॉडल डेटा की सुसंगतता को प्राथमिकता देता है, और क्लस्टर बिना क्वोरम के लेखन लेनदेन स्वीकार नहीं कर सकता। हालांकि, दोनों समूहों के नोड्स क्लस्टर को पुनर्स्थापित करने के प्रयास में दूसरे समूह के नोड्स के साथ फिर से जुड़ने की कोशिश करते हैं।

<!-- example case 7 -->
यदि कोई नेटवर्क बहाल होने से पहले क्लस्टर को पुनर्स्थापित करना चाहता है, तो वही कदम उठाए जाने चाहिए जो [केस 5](../../Creating_a_cluster/Setting_up_replication/Cluster_recovery.md#Case-5) में विस्तृत किए गए हैं, लेकिन केवल एक नोड्स के समूह पर। 

बयान चलाने के बाद, जिस समूह में यह चलाया गया था, वह एक बार फिर से लेखन लेनदेन को संभालने में सक्षम होगा।


<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
SET CLUSTER posts GLOBAL 'pc.bootstrap' = 1
```
<!-- request JSON -->

```json
POST /cli -d "
SET CLUSTER posts GLOBAL 'pc.bootstrap' = 1
"
```
<!-- end -->

हालाँकि, यह ध्यान रखना महत्वपूर्ण है कि यदि बयान दोनों समूहों पर जारी किया जाता है, तो इसका परिणाम दो अलग-अलग क्लस्टरों के निर्माण में होगा, और इसके बाद नेटवर्क रिकवरी के कारण समूह फिर से नहीं मिलेंगे।
<!-- proofread -->
