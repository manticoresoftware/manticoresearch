# MySQL протокол

Manticore Search реализует SQL-интерфейс, используя протокол MySQL, что позволяет использовать любую библиотеку или коннектор MySQL и множество клиентов MySQL для подключения к Manticore Search и работы с ним так, как если бы это был сервер MySQL, а не Manticore.

Однако диалект SQL отличается и реализует только подмножество команд или функций SQL, доступных в MySQL. Кроме того, существуют конструкции и функции, которые специфичны для Manticore Search, такие как клаузула `MATCH()` для полнотекстового поиска.

Manticore Search не поддерживает серверные подготовленные выражения, но можно использовать клиентские подготовленные выражения. Важно отметить, что Manticore реализует тип данных с множественными значениями (MVA), которому нет эквивалента в MySQL или библиотеках, реализующих подготовленные выражения. В таких случаях значения MVA должны быть сформированы в сыром запросе.

Некоторые клиенты/коннекторы MySQL требуют значения для пользователя/пароля и/или имени базы данных. Поскольку в Manticore Search отсутствует понятие баз данных и не реализован контроль доступа пользователей, эти значения могут быть установлены произвольно, так как Manticore просто их игнорирует.

## Конфигурация

**Порт по умолчанию для SQL-интерфейса — 9306**, и он включён по умолчанию.

Вы можете настроить порт MySQL в секции searchd конфигурационного файла, используя директиву `listen`, например так:

```ini
searchd {
...
   listen = 127.0.0.1:9306:mysql
...
}
```

Имейте в виду, что в Manticore отсутствует аутентификация пользователей, поэтому убедитесь, что порт MySQL недоступен никому извне вашей сети.

### VIP-соединение
Для выполнения "VIP"-соединений можно использовать отдельный порт MySQL. При подключении к этому порту пул потоков обходится, и всегда создаётся новый выделенный поток. Это полезно в случаях сильной перегрузки, когда сервер либо зависает, либо предотвращает соединение через обычный порт.

```ini
searchd {
...
   listen = 127.0.0.1:9306:mysql
   listen = 127.0.0.1:9307:mysql_vip
...
}
```

## Подключение через стандартный клиент MySQL
Самый простой способ подключиться к Manticore — использовать стандартный клиент MySQL:

```shell
mysql -P9306 -h0
```

## Защищённое MySQL-соединение

Протокол MySQL поддерживает [SSL-шифрование](../Security/SSL.md). Защищённые соединения могут быть установлены на том же порту прослушивания `mysql`.

## Сжатое MySQL-соединение

Сжатие можно использовать с MySQL-соединениями, и оно доступно клиентам по умолчанию. Клиенту нужно просто указать, что соединение должно использовать сжатие.

Пример с использованием клиента MySQL:

```shell
mysql -P9306 -h0 -C
```

Сжатие можно использовать как в защищённых, так и в незащищённых соединениях.

## Примечания по коннекторам MySQL
Официальные коннекторы MySQL можно использовать для подключения к Manticore Search, однако им могут потребоваться определённые настройки, указанные в DSN-строке, так как коннектор может попытаться выполнить команды SQL, которые ещё не реализованы в Manticore.

JDBC Connector версии 6.x и выше требуют Manticore Search 2.8.2 или новее, а DSN-строка должна содержать следующие опции:
```ini
jdbc:mysql://IP:PORT/DB/?characterEncoding=utf8&maxAllowedPacket=512000&serverTimezone=XXX
```

По умолчанию Manticore Search сообщает о своей собственной версии коннектору, однако это может вызвать некоторые проблемы. Чтобы это обойти, директива `mysql_version_string` в секции searchd конфигурационного файла должна быть установлена в версию ниже 5.1.1:

```ini
searchd {
...
   mysql_version_string = 5.0.37
...
}
```

Коннектор .NET MySQL по умолчанию использует пулы соединений. Чтобы правильно получить статистику `SHOW META`, запросы вместе с командой `SHOW META` должны отправляться как одно мультизапросное выражение (`SELECT ...;SHOW META`). Если pooling включён, необходимо добавить в строку подключения опцию `Allow Batch=True` для разрешения мультизапросов:
```ini
Server=127.0.0.1;Port=9306;Database=somevalue;Uid=somevalue;Pwd=;Allow Batch=True;
```

## Примечания по работе с ODBC
К Manticore можно получить доступ через ODBC. Рекомендуется установить `charset=UTF8` в строке ODBC. Некоторые ODBC-драйверы не понравится версия, которую сообщает сервер Manticore, так как они воспримут её как очень старую версию MySQL. Это можно переопределить с помощью опции `mysql_version_string`.

## Синтаксис комментариев

Manticore SQL поверх MySQL поддерживает синтаксис комментариев в стиле C. Всё от открывающей последовательности `/*` до закрывающей `*/` игнорируется. Комментарии могут занимать несколько строк, не могут быть вложенными и не должны попадать в логи. Специфичные для MySQL комментарии `/*! ... */` также в настоящее время игнорируются. (Так как поддержка комментариев была добавлена в основном для улучшения совместимости с дампами, создаваемыми `mysqldump`, а не для улучшения общей совместимости запросов между Manticore и MySQL.)

```sql
SELECT /*! SQL_CALC_FOUND_ROWS */ col1 FROM table1 WHERE ...
```
<!-- proofread -->

