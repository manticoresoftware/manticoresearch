# Протокол MySQL

Manticore Search реализует SQL-интерфейс с использованием протокола MySQL, что позволяет использовать любую библиотеку или коннектор MySQL, а также многие MySQL-клиенты для подключения к Manticore Search и работы с ним так, как если бы это был сервер MySQL, а не Manticore.

Однако диалект SQL отличается и реализует только подмножество SQL-команд или функций, доступных в MySQL. Кроме того, существуют команды и функции, специфичные для Manticore Search, такие как клауза `MATCH()` для полнотекстового поиска.

Manticore Search поддерживает подготовленные выражения на стороне сервера через протокол MySQL. Также могут использоваться подготовленные выражения на стороне клиента. Важно отметить, что Manticore реализует типы данных multi-value (MVA) и `float_vector`, которые не имеют эквивалентов в MySQL или библиотеках, реализующих подготовленные выражения. В этих случаях значения должны быть оформлены в исходном запросе как литералы списков.

## Подготовленные выражения

Manticore поддерживает COM_STMT_PREPARE/COM_STMT_EXECUTE через протокол MySQL.
Это доступно только через протокол MySQL (не через HTTP SQL endpoints), и выборка на основе курсоров не поддерживается.

### Параметры списка для MVA и float_vector

Подготовленные выражения принимают параметры списка для `multi`, `multi64` и `float_vector` только в формате `(1,2,3)`.
Используйте `TO_MULTI(?)` или `TO_VECTOR(?)`, чтобы явно пометить параметр как список.

### Примечания по совместимости

Некоторые драйверы отправляют числовые параметры как DOUBLE (например, mysql2 для Node.js).
Если вам требуется строгое целочисленное поведение (например, отклонение отрицательных id), отправляйте целые числа в виде строк или целочисленных типов, специфичных для драйвера (например, BigInt).

Некоторые клиенты/коннекторы MySQL требуют значения для пользователя/пароля и/или имени базы данных. Поскольку в Manticore Search нет понятия баз данных и не реализован контроль доступа пользователей, эти значения могут быть заданы произвольно, так как Manticore просто их игнорирует.

## Конфигурация

**Порт по умолчанию для SQL-интерфейса — 9306**, и он включен по умолчанию.

Вы можете настроить порт MySQL в разделе searchd конфигурационного файла, используя директиву `listen` следующим образом:

```ini
searchd {
...
   listen = 127.0.0.1:9306:mysql
...
}
```

Имейте в виду, что в Manticore нет аутентификации пользователей, поэтому убедитесь, что порт MySQL недоступен никому за пределами вашей сети.

### VIP-подключение
Для выполнения "VIP" подключений можно использовать отдельный порт MySQL. При подключении к этому порту пул потоков обходится, и всегда создается новый выделенный поток. Это полезно в случае серьезной перегрузки, когда сервер либо зависает, либо препятствует подключению через обычный порт.

```ini
searchd {
...
   listen = 127.0.0.1:9306:mysql
   listen = 127.0.0.1:9307:mysql_vip
...
}
```

## Подключение через стандартный MySQL клиент
Самый простой способ подключения к Manticore — использование стандартного MySQL клиента:

```shell
mysql -P9306 -h0
```

## Защищённое MySQL-подключение

Протокол MySQL поддерживает [шифрование SSL](../Security/SSL.md). Безопасные подключения можно установить на том же порту `mysql`.

## Сжатое MySQL-подключение

Сжатие можно использовать при подключениях MySQL, и оно доступно клиентам по умолчанию. Клиенту просто нужно указать, что соединение должно использовать сжатие.

Пример использования MySQL-клиента:

```shell
mysql -P9306 -h0 -C
```

Сжатие можно использовать как в защищённых, так и в незашищённых подключениях.

## Примечания по коннекторам MySQL
Официальные коннекторы MySQL можно использовать для подключения к Manticore Search, однако им могут потребоваться определённые настройки, передаваемые в строке DSN, поскольку коннектор может попытаться выполнить SQL-команды, которые ещё не реализованы в Manticore.

JDBC коннектор 6.x и выше требует Manticore Search версии 2.8.2 или выше, и строка DSN должна содержать следующие опции:
```ini
jdbc:mysql://IP:PORT/DB/?characterEncoding=utf8&maxAllowedPacket=512000&serverTimezone=XXX
```

По умолчанию Manticore Search сообщает коннектору свою собственную версию, однако это может вызвать некоторые проблемы. Для их решения директива `mysql_version_string` в разделе searchd конфигурационного файла должна быть установлена на версию ниже 5.1.1:

```ini
searchd {
...
   mysql_version_string = 5.0.37
...
}
```

.NET коннектор MySQL по умолчанию использует пулы подключений. Для правильного получения статистики `SHOW META` запросы вместе с командой `SHOW META` должны отправляться как единое многокомандное выражение (`SELECT ...;SHOW META`). Если пулы включены, в строку подключения необходимо добавить опцию `Allow Batch=True`, чтобы разрешить многокомандность:
```ini
Server=127.0.0.1;Port=9306;Database=somevalue;Uid=somevalue;Pwd=;Allow Batch=True;
```

## Примечания по ODBC-подключению
К Manticore можно получить доступ с помощью ODBC. Рекомендуется устанавливать `charset=UTF8` в строке ODBC. Некоторые драйверы ODBC не понравится версия, сообщаемая сервером Manticore, так как они увидят её как очень старую версию сервера MySQL. Это можно переопределить с помощью опции `mysql_version_string`.

## Синтаксис комментариев

SQL Manticore через MySQL поддерживает синтаксис комментариев в стиле C. Всё от начальной последовательности `/*` до конечной последовательности `*/` игнорируется. Комментарии могут занимать несколько строк, не могут вкладываться и не должны записываться в лог. Специфичные для MySQL комментарии `/*! ... */` также в настоящее время игнорируются. (Поддержка комментариев была добавлена скорее для лучшей совместимости с дампами, созданными `mysqldump`, а не для улучшения общей интероперабельности запросов между Manticore и MySQL.)

```sql
SELECT /*! SQL_CALC_FOUND_ROWS */ col1 FROM table1 WHERE ...
```
<!-- proofread -->
