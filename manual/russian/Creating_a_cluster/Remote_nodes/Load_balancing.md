# Балансировка нагрузки

Балансировка нагрузки включена по умолчанию для любой [распределённой таблицы](../../Creating_a_table/Creating_a_distributed_table/Creating_a_distributed_table.md), использующей [зеркалирование](../../Creating_a_cluster/Remote_nodes/Mirroring.md). По умолчанию запросы распределяются случайным образом между зеркалами. Вы можете изменить это поведение, используя [ha_strategy](../../Creating_a_cluster/Remote_nodes/Load_balancing.md).

## ha_strategy

```ini
ha_strategy = {random|nodeads|noerrors|roundrobin}
```

Стратегия выбора зеркала для балансировки нагрузки является необязательной и по умолчанию установлена в `random`.

Стратегия, используемая для выбора зеркала, или, другими словами, выбора конкретного [зеркала агента](../../Creating_a_cluster/Remote_nodes/Mirroring.md#Agent-mirrors) в распределённой таблице, контролируется этим параметром. По сути, этот параметр управляет тем, как мастер выполняет балансировку нагрузки между настроенными узлами агента-зеркала. Реализованы следующие стратегии:

### Простая случайная балансировка

<!-- example conf balancing 1 -->
Режим балансировки по умолчанию — простое линейное случайное распределение между зеркалами. Это означает, что каждому зеркалу назначаются равные вероятности выбора. Это похоже на круговой обход (round-robin, RR), но не накладывает строгий порядок выбора.

<!-- intro -->
##### Пример:

<!-- request Example -->
```ini
ha_strategy = random
```
<!-- end -->

### Адаптивная случайная балансировка

Простая случайная стратегия по умолчанию не учитывает статус зеркал, уровень ошибок и, что важнее всего, фактическую задержку ответа. Чтобы справиться с неоднородными кластерами и временными всплесками нагрузки на узлы агентов, существует группа стратегий балансировки, которые динамически корректируют вероятности на основе настоящих задержек запроса, наблюдаемых мастером.

Адаптивные стратегии, основанные на **вероятностях с весом задержки (latency-weighted probabilities)** работают следующим образом:

1. Статистика задержки накапливается блоками по ha_period_karma секунд.
2. Вероятности, взвешенные по задержке, пересчитываются один раз за период karma.
3. Флаг «жив/мертв» корректируется один раз за запрос, включая ping-запросы.

Изначально вероятности равны. На каждом шаге они масштабируются обратными значениями задержек, наблюдаемых в последнем karma-периоде, затем нормализуются заново. Например, если в течение первых 60 секунд после запуска мастера 4 зеркала имели задержки 10 мс, 5 мс, 30 мс и 3 мс соответственно, первый шаг корректировки будет следующим:

1. Начальные проценты: 0.25, 0.25, 0.25, 0.25.
2. Наблюдаемые задержки: 10 мс, 5 мс, 30 мс, 3 мс.
3. Обратные значения задержек: 0.1, 0.2, 0.0333, 0.333.
4. Масштабированные проценты: 0.025, 0.05, 0.008333, 0.0833.
5. Перенормированные проценты: 0.15, 0.30, 0.05, 0.50.

Это означает, что первое зеркало будет выбрано с вероятностью 15% в течение следующего периода karma, второе — 30%, третье (самое медленное с задержкой 30 мс) — только 5%, а четвёртое и самое быстрое (3 мс) — 50%. После этого периода второй шаг корректировки снова обновит эти шансы и так далее.

Идея в том, что после стабилизации **наблюдаемых задержек** стабилизируются и **вероятности, взвешенные по задержке**. Все эти итерации корректировки призваны привести к равновесию, при котором средние задержки во всех зеркалах примерно равны.

<!-- example conf balancing 2 -->
#### nodeads
Вероятности, взвешенные по задержке, но "мертвые" зеркала исключаются из выбора. "Мёртвым" считается зеркало, которое дало несколько последовательных жёстких ошибок (например, сбой сети или отсутствие ответа).

<!-- intro -->
##### Пример:

<!-- request Example -->
```ini
ha_strategy = nodeads
```
<!-- end -->

<!-- example conf balancing 3 -->
#### noerrors

Вероятности, взвешенные по задержке, но зеркала с худшим соотношением ошибок и успешных запросов исключаются из выбора.

<!-- intro -->
##### Пример:

<!-- request Example -->

```ini
ha_strategy = noerrors
```
<!-- end -->

### Балансировка круговым обходом (Round-robin)

<!-- example conf balancing 4 -->
Простой выбор по круговому обходу, то есть выбор первого зеркала в списке, затем второго, затем третьего и так далее, с повторением процесса после достижения последнего зеркала в списке. В отличие от случайных стратегий, RR накладывает строгий порядок запросов (1, 2, 3, ..., N-1, N, 1, 2, 3, ... и так далее) и *гарантирует*, что два последовательных запроса не будут отправлены одному и тому же зеркалу.

<!-- intro -->
##### Пример:

<!-- request Example -->
```ini
ha_strategy = roundrobin
```
<!-- end -->

## Глобальные опции экземпляра

### ha_period_karma

```ini
ha_period_karma = 2m
```

`ha_period_karma` определяет размер окна статистики зеркал агента в секундах (или с суффиксом времени). Необязательный параметр, по умолчанию 60.

Для распределённой таблицы с зеркалами агентов сервер отслеживает несколько различных счётчиков по каждому зеркалу. Эти счётчики затем используются для отказоустойчивости и балансировки. (Сервер выбирает лучшее зеркало исходя из значений счётчиков.) Счётчики накапливаются блоками по `ha_period_karma` секунд.

После начала нового блока мастер может использовать накопленные значения из предыдущего блока до тех пор, пока новый блок не будет заполнен наполовину. Таким образом, любая предыдущая история перестаёт влиять на выбор зеркала максимум через 1,5 раза ha_period_karma секунд.

Хотя для выбора зеркала используется максимум 2 блока, до 15 последних блоков фактически сохраняются для целей мониторинга. Они могут быть просмотрены с помощью оператора `SHOW AGENT STATUS`.

### ha_ping_interval

```ini
ha_ping_interval = 3s
```

Параметр `ha_ping_interval` задаёт интервал между ping-запросами, отправляемыми зеркалам агентов, в миллисекундах (или с суффиксом времени). Этот параметр необязателен, значение по умолчанию — 1000.

Для распределённой таблицы с зеркалами агентов сервер во время простоя отправляет всем зеркалам команду ping для отслеживания их текущего статуса (живы они или мертвы, время сетевого задерживания и т.д.). Интервал между ping-запросами определяется настройкой ha_ping_interval.

Если вы хотите отключить ping-запросы, установите ha_ping_interval в 0.

<!-- proofread -->

