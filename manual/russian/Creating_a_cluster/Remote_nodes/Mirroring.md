# Зеркалирование

[Агенты](../../Creating_a_table/Creating_a_distributed_table/Remote_tables.md#agent) зеркал могут использоваться взаимозаменяемо при обработке поискового запроса. Экземпляр(ы) Manticore, хранящие распределённую таблицу, в которой определены зеркальные агенты, отслеживает статус зеркал (активно или неактивно) и время отклика, а также выполняет автоматическое переключение и балансировку нагрузки на основе этой информации.

## Зеркала агента

```ini
agent = node1|node2|node3:9312:shard2
```

Приведённый выше пример объявляет, что у `node1:9312`, `node2:9312` и `node3:9312` есть таблица с именем shard2, и они могут использоваться как взаимозаменяемые зеркала. Если какой-либо из этих серверов перестанет работать, запросы будут распределены между оставшимися двумя. Когда сервер возвращается в онлайн, мастер обнаруживает это и снова начинает направлять запросы ко всем трём узлам.

Зеркало также может включать индивидуальный список таблиц, как показано ниже:

```ini
agent = node1:9312:node1shard2|node2:9312:node2shard2
```

Это работает аналогично предыдущему примеру, но при запросе на разные серверы будут использоваться разные имена таблиц. Например, node1shard2 будет использоваться при запросе к node1:9312, а node2shard — при запросе к node2:9312.

По умолчанию все запросы направляются к лучшему из зеркал. Лучшее зеркало выбирается на основе последних статистических данных, контролируемых директивой конфигурации [ha_period_karma](../../Server_settings/Searchd.md#ha_period_karma). Мастер хранит метрики (общее число запросов, количество ошибок, время отклика и т. д.) для каждого агента и группирует их по временным промежуткам. Карма — это длина такого временного промежутка. Лучшее зеркало агента определяется динамически на основе двух последних таких временных промежутков. Конкретный алгоритм выбора зеркала можно настроить с помощью директивы [ha_strategy](../../Creating_a_cluster/Remote_nodes/Load_balancing.md#ha_strategy).

Период кармы задаётся в секундах и по умолчанию составляет 60 секунд. Мастер хранит до 15 промежутков кармы с пер-агентной статистикой для целей инструментирования (см. команду `SHOW AGENT STATUS`). Однако для логики HA/LB используются только два последних промежутка.

Когда запросов нет, мастер отправляет команду ping с интервалом каждые [ha_ping_interval](../../Creating_a_cluster/Remote_nodes/Load_balancing.md#ha_ping_interval) миллисекунд для сбора статистики и проверки, жив ли удалённый хост. Значение ha_ping_interval по умолчанию равно 1000 мс. Если установить 0, пинги отключаются, и статистика будет накапливаться только на основе реальных запросов.

Пример:

```ini
# sharding table over 4 servers total
# in just 2 shards but with 2 failover mirrors for each shard
# node1, node2 carry shard1 as local
# node3, node4 carry shard2 as local

# config on node1, node2
agent = node3:9312|node4:9312:shard2

# config on node3, node4
agent = node1:9312|node2:9312:shard1
```
<!-- proofread -->

