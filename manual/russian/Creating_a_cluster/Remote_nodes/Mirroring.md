# Зеркалирование

[Агент](../../Creating_a_table/Creating_a_distributed_table/Remote_tables.md#agent) зеркала могут использоваться взаимозаменяемо при обработке поискового запроса. Экземпляр Manticore, размещающий распределенную таблицу, где определены зеркала агентов, отслеживает статус зеркала (активно или неактивно) и время отклика, а также выполняет автоматическое переключение при сбоях и балансировку нагрузки на основе этой информации.

## Зеркала агентов

```ini
agent = node1|node2|node3:9312:shard2
```

В приведенном выше примере объявлено, что `node1:9312`, `node2:9312` и `node3:9312` имеют таблицу с названием shard2 и могут использоваться в качестве взаимозаменяемых зеркал. Если какой-либо из этих серверов выйдет из строя, запросы будут распределяться между оставшимися двумя. Когда сервер снова станет доступен, мастер обнаружит это и начнет направлять запросы ко всем трем узлам снова.

Зеркало также может включать индивидуальный список таблиц, как показано ниже:

```ini
agent = node1:9312:node1shard2|node2:9312:node2shard2
```

Это работает аналогично предыдущему примеру, но будут использоваться разные названия таблиц при запросах к разным серверам. Например, node1shard2 будет использован при запросе к node1:9312, а node2shard будет использован при запросе к node2:9312.

По умолчанию все запросы направляются к лучшему из зеркал. Лучшее зеркало выбирается на основе недавней статистики, контролируемой директивой конфигурации [ha_period_karma](../../Server_settings/Searchd.md#ha_period_karma). Мастер хранит метрики (общее количество запросов, количество ошибок, время отклика и т.д.) для каждого агента и группирует их по временным интервалам. Карма — это длина временного интервала. Лучшее зеркало агента определяется динамически на основе последних двух таких временных интервалов. Конкретный алгоритм, используемый для выбора зеркала, можно настроить с помощью директивы [ha_strategy](../../Creating_a_cluster/Remote_nodes/Load_balancing.md#ha_strategy).

Период кармы измеряется в секундах и по умолчанию составляет 60 секунд. Мастер хранит до 15 интервалов кармы с статистикой по агентам для инструментальных целей (см. оператор `SHOW AGENT STATUS`). Однако только последние два интервала из этих используются для логики HA/LB.

Когда нет запросов, мастер отправляет регулярную команду ping каждые [ha_ping_interval](../../Creating_a_cluster/Remote_nodes/Load_balancing.md#ha_ping_interval) миллисекунд для сбора статистики и проверки, жив ли удаленный хост. Значение по умолчанию для ha_ping_interval составляет 1000 мс. Установка его в 0 отключает ping, и статистика будет накапливаться только на основе фактических запросов.

Пример:

```ini
# шардирование таблицы на 4 серверах всего
# всего в 2 шард, но с 2 зеркалами при сбое для каждого шарда
# node1, node2 хранят shard1 как локальную
# node3, node4 хранят shard2 как локальную

# конфигурация на node1, node2
agent = node3:9312|node4:9312:shard2

# конфигурация на node3, node4
agent = node1:9312|node2:9312:shard1
```
<!-- proofread -->
