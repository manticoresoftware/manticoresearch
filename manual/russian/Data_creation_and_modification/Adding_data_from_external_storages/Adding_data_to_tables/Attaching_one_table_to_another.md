# Присоединение одной таблицы к другой

<!-- example Example_1 -->

Обычную таблицу можно преобразовать в таблицу реального времени или добавить к существующей таблице реального времени.

Первый случай полезен, когда необходимо полностью пересоздать таблицу реального времени, что может потребоваться, например, если нужно обновить настройки токенизации. В такой ситуации подготовка обычной таблицы и её преобразование в таблицу реального времени может быть проще, чем подготовка пакетной задачи для выполнения INSERT-запросов для добавления всех данных в таблицу реального времени.

Во втором случае обычно нужно добавить большой объем новых данных в таблицу реального времени, и снова создание обычной таблицы с этими данными проще, чем заполнение существующей таблицы реального времени.

Также можно присоединить существующую таблицу реального времени к другой.

##### Присоединение таблицы - общий синтаксис
Оператор `ATTACH` позволяет преобразовать обычную таблицу для присоединения к существующей таблице реального времени. Он также позволяет присоединить содержимое одной таблицы реального времени к другой таблице реального времени.

```sql
ATTACH TABLE plain_or_rt_table TO TABLE rt_table [WITH TRUNCATE]
```

После успешного выполнения `ATTACH` данные, изначально хранившиеся в исходной обычной таблице, становятся частью целевой таблицы реального времени, а исходная обычная таблица становится недоступной (до следующей перестройки). Если исходная таблица является таблицей реального времени, её содержимое перемещается в целевую таблицу реального времени, а исходная таблица реального времени остаётся пустой. `ATTACH` не приводит к изменению данных таблицы. По сути, он просто переименовывает файлы (делая исходную таблицу новым дисковым чанком целевой таблицы реального времени) и обновляет метаданные. Поэтому это обычно быстрая операция, которая часто завершается менее чем за секунду.

Обратите внимание, что когда таблица присоединяется к пустой таблице реального времени, поля, атрибуты и настройки обработки текста (токенизатор, словоформы и т.д.) из *исходной* таблицы копируются и вступают в силу. Соответствующие части определения таблицы реального времени из конфигурационного файла будут игнорироваться.

При использовании опции `TRUNCATE` таблица реального времени очищается перед присоединением исходной обычной таблицы. Это позволяет сделать операцию атомарной или гарантирует, что присоединённая исходная обычная таблица будет единственными данными в целевой таблице реального времени.

`ATTACH TABLE` имеет ряд ограничений. В частности, целевая таблица реального времени в настоящее время должна быть либо пустой, либо иметь те же настройки, что и исходная таблица. В случае присоединения исходной таблицы к непустой таблице реального времени, данные таблицы реального времени, собранные до этого, сохраняются как обычный дисковый чанк, а присоединяемая таблица становится новейшим дисковым чанком, при этом документы с одинаковыми ID удаляются. Полный список ограничений следующий:
* Целевая таблица реального времени должна быть либо пустой, либо иметь те же настройки, что и исходная таблица.
* Исходная таблица должна иметь [phrase_boundary_step](../../../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#phrase_boundary_step) равный 0 и [stopword_step](../../../Creating_a_table/NLP_and_tokenization/Ignoring_stop-words.md#stopword_step) равный 1.


<!-- intro -->
##### Пример:

<!-- request Example -->
До выполнения ATTACH таблица реального времени пуста и содержит 3 поля:

```sql
mysql> DESC rt;
Empty set (0.00 sec)

mysql> SELECT * FROM rt;
+-----------+---------+
| Field     | Type    |
+-----------+---------+
| id        | integer |
| testfield | field   |
| testattr  | uint    |
+-----------+---------+
3 rows in set (0.00 sec)
```

Обычная таблица не пуста:

```sql
mysql> SELECT * FROM plain WHERE MATCH('test');
+------+--------+----------+------------+
| id   | weight | group_id | date_added |
+------+--------+----------+------------+
|    1 |   1304 |        1 | 1313643256 |
|    2 |   1304 |        1 | 1313643256 |
|    3 |   1304 |        1 | 1313643256 |
|    4 |   1304 |        1 | 1313643256 |
+------+--------+----------+------------+
4 rows in set (0.00 sec)
```

Присоединение обычной таблицы к таблице реального времени:
```sql
mysql> ATTACH TABLE plain TO TABLE rt;
Query OK, 0 rows affected (0.00 sec)
```

Теперь таблица реального времени содержит 5 полей:

```sql
mysql> DESC rt;
+------------+-----------+
| Field      | Type      |
+------------+-----------+
| id         | integer   |
| title      | field     |
| content    | field     |
| group_id   | uint      |
| date_added | timestamp |
+------------+-----------+
5 rows in set (0.00 sec)
```

И она не пуста:

```sql
mysql> SELECT * FROM rt WHERE MATCH('test');
+------+--------+----------+------------+
| id   | weight | group_id | date_added |
+------+--------+----------+------------+
|    1 |   1304 |        1 | 1313643256 |
|    2 |   1304 |        1 | 1313643256 |
|    3 |   1304 |        1 | 1313643256 |
|    4 |   1304 |        1 | 1313643256 |
+------+--------+----------+------------+
4 rows in set (0.00 sec)
```

После выполнения ATTACH обычная таблица удаляется и больше недоступна для поиска:

```sql
mysql> SELECT * FROM plain WHERE MATCH('test');
ERROR 1064 (42000): no enabled local indexes to search
```
<!-- end -->
<!-- proofread -->

