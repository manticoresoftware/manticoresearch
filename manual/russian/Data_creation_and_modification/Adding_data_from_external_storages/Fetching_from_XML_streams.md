# Получение данных из XML-потоков

Тип источника `xmlpipe2` позволяет передавать в Manticore настраиваемые полнотекстовые и атрибутные данные в пользовательском XML-формате, при этом схема (т.е. набор полей и атрибутов) задаётся либо в самом XML-потоке, либо в настройках источника.

## Объявление XML-потока
Для объявления XML-потока обязательна директива `xmlpipe_command`, которая содержит shell-команду, создающую XML-поток для индексации. Это может быть файл, а также программа, генерирующая XML-контент "на лету".

## Формат XML-файла

При индексации источника xmlpipe2 индексатор запускает указанную команду, открывает канал на её stdout и ожидает хорошо сформированный XML-поток.

Вот пример того, как может выглядеть XML-поток данных:

```xml
<?xml version="1.0" encoding="utf-8"?>
<sphinx:docset>

<sphinx:schema>
<sphinx:field name="subject"/>
<sphinx:field name="content"/>
<sphinx:attr name="published" type="timestamp"/>
<sphinx:attr name="author_id" type="int" bits="16" default="1"/>
</sphinx:schema>

<sphinx:document id="1234">
<content>this is the main content <![CDATA[and this <cdata> entry
must be handled properly by xml parser lib]]></content>
<published>1012325463</published>
<subject>note how field/attr tags can be
in <b> class="red">randomized</b> order</subject>
<misc>some undeclared element</misc>
</sphinx:document>

<sphinx:document id="1235">
<subject>another subject</subject>
<content>here comes another document, and i am given to understand,
that in-document field order must not matter, sir</content>
<published>1012325467</published>
</sphinx:document>

<!-- ... even more sphinx:document entries here ... -->

<sphinx:killlist>
<id>1234</id>
<id>4567</id>
</sphinx:killlist>

</sphinx:docset>
```

Разрешены произвольные поля и атрибуты. Они также могут встречаться в потоке в произвольном порядке внутри каждого документа; порядок игнорируется. Существует ограничение максимальной длины поля; поля длиной более 2 МБ будут усечены до 2 МБ (этот лимит можно изменить в источнике).

Схема, т.е. полный список полей и атрибутов, должна быть объявлена перед тем, как можно будет разобрать какой-либо документ. Это можно сделать либо в конфигурационном файле с помощью настроек `xmlpipe_field` и `xmlpipe_attr_XXX`, либо непосредственно в потоке с использованием элемента `<sphinx:schema>`. Элемент `<sphinx:schema>` необязателен. Его допустимо разместить только как самый первый дочерний элемент в `<sphinx:docset>`. Если определение схемы в потоке отсутствует, используются настройки из конфигурационного файла. В противном случае приоритет отдается настройкам потока. Обратите внимание, что идентификатор документа должен указываться как свойство `id` тега `<sphinx:document>` (например, `<sphinx:document id="1235">`) и должен быть уникальным положительным 64-битным целым числом, не равным нулю.

Неизвестные теги (которые не были объявлены ни как поля, ни как атрибуты) будут проигнорированы с предупреждением. В приведённом примере, тег `<misc>` будет проигнорирован. Все вложенные теги и их атрибуты (например, `<strong>` внутри `<subject>` из примера выше) будут тихо проигнорированы.

Поддержка кодировок входящего потока зависит от наличия на системе `iconv`. xmlpipe2 парсится с использованием парсера `libexpat`, который нативно понимает US-ASCII, ISO-8859-1, UTF-8 и некоторые варианты UTF-16. Скрипт конфигурации Manticore также проверит наличие `libiconv` и использует его для работы с другими кодировками. `libexpat` также накладывает требование использовать кодировку UTF-8 на стороне Manticore, поскольку возвращаемые данные парсера всегда в UTF-8.

XML-элементы (теги), распознаваемые xmlpipe2 (и их атрибуты, где применимо):

* `sphinx:docset` — обязательный верхнеуровневый элемент, обозначает и содержит набор документов xmlpipe2.
* `sphinx:schema` — необязательный элемент, должен либо располагаться как самый первый дочерний у sphinx:docset, либо отсутствовать совсем. Объявляет схему документа и содержит декларации полей и атрибутов. Если присутствует, переопределяет настройки источника из конфигурационного файла.
* `sphinx:field` — необязательный элемент, дочерний для sphinx:schema. Объявляет полнотекстовое поле. Известные атрибуты:
    *   "name", задаёт имя XML-элемента, который будет рассматриваться как полнотекстовое поле в последующих документах.
    *   "attr", указывает, индексировать ли это поле также как строковый атрибут. Возможное значение — "string".
* `sphinx:attr` — необязательный элемент, дочерний для sphinx:schema. Объявляет атрибут. Известные атрибуты:
    *   "name", задаёт имя элемента, который должен интерпретироваться как атрибут в последующих документах.
    *   "type", задаёт тип атрибута. Возможные значения: "int", "bigint", "timestamp", "bool", "float", "multi" и "json".
    *   "bits", задаёт размер в битах для атрибута типа "int". Допустимые значения — от 1 до 32.
    *   "default", задаёт значение по умолчанию для этого атрибута, используемое если элемент с атрибутом отсутствует в документе.
* `sphinx:document` — обязательный элемент, должен быть дочерним у sphinx:docset. Содержит произвольные другие элементы с полями и значениями атрибутов для индексации, как объявлено через sphinx:field и sphinx:attr либо в конфигурационном файле. Единственный известный атрибут — "id", который должен содержать уникальный целочисленный ID документа.
* `sphinx:killlist` — необязательный элемент, дочерний у sphinx:docset. Содержит несколько элементов "id", содержимое которых — ID документов, помещаемых в kill-list таблицы. Kill-list используется в мульти-табличных поисках для подавления документов, найденных в других таблицах поиска.

## Определение данных в конфигурации источника

Если XML не определяет схему, типы данных элементов таблиц должны быть определены в конфигурации источника.

* `xmlpipe_field` — объявляет поле типа `text`.
* `xmlpipe_field_string` — объявляет текстовое поле/строковый атрибут. Столбец будет индексироваться как текстовое поле и также храниться как строковый атрибут.
* `xmlpipe_attr_uint` — объявляет целочисленный атрибут
* `xmlpipe_attr_timestamp` — объявляет атрибут типа временной метки
* `xmlpipe_attr_bool` — объявляет булев атрибут
* `xmlpipe_attr_float` — объявляет атрибут с плавающей точкой
* `xmlpipe_attr_bigint` — объявляет атрибут большого целого числа
* `xmlpipe_attr_multi` — объявляет мульти-значный атрибут с целыми числами
* `xmlpipe_attr_multi_64` — объявляет мульти-значный атрибут с 64-битными целыми
* `xmlpipe_attr_string` — объявляет строковый атрибут
* `xmlpipe_attr_json` — объявляет JSON-атрибут

### Специфичные настройки XML-источника

Если задан `xmlpipe_fixup_utf8`, включается проверка и фильтрация UTF-8 на стороне Manticore для предотвращения сбоев XML-парсера на не-UTF-8 документах. По умолчанию эта опция отключена.

В некоторых случаях может быть трудно или даже невозможно гарантировать, что входящие тела документов XMLpipe2 находятся в идеально валидной и соответствующей кодировке UTF-8. Например, в поток могут попасть документы с национальными однобайтными кодировками. Парсер XML libexpat является хрупким, что означает, что он прекратит обработку в таких случаях. Функция исправления UTF8 позволяет избежать этого. Когда исправление включено, Manticore будет предварительно обрабатывать входящий поток перед передачей его парсеру XML и заменять недопустимые последовательности UTF-8 пробелами.

```ini
xmlpipe_fixup_utf8 = 1
```

Пример исходного XML без схемы в конфигурации:

```ini
source xml_test_1
{
    type = xmlpipe2
    xmlpipe_command = cat /tmp/products_today.xml
}
```

Пример исходного XML со схемой в конфигурации:

```ini
source xml_test_2
{
    type = xmlpipe2
    xmlpipe_command = cat /tmp/products_today.xml
    xmlpipe_field = subject
    xmlpipe_field = content
    xmlpipe_attr_timestamp = published
    xmlpipe_attr_uint = author_id:16
}
```
<!-- proofread -->

