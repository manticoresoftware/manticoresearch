# Диапазонные запросы 


Основной запрос, который должен получить все документы, может наложить блокировку на чтение на всю таблицу и остановить параллельные запросы (например, INSERT в таблицу MyISAM), тратить много памяти на набор результатов и т. д. Чтобы избежать этого, Manticore поддерживает так называемые *диапазонные запросы*. С помощью диапазонных запросов Manticore сначала извлекает минимальные и максимальные идентификаторы документов из таблицы, а затем подставляет разные интервалы идентификаторов в текст основного запроса и выполняет модифицированный запрос для получения другой части документов. Вот пример.

Пример использования диапазонного запроса:

```ini
sql_query_range = SELECT MIN(id),MAX(id) FROM documents
sql_range_step = 1000
sql_query = SELECT * FROM documents WHERE id>=$start AND id<=$end
```

Если таблица содержит идентификаторы документов от 1 до, скажем, 2345, то sql_query будет выполняться трижды:

1.  с заменой `$start` на 1 и `$end` на 1000;
2.  с заменой `$start` на 1001 и `$end` на 2000;
3.  с заменой `$start` на 2001 и `$end` на 2345.

Очевидно, что это не сильно отличается для таблицы из 2000 строк, но когда речь идет о индексации таблицы из 10 миллионов строк, диапазонные запросы могут быть полезны.

### sql_query_range

Определяет диапазонный запрос. Запрос, указанный в этом параметре, должен извлекать минимальные и максимальные идентификаторы документов, которые будут использоваться в качестве границ диапазона. Он должен возвращать ровно два целых поля, минимальный ID первым и максимальный ID вторым; имена полей игнорируются. Когда эта опция включена, `sql_query` должен содержать макросы $start и $end. Обратите внимание, что интервалы, заданные $start..$end, не должны перекрывать друг друга, поэтому вам не следует удалять идентификаторы документов, которые точно равны $start или $end из вашего запроса.
 
### sql_range_step

Этот директив определяет шаг диапазонного запроса. Значение по умолчанию составляет 1024.

### sql_ranged_throttle

Этот директив может использоваться для ограничения диапазонного запроса. По умолчанию нет ограничения. Значения для sql_ranged_throttle должны быть указаны в миллисекундах.

Ограничение может быть полезно, когда индексация создает слишком большую нагрузку на сервер базы данных. Оно вызывает приостановку индексации на заданное количество времени после каждого шага диапазонного запроса. Эта пауза является безусловной и выполняется перед запросом извлечения.

```ini
sql_ranged_throttle = 1000 # пауза 1 секунда перед каждым шагом запроса
```
<!-- proofread -->
