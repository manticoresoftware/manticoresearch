# Диапазонные запросы


Основной запрос, который должен получить все документы, может наложить блокировку на чтение всей таблицы и задержать параллельные запросы (например, INSERT в таблицу MyISAM), потребить много памяти для набора результатов и т. д. Чтобы избежать этого, Manticore поддерживает так называемые *диапазонные запросы*. С помощью диапазонных запросов Manticore сначала извлекает минимальные и максимальные ID документов из таблицы, а затем подставляет различные интервалы ID в текст основного запроса и запускает изменённый запрос для получения следующей части документов. Вот пример.

Пример использования диапазонного запроса:

```ini
sql_query_range = SELECT MIN(id),MAX(id) FROM documents
sql_range_step = 1000
sql_query = SELECT * FROM documents WHERE id>=$start AND id<=$end
```

Если таблица содержит ID документов от 1 до, скажем, 2345, то sql_query будет выполнен трижды:

1.  с заменой `$start` на 1 и `$end` на 1000;
2.  с заменой `$start` на 1001 и `$end` на 2000;
3.  с заменой `$start` на 2001 и `$end` на 2345.

Очевидно, что для таблицы из 2000 строк это не сильно отличается, но когда речь идёт об индексировании таблицы в 10 миллионов строк, диапазонные запросы могут оказаться полезными.

### sql_query_range

Определяет диапазонный запрос. В запросе, указанном в этой опции, должны извлекаться минимальные и максимальные ID документов, которые будут использоваться в качестве границ диапазона. Он должен возвращать ровно два целочисленных поля: сначала min ID, затем max ID; имена полей игнорируются. Если включено, `sql_query` должен содержать макросы $start и $end. Обратите внимание, что интервалы, определённые $start..$end, не пересекаются, поэтому не следует исключать из запроса документы с ID, равным точно $start или $end.

### sql_range_step

Эта директива определяет шаг диапазонного запроса. Значение по умолчанию — 1024.

### sql_ranged_throttle

Эта директива может использоваться для ограничения скорости диапазонного запроса. По умолчанию ограничений нет. Значения для sql_ranged_throttle указываются в миллисекундах.

Ограничение скорости может быть полезно, когда индексатор создаёт слишком большую нагрузку на сервер базы данных. Это заставляет индексатор засыпать на заданное время один раз за каждый шаг диапазонного запроса. Сон является безусловным и выполняется до выполнения выборочного запроса.

```ini
sql_ranged_throttle = 1000 # sleep for 1 sec before each query step
```
<!-- proofread -->

