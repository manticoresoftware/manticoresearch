# Поворот таблицы

Поворот таблицы — это процедура, при которой сервер searchd ищет новые версии определённых таблиц в конфигурации. Поворот поддерживается только в режиме Plain.

Могут быть два случая:

* для plain таблиц, которые уже загружены
* для таблиц, добавленных в конфигурацию, но ещё не загруженных

В первом случае индексатор не может выложить новую версию таблицы онлайн, так как запущенная копия заблокирована и загружена `searchd`. В этом случае `indexer` нужно вызвать с параметром [--rotate](../../Data_creation_and_modification/Adding_data_from_external_storages/Plain_tables_creation.md#Indexer-command-line-arguments). При использовании rotate `indexer` создаёт новые файлы таблицы с `.new.` в именах и посылает сигнал *HUP* в `searchd`, уведомляя его о новой версии. `searchd` выполняет проверку и подставляет новую версию таблицы, отбросив старую. В некоторых случаях может потребоваться создать новую версию таблицы, но не выполнять поворот сразу. Например, сначала может понадобиться проверить состояние новых версий таблицы. Тогда `indexer` может принять параметр `--nohup`, который запрещает посылать HUP сигнал серверу.

Новые таблицы могут загружаться через поворот; однако стандартная обработка сигнала HUP заключается в проверке новых таблиц только если конфигурация изменилась с момента запуска сервера. Если таблица уже была определена в конфигурации, таблицу следует сначала создать, запустив `indexer` без поворота, и выполнить оператор [RELOAD TABLES](../../Data_creation_and_modification/Adding_data_from_external_storages/Rotating_a_table.md#RELOAD-TABLES).

Также есть два специализированных оператора, которые можно использовать для выполнения поворотов таблиц:

## RELOAD TABLE

```sql
RELOAD TABLE tbl [ FROM '/path/to/table_files' [ OPTION switchover=1 ] ];
```

Команда `RELOAD TABLE` позволяет выполнять поворот таблицы через SQL.

Эта команда работает в трёх режимах. В первом режиме, без указания пути, сервер Manticore проверяет наличие новых файлов таблицы в директории, указанной в параметре [path](../../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#path). Новые файлы таблицы должны иметь имена вида `tbl.new.sp?`.

Если указать путь, сервер ищет файлы таблицы в этой директории, перемещает их в путь таблицы [path](../../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#path), переименовывает из `tbl.sp?` в `tbl.new.sp?` и выполняет поворот.

Третий режим, активируемый опцией `OPTION switchover=1`, переключает индекс на новый путь. Здесь демон пытается загрузить таблицу непосредственно из нового пути без перемещения файлов. Если загрузка успешна, новый индекс заменяет старый.

Также демон записывает уникальный файл ссылки (`tbl.link`) в директорию, указанную в [path](../../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#path), обеспечивая постоянное перенаправление.

Если вы возвращаете перенаправленный индекс к пути, указанному в конфигурации, демон обнаружит это и удалит файл ссылки.

После перенаправления демон извлекает таблицу из новосозданного связанного пути. При повороте он ищет новые версии таблиц по новому перенаправленному пути. Учтите, что демон проверяет конфигурацию на общие ошибки, например дублирующиеся пути в разных таблицах. Однако он не выявит, если несколько таблиц указывают на один и тот же путь через перенаправление. В обычной работе таблицы блокируются файлом `.spl`, но отключение блокировки может вызвать проблемы. Если возникает ошибка (например, путь недоступен по любой причине), вам следует вручную исправить (или просто удалить) файл ссылки.

`indextool` следует за файлом ссылки, но другие инструменты (`indexer`, `index_converter` и т. д.) не распознают файл ссылки и всегда используют путь, определённый в конфигурационном файле, игнорируя любые перенаправления. Таким образом, вы можете проверить индекс с помощью `indextool`, и он прочитает из нового расположения. Однако более сложные операции, такие как слияние, не будут учитывать файл ссылки.

```sql
mysql> RELOAD TABLE plain_table;
mysql> RELOAD TABLE plain_table FROM '/home/mighty/new_table_files';
mysql> RELOAD TABLE plain_table FROM '/home/mighty/new/place/for/table/table_files' OPTION switchover=1;
```

## RELOAD TABLES

```sql
RELOAD TABLES;
```

Эта команда работает аналогично системному сигналу HUP, вызывая поворот таблиц. Тем не менее, она не полностью повторяет поведение обычного сигнала HUP (который может быть послан, например, командой `kill -HUP` или `indexer --rotate`). Эта команда активно ищет таблицы, нуждающиеся в повороте, и способна перечитывать конфигурацию. Например, если вы запустите Manticore в plain режиме с конфигурационным файлом, указывающим на несуществующую plain таблицу, и потом попытаетесь выполнить `indexer --rotate` для этой таблицы, сервер не распознает новую таблицу до тех пор, пока не выполните `RELOAD TABLES` или не перезапустите сервер.

В зависимости от значения настройки [seamless_rotate](../../Server_settings/Searchd.md#seamless_rotate) новые запросы могут быть кратковременно задержаны, и клиенты получат временные ошибки.

```sql
mysql> RELOAD TABLES;
Query OK, 0 rows affected (0.01 sec)
```

## Бесшовный поворот

Поворот подразумевает, что старая версия таблицы отброшена, а новая загружена и заменяет существующую. Во время этого обмена сервер должен обслуживать входящие запросы к таблице, которая обновляется. Чтобы избежать задержек запросов, сервер по умолчанию реализует бесшовный поворот таблицы, как описано ниже.

Таблицы могут содержать данные, которые необходимо предварительно разместить в ОЗУ. В настоящее время файлы `.spa`, `.spb`, `.spi` и `.spm` полностью кэшируются заранее (они содержат данные атрибутов, данные blob-атрибутов, таблицу ключевых слов и карту удалённых строк, соответственно). Без бесшовного поворота поворот таблицы старается использовать минимально возможное ОЗУ и работает следующим образом:

1. Новые запросы временно отклоняются (с кодом ошибки "retry").
2. `searchd` ждёт завершения всех текущих запросов.
3. Старая таблица освобождается, а её файлы переименовываются.
4. Файлы новой таблицы переименовываются, и выделяется необходимая ОЗУ.
5. Данные атрибутов и словарь новой таблицы предварительно загружаются в ОЗУ.
6. `searchd` возобновляет обработку запросов из новой таблицы.

Однако, если данных атрибутов или словаря много, этап предварительной загрузки может занять заметное время — до нескольких минут при предварительной загрузке файлов объёмом 1-5+ ГБ.

При включенной бесшовной ротации, вращение работает следующим образом:

1. Выделяется новая оперативная память для таблицы.
2. Атрибуты новой таблицы и данные словаря асинхронно загружаются в оперативную память.
3. В случае успеха, старая таблица освобождается, и файлы обеих таблиц переименовываются.
4. В случае неудачи, новая таблица освобождается.
5. В любой момент запросы обслуживаются либо из старой, либо из новой копии таблицы.

Бесшовная ротация сопровождается более высоким **пиковым** использованием памяти во время вращения (поскольку копии данных `.spa/.spb/.spi/.spm` и старой, и новой таблиц должны одновременно находиться в оперативной памяти во время загрузки новой копии). Однако среднее использование памяти остается неизменным.

Пример:

```ini
seamless_rotate = 1
```
<!-- proofread -->

