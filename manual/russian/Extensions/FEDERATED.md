# ФЕДЕРИРОВАННЫЙ

С помощью механизма MySQL FEDERATED вы можете подключаться к локальному или удаленному экземпляру Manticore из MySQL/MariaDB и выполнять поисковые запросы.

## Использование FEDERATED

Фактический запрос Manticore не может быть использован напрямую с механизмом FEDERATED и должен быть "проксирован" (отправлен в виде строки в столбце) из-за ограничений механизма FEDERATED и того факта, что Manticore реализует собственный синтаксис, такой как условие [MATCH](../Searching/Full_text_matching/Basic_usage.md).

Чтобы выполнить поиск через `FEDERATED`, вам сначала нужно создать таблицу механизма FEDERATED. Запрос Manticore будет включен в столбец `query` в команде `SELECT`, выполняемой над таблицей FEDERATED.

<!-- example create federated -->
Создание таблицы MySQL, совместимой с FEDERATED:


<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
CREATE TABLE t1
(
    id          INTEGER UNSIGNED NOT NULL,
    year        INTEGER NOT NULL,
    rating    	FLOAT,
    query       VARCHAR(1024) NOT NULL,
    INDEX(query)
) ENGINE=FEDERATED
DEFAULT CHARSET=utf8
CONNECTION='mysql://FEDERATED@127.0.0.1:9306/DB/movies';
```
<!-- response SQL-->

```sql
Запрос выполнен успешно, 0 строк затронуто (0.00 сек)
```
<!-- end -->

<!-- example select federated -->
Запрос к таблице, совместимой с FEDERATED:


<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
SELECT * FROM t1 WHERE query='SELECT * FROM movies WHERE MATCH (\'pie\')';
```

<!-- response SQL-->

```sql
+----+------+--------+------------------------------------------+
| id | year | rating | query                                    |
+----+------+--------+------------------------------------------+
|  1 | 2019 |      5 | SELECT * FROM movies WHERE MATCH ('pie') |
+----+------+--------+------------------------------------------+
1 строка в наборе (0.04 сек)
```
<!-- end -->

Единственное фиксированное соответствие — это столбец `query`. Он является обязательным и должен быть единственным столбцом с прикрепленной таблицей.

Таблица Manticore, связанная через `FEDERATED`, **должна** быть физической таблицей (обычной или в реальном времени).

Таблица FEDERATED должна иметь столбцы с теми же именами, что и атрибуты удаленной таблицы Manticore, поскольку они будут связаны с атрибутами, предоставленными в наборе результатов Manticore по именам. Однако она может сопоставлять только некоторые атрибуты, а не все из них.

Сервер Manticore идентифицирует запрос от клиента FEDERATED по имени пользователя "FEDERATED". Параметр строки `CONNECTION` используется для указания хоста Manticore, SQL-порта и таблиц для запросов, приходящих через соединение. Синтаксис строки подключения следующий:

```ini
CONNECTION="mysql://FEDERATED@HOST:PORT/DB/TABLENAME"
```

Поскольку в Manticore нет концепции базы данных, строка `DB` может быть произвольной, так как она будет игнорироваться Manticore, но MySQL требует значения в определении строки `CONNECTION`. Как видно из примера, полный SQL-запрос `SELECT` должен быть помещен в условие WHERE по отношению к столбцу `query`.

Поддерживается только оператор `SELECT`, не поддерживаются `INSERT`, `REPLACE`, `UPDATE` или `DELETE`.

### Советы по FEDERATED

Одно **очень важное** замечание: значительно эффективнее позволить Manticore выполнять сортировку, фильтрацию и разбивку набора результатов, чем увеличивать максимальное количество совпадений и использовать условия WHERE, ORDER BY и LIMIT на стороне MySQL. Это связано с двумя причинами. Во-первых, Manticore реализует ряд оптимизаций и работает лучше, чем MySQL для этих задач. Во-вторых, меньше данных нужно упаковывать, передавать и распаковывать между Manticore и MySQL.

<!-- example federated join -->
JOIN-ы могут выполняться между таблицей FEDERATED и другими таблицами MySQL. Это можно использовать для получения информации, которая не хранится в таблице Manticore.


<!-- intro -->
##### SQL:

<!-- request SQL -->
##### Запрос для объединения таблицы на основе MySQL с таблицей FEDERATED, обслуживаемой Manticore:

```sql
SELECT t1.id, t1.year, comments.comment FROM t1 JOIN comments ON t1.id=comments.post_id WHERE query='SELECT * FROM movies WHERE MATCH (\'pie\')';
```

<!-- response SQL-->

```sql
+----+------+--------------+
| id | year | comment      |
+----+------+--------------+
|  1 | 2019 | было не хорошо |
+----+------+--------------+
1 строка в наборе (0.00 сек)
```

<!-- end -->
<!-- proofread -->
