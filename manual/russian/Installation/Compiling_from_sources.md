# Компиляция Manticore из исходников

Компиляция Manticore Search из исходных кодов позволяет создавать пользовательские конфигурации сборки, например, отключать определённые функции или добавлять новые патчи для тестирования. Например, вы можете захотеть собрать из исходников и отключить встроенную ICU, чтобы использовать другую версию, установленную в вашей системе, которую можно обновлять независимо от Manticore. Это также полезно, если вы заинтересованы в внесении вклада в проект Manticore Search.

## Сборка с использованием CI Docker
Для подготовки [официальных релизных и девелоперских пакетов](https://repo.manticoresearch.com/) мы используем Docker и специальный образ для сборки. Этот образ включает необходимые инструменты и предназначен для работы с внешними sysroot, чтобы один контейнер мог собирать пакеты для всех операционных систем. Вы можете собрать этот образ, используя [Dockerfile](https://github.com/manticoresoftware/manticoresearch/blob/master/dist/build_dockers/cross/external_toolchain/Dockerfile) и [README](https://github.com/manticoresoftware/manticoresearch/blob/master/dist/build_dockers/README.md) или использовать образ с [Docker Hub](https://hub.docker.com/r/manticoresearch/external_toolchain/tags). Это самый простой способ собрать двоичные файлы для любой поддерживаемой операционной системы и архитектуры. Также вам нужно указать следующие переменные окружения при запуске контейнера:

* `DISTR`: целевая платформа: `bionic`, `focal`, `jammy`, `buster`, `bullseye`, `bookworm`, `rhel7`, `rhel8`, `rhel9`, `rhel10`, `macos`, `windows`, `freebsd13`
* `arch`: архитектура: `x86_64`, `x64` (для Windows), `aarch64`, `arm64` (для Macos)
* `SYSROOT_URL`: URL к архивам sysroot. Вы можете использовать https://repo.manticoresearch.com/repository/sysroots, если только не собираете sysroot самостоятельно (инструкции можно найти [здесь](https://github.com/manticoresoftware/manticoresearch/tree/master/dist/build_dockers/cross/sysroots)).
* Используйте файлы CI workflow в качестве справочника для других переменных окружения, которые вам могут понадобиться:
  - https://github.com/manticoresoftware/manticoresearch/blob/master/.github/workflows/pack_publish.yml
  - https://github.com/manticoresoftware/manticoresearch/blob/master/.github/workflows/build_template.yml

Для подбора возможных значений `DISTR` и `arch` можно использовать директорию https://repo.manticoresearch.com/repository/sysroots/roots_with_zstd/ как справочник, так как она включает sysroot для всех поддерживаемых комбинаций.

После этого сборка пакетов внутри Docker контейнера проста, достаточно вызвать:

```bash
cmake -DPACK=1 /path/to/sources
cmake --build .
```

Например, чтобы создать пакет для Ubuntu Jammy, похожий на официальную версию, предоставляемую командой Manticore Core Team, необходимо выполнить следующие команды в каталоге с исходными кодами Manticore Search. Этот каталог является корнем клонированного репозитория с https://github.com/manticoresoftware/manticoresearch:

```bash
docker run -it --rm \
-e CACHEB="../cache" \
-e DIAGNOSTIC=1 \
-e PACK_ICUDATA=0 \
-e NO_TESTS=1 \
-e DISTR=jammy \
-e boost=boost_nov22 \
-e sysroot=roots_nov22 \
-e arch=x86_64 \
-e CTEST_CMAKE_GENERATOR=Ninja \
-e CTEST_CONFIGURATION_TYPE=RelWithDebInfo \
-e WITH_COVERAGE=0 \
-e SYSROOT_URL="https://repo.manticoresearch.com/repository/sysroots" \
-e HOMEBREW_PREFIX="" \
-e PACK_GALERA=0 \
-e UNITY_BUILD=1 \
-v $(pwd):/manticore_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa \
manticoresearch/external_toolchain:vcpkg331_20250114 bash

# following is to be run inside docker shell
cd /manticore_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/
mkdir build && cd build
cmake -DPACK=1 ..
export CMAKE_TOOLCHAIN_FILE=$(pwd)/dist/build_dockers/cross/linux.cmake
cmake --build .
# or if you want to build packages:
# cmake --build . --target package
```
Требуется длинный путь к исходному каталогу, иначе сборка исходников может не пройти успешно в некоторых случаях (например, в Centos).

Такой же процесс можно использовать для сборки двоичных файлов/пакетов не только для популярных дистрибутивов Linux, но и для FreeBSD, Windows и macOS.

## Ручная сборка

Компиляция Manticore без использования Docker для сборки **не рекомендуется**, но если необходимо, вот что вам нужно знать:

### Необходимые инструменты

* Компилятор C++
  * В Linux — можно использовать GNU (4.7.2 и выше) или Clang
  * В Windows — Microsoft Visual Studio 2019 и выше (достаточно Community Edition)
  * На macOS — Clang (из инструментов командной строки XCode, для установки используйте `xcode-select --install`).
* Bison, Flex — на большинстве систем доступны как пакеты, в Windows их можно установить в среде cygwin.
* Cmake — используется на всех платформах (требуется версия 3.19 и выше)

### Получение исходников

#### Из git

Исходный код Manticore размещён на [GitHub](https://github.com/manticoresoftware/manticoresearch).
Чтобы получить исходный код, склонируйте репозиторий и переключитесь на нужную ветку или тег. Ветка `master` представляет основную ветку разработки. При выпуске новой версии создаётся тег с номером версии, например `3.6.0`, и запускается новая ветка для текущего релиза, в данном случае `manticore-3.6.0`. Голова версии в теговой ветке после всех изменений используется как исходник для сборки всех двоичных релизов. Например, чтобы взять исходники версии 3.6.0, выполните:

```bash
git clone https://github.com/manticoresoftware/manticoresearch.git
cd manticoresearch
git checkout manticore-3.6.0
```

#### Из архива

Можно скачать нужный код с GitHub с помощью кнопки "Download ZIP". Подходят оба формата: .zip и .tar.gz.

```bash
wget -c https://github.com/manticoresoftware/manticoresearch/archive/refs/tags/3.6.0.tar.gz
tar -zxf 3.6.0.tar.gz
cd manticoresearch-3.6.0
```

### Конфигурация

Manticore использует CMake. Предположим, вы находитесь в корне клонированного репозитория:

```bash
mkdir build && cd build
cmake ..
```

CMake проверит доступные функции и сконфигурирует сборку с их учётом. По умолчанию все функции считаются включёнными, если они доступны. Скрипт также скачивает и компилирует некоторые внешние библиотеки, предполагая, что вы хотите их использовать. Таким образом, по умолчанию вы получаете поддержку максимального количества функций.

Также можно явно конфигурировать сборку с помощью флагов и опций. Чтобы включить функцию `FOO`, добавьте `-DFOO=1` в вызов CMake.
Чтобы отключить, используйте `-DFOO=0`. Если не указано иное, включение функции, которая недоступна (например, `WITH_GALERA` при сборке под MS Windows), приведёт к ошибке конфигурации. Отключение функции, помимо исключения из сборки, также исключает её проверку в системе и скачивание/сборку связанных внешних библиотек.

#### Флаги и опции конфигурации

- **USE_SYSLOG** — разрешает использование `syslog` в [логировании запросов](../Logging/Query_logging.md).
- **WITH_GALERA** - Включает поддержку репликации на демон поиска. Поддержка будет настроена для сборки, и источники библиотеки Galera будут загружены, собраны и включены в дистрибуцию/установку. Обычно безопасно собирать с Galera, но не распространять саму библиотеку (то есть без модуля Galera, без репликации). Тем не менее, иногда вам может потребоваться явно отключить это, например, если вы хотите собрать статичный бинарный файл, который по дизайну не может загружать какие-либо библиотеки, так что даже наличие вызова функции 'dlopen' внутри демона вызовет ошибку линковки.
- **WITH_RE2** - Собирает с использованием библиотеки регулярных выражений RE2. Это необходимо для функций, таких как [REGEX()](../Functions/String_functions.md#REGEX%28%29), и [regexp_filter](../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#regexp_filter)
  функции.
- **WITH_RE2_FORCE_STATIC** - Загружает источники RE2, компилирует их и линковает статически, так что итоговые бинарные файлы не будут зависеть от наличия совместимой библиотеки `RE2` в вашей системе.
- **WITH_STEMMER** - Собирает с использованием библиотеки стеммирования Snowball.
- **WITH_STEMMER_FORCE_STATIC** - Загружает источники Snowball, компилирует их и линковает статически, так что итоговые бинарные файлы не будут зависеть от наличия совместимой библиотеки `libstemmer` в вашей системе.
- **WITH_ICU** - Собирает с библиотекой ICU (International Components for Unicode). Она используется для сегментации китайского текста. Она используется, когда используется морфология=`icu_chinese`.
- **WITH_JIEBA** - Собирает с инструментом сегментации китайского текста Jieba. Он используется для сегментации китайского текста. Она используется, когда используется морфология=`jieba_chinese`.
- **WITH_ICU_FORCE_STATIC** - Загружает источники ICU, компилирует их и линковает статически, так что итоговые бинарные файлы не будут зависеть от наличия совместимой библиотеки `icu` в вашей системе. Также включает файл данных ICU в установку/распределение. Цель линкованной статически библиотеки ICU - иметь библиотеку известной версии, чтобы поведение было определено и не зависело от каких-либо системных библиотек. Вы, скорее всего, предпочтете использовать системную ICU, так как она может обновляться со временем без необходимости повторной компиляции демона Manticore. В этом случае вам нужно явно отключить эту опцию. Это также сэкономит вам место, занимаемое файлом данных ICU (около 30M), так как он не будет включен в распределение.
- **WITH_SSL** - Используется для поддержки HTTPS, а также зашифрованных соединений MySQL с демоном. Системная библиотека OpenSSL будет связана с демоном. Это подразумевает, что OpenSSL будет необходим для запуска демона. Это обязательно для поддержки HTTPS, но не строго обязательно для сервера (то есть отсутствие SSL означает отсутствие возможности подключения по HTTPS, но другие протоколы будут работать). Библиотека SSL версий с 1.0.2 до 1.1.1 может быть использована Manticore, однако обратите внимание, что **ради безопасности настоятельно рекомендуется использовать самую свежую возможную библиотеку SSL**
  . На данный момент поддерживается только версия v1.1.1, остальные устарели (
  см. [стратегию релиза openssl](https://www.openssl.org/policies/releasestrat.html)
- **WITH_ZLIB** - используется индексатором для работы с сжатыми колонками из MySQL. Используется демоном для обеспечения поддержки сжатого протокола MySQL.
- **WITH_ODBC** - используется индексатором для поддержки индексирования источников из ODBC-поставщиков (обычно это UnixODBC и iODBC). На MS Windows ODBC является правильным способом работы с источниками MS SQL, так что индексирование `MSSQL` также подразумевает этот флаг.
- **DL_ODBC** - не связывать с библиотекой ODBC. Если ODBC связан, но недоступен, вы не сможете запустить инструмент индексирования, даже если хотите обработать что-то, не относящееся к ODBC. Эта опция просит индексатор загрузить библиотеку во время выполнения только когда вы хотите работать с ODBC источником.
- **ODBC_LIB** - имя файла библиотеки ODBC. Индексатор попытается загрузить этот файл, когда вы захотите обработать ODBC источник. Эта опция автоматически записывается из доступного исследования совместимой библиотеки ODBC. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения `ODBC_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_EXPAT** - используется индексатором для поддержки индексирования источников xmlpipe.
- **DL_EXPAT** - не связывать с библиотекой EXPAT. Если EXPAT связан, но недоступен, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не относящееся к xmlpipe. Эта опция просит индексатор загрузить библиотеку во время выполнения только когда вы хотите работать с xmlpipe источником.
- **EXPAT_LIB** - имя файла библиотеки EXPAT. Индексатор попытается загрузить этот файл, когда вы захотите обработать xmlpipe источник. Эта опция автоматически записывается из доступного исследования совместимой библиотеки EXPAT. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения EXPAT_LIB с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_ICONV** - для поддержки различных кодировок при индексировании источников xmlpipe с помощью индексатора.
- **DL_ICONV** - не связывать с библиотекой iconv. Если iconv связан, но недоступен, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не относящееся к xmlpipe. Эта опция просит индексатор загрузить библиотеку во время выполнения только когда вы хотите работать с xmlpipe источником.
- **ICONV_LIB** - имя файла библиотеки iconv. Индексатор попытается загрузить этот файл, когда вы захотите обработать xmlpipe источник. Эта опция автоматически записывается из доступного исследования совместимой библиотеки iconv. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения `ICONV_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_MYSQL** - используется индексатором для поддержки индексирования источников MySQL.
- **DL_MYSQL** - не связывать с библиотекой MySQL. Если MySQL связана, но недоступна, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не связанное с MySQL. Этот параметр требует от индексатора загрузки библиотеки во время выполнения только тогда, когда вы хотите работать с источником MySQL.
- **MYSQL_LIB** -- имя файла библиотеки MySQL. Индексатор попытается загрузить этот файл, когда вы захотите обработать источник MySQL. Этот параметр автоматически записывается после проверки доступных общих библиотек MySQL. Вы также можете переопределить это имя во время выполнения, задав переменную окружения `MYSQL_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_POSTGRESQL** - используется индексатором для поддержки индексирования источников PostgreSQL.
- **DL_POSTGRESQL** - не связывать с библиотекой PostgreSQL. Если PostgreSQL связана, но недоступна, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не связанное с PostgreSQL. Этот параметр требует от индексатора загрузки библиотеки во время выполнения только тогда, когда вы хотите работать с источником PostgreSQL.
- **POSTGRESQL_LIB** - имя файла библиотеки postgresql. Индексатор попытается загрузить указанный файл библиотеки postgresql при обработке источника postgresql. Этот параметр автоматически определяется после проверки доступных общих библиотек postgresql. Вы также можете переопределить имя во время выполнения, задав переменную окружения `POSTGRESQL_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **LOCALDATADIR** - путь по умолчанию, где демон хранит журналы двоичных логов. Если этот путь не предоставлен или явно отключен в конфигурации времени выполнения демона (т.е. файл `manticore.conf`, который не связан с этой конфигурацией сборки), журналы двоичных логов будут размещены по этому пути. Обычно это абсолютный путь, однако он не обязан быть таковым, можно использовать и относительные пути. Вероятно, вам не нужно менять значение по умолчанию, определяемое конфигурацией, которое, в зависимости от целевой системы, может быть таким, как `/var/data`, `/var/lib/manticore/data` или `/usr/local/var/lib/manticore/data`.
- **FULL_SHARE_DIR** - путь по умолчанию, где хранятся все ассеты. Его можно переопределить переменной окружения `FULL_SHARE_DIR` перед запуском любого инструмента, использующего файлы из этой папки. Это важный путь, так как по умолчанию там ожидается множество данных. Сюда входят предопределенные таблицы кодировок, стоп-слова, модули manticore и файлы данных icu, все размещены в этой папке. Скрипт конфигурации обычно устанавливает этот путь как `/usr/share/manticore` или `/usr/local/share/manticore`.
- **DISTR_BUILD** - ярлык для параметров выпуска пакетов. Это строковое значение с названием целевой платформы. Может применяться вместо ручной настройки всех параметров. На системах Debian и Redhat Linux значение по умолчанию может быть определено легкой интроспекцией и установлено в общий вид «Debian» или «RHEL». В противном случае значение не определено.
- **PACK** - еще более удобный ярлык. Он читает переменную окружения `DISTR`, присваивает ее параметру **DISTR_BUILD** и далее работает как обычно. Это очень полезно при сборке в подготовленных системах сборки, например, в Docker-контейнерах, где переменная `DISTR` установлена на уровне системы и отражает целевую систему, для которой предназначен контейнер.
- **CMAKE_INSTALL_PREFIX** (путь) - где ожидается установка Manticore. Сборка не выполняет установку, но готовит правила установки, которые выполняются при запуске команды `cmake --install` или создании пакета и последующей его установке. Префикс можно менять в любое время, даже во время установки, вызвав
  `cmake --install . --prefix /path/to/installation`. Однако во время конфигурации эта переменная используется для инициализации значений по умолчанию для `LOCALDATADIR` и `FULL_SHARE_DIR`. Например, установка её в `/my/custom` во время конфигурации
  жестко задаст `LOCALDATADIR` как `/my/custom/var/lib/manticore/data`, а `FULL_SHARE_DIR` как
  `/my/custom/usr/share/manticore`.
- **BUILD_TESTING** (bool) поддержка тестирования. Если включено, после сборки вы можете запустить 'ctest' и проверить сборку. Обратите внимание, что тестирование предполагает дополнительные зависимости, такие как наличие PHP cli, Python и доступного сервера MySQL с тестовой базой данных. По умолчанию этот параметр включен. Поэтому для «просто сборки» вы, возможно, захотите отключить опцию, явно указав значение 'off'.
- **LIBS_BUNDLE** - путь к папке с различными библиотеками. В основном актуально для сборки в Windows, но может быть полезно, если приходится часто собирать, чтобы избежать повторного скачивания сторонних исходников. По умолчанию этот путь не меняется скриптом конфигурации; всё туда нужно помещать вручную. Например, для поддержки стеммера — исходники загружаются с сайта Snowball, затем распаковываются, настраиваются, строятся и так далее. Вместо этого вы можете хранить оригинальный архив исходников (например `libstemmer_c.tgz`) в этой папке. В следующий раз при сборке скрипт сначала проверит бандл, и если стеммер там найден, он не будет загружать его заново из интернета.
- **CACHEB** - путь к папке с сохранёнными сборками сторонних библиотек. Обычно такие компоненты, как galera, re2, icu и др. сначала загружаются или берутся из бандла, затем распаковываются, собираются и устанавливаются во временную внутреннюю папку. При сборке manticore эта папка используется как место, где находятся необходимые для поддержки требуемых функций сборки. В итоге они либо связываются с manticore (если это библиотека), либо идут напрямую в дистрибутив/установку (например, galera или icu data). Когда **CACHEB** задан как параметр конфигурации cmake или переменная окружения системы, она используется как целевая папка для этих сборок. Эту папку можно сохранять между сборками, чтобы уже собранные библиотеки не пересобирались, что значительно сокращает время сборки.


Обратите внимание, что некоторые параметры организованы в тройки: `WITH_XXX`, `DL_XXX` и `XXX_LIB` - как поддержка mysql, odbc и т.д. `WITH_XXX` определяет, имеют ли два следующих параметра эффект или нет. Т.е., если вы установите `WITH_ODBC` в `0` - нет смысла предоставлять `DL_ODBC` и `ODBC_LIB`, и эти два не будут иметь эффекта, если вся функция отключена. Кроме того, `XXX_LIB` не имеет смысла без `DL_XXX`, потому что если вы не хотите параметр `DL_XXX`, динамическая загрузка не будет использована, и имя, предоставленное `XXX_LIB`, бесполезно. Это используется по умолчанию для интроспекции.

Также, использование библиотеки `iconv` предполагает `expat` и является бесполезным, если последнее отключено.

Кроме того, некоторые библиотеки могут быть всегда доступны, и, следовательно, нет смысла избегать связи с ними. Например, в Windows это ODBC. На macOS это Expat, iconv и, возможно, другие. Интроспекция по умолчанию определяет такие библиотеки и эффективно выводит только `WITH_XXX` для них, без `DL_XXX` и `XXX_LIB`, что упрощает ситуацию.

При некоторых вариантах в игре конфигурация может выглядеть так:

```bash
mkdir build && cd build
cmake -DWITH_MYSQL=1 -DWITH_RE2=1 ..
```

Помимо общих значений конфигурации, вы также можете изучить файл `CMakeCache.txt`, который остается в папке сборки сразу после того, как вы запустите конфигурацию. Любые значения, определенные там, могут быть переопределены явно при запуске cmake. Например, вы можете выполнить `cmake -DHAVE_GETADDRINFO_A=FALSE ...`, и этот запуск конфигурации не будет учитывать исследуемое значение этой переменной, а будет использовать то, что вы предоставили.

#### Специфические переменные окружения

Переменные окружения полезны для предоставления некоторых глобальных настроек, которые хранятся отдельно от конфигурации сборки и всегда присутствуют. Для постоянства их можно задать глобально в системе различными способами - например, добавив их в файл `.bashrc`, или встроив их в Dockerfile, если вы создаете систему сборки на базе Docker, или написав их в системных настройках переменных окружения в Windows. Также вы можете установить их кратковременно, используя `export VAR=value` в оболочке. Или даже короче, добавив значения перед вызовом cmake, например, `CACHEB=/my/cache cmake ...` - таким образом, это будет работать только при этом вызове и не будет видно при следующем.

Некоторые из таких переменных известны как используемые в общем cmake и некоторых других инструментах. Это такие вещи, как `CXX`, который определяет текущий компилятор C++, или `CXX_FLAGS` для предоставления флагов компилятора и т.д.

Тем не менее, у нас есть некоторые переменные, специфичные для конфигурации Manticore, которые были придуманы исключительно для наших сборок.

- **CACHEB** - то же самое, что и опция конфигурации **CACHEB**
- **LIBS_BUNDLE** - то же самое, что и опция конфигурации **LIBS_BUNDLE**
- **DISTR** - используется для инициализации опции `DISTR_BUILD`, когда используется `-DPACK=1`.
- **DIAGNOSTIC** - делает вывод конфигурации cmake гораздо более подробным, объясняя все, что происходит
- **WRITEB** - предполагает **LIBS_BUNDLE** и, если установлено, будет загружать файлы исходных архивов для различных инструментов в папку LIBS_BUNDLE. То есть, если выходит свежая версия стеммера - вы можете вручную удалить libstemmer_c.tgz из пакета, а затем выполнить однократный `WRITEB=1 cmake ...` - он не найдет исходники стеммера в пакете и затем загрузит их с сайта поставщика в пакет (без WRITEB они будут загружены во временную папку внутри сборки и исчезнут, когда вы удалите папку сборки).

В конце конфигурации вы можете увидеть, что доступно и будет использовано в списке, как в этом:

```
-- Enabled features compiled in:
* Galera, replication of tables
* re2, a regular expression library
* stemmer, stemming library (Snowball)
* icu, International Components for Unicode
* OpenSSL, for encrypted networking
* ZLIB, for compressed data and networking
* ODBC, for indexing MSSQL (windows) and generic ODBC sources with indexer
* EXPAT, for indexing xmlpipe sources with indexer
* Iconv, for support of different encodings when indexing xmlpipe sources with indexer
* MySQL, for indexing MySQL sources with indexer
* PostgreSQL, for indexing PostgreSQL sources with indexer
```

### Сборка

```bash
cmake --build . --config RelWithDebInfo
```

### Установка

Для установки выполните:

```bash
cmake --install . --config RelWithDebInfo
```

чтобы установить в пользовательскую (не по умолчанию) папку, выполните

```bash
cmake --install . --prefix path/to/build --config RelWithDebInfo
```

### Сборка пакетов

Для сборки пакета используйте цель `package`. Она соберет пакет в соответствии с выбором, предоставленным с помощью опции `-DDISTR_BUILD`. По умолчанию это будет простой архив .zip или .tgz со всеми двоичными и вспомогательными файлами.

```bash
cmake --build . --target package --config RelWithDebInfo
```

## Некоторые продвинутые моменты о сборке

### Рекомпиляция (обновление) на одноконфигурации

Если вы не изменили путь к источникам и сборке, просто перейдите в свою папку сборки и выполните:

```bash
cmake .
cmake --build . --clean-first --config RelWithDebInfo
```

Если по какой-либо причине это не сработает, вы можете удалить файл `CMakeCache.txt`, расположенный в папке сборки. После этого шага вам
необходимо снова запустить cmake, указывая на папку с исходниками и настраивая параметры.

Если это также не поможет, просто очистите свою папку сборки и начните с нуля.

### Типы сборки

Кратко - просто используйте `--config RelWithDebInfo`, как написано выше. Это не вызовет ошибок.

Мы используем два типа сборки. Для разработки это `Debug` - он присваивает флаги компилятора для оптимизации и других вещей таким образом, что он очень удобен для разработки, что означает, что отладочные запуски выполняются с пошаговым выполнением. Однако сгенерированные двоичные файлы достаточно большие и медленные для производства.

Для релиза мы используем другой тип - `RelWithDebInfo` - что означает 'релизная сборка с отладочной информацией'. Он создает производственные двоичные файлы с встроенной отладочной информацией. Последняя затем разделяется на отдельные пакеты debuginfo, которые сохраняются отдельно от релизных пакетов и могут быть использованы в случае возникновения некоторых проблем, таких как сбои - для расследования и исправления ошибок. Cmake также предоставляет `Release` и `MinSizeRel`, но мы их не используем. Если тип сборки недоступен, cmake выполнит сборку `noconfig`.

#### Генераторы систем сборки

Существует два типа генераторов: одноконфигурационные и многоконфигурационные.

- Одноконфигурационные требуют, чтобы тип сборки был указан во время конфигурации через параметр `CMAKE_BUILD_TYPE`. Если он не определен, сборка вернется к типу `RelWithDebInfo`, который подходит, если вы просто хотите собрать Manticore из исходников и не участвовать в разработке. Для явных сборок вы должны указать тип сборки, например, `-DCMAKE_BUILD_TYPE=Debug`.
- Многоконфигурационные выбирают тип сборки во время сборки. Он должен быть указан с помощью опции `--config`, иначе будет собрано нечто вроде `noconfig`, что нежелательно. Поэтому вам всегда следует указывать тип сборки, например, `--config Debug`.

Если вы хотите указать тип сборки, но не хотите заботиться о том, является ли генератор 'single' или 'multi' конфигурации — просто предоставьте необходимые ключи в обоих местах. Т.е., сконфигурируйте с `-DCMAKE_BUILD_TYPE=Debug`, а затем собирайте с `--config Debug`. Главное, чтобы оба значения совпадали. Если целевой билд-системой является single-config, она примет параметр конфигурации. Если это multi-config, параметр конфигурации будет игнорироваться, но правильная конфигурация сборки будет выбрана с помощью ключа `--config`.

Если вам нужен `RelWithDebInfo` (т.е. просто сборка для производства) и вы знаете, что находитесь на платформе с single-config (то есть на всех, кроме Windows) — вы можете опустить флаг `--config` при вызове cmake. Тогда будет сконфигурирована и использована конфигурация по умолчанию `CMAKE_BUILD_TYPE=RelWithDebInfo`. Все команды для 'сборки', 'установки' и 'пакетирования' станут короче.

#### Явный выбор генераторов систем сборки

Cmake — это инструмент, который сам по себе не выполняет сборку, а генерирует правила для локальной системы сборки.
Обычно он хорошо определяет доступную систему сборки, но иногда вам нужно явно указать генератор. Вы
можете запустить `cmake -G` и просмотреть список доступных генераторов.

- На Windows, если у вас установлено несколько версий Visual Studio, возможно, потребуется указать, какую использовать,
например:
```bash
cmake -G "Visual Studio 16 2019" ....
  ```
- On all other platforms - usually Unix Makefiles are used, but you can specify another one, such as Ninja, or Ninja Multi-Config, as:
  Multi-Config`, as:
```bash
  cmake -GNinja ...
  ```
  или
```bash
  cmake -G"Ninja Multi-Config" ...
```
Ninja Multi-Config достаточно полезен, так как он действительно 'multi-config' и доступен на Linux/macOS/BSD. С этим генератором вы можете отложить выбор типа конфигурации до времени сборки, а также можете собрать несколько конфигураций в одной и той же папке сборки, меняя только параметр `--config`.

### Предупреждения

1. Если вы хотите в итоге собрать полнофункциональный RPM-пакет, путь к папке сборки должен быть достаточно длинным для корректного формирования отладочной информации.
Например, `/manticore012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789`. Это связано с тем, что инструменты RPM модифицируют путь к скомпилированным бинарникам при построении отладочной информации, и они могут просто перезаписать доступное место, не выделив больше. Указанный длинный путь содержит 100 символов, чего достаточно для такой ситуации.

## Внешние зависимости

Некоторые библиотеки должны быть доступны, если вы хотите их использовать.
- Для индексирования (инструмент `indexer`): `expat`, `iconv`, `mysql`, `odbc`, `postgresql`. Без них вы сможете обрабатывать только источники формата `tsv` и `csv`.
- Для обслуживания запросов (демон `searchd`): возможно потребуется `openssl`.
- Для всего (обязательно!) нужна библиотека Boost. Минимальная версия — 1.61.0, однако мы собираем бинарники с более свежей версией 1.75.0. Даже более новые версии (например, 1.76) тоже должны быть приемлемы. На Windows вы можете скачать предсобранный Boost с их сайта (boost.org) и установить его в путь по умолчанию (т.е. `C:\\boost...`). На MacOs подойдет версия из brew. На Linux вы можете проверить доступную версию в официальных репозиториях, и если она не соответствует требованиям, собрать из исходников. Нам нужен компонент 'context', вы также можете собрать компоненты 'system' и 'program_options', они понадобятся, если вы хотите также собрать библиотеку Galera из исходников. Посмотрите в `dist/build_dockers/xxx/boost_175/Dockerfile` для краткого самодокументируемого скрипта/инструкции по сборке.

На системе сборки должны быть установлены 'dev' или 'devel' версии этих пакетов (т.е. - libmysqlclient-devel, unixodbc-devel и т.п. Смотрите наши docker-файлы для названий конкретных пакетов).

На системах выполнения эти пакеты должны присутствовать хотя бы в финальных (не dev) вариантах. (devel варианты обычно больше, так как включают не только бинарные файлы, но и различные инструменты для разработки, заголовочные файлы и т.п.).

### Сборка на Windows

Помимо необходимых предусловий, вам могут понадобиться предсобранные клиентские библиотеки `expat`, `iconv`, `mysql` и `postgresql`. Вам нужно либо собрать их самостоятельно, либо связаться с нами, чтобы получить наш сборочный пакет (простой zip-архив, в котором есть папка с этими целями).

- ODBC не обязателен, так как это системная библиотека.
- OpenSSL можно собрать из исходников или скачать предсобранный с https://slproweb.com/products/Win32OpenSSL.html (как упомянуто во внутреннем скрипте cmake FindOpenSSL).
- Boost можно скачать предсобранный с https://www.boost.org/ releases.

### Узнать, что собрано

Запустите `indexer -h`. Он покажет, какие функции были сконфигурированы и собраны (явно или исследовано, не важно):

```
Built on Linux x86_64 by GNU 8.3.1 compiler.

Configured with these definitions: -DDISTR_BUILD=rhel8 -DUSE_SYSLOG=1 -DWITH_GALERA=1 -DWITH_RE2=1 -DWITH_RE2_FORCE_STATIC=1
-DWITH_STEMMER=1 -DWITH_STEMMER_FORCE_STATIC=1 -DWITH_ICU=1 -DWITH_ICU_FORCE_STATIC=1 -DWITH_SSL=1 -DWITH_ZLIB=1 -DWITH_ODBC=1 -DDL_ODBC=1
-DODBC_LIB=libodbc.so.2 -DWITH_EXPAT=1 -DDL_EXPAT=1 -DEXPAT_LIB=libexpat.so.1 -DWITH_ICONV=1 -DWITH_MYSQL=1 -DDL_MYSQL=1
-DMYSQL_LIB=libmariadb.so.3 -DWITH_POSTGRESQL=1 -DDL_POSTGRESQL=1 -DPOSTGRESQL_LIB=libpq.so.5 -DLOCALDATADIR=/var/lib/manticore/data
-DFULL_SHARE_DIR=/usr/share/manticore
```
<!-- proofread -->

