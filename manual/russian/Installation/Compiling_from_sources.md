# Компиляция Manticore из исходников

Компиляция Manticore Search из исходных кодов позволяет использовать кастомные конфигурации сборки, такие как отключение определённых функций или добавление новых патчей для тестирования. Например, вы можете захотеть скомпилировать из исходников и отключить встроенный ICU, чтобы использовать другую версию, установленную в вашей системе, которую можно обновлять отдельно от Manticore. Это также полезно, если вы хотите внести вклад в проект Manticore Search.

## Сборка с использованием CI Docker
Для подготовки [официальных релизных и девелоперских пакетов](https://repo.manticoresearch.com/) мы используем Docker и специальный образ для сборки. Этот образ включает необходимые инструменты и предназначен для использования с внешними sysroots, так что один контейнер может собирать пакеты для всех операционных систем. Вы можете собрать образ, используя [Dockerfile](https://github.com/manticoresoftware/manticoresearch/blob/master/dist/build_dockers/cross/external_toolchain/Dockerfile) и [README](https://github.com/manticoresoftware/manticoresearch/blob/master/dist/build_dockers/README.md) или использовать образ с [Docker Hub](https://hub.docker.com/r/manticoresearch/external_toolchain/tags). Это самый простой способ создать бинарники для любой поддерживаемой операционной системы и архитектуры. При запуске контейнера также нужно указать следующие переменные окружения:

* `DISTR`: целевая платформа: `bionic`, `focal`, `jammy`, `buster`, `bullseye`, `bookworm`, `rhel7`, `rhel8`, `rhel9`, `macos`, `windows`, `freebsd13`
* `arch`: архитектура: `x86_64`, `x64` (для Windows), `aarch64`, `arm64` (для Macos)
* `SYSROOT_URL`: URL архивов системных корней. Вы можете использовать https://repo.manticoresearch.com/repository/sysroots, если не собираете sysroots самостоятельно (инструкции можно найти [здесь](https://github.com/manticoresoftware/manticoresearch/tree/master/dist/build_dockers/cross/sysroots)).
* Используйте файлы CI workflow в качестве примера для поиска других переменных окружения, которые вам могут понадобиться:
  - https://github.com/manticoresoftware/manticoresearch/blob/master/.github/workflows/pack_publish.yml
  - https://github.com/manticoresoftware/manticoresearch/blob/master/.github/workflows/build_template.yml

Чтобы узнать возможные значения для `DISTR` и `arch`, вы можете использовать в качестве примера директорию https://repo.manticoresearch.com/repository/sysroots/roots_with_zstd/, так как она включает sysroots для всех поддерживаемых комбинаций.

После этого сборка пакетов внутри Docker-контейнера сводится к вызову:

```bash
cmake -DPACK=1 /path/to/sources
cmake --build .
```

Например, чтобы создать пакет для Ubuntu Jammy, схожий с официальной версией от команды Manticore Core Team, выполните следующие команды в директории с исходниками Manticore Search. Эта директория — корень клонированного репозитория с https://github.com/manticoresoftware/manticoresearch:

```bash
docker run -it --rm \
-e CACHEB="../cache" \
-e DIAGNOSTIC=1 \
-e PACK_ICUDATA=0 \
-e NO_TESTS=1 \
-e DISTR=jammy \
-e boost=boost_nov22 \
-e sysroot=roots_nov22 \
-e arch=x86_64 \
-e CTEST_CMAKE_GENERATOR=Ninja \
-e CTEST_CONFIGURATION_TYPE=RelWithDebInfo \
-e WITH_COVERAGE=0 \
-e SYSROOT_URL="https://repo.manticoresearch.com/repository/sysroots" \
-e HOMEBREW_PREFIX="" \
-e PACK_GALERA=0 \
-e UNITY_BUILD=1 \
-v $(pwd):/manticore_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa \
manticoresearch/external_toolchain:vcpkg331_20250114 bash

# following is to be run inside docker shell
cd /manticore_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/
mkdir build && cd build
cmake -DPACK=1 ..
export CMAKE_TOOLCHAIN_FILE=$(pwd)/dist/build_dockers/cross/linux.cmake
cmake --build .
# or if you want to build packages:
# cmake --build . --target package
```
Требуется полный путь к исходной директории, иначе в некоторых случаях (например, Centos) сборка исходников может потерпеть неудачу.

Аналогичным образом можно собирать бинарники и пакеты не только для популярных дистрибутивов Linux, но и для FreeBSD, Windows и macOS.

## Ручная сборка

Компиляция Manticore без использования Docker для сборки **не рекомендуется**, но если вам нужно это сделать, вот что может быть полезно знать:

### Необходимые инструменты

* Компилятор C++
  * В Linux — можно использовать GNU (версии 4.7.2 и выше) или Clang
  * В Windows — Microsoft Visual Studio 2019 и выше (достаточно community edition)
  * В macOS — Clang (из командных инструментов XCode, для установки используйте `xcode-select --install`).
* Bison, Flex — в большинстве систем они доступны в виде пакетов, в Windows доступны в среде cygwin.
* Cmake — используется на всех платформах (требуется версия 3.19 или выше)

### Получение исходников

#### Из git

Исходный код Manticore размещён на [GitHub](https://github.com/manticoresoftware/manticoresearch).
Чтобы получить исходный код, клонируйте репозиторий и переключитесь на нужную ветку или тег. Ветка `master` представляет основную ветку разработки. При релизе создаётся версионированный тег, например `3.6.0`, и начинается новая ветка для текущего релиза, в данном случае `manticore-3.6.0`. Голова ветки с версией после всех изменений используется в качестве источника для сборки всех бинарных релизов. Например, чтобы взять исходники версии 3.6.0, выполните:

```bash
git clone https://github.com/manticoresoftware/manticoresearch.git
cd manticoresearch
git checkout manticore-3.6.0
```

#### Из архива

Вы можете скачать нужный код с GitHub, используя кнопку "Download ZIP". Подходят оба формата: .zip и .tar.gz.

```bash
wget -c https://github.com/manticoresoftware/manticoresearch/archive/refs/tags/3.6.0.tar.gz
tar -zxf 3.6.0.tar.gz
cd manticoresearch-3.6.0
```

### Конфигурация

Manticore использует CMake. Предполагается, что вы находитесь в корневой директории клонированного репозитория:

```bash
mkdir build && cd build
cmake ..
```

CMake исследует доступные функции и сконфигурирует сборку в соответствии с ними. По умолчанию все функции считаются включёнными, если они доступны. Скрипт также скачивает и собирает некоторые внешние библиотеки, предполагая, что вы хотите их использовать. Таким образом, вы получаете поддержку максимального количества функций.

Также вы можете явно конфигурировать сборку с помощью флагов и опций. Чтобы включить функцию `FOO`, добавьте `-DFOO=1` к вызову CMake.
Чтобы отключить, используйте `-DFOO=0`. Если явно не указано и функция недоступна (например, `WITH_GALERA` в сборке для MS Windows), попытка включения вызовет ошибку конфигурации. Отключение функции, помимо исключения из сборки, также отключает проверку её наличия в системе и загрузку/сборку связанных внешних библиотек.

#### Флаги и опции конфигурации

- **USE_SYSLOG** — позволяет использовать `syslog` в [логе запросов](../Logging/Query_logging.md).
- **WITH_GALERA** - Включает поддержку репликации на демон поиска. Поддержка будет настроена для сборки, и источники для библиотеки Galera будут загружены, собраны и включены в дистрибуцию/установку. Обычно безопасно собирать с Galera, но не distributing the library itself (так что нет модуля Galera, нет репликации). Однако иногда вам может понадобиться явно отключить это, например, если вы хотите собрать статический бинарный файл, который по дизайну не может загружать никакие библиотеки, так что даже наличие вызова функции 'dlopen' внутри демона вызовет ошибку линковки.
- **WITH_RE2** - Собирает с использованием библиотеки регулярных выражений RE2. Это необходимо для таких функций, как [REGEX()](../Functions/String_functions.md#REGEX%28%29), и [regexp_filter](../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#regexp_filter)
  функция.
- **WITH_RE2_FORCE_STATIC** - Загружает источники RE2, компилирует их и статически связывает, так что финальные бинарные файлы не будут зависеть от наличия общей библиотеки `RE2` в вашей системе.
- **WITH_STEMMER** - Собирает с использованием библиотеки стемминга Snowball.
- **WITH_STEMMER_FORCE_STATIC** - Загружает источники Snowball, компилирует их и статически связывает, так что финальные бинарные файлы не будут зависеть от наличия общей библиотеки `libstemmer` в вашей системе.
- **WITH_ICU** - Собирает с библиотекой ICU (International Components for Unicode). Она используется для сегментации китайского текста. Она используется, когда morphology=`icu_chinese` используется.
- **WITH_JIEBA** - Собирает с инструментом сегментации китайского текста Jieba. Она используется для сегментации китайского текста. Она используется, когда morphology=`jieba_chinese` используется.
- **WITH_ICU_FORCE_STATIC** - Загружает источники ICU, компилирует их и статически связывает, так что финальные бинарные файлы не будут зависеть от наличия общей библиотеки `icu` в вашей системе. Также включает файл данных ICU в установку/дистрибуцию. Цель статически связанной ICU - иметь библиотеку известной версии, так что поведение определено и не зависит от каких-либо системных библиотек. Вы, скорее всего, предпочтете использовать системную ICU, так как она может обновляться со временем без необходимости повторной компиляции демона Manticore. В этом случае вам нужно будет явно отключить эту опцию. Это также сэкономит место, занимаемое файлом данных ICU (около 30M), так как он не будет включен в дистрибуцию.
- **WITH_SSL** - Используется для поддержки HTTPS, а также зашифрованных соединений MySQL с демоном. Системная библиотека OpenSSL будет связана с демоном. Это подразумевает, что OpenSSL будет необходим для запуска демона. Это обязательно для поддержки HTTPS, но не строго обязательно для сервера (т.е. отсутствие SSL означает отсутствие возможности подключения через HTTPS, но другие протоколы будут работать). Версии библиотеки SSL, начиная с 1.0.2 до 1.1.1, могут быть использованы Manticore, однако обратите внимание, что **в целях безопасности настоятельно рекомендуется использовать самую свежую возможную библиотеку SSL
  библиотеку**. На данный момент поддерживается только версия v1.1.1, остальные устарели (
  смотрите [стратегию релиза openssl](https://www.openssl.org/policies/releasestrat.html)
- **WITH_ZLIB** - используется индексатором для работы с сжатыми колонками из MySQL. Используется демоном для поддержки сжатого протокола MySQL.
- **WITH_ODBC** - используется индексатором для поддержки индексирования источников от ODBC-поставщиков (обычно это UnixODBC и iODBC). На MS Windows ODBC является правильным способом работы с источниками MS SQL, поэтому индексирование `MSSQL` также подразумевает этот флаг.
- **DL_ODBC** - не связывать с библиотекой ODBC. Если ODBC связан, но недоступен, вы не можете запустить инструмент индексирования, даже если хотите обработать что-то, не связанное с ODBC. Эта опция заставляет индексатор загружать библиотеку во время выполнения только тогда, когда вы хотите работать с источником ODBC.
- **ODBC_LIB** - имя файла библиотеки ODBC. Индексатор попытается загрузить этот файл, когда вы захотите обработать источник ODBC. Эта опция автоматически записывается на основе доступного исследования общей библиотеки ODBC. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения `ODBC_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_EXPAT** - используется индексатором для поддержки индексирования источников xmlpipe.
- **DL_EXPAT** - не связывать с библиотекой EXPAT. Если EXPAT связан, но недоступен, вы не можете запустить инструмент `indexer`, даже если хотите обработать что-то, не связанное с xmlpipe. Эта опция заставляет индексатор загружать библиотеку во время выполнения только тогда, когда вы хотите работать с источником xmlpipe.
- **EXPAT_LIB** - имя файла библиотеки EXPAT. Индексатор попытается загрузить этот файл, когда вы захотите обработать источник xmlpipe. Эта опция автоматически записывается на основе доступного исследования общей библиотеки EXPAT. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения EXPAT_LIB с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_ICONV** - для поддержки различных кодировок при индексировании источников xmlpipe с индексатором.
- **DL_ICONV** - не связывать с библиотекой iconv. Если iconv связан, но недоступен, вы не можете запустить инструмент `indexer`, даже если хотите обработать что-то, не связанное с xmlpipe. Эта опция заставляет индексатор загружать библиотеку во время выполнения только тогда, когда вы хотите работать с источником xmlpipe.
- **ICONV_LIB** - имя файла библиотеки iconv. Индексатор попытается загрузить этот файл, когда вы захотите обработать источник xmlpipe. Эта опция автоматически записывается на основе доступного исследования общей библиотеки iconv. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения `ICONV_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_MYSQL** - используется индексатором для поддержки индексирования источников MySQL.
- **DL_MYSQL** - не связывайтесь с библиотекой MySQL. Если MySQL связан, но недоступен, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не относящееся к MySQL. Этот параметр запрашивает у индексатора загрузку библиотеки во время выполнения только тогда, когда вы хотите работать с источником MySQL.
- **MYSQL_LIB** -- имя файла библиотеки MySQL. Индексатор попытается загрузить этот файл, когда вы захотите обработать источник MySQL. Этот параметр автоматически заполняется на основе доступного исследования совместимой библиотеки MySQL. Вы также можете переопределить это имя во время выполнения, предоставив переменную окружения `MYSQL_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **WITH_POSTGRESQL** - используется индексатором для поддержки индексации источников PostgreSQL.
- **DL_POSTGRESQL** - не связывайтесь с библиотекой PostgreSQL. Если PostgreSQL связан, но недоступен, вы не сможете запустить инструмент `indexer`, даже если хотите обработать что-то, не относящееся к PostgreSQL. Этот параметр запрашивает у индексатора загрузку библиотеки во время выполнения только тогда, когда вы хотите работать с источником PostgreSQL.
- **POSTGRESQL_LIB** - имя файла библиотеки PostgreSQL. Индексатор попытается загрузить указанный файл библиотеки PostgreSQL при обработке источника PostgreSQL. Этот параметр автоматически определяется на основе доступного исследования совместимой библиотеки PostgreSQL. Вы также можете переопределить имя во время выполнения, предоставив переменную окружения `POSTGRESQL_LIB` с правильным путем к альтернативной библиотеке перед запуском индексатора.
- **LOCALDATADIR** - путь по умолчанию, где демон хранит binlogs. Если этот путь не указан или явно отключен в конфигурации времени выполнения демона (т.е. в файле `manticore.conf`, который не связан с этой конфигурацией сборки), binlogs будут размещены в этом пути. Обычно это абсолютный путь, однако он не обязательно должен быть таким, также можно использовать относительные пути. Вам, вероятно, не нужно менять значение по умолчанию, определенное в конфигурации, которое, в зависимости от целевой системы, может быть чем-то вроде `/var/data`, `/var/lib/manticore/data` или `/usr/local/var/lib/manticore/data`.
- **FULL_SHARE_DIR** - путь по умолчанию, где хранятся все активы. Его можно переопределить переменной окружения `FULL_SHARE_DIR` перед запуском любого инструмента, который использует файлы из этой папки. Это важный путь, так как многие вещи ожидаются там по умолчанию. К ним относятся предварительно определенные таблицы символов, стоп-слова, модули manticore и файлы данных icu, все размещенные в этой папке. Скрипт конфигурации обычно определяет этот путь как что-то вроде `/usr/share/manticore` или `/usr/local/share/manticore`.
- **DISTR_BUILD** - сокращение для параметров выпуска пакетов. Это строковое значение с названием целевой платформы. Его можно использовать вместо ручной настройки всех параметров. На Debian и Redhat Linux значение по умолчанию может быть определено путём легкой интроспекции и установлено как общее 'Debian' или 'RHEL'. В противном случае значение не определено.
- **PACK** - ещё более удобное сокращение. Оно считывает переменную окружения `DISTR`, присваивает её параметру **DISTR_BUILD** и затем работает как обычно. Это очень полезно при сборке в подготовленных системах сборки, таких как контейнеры Docker, где переменная `DISTR` устанавливается на уровне системы и отражает целевую систему, для которой предназначен контейнер.
- **CMAKE_INSTALL_PREFIX** (путь) - где ожидается установка Manticore. Сборка не выполняет никаких установок, но она подготавливает правила установки, которые выполняются, когда вы запускаете команду `cmake --install` или создаете пакет, а затем устанавливаете его. Префикс может быть изменен в любое время, даже во время установки, вызвав
  `cmake --install . --prefix /path/to/installation`. Однако во время конфигурации эта переменная используется для инициализации значений по умолчанию `LOCALDATADIR` и `FULL_SHARE_DIR`. Например, установка его на `/my/custom` во время конфигурации
  зафиксирует `LOCALDATADIR` как `/my/custom/var/lib/manticore/data`, и `FULL_SHARE_DIR` как
  `/my/custom/usr/share/manticore`.
- **BUILD_TESTING** (bool) поддерживать ли тестирование. Если включено, после сборки вы можете запустить 'ctest' и протестировать сборку. Обратите внимание, что тестирование подразумевает дополнительные зависимости, такие как наличие PHP cli, Python и доступного сервера MySQL с тестовой базой данных. По умолчанию этот параметр включен. Поэтому для 'просто сборки' вы можете отключить опцию, явно указав значение 'off'.
- **LIBS_BUNDLE** - путь к папке с различными библиотеками. Это наиболее актуально для сборки под Windows, но может быть полезно, если вам приходится часто собирать, чтобы избежать загрузки сторонних источников каждый раз. По умолчанию этот путь никогда не изменяется скриптом конфигурации; вам следует помещать все туда вручную. Когда, скажем, нам нужна поддержка стеммера - источники будут загружены с домашней страницы Snowball, затем извлечены, настроены, собраны и т.д. Вместо этого вы можете сохранить оригинальный архив источника (который `libstemmer_c.tgz`) в этой папке. В следующий раз, когда вы захотите собрать с нуля, скрипт конфигурации сначала проверит наличие в пакете, и если он найдёт стеммер там, он не будет загружать его снова из Интернета.
- **CACHEB** - путь к папке со хранимыми сборками сторонних библиотек. Обычно такие функции, как galera, re2, icu и т.д. сначала загружаются или получаются из пакета, затем распаковываются, собираются и устанавливаются во временную внутреннюю папку. При сборке manticore эта папка затем используется как место, где находятся необходимые вещи для поддержки запрашиваемой функции. Наконец, они либо связываются с manticore, если это библиотека; либо идут прямо в распределение/установку (такие как galera или данные icu). Когда **CACHEB** определяется либо как параметр конфигурации cmake, либо как системная переменная окружения, он используется в качестве целевой папки для этих сборок. Эта папка может сохраняться между сборками, так что хранимые библиотеки там больше не будут собираться заново, что значительно сокращает весь процесс сборки.


Обратите внимание, что некоторые параметры организованы в тройки: `WITH_XXX`, `DL_XXX` и `XXX_LIB` - например, поддержка mysql, odbc и т.д. `WITH_XXX` определяет, повлияют ли следующие два или нет. То есть, если вы установите `WITH_ODBC` в `0`, нет смысла предоставлять `DL_ODBC` и `ODBC_LIB`, и эти два не будут иметь никакого эффекта, если вся функция отключена. Также `XXX_LIB` не имеет смысла без `DL_XXX`, потому что если вы не хотите параметр `DL_XXX`, динамическая загрузка не будет использоваться, и имя, предоставленное `XXX_LIB`, бесполезно. Это используется по умолчанию для интроспекции.

Кроме того, использование библиотеки `iconv` предполагает наличие `expat` и бесполезно, если последняя отключена.

Также некоторые библиотеки могут быть всегда доступными, и поэтому нет смысла избегать связывания с ними. Например, в Windows это ODBC. На macOS это Expat, iconv и, возможно, другие. Интроспекция по умолчанию определяет такие библиотеки и эффективно излучает только `WITH_XXX` для них, без `DL_XXX` и `XXX_LIB`, что упрощает дело.

С некоторыми параметрами в конфигурации игры это может выглядеть так:

```bash
mkdir build && cd build
cmake -DWITH_MYSQL=1 -DWITH_RE2=1 ..
```

Кроме общих значений конфигурации, вы также можете изучить файл `CMakeCache.txt`, который остается в папке сборки сразу после того, как вы запустите конфигурацию. Любые значения, определенные там, могут быть переопределены явно при запуске cmake. Например, вы можете запустить `cmake -DHAVE_GETADDRINFO_A=FALSE ...`, и эта конфигурация не будет учитывать исследованное значение этой переменной, но будет использовать то, что вы предоставили.

#### Специфические переменные окружения

Переменные окружения полезны для предоставления какой-то глобальной настройки, которые хранятся отдельно от конфигурации сборки и всегда присутствуют. Для сохранности их можно установить глобально в системе разными способами - например, добавив их в файл `.bashrc`, или встроив их в Dockerfile, если вы создаете систему сборки на основе Docker, или указав их в системных переменных окружения в Windows. Также вы можете установить их на короткий срок, используя `export VAR=value` в оболочке. Или даже короче, добавив значения к вызову cmake, например, `CACHEB=/my/cache cmake ...` - таким образом это будет работать только для этого вызова и не будет видно в следующем.

Некоторые из таких переменных известны тем, что используются в общем для cmake и некоторых других инструментов. Это такие вещи, как `CXX`, которая определяет текущий компилятор C++, или `CXX_FLAGS`, чтобы предоставить флаги компилятора и т.д.

Однако у нас есть некоторые переменные, которые специфичны для конфигурации manticore, которые были придуманы исключительно для наших сборок.

- **CACHEB** - то же самое, что параметр конфигурации **CACHEB**
- **LIBS_BUNDLE** - то же самое, что параметр конфигурации **LIBS_BUNDLE**
- **DISTR** - используется для инициализации параметра `DISTR_BUILD`, когда используется `-DPACK=1`.
- **DIAGNOSTIC** - делает вывод конфигурации cmake гораздо более подробным, объясняя все происходящее
- **WRITEB** - предполагает **LIBS_BUNDLE** и, если установлено, будет загружать архивы исходных файлов для различных инструментов в папку LIBS_BUNDLE. То есть, если появляется свежая версия стеммера - вы можете вручную удалить libstemmer_c.tgz из пакета и затем запустить одноразовый `WRITEB=1 cmake ...` - она не найдет источники стеммера в пакете и затем загрузит их с сайта поставщика в пакет (без WRITEB они будут загружены во временную папку внутри сборки и исчезнут, когда вы очистите папку сборки).

В конце конфигурации вы можете увидеть, что доступно и будет использоваться в списке, подобном этому:

```
-- Enabled features compiled in:
* Galera, replication of tables
* re2, a regular expression library
* stemmer, stemming library (Snowball)
* icu, International Components for Unicode
* OpenSSL, for encrypted networking
* ZLIB, for compressed data and networking
* ODBC, for indexing MSSQL (windows) and generic ODBC sources with indexer
* EXPAT, for indexing xmlpipe sources with indexer
* Iconv, for support of different encodings when indexing xmlpipe sources with indexer
* MySQL, for indexing MySQL sources with indexer
* PostgreSQL, for indexing PostgreSQL sources with indexer
```

### Сборка

```bash
cmake --build . --config RelWithDebInfo
```

### Установка

Чтобы установить, выполните:

```bash
cmake --install . --config RelWithDebInfo
```

чтобы установить в пользовательскую (не по умолчанию) папку, выполните

```bash
cmake --install . --prefix path/to/build --config RelWithDebInfo
```

### Сборка пакетов

Для сборки пакета используйте цель `package`. Это построит пакет в соответствии с выбором, предоставленным с помощью параметра `-DDISTR_BUILD`. По умолчанию это будет простой архив .zip или .tgz со всеми бинарными файлами и вспомогательными файлами.

```bash
cmake --build . --target package --config RelWithDebInfo
```

## Некоторые продвинутые вещи о сборке

### Рекомпиляция (обновление) на однофайловой конфигурации

Если вы не изменили путь к исходникам и сборке, просто перейдите в свою папку сборки и выполните:

```bash
cmake .
cmake --build . --clean-first --config RelWithDebInfo
```

Если по какой-либо причине это не сработает, вы можете удалить файл `CMakeCache.txt`, расположенный в папке сборки. После этого шага вам
нужно снова запустить cmake, указав папку с исходниками и конфигурировав параметры.

Если это тоже не поможет, просто очистите вашу папку сборки и начните с нуля.

### Типы сборки

Кратко - просто используйте `--config RelWithDebInfo`, как написано выше. Это не вызовет ошибки.

Мы используем два типа сборки. Для разработки это `Debug` - он присваивает флаги компилятора для оптимизации и других вещей так, что это очень удобно для разработки, что означает, что отладочные запуски проходят с поэтапным выполнением. Однако производимые бинарные файлы довольно большие и медленные для производства.

Для выпуска мы используем другой тип - `RelWithDebInfo` - что означает 'релизная сборка с отладочной информацией'. Она производит бинарные файлы для производства с встроенной отладочной информацией. Последняя затем отделяется в отдельные пакеты debuginfo, которые хранятся отдельно от релизных пакетов и могут быть использованы в случае каких-либо проблем, таких как сбои - для расследования и устранения ошибок. Cmake также предоставляет `Release` и `MinSizeRel`, но мы их не используем. Если тип сборки недоступен, cmake создаст сборку `noconfig`.

#### Генераторы систем сборки

Существует два типа генераторов: однофайловые и многопараметрические.

- Однофайловые требуют, чтобы тип сборки был указан во время конфигурации, через параметр `CMAKE_BUILD_TYPE`. Если он не определен, сборка вернется к типу `RelWithDebInfo`, который подходит, если вы просто хотите собрать Manticore из источников и не участвовать в разработке. Для явных сборок вы должны указать тип сборки, например, `-DCMAKE_BUILD_TYPE=Debug`.
- Многопараметрические выбирают тип сборки во время сборки. Он должен быть указан с помощью параметра `--config`, в противном случае будет собрана своего рода `noconfig`, что нежелательно. Поэтому всегда следует указывать тип сборки, например, `--config Debug`.

Если вы хотите указать тип сборки, но не хотите заботиться о том, является ли генератор одноконфигурационным или многоконфигурационным — просто укажите необходимые ключи в обоих местах. Т.е. настройте с помощью `-DCMAKE_BUILD_TYPE=Debug`, а затем собирайте с помощью `--config Debug`. Просто убедитесь, что оба значения совпадают. Если сборщик одноконфигурационный, он учтёт параметр конфигурации. Если же он многоконфигурационный, параметр конфигурации будет проигнорирован, но правильная конфигурация сборки будет выбрана по ключу `--config`.

Если вам нужна конфигурация `RelWithDebInfo` (т.е. просто сборка для продакшена) и вы уверены, что платформа одноконфигурационная (то есть все, кроме Windows) — вы можете опустить флаг `--config` при вызове cmake. Тогда будет сконфигурирована и использована конфигурация по умолчанию `CMAKE_BUILD_TYPE=RelWithDebInfo`. Все команды для «сборки», «установки» и «сборки пакета» при этом станут короче.

#### Явный выбор генераторов системы сборки

Cmake — это инструмент, который сам по себе не выполняет сборку, но генерирует правила для локальной системы сборки.
Обычно он хорошо определяет доступную систему сборки, но иногда может потребоваться явное указание генератора. Вы
можете запустить `cmake -G` и просмотреть список доступных генераторов.

- В Windows, если у вас установлено несколько версий Visual Studio, возможно, понадобится указать, какую из них использовать,
например:
```bash
cmake -G "Visual Studio 16 2019" ....
  ```
- On all other platforms - usually Unix Makefiles are used, but you can specify another one, such as Ninja, or Ninja Multi-Config, as:
  Multi-Config`, as:
```bash
  cmake -GNinja ...
  ```
  или
```bash
  cmake -G"Ninja Multi-Config" ...
```
Ninja Multi-Config весьма полезен, так как действительно является «многоконфигурационным» и доступен на Linux/macOS/BSD. С этим генератором вы можете отложить выбор типа конфигурации на время сборки, а также собирать несколько конфигураций в одной и той же папке сборки, меняя только параметр `--config`.

### Особенности

1. Если вы хотите в итоге собрать полнофункциональный RPM-пакет, путь к директории сборки должен быть достаточно длинным для корректной генерации отладочной информации.
Например, `/manticore012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789`. Это связано с тем, что инструменты RPM меняют путь над скомпилированными бинарниками при создании отладочной информации, и они могут просто записать поверх уже имеющегося места, не выделяя больше. Указанный длинный путь содержит 100 символов, что вполне достаточно для такого случая.

## Внешние зависимости

Некоторые библиотеки должны быть доступны, если вы хотите их использовать.
- Для индексирования (инструмент `indexer`): `expat`, `iconv`, `mysql`, `odbc`, `postgresql`. Без них можно обрабатывать только источники `tsv` и `csv`.
- Для обслуживания запросов (демон `searchd`): возможно, потребуется `openssl`.
- Для всего (обязательно, обязательно!) нужна библиотека Boost. Минимальная версия — 1.61.0, однако мы собираем бинарники с более свежей версией 1.75.0. Ещё более новые версии (например, 1.76) тоже подойдут. На Windows вы можете скачать предсобранный Boost с их сайта (boost.org) и установить его в путь по умолчанию (например, `C:\\boost...`). На MacOS версия из brew подходит. На Linux вы можете проверить доступную версию в официальных репозиториях, и если она не соответствует требованиям, собрать из исходников. Нам нужен компонент 'context', можно также собрать компоненты 'system' и 'program_options', они потребуются, если вы хотите также собрать библиотеку Galera из исходников. Посмотрите в `dist/build_dockers/xxx/boost_175/Dockerfile` короткий самодокументируемый скрипт/инструкцию, как это сделать.

На системе сборки у вас должны быть установлены 'dev' или 'devel' версии этих пакетов (например, libmysqlclient-devel, unixodbc-devel и т.д. Смотрите наши dockerfiles для названий конкретных пакетов).

В системах запуска эти пакеты должны присутствовать как минимум в финальных (не dev) вариантах. (devel версии обычно больше, так как включают не только целевые бинарники, но и различные пакетные материалы для разработки, например include-заголовки и пр.).

### Сборка на Windows

Помимо необходимых предварительных условий, вам могут понадобиться предсобранные библиотеки клиентов `expat`, `iconv`, `mysql` и `postgresql`. Вам придётся либо собрать их самостоятельно, либо связаться с нами, чтобы получить наш сборочный пакет (простой zip-архив, в котором расположена папка с этими целями).

- ODBC не нужен, так как это системная библиотека.
- OpenSSL можно собрать из исходников или скачать предсобранный с https://slproweb.com/products/Win32OpenSSL.html (как упомянуто во внутреннем скрипте cmake на FindOpenSSL).
- Boost можно скачать предсобранным с https://www.boost.org/ releases.

### Посмотреть, что собрано

Запустите `indexer -h`. Он покажет, какие функции были сконфигурированы и собраны (явные или исследованные — без разницы):

```
Built on Linux x86_64 by GNU 8.3.1 compiler.

Configured with these definitions: -DDISTR_BUILD=rhel8 -DUSE_SYSLOG=1 -DWITH_GALERA=1 -DWITH_RE2=1 -DWITH_RE2_FORCE_STATIC=1
-DWITH_STEMMER=1 -DWITH_STEMMER_FORCE_STATIC=1 -DWITH_ICU=1 -DWITH_ICU_FORCE_STATIC=1 -DWITH_SSL=1 -DWITH_ZLIB=1 -DWITH_ODBC=1 -DDL_ODBC=1
-DODBC_LIB=libodbc.so.2 -DWITH_EXPAT=1 -DDL_EXPAT=1 -DEXPAT_LIB=libexpat.so.1 -DWITH_ICONV=1 -DWITH_MYSQL=1 -DDL_MYSQL=1
-DMYSQL_LIB=libmariadb.so.3 -DWITH_POSTGRESQL=1 -DDL_POSTGRESQL=1 -DPOSTGRESQL_LIB=libpq.so.5 -DLOCALDATADIR=/var/lib/manticore/data
-DFULL_SHARE_DIR=/usr/share/manticore
```
<!-- proofread -->

