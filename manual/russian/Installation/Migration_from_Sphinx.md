# Миграция с Sphinx Search

## Sphinx 2.x -> Manticore 2.x
Manticore Search 2.x сохраняет совместимость с Sphinxsearch 2.x и может загружать существующие таблицы, созданные Sphinxsearch. В большинстве случаев обновление сводится к замене бинарных файлов.

Вместо sphinx.conf (в Linux обычно находится по пути `/etc/sphinxsearch/sphinx.conf`) Manticore по умолчанию использует `/etc/manticoresearch/manticore.conf`. Также он работает под другим пользователем и использует разные папки.

Имя сервиса systemd изменилось с `sphinx/sphinxsearch` на `manticore`, и сервис запускается под пользователем `manticore` (Sphinx использовал `sphinx` или `sphinxsearch`). Также используется другая папка для PID файла.

Папки по умолчанию: `/var/lib/manticore`, `/var/log/manticore`, `/var/run/manticore`. Вы всё ещё можете использовать существующую конфигурацию Sphinx, но вам нужно вручную изменить права доступа на папки `/var/lib/sphinxsearch` и `/var/log/sphinxsearch`. Или просто глобально переименовать 'sphinx' в 'manticore' в системных файлах. Если вы используете другие папки (для данных, файлов wordforms и т.д.), их владельцем также должен стать пользователь `manticore`. Расположение `pid_file` следует изменить, чтобы оно соответствовало manticore.service: `/var/run/manticore/searchd.pid`.

Если вы хотите использовать папку Manticore, файлы таблиц нужно переместить в новый каталог данных (`/var/lib/manticore`) и сменить права на пользователя `manticore`.

## Sphinx 2.x / Manticore 2.x -> Manticore 3.x
Обновление с Sphinx / Manticore 2.x до 3.x не является тривиальным, так как движок хранения таблиц подвергся значительному усовершенствованию, и новый searchd не может загружать старые таблицы и обновлять их до нового формата на лету.

Manticore Search 3 получил переработанное хранение таблиц. Таблицы, созданные с помощью Manticore/Sphinx 2.x, не могут быть загружены Manticore Search 3 без [конвертации](../Installation/Migration_from_Sphinx.md#index_converter). Из-за ограничения в 4 ГБ реальном времени таблицы в 2.x могли иметь несколько дисковых чанков после операции оптимизации. После обновления до 3.x эти таблицы теперь могут быть оптимизированы до одного дискового чанка с использованием обычной команды [OPTIMIZE](../Securing_and_compacting_a_table/Compacting_a_table.md#OPTIMIZE-TABLE). Файлы индексов также изменились. Единственный компонент, который не претерпел структурных изменений — это файл `.spp` (hitlists). `.sps` (строки/json) и `.spm` (MVA) теперь входят в состав `.spb` (атрибуты переменной длины). В новом формате присутствует файл `.spm`, но теперь он используется для отображения строк (ранее предназначался для MVA атрибутов). Новыми расширениями являются `.spt` (поиск по docid), `.sphi` (гистограммы вторичных индексов), `.spds` (хранение документов). Если вы используете скрипты, которые манипулируют файлами таблиц, их необходимо адаптировать под новые расширения файлов.

Процедура обновления может различаться в зависимости от вашей конфигурации (число серверов в кластере, наличие высокой доступности и т. д.), но в целом включает в себя создание новых версий таблиц 3.x и замену существующих, а также замену старых бинарных файлов 2.x на новые.

Есть два специальных требования:

* Реальное времени таблицы необходимо сбросить с помощью [FLUSH RAMCHUNK](../Securing_and_compacting_a_table/Flushing_RAM_chunk_to_a_new_disk_chunk.md#FLUSH-RAMCHUNK)
* Обычные таблицы с kill-листами требуют добавления новой директивы в конфигурацию таблиц (см. [killlist_target](../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#killlist_target))

Manticore Search 3 включает новый инструмент — [index_converter](../Installation/Migration_from_Sphinx.md#index_converter), который может конвертировать таблицы Sphinx 2.x / Manticore 2.x в формат 3.x. `index_converter` поставляется в отдельном пакете, который нужно установить первым. С помощью конвертера создайте версии таблиц 3.x. `index_converter` может записывать новые файлы в существующую папку данных с резервным копированием старых файлов или записывать их в выбранную папку.

## Основная инструкция по обновлению

Если у вас один сервер:

* Установите пакет manticore-converter
* Используйте index_converter для создания новых версий таблиц в отдельной папке, отличной от текущей папки данных (с опцией `--output-dir`)
* Остановите существующий Manticore/Sphinx, обновитесь до 3.0, перенесите новые таблицы в папку данных и запустите Manticore

Для минимизации простоя можно скопировать таблицы 2.x, конфигурацию (нужно будет изменить пути для таблиц, логов и разных портов) и бинарники в отдельное место и запустить это на отдельном порте. Направьте ваше приложение на этот порт. После обновления до 3.0 и запуска нового сервера можно вернуть приложение на обычные порты. Если всё работает хорошо, остановите копию 2.x и удалите файлы, чтобы освободить место.

Если у вас есть резервный сервер (например, тестовый или staging), вы можете сначала выполнить обновление таблиц там и даже установить Manticore 3 для проведения тестов. Если всё нормально, скопируйте новые файлы таблиц на сервер продакшена. Если у вас несколько серверов, которые можно снять с эксплуатации, обновляйте их по одному и выполняйте обновление на каждом. Для распределённых конфигураций searchd версии 2.x может работать в роли мастера с узлами 3.x, так что вы можете сначала обновить узлы данных, а потом мастер-узел.

В способе подключения клиентов к движку изменений не произошло, также не изменился режим запросов и поведение запросов.

## kill-листы в Sphinx / Manticore 2.x и Manticore 3.x
[Kill-листы](../Data_creation_and_modification/Adding_data_from_external_storages/Adding_data_to_tables/Killlist_in_plain_tables.md) были переработаны в Manticore Search 3. В предыдущих версиях kill-листы применялись к результирующему набору, предоставляемому каждой ранее обработанной таблицей в момент выполнения запроса.

Следовательно, в 2.x порядок таблиц во время запроса имел значение. Например, если дельта-таблица имела kill-лист, чтобы применить его к основной таблице, порядок должен был быть: основная, дельта (либо в распределённой таблице, либо в конструкции FROM).

В Manticore 3 kill-листы применяются к таблице при её загрузке во время запуска searchd или при её ротации. Новая директива `killlist_target` в конфигурации таблицы указывает целевые таблицы и определяет, какие id документов из исходной таблицы должны использоваться для подавления. Это могут быть id из определённого kill-листа, фактические id документов таблицы или и те, и другие.

Документы из kill-листов удаляются из целевых таблиц, они не возвращаются в результатах даже если поиск не включает таблицу, которая предоставила kill-листы. Из-за этого порядок таблиц для поиска больше не имеет значения. Теперь `delta, main` и `main, delta` дают одинаковые результаты.

В прежних версиях таблицы ротировались в порядке, заданном в конфигурационном файле. В Manticore 3 порядок ротации таблиц гораздо умнее и работает в соответствии с целями kill-листов. Перед началом ротации таблиц сервер ищет цепочки таблиц по определениям `killlist_target`. Затем он сначала ротирует таблицы, на которые не ссылаются как на цели kill-листов. Далее он ротирует таблицы, по которым уже были выполнены ротации, и так далее. Например, если мы делаем `indexer --all` и у нас есть 3 таблицы: main, delta_big (целевая main) и delta_small (целевая delta_big), сначала ротируется delta_small, потом delta_big и наконец main. Это делается для того, чтобы при ротации зависимой таблицы у неё был самый актуальный kill-лист из других таблиц.

## Ключи конфигурации, удалённые в Manticore 3.x
* `docinfo` — теперь всё во внешнем виде
* `inplace_docinfo_gap` — больше не требуется
* `mva_updates_pool` — MVAs больше не имеют выделенного пула для обновлений, так как теперь они могут обновляться непосредственно в блобе (см. ниже).

## Обновление атрибутов переменной длины в Manticore 3.x
Строковые, JSON и MVA-атрибуты могут обновляться в Manticore 3.x с помощью оператора `UPDATE`.

В 2.x строковые атрибуты требовали `REPLACE`, для JSON было возможно обновлять только скалярные свойства (так как они были фиксированной длины), а MVAs могли обновляться с использованием пула MVA. Теперь обновления выполняются прямо на компоненте блоба. Один параметр, который может потребовать настройки, — это [attr_update_reserve](../Data_creation_and_modification/Updating_documents/UPDATE.md#attr_update_reserve), позволяющий изменить размер выделенного дополнительного пространства в конце блоба для избежания частых перераспределений, когда новые значения больше существующих в блобе.

## ID документов в Manticore 3.x
ID документов раньше были беззнаковыми 64-битными целыми числами. Теперь это положительные знаковые 64-битные целые числа.

## Режим RT в Manticore 3.x
Читайте здесь о [режиме RT](../Read_this_first.md#Real-time-mode-vs-plain-mode)

## Специальные суффиксы в Manticore 3.x
Manticore 3.x распознаёт и парсит специальные суффиксы, что облегчает использование числовых значений со специальным смыслом. Общая форма таких суффиксов — целое число + литерал, например 10k или 100d, но не 40.3s (потому что 40.3 не целое), и не 2d 4h (потому что там две, а не одна величина). Литералы не чувствительны к регистру, поэтому 10W и 10w равнозначны. В настоящее время поддерживаются 2 типа таких суффиксов:

* Суффиксы размеров — могут использоваться в параметрах, задающих размер чего-либо (буфер памяти, файл на диске, лимит оперативной памяти и т. п.) в байтах. "Голые" числа в таких местах означают буквально размер в байтах (октетах). Размеры могут иметь суффиксы `k` для килобайт (1k=1024), `m` для мегабайт (1m=1024k), `g` для гигабайт (1g=1024m) и `t` для терабайт (1t=1024g).
* Суффиксы времени — могут использоваться в параметрах, задающих временные интервалы, такие как задержки, таймауты и т. п. "Голые" значения таких параметров обычно имеют документированную шкалу, и вы должны знать, означает ли число, например, 100 — '100 секунд' или '100 миллисекунд'. Вместо догадок можно написать значение с суффиксом, и оно будет однозначно интерпретировано. Временные значения могут иметь суффиксы `us` для микросекунд, `ms` для миллисекунд, `s` для секунд, `m` для минут, `h` для часов, `d` для дней и `w` для недель.

## index_converter

`index_converter` — инструмент для конвертации таблиц, созданных в Sphinx/Manticore Search 2.x, в формат таблиц Manticore Search 3.x. Инструмент можно использовать несколькими способами:

#### Конвертация по одной таблице за раз

```ini
$ index_converter --config /home/myuser/manticore.conf --index tablename
```

#### Конвертация всех таблиц

```ini
$ index_converter --config /home/myuser/manticore.conf --all
```

#### Конвертация таблиц, найденных в папке

```ini
$ index_converter  --path /var/lib/manticoresearch/data --all
```

Новая версия таблицы по умолчанию записывается в ту же папку. Файлы предыдущей версии сохраняются с расширением `.old` в названии. Исключением является файл `.spp` (hitlists), который является единственным компонентом таблицы, не изменившимся в новом формате.

Вы можете сохранить новую версию таблицы в другую папку с помощью опции `--output-dir`

```ini
$ index_converter --config /home/myuser/manticore.conf --all --output-dir /new/path
```

#### Конвертация kill-листов

Особый случай — таблицы, содержащие kill-листы. Так как поведение kill-листов изменилось (см. [killlist_target](../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#killlist_target)), дельта-таблица должна знать, какие таблицы являются целевыми для применения kill-листов. Есть три способа подготовить конвертированную таблицу к установке целевых таблиц для kill-листов:

* Использовать `--killlist-target` при конвертации таблицы
  ```ini
  $ index_converter --config /home/myuser/manticore.conf --index deltaindex --killlist-target mainindex:kl
  ```
* Добавить killlist_target в конфигурацию перед конвертацией
* Использовать команду [ALTER ... KILLIST_TARGET](../Data_creation_and_modification/Adding_data_from_external_storages/Adding_data_to_tables/Killlist_in_plain_tables.md#killlist_target) после конвертации

#### Полный список опций index_converter

Вот полный список опций `index_converter`:

* `--config <file>` (`-c <file>` для краткости) указывает index_converter использовать заданный конфигурационный файл. Обычно он ищет manticore.conf в каталоге установки (например, `/usr/local/manticore/etc/manticore.conf`, если установлен в `/usr/local/sphinx`), затем в текущем каталоге, в котором вы запускаете index_converter из оболочки.
* `--index` указывает, какую таблицу следует конвертировать
* `--path` - вместо использования конфигурационного файла можно указать путь, содержащий таблицу(ы)
* `--strip-path` - удаляет путь из имён файлов, на которые ссылается таблица: стоп-слова, исключения и словоформы
* `--large-docid` - позволяет конвертировать документы с идентификаторами больше 2^63 и выводить предупреждение, в противном случае программа завершится с ошибкой при большом идентификаторе. Эта опция была добавлена, так как в Manticore 3.x идентификаторы документов имеют тип signed bigint, тогда как ранее они были unsigned
* `--output-dir <dir>` - записывает новые файлы в выбранную папку, а не в ту же директорию, что и существующие файлы таблиц. При установке этой опции существующие файлы таблиц останутся нетронутыми в своём расположении.
* `--all` - конвертирует все таблицы из конфигурации
* `--killlist-target <targets>` задаёт целевые таблицы, к которым будут применены kill-листы. Эта опция должна использоваться только вместе с опцией `--index`

<!-- proofread -->

