# Синхронизация из Kafka

> ЗАМЕТКА: эта функция требует [Manticore Buddy](../Installation/Manticore_Buddy.md). Если это не работает, убедитесь, что Buddy установлен.

Manticore Search может бесшовно потреблять сообщения из брокера Kafka, позволяя индексировать и осуществлять поиск данных в реальном времени.

Чтобы начать, вам нужно:
1. **Определить источник:** Укажите тему Kafka, из которой Manticore Search будет считывать сообщения. Эта настройка включает такие детали, как хост брокера, порт и название темы.
2. **Настроить таблицу назначения:** Выберите реальную таблицу Manticore для хранения входящих данных Kafka.
3. **Создать материализованный вид:** Настройте материализованный вид (`mv`), чтобы обрабатывать преобразование данных и их сопоставление из Kafka в таблицу назначения в Manticore Search. Здесь вы определите сопоставления полей, преобразования данных и любые фильтры или условия для входящего потока данных.

## Источник

<!-- example kafka_source -->

Конфигурация `source` позволяет вам определить `broker`, `topic list`, `consumer group` и структуру сообщения.

#### Схема

Определите схему, используя типы полей Manticore, такие как `int`, `float`, `text`, `json` и т. д.

```sql
CREATE SOURCE <имя источника> [(тип колонки, ...)] [source_options]
```

Все ключи схемы нечувствительны к регистру, что означает, что `Products`, `products` и `PrOdUcTs` обрабатываются одинаково. Они все конвертируются в нижний регистр.

Если ваши имена полей не соответствуют [синтаксису имен полей](../../Creating_a_table/Data_types.md#Field-name-syntax), допускаемому в Manticore Search (например, если они содержат специальные символы или начинаются с цифр), вам необходимо определить сопоставление схемы. Например, `$keyName` или `123field` являются действительными ключами в JSON, но не являются действительными именами полей в Manticore Search. Если вы попытаетесь использовать недопустимые имена полей без надлежащего сопоставления, Manticore вернет ошибку, и создание источника не удастся.

Чтобы обработать такие случаи, используйте следующий синтаксис схемы для сопоставления недопустимых имен полей с допустимыми:

```
allowed_field_name 'оригинальное имя ключа JSON с особыми символами' type
```

Например:
```sql
price_field '$price' float    -- сопоставляет ключ JSON '$price' с полем 'price_field'
field_123 '123field' text     -- сопоставляет ключ JSON '123field' с полем 'field_123'
```
<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
CREATE SOURCE kafka
(id bigint, term text, abbrev '$abbrev' text, GlossDef json)
type='kafka'
broker_list='kafka:9092'
topic_list='my-data'
consumer_group='manticore'
num_consumers='2'
batch=50
```

<!-- response -->

```
Запрос выполнен, 2 строки затронуты (0.02 сек)
```

<!-- end -->

#### Опции

| Опция | Допустимые значения | Описание |
|-|-|-|
| `type` | `kafka` | Устанавливает тип источника. В настоящее время поддерживается только `kafka` |
| `broker_list` | `host:port [, ...]` | Указывает URL-адреса брокеров Kafka |
| `topic_list` | `string [, ...]` | Перечисляет темы Kafka для потребления |
| `consumer_group`| `string` | Определяет группу потребителей Kafka, по умолчанию `manticore`. |
| `num_consumers` | `int` | Количество потребителей для обработки сообщений. |
| `batch` | `int` | Количество сообщений, которые нужно обработать перед переходом к следующему. По умолчанию `100`; обрабатывает оставшиеся сообщения по истечении времени ожидания |

### Таблица назначения

<!-- example kafka_destination -->

Таблица назначения является обычной реальной таблицей, в которой хранятся результаты обработки сообщений Kafka. Эта таблица должна быть определена в соответствии с требованиями схемы входящих данных и оптимизирована для потребностей в производительности запросов вашего приложения. Узнайте больше о создании реальных таблиц [здесь](../Creating_a_table/Local_tables/Real-time_table.md#Creating-a-real-time-table:).

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
CREATE TABLE destination_kafka
(id bigint, name text, short_name text, received_at text, size multi);
```

<!-- response -->

```
Запрос выполнен, 0 строк затронуты (0.02 сек)
```

<!-- end -->

### Материализованный вид

<!-- example kafka_mv -->

Материализованный вид позволяет выполнять преобразование данных из сообщений Kafka. Вы можете переименовывать поля, применять функции Manticore Search и выполнять сортировку, группировку и другие операции с данными.

Материализованный вид действует как запрос, который перемещает данные из источника Kafka в таблицу назначения, позволяя вам использовать синтаксис Manticore Search для настройки этих запросов. Убедитесь, что поля в `select` соответствуют полям в источнике.

```
CREATE MATERIALIZED VIEW <имя материализованного вида>
TO <имя таблицы назначения> AS
SELECT [column|function [as <новое имя>], ...] FROM <имя источника>
```

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
CREATE MATERIALIZED VIEW view_table
TO destination_kafka AS
SELECT id, term as name, abbrev as short_name,
       UTC_TIMESTAMP() as received_at, GlossDef.size as size FROM kafka

```

<!-- response -->

```sql
Запрос выполнен, 2 строки затронуты (0.02 сек)
```

<!-- end -->

Данные передаются из Kafka в Manticore Search пакетами, которые очищаются после каждой обработки. Для расчетов по пакетам, таких как AVG, будьте осторожны, так как они могут не работать так, как ожидалось, из-за обработки по пакетам.


### Сопоставление полей

Вот таблица сопоставления на основе приведенных выше примеров:

| Kafka           | Исходный   | Буфер   | MV                                | Назначение |
|-----------------|----------|----------|-----------------------------------|-------------|
| `id`              | `id`       | `id`       | `id`                                | `id`          |
| `term`            | `term`     | `term`     | `term as name`                      | `name`        |
| `unnecessary_key` which we're not interested in | -        | -        |                                   |             |
| `$abbrev`         | `abbrev`   | `abbrev`   | `abbrev` as `short_name`              | `short_name`  |
| -                 | -        | -         | `UTC_TIMESTAMP() as received_at`  | `received_at` |
| `GlossDef`        | `glossdef` | `glossdef` | `glossdef.size as size`             | `size`        |

### Список

<!-- example kafka_listing -->

Чтобы просмотреть источники и материализованные представления в Manticore Search, используйте эти команды:
- `SHOW SOURCES`: Перечисляет все настроенные источники.
- `SHOW MVS`: Перечисляет все материализованные представления.
- `SHOW MV view_table`: Показывает подробную информацию о конкретном материализованном представлении.

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
SHOW SOURCES
```

<!-- response -->

```
+-------+
| name  |
+-------+
| kafka |
+-------+
```

<!-- end -->

<!-- example kafka_create_source -->

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
SHOW SOURCE kafka;
```

<!-- response -->

```
+--------+-------------------------------------------------------------------+
| Source | Create Table                                                      |
+--------+-------------------------------------------------------------------+
| kafka  | CREATE SOURCE kafka                                               |
|        | (id bigint, term text, abbrev '$abbrev' text, GlossDef json)      |
|        | type='kafka'                                                      |
|        | broker_list='kafka:9092'                                          |
|        | topic_list='my-data'                                              |
|        | consumer_group='manticore'                                        |
|        | num_consumers='2'                                                 |
|        | batch=50                                                          |
+--------+-------------------------------------------------------------------+
```

<!-- end -->

<!-- example kafka_view -->

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
SHOW MVS
```

<!-- response -->

```
+------------+
| name       |
+------------+
| view_table |
+------------+
```

<!-- end -->

<!-- example kafka_show -->

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
SHOW MV view_table
```

<!-- response -->

```
+------------+--------------------------------------------------------------------------------------------------------+-----------+
| View       | Create Table                                                                                           | suspended |
+------------+--------------------------------------------------------------------------------------------------------+-----------+
| view_table | CREATE MATERIALIZED VIEW view_table TO destination_kafka AS                                            | 0         |
|            | SELECT id, term as name, abbrev as short_name, UTC_TIMESTAMP() as received_at, GlossDef.size as size   |           |
|            | FROM kafka                                                                                             |           |
+------------+--------------------------------------------------------------------------------------------------------+-----------+
```

<!-- end -->

### Изменение материализованных представлений

<!-- example mv_suspend -->

Вы можете приостановить потребление данных, изменив материализованные представления.

Если вы удалите `source`, не удаляя MV, она автоматически приостановится. После воссоздания источника, отмените приостановку MV вручную, используя команду `ALTER`.

В настоящее время можно изменять только материализованные представления. Чтобы изменить параметры `source`, удалите и воссоздайте источник.

<!-- intro -->

##### SQL:

<!-- request SQL -->

```sql
ALTER MATERIALIZED VIEW view_table suspended=1
```

<!-- response -->

```sql
Query OK (0.02 sec)
```

<!-- end -->

### Устранение неполадок

#### Дубликаты записей

Коммиты смещений Kafka происходят после каждой партии или когда время обработки истекает. Если процесс останавливается неожиданно во время запроса материализованного представления, вы можете увидеть дубликаты записей. Чтобы избежать этого, включите поле `id` в вашу схему, что позволит Manticore Search предотвращать дубликаты в таблице.

### Как это работает внутренне

- **Инициализация рабочего процесса:** После настройки источника и материализованного представления Manticore Search настраивает специализированный рабочий процесс для обработки потребления данных из Kafka.
- **Сопоставление сообщений:** Сообщения сопоставляются в соответствии со схемой конфигурации источника, преобразуя их в структурированный формат.
- **Пакетирование:** Сообщения группируются в пакеты для эффективной обработки. Размер пакета можно регулировать в зависимости от ваших потребностей в производительности и задержке.
- **Буферизация:** Сопоставленные данные пакетов хранятся в буферной таблице для эффективных массовых операций.
- **Обработка материализованного представления:** Логика представления применяется к данным в буферной таблице, выполняя любые преобразования или фильтрацию.
- **Передача данных:** Обработанные данные затем передаются в целевую таблицу реального времени.
- **Очистка:** Буферная таблица очищается после каждой партии, обеспечивая ее готовность к следующему набору данных.

<!-- proofread -->
