# Логирование запросов

<!-- пример query_logging -->
Логирование запросов можно включить, установив директиву [query_log](../Server_settings/Searchd.md#query_log) в секции searchd конфигурационного файла.

Запросы также могут быть отправлены в syslog, установив `syslog` вместо пути к файлу. В этом случае все поисковые запросы будут отправлены демону syslog с приоритетом `LOG_INFO`, предваряемым `[query]` вместо метки времени. Поддерживается только формат лога `plain` для syslog.

<!-- ввод -->
Пример `query_log`:
<!-- запрос Config -->
```ini
searchd {
...
    query_log = /var/log/query.log
    query_log_format = sphinxql # по умолчанию
...
}
```
<!-- конец -->


## Формат логирования

Поддерживаются два формата логов запросов:
* `sphinxql` (по умолчанию): Логи в SQL формате. Это также обеспечивает простой способ воспроизведения зарегистрированных запросов.
* `plain`: Логи полнотекстовых запросов в простом текстовом формате. Этот формат рекомендуется, если большая часть ваших запросов является преимущественно полнотекстовой или если вам не нужно регистрировать неполнотекстовые компоненты, такие как фильтрация по атрибутам, сортировка или группировка. Запросы, зарегистрированные в формате `plain`, не могут быть воспроизведены. Обратите внимание, что запросы, обработанные через [Buddy](../Installation/Manticore_Buddy.md), не регистрируются в этом режиме.

Чтобы переключаться между форматами, вы можете использовать настройку searchd [query_log_format](../Server_settings/Searchd.md#query_log_format).

### Формат SQL логов

<!-- пример sphixql_log -->
Формат SQL логов является настройкой по умолчанию. В этом режиме Manticore записывает все успешные и неуспешные выборочные запросы. Запросы, отправленные в виде SQL или через двоичный API, записываются в формате SQL, но JSON запросы записываются как есть. Этот тип логирования работает только с простыми лог-файлами и не поддерживает службу 'syslog' для логирования.

<!-- ввод -->
Пример `query_log_format`:
<!-- запрос Config -->
```ini
query_log_format = sphinxql # по умолчанию
```

<!-- конец -->

<!-- пример sphixql_log2 -->
Особенности формата SQL логов Manticore по сравнению с [plain формат](../../Logging/Query_logging.md#Plain-log-format) включают:
* Полные данные запроса регистрируются, где это возможно.
* Ошибки и предупреждения регистрируются.
* Лог запросов может быть воспроизведен.
* Дополнительные счетчики производительности (в настоящее время, распределенные времена запроса на агента) регистрируются.
* Каждая запись в логе является допустимым SQL/JSON запросом Manticore, который восстанавливает полный запрос, если только зарегистрированный запрос не слишком велик и не требует сокращения по соображениям производительности.
* JSON запросы и дополнительные сообщения, счетчики и т.д. регистрируются как комментарии.

<!-- ввод -->
Пример записей лога `sphinxql`:
<!-- запрос Пример -->
```sql
/* Вс, 28 апреля 12:38:02.808 2024 соединение 2 (127.0.0.1:53228) реальное 0.000 стенка 0.000 найдено 0 */ SELECT * FROM test WHERE MATCH('test') OPTION ranker=proximity;
/* Вс, 28 апреля 12:38:05.585 2024 соединение 2 (127.0.0.1:53228) реальное 0.001 стенка 0.001 найдено 0 */ SELECT * FROM test WHERE MATCH('test') GROUP BY channel_id OPTION ranker=proximity;
/* Вс, 28 апреля 12:40:57.366 2024 соединение 4 (127.0.0.1:53256) реальное 0.000 стенка 0.000 найдено 0 */  /*{
    "table" : "test",
    "query":
    {
        "match":
        {
            "*" : "test"
        }
    },
    "_source": ["f"],
    "limit": 30
} */
```
<!-- конец -->

### Формат простого лога

<!-- пример plain_log -->
С форматом лога `plain` Manticore регистрирует все успешно выполненные поисковые запросы в простом текстовом формате. Неполнозначные части запросов не регистрируются. JSON запросы записываются как однострочные записи. Запросы, обработанные через [Buddy](../Installation/Manticore_Buddy.md), не регистрируются.

<!-- ввод -->
Пример `query_log_format`:
<!-- запрос Config -->
```ini
query_log_format = plain
```
<!-- конец -->

<!-- пример plain_log2 -->
Формат лога следующий:

```
[query-date] реальное время время стены [режим-соответствия/количество-фильтров/режим-сортировки всего-совпадений (смещение,лимит) @группировка-атрибута] [имя-таблицы] {статистика-производительности} запрос
```

где:
* `реальное время` — это время от начала до конца запроса.
* `время стены` — аналогично реальному времени, но исключает время ожидания агентов и объединения наборов результатов от них.
* `статистика-производительности` включает статистику CPU/IO, когда Manticore запускается с `--cpustats` (или это было включено через `SET GLOBAL cpustats=1`) и/или `--iostats` (или это было включено через `SET GLOBAL iostats=1`):
  - `ios` — это количество операций ввода-вывода файла;
  - `kb` — это количество данных в килобайтах, прочитанных из файлов таблицы;
  - `ms` — это время, потраченное на операции ввода-вывода.
  - `cpums` — это время в миллисекундах, потраченное на обработку запроса CPU.
* `режим-соответствия` может иметь одно из следующих значений:
  - "all" для режима `SPH_MATCH_ALL`;
  - "any" для режима `SPH_MATCH_ANY`;
  - "phr" для режима `SPH_MATCH_PHRASE`;
  - "bool" для режима `SPH_MATCH_BOOLEAN`;
  - "ext" для режима `SPH_MATCH_EXTENDED`;
  - "ext2" для режима `SPH_MATCH_EXTENDED2`;
  - "scan", если был использован режим полного сканирования, либо с указанием `SPH_MATCH_FULLSCAN`, либо, если запрос был пустым.
* `режим-сортировки` может иметь одно из следующих значений:
  - "rel" для режима `SPH_SORT_RELEVANCE`;
  - "attr-" для режима `SPH_SORT_ATTR_DESC`;
  - "attr+" для режима `SPH_SORT_ATTR_ASC`;
  - "tsegs" для режима `SPH_SORT_TIME_SEGMENTS`;
  - "ext" для режима `SPH_SORT_EXTENDED`.

Примечание: `SPH*` режимы специфичны для устаревшего интерфейса `sphinx`. SQL и JSON интерфейсы будут регистрировать, в большинстве случаев, `ext2` как `match-mode` и `ext` и `rel` как `sort-mode`.

<!-- ввод -->
Пример лога запросов:
<!-- запрос Пример -->
```ini
[Пт 29 Июн 21:17:58 2021] 0.004 сек [all/0/rel 35254 (0,20)] [lj] [ios=6 kb=111.1 ms=0.5] test
[Пт 29 Июн 21:17:58 2021] 0.004 сек [all/0/rel 35254 (0,20)] [lj] [ios=6 kb=111.1 ms=0.5 cpums=0.3] test
[Вс 28 Апр 15:09:38.712 2024] 0.000 сек 0.000 сек [ext2/0/ext 0 (0,20)] [test] test
[Sun Apr 28 15:09:44.974 2024] 0.000 сек 0.000 сек [ext2/0/ext 0 (0,20) @channel_id] [test] test
[Sun Apr 28 15:24:32.975 2024] 0.000 сек 0.000 сек [ext2/0/ext 0 (0,30)] [test] {     "table" : "test",     "query":     {         "match":         {             "*" : "test"         }     },     "_source": ["f"],     "limit": 30 }
```

<!-- end -->

## Логгирование только медленных запросов

<!-- example query_log_min_msec -->
По умолчанию все запросы логируются. Если вы хотите логировать только запросы с временем выполнения, превышающим заданный предел, можно использовать директиву `query_log_min_msec`.

Ожидаемая единица измерения - миллисекунды, но также могут использоваться выражения с суффиксами времени.

<!-- intro -->
Пример `query_log_min_msec`:
<!-- request Config -->
```ini
searchd {
...
    query_log = /var/log/query.log
    query_log_min_msec  = 1000
    # query_log_min_msec  = 1s
...
}
```

<!-- end -->

## Режим разрешений файла журнала

<!-- Example query_log_mode -->
По умолчанию файлы журнала searchd и запросов создаются с разрешениями `600`, поэтому только пользователь, под которым работает Manticore, и `root` могут читать файлы журнала. Опция `query_log_mode` позволяет установить другое разрешение. Это может быть полезно для разрешения другим пользователям читать файлы журнала (например, решения для мониторинга, работающие на пользователях без прав root).

<!-- intro -->
Пример `query_log_mode`:
<!-- request Config -->
```ini
searchd {
...
    query_log = /var/log/query.log
    query_log_mode = 666
...
}
```
<!-- end -->
<!-- proofread -->
