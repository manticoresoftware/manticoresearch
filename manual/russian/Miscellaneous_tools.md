# Различные инструменты

## indextool

`indextool` — полезная утилита, которая извлекает различную информацию о физической таблице, исключая `template` или `distributed` таблицы. Вот общий синтаксис использования `indextool`:

```sql
indextool <command> [options]
```

### Опции

Эти опции применимы ко всем командам:

* `--config <file>` (`-c <file>` сокращенно) позволяет переопределить имена файлов конфигурации по умолчанию.
* `--quiet` (`-q` сокращенно) подавляет вывод баннеров и подобных сообщений от `indextool`.
* `--help` (`-h` сокращенно) отображает все параметры, доступные в вашей конкретной сборке `indextool`.
* `-v` отображает информацию о версии вашей конкретной сборки `indextool`.

### Команды

Доступные команды:

* `--checkconfig` загружает и проверяет файл конфигурации, проверяя его корректность и наличие синтаксических ошибок.
* `--buildidf DICTFILE1 [DICTFILE2 ...] --out IDFILE` создает IDF файл из одного или нескольких дампов словарей (см. `--dumpdict`). Дополнительный параметр `--skip-uniq` пропускает уникальные слова (df=1).
* `--build-infixes TABLENAME` генерирует инфиксы для уже существующей таблицы с dict=keywords (обновляет .sph, .spi на месте). Используйте эту опцию для файлов таблиц наследия, которые уже используют dict=keywords, но теперь требуют поддержки инфиксного поиска; обновление файлов таблиц с помощью indextool может быть проще или быстрее, чем полное пересоздание их через indexer.
* `--dumpheader FILENAME.sph` немедленно выводит дамп заголовочного файла таблицы без изменения других файлов таблицы или даже конфигурационного файла. Отчет предлагает детальный обзор всех настроек таблицы, особенно полный список атрибутов и полей.
* `--dumpconfig FILENAME.sph` извлекает определение таблицы из указанного заголовочного файла таблицы в формате, практически совместимом с файлом manticore.conf.
* `--dumpheader TABLENAME` выводит дамп заголовка таблицы по имени таблицы, ищет путь к заголовку в конфигурационном файле.
* `--dumpdict TABLENAME` выводит дамп словаря. Дополнительный переключатель `-stats` добавит общее количество документов к дампу словаря. Это требуется для словарных файлов, используемых при создании IDF файлов.
* `--dumpdocids TABLENAME` выводит ID документов по имени таблицы.
* `--dumphitlist TABLENAME KEYWORD` выводит все случаи (вхождения) заданного ключевого слова в указанной таблице, где ключевое слово задано в виде текста.
* `--dumphitlist TABLENAME --wordid ID` выводит все случаи (вхождения) конкретного ключевого слова в указанной таблице, где ключевое слово представлено как внутренний числовой ID.
* `--docextract TBL DOCID` выполняет стандартную проверку таблицы целиком по словарю/документам/вхождениям и собирает все слова и вхождения, связанные с запрошенным документом. Затем все слова упорядочиваются согласно полям и позициям, и результат выводится, сгруппированный по полям.
* `--fold TABLENAME OPTFILE` Эта опция помогает понять, как токенизатор обрабатывает ввод. Вы можете предоставить indextool текст из файла, если он указан, либо из stdin в противном случае. Вывод заменит разделители пробелами (на основе настроек `charset_table`) и преобразует буквы в словах в нижний регистр.
* `--htmlstrip TABLENAME` применяет настройки HTML-стриппера для указанной таблицы для фильтрации stdin и отправляет результаты фильтрации в stdout. Учтите, что настройки берутся из manticore.conf, а не из заголовка таблицы.
* `--mergeidf NODE1.idf [NODE2.idf ...] --out GLOBAL.idf` объединяет несколько .idf файлов в один. Дополнительный параметр `--skip-uniq` пропускает уникальные слова (df=1).
* `--morph TABLENAME` применяет морфологию к передаваемому stdin и выводит результат в stdout.
* `--check TABLENAME` оценивает файлы данных таблицы на предмет ошибок согласованности, которые могут быть вызваны ошибками в `indexer` или сбоями оборудования. `--check` также работает с RT таблицами, RAM и дисковыми чанками. Дополнительные опции:
    - `--check-id-dups` проверяет дубликаты ID документов в простой таблице и во всех дисковых чанках RT таблицы
    - `--check-disk-chunk CHUNK_NAME` проверяет только конкретный дисковый чанк RT таблицы. Аргумент — числовое расширение дискового чанка RT таблицы, который необходимо проверить.
* `--strip-path` удаляет пути из всех имен файлов, упомянутых в таблице (стоп-слова, словоформы, исключения и т.д.). Это полезно при проверке таблиц, созданных на другой машине с возможной иной структурой путей.
* `--rotate` совместима только с `--check` и определяет, проверять ли таблицу в ожидании ротации, то есть с расширением .new. Это удобно, если вы хотите проверить таблицу перед её реальным использованием.
* `--apply-killlists` загружает и применяет списки исключений для всех таблиц, перечисленных в конфигурационном файле. Изменения сохраняются в файлах .SPM. Файлы списков исключений (.SPK) удаляются. Это удобно, если вы хотите перенести применение списков с запуска сервера на этап индексации.

### Важное замечание по проверке RT таблиц

`indextool` не может полностью проверить RT таблицу, которая в данный момент обслуживается демоном. При попытке проверить активную RT таблицу вы можете получить следующее предупреждение:

```
WARNING: failed to load RAM chunks, checking only N disk chunks
```

Чтобы избежать этих предупреждений и обеспечить корректную проверку RT таблицы, рассмотрите следующие подходы:

- остановите демон перед запуском `indextool --check`.
- убедитесь, что RT таблица не обслуживается демоном в данный момент.
- проверьте отдельную копию RT таблицы вместо живой.

Если остановить демон невозможно, можно предотвратить нежелательные изменения RT таблицы, выполнив следующий SQL-запрос в MySQL перед запуском `indextool --check`:

```sql
SET GLOBAL AUTO_OPTIMIZE=0;
```

Эта команда блокирует автоматическую оптимизацию демоном, обеспечивая неизменность файлов RT таблицы. После выполнения запроса дождитесь полного прекращения потока оптимизации, перед тем как запускать `indextool --check`. Это гарантирует, что во время проверки никакие дисковые чанки не будут случайно изменены или удалены.
Если автоматическая оптимизация была включена ранее, после завершения проверки её нужно вручную включить обратно командой:

```sql
SET GLOBAL AUTO_OPTIMIZE=1;
```

## spelldump

Команда `spelldump` предназначена для извлечения содержимого из файла словаря, который использует формат `ispell` или `MySpell`. Это может быть полезно, когда вам нужно составить списки слов для форм слов, поскольку она генерирует все возможные формы для вас.

Вот общий синтаксис:

```bash
spelldump [options] <dictionary> <affix> [result] [locale-name]
```

Основными параметрами являются главный файл и файл аффиксов словаря. Обычно они называются соответственно `[language-prefix].dict` и `[language-prefix].aff`. Эти файлы можно найти в большинстве стандартных дистрибутивов Linux или из многочисленных онлайн-источников.

Параметр `[result]` — это место, куда будет записываться извлечённые данные словаря, а `[locale-name]` — параметр, используемый для указания локали по вашему выбору.

Также есть опциональный параметр `-c [file]`. Эта опция позволяет указать файл с деталями преобразования регистра.

Вот несколько примеров использования:

```bash
spelldump en.dict en.aff
spelldump ru.dict ru.aff ru.txt ru_RU.CP1251
spelldump ru.dict ru.aff ru.txt .1251
```

Полученный файл будет содержать все слова из словаря, расположенные по алфавиту и отформатированные как файл форм слов. Вы затем можете изменить этот файл в соответствии с вашими конкретными требованиями. Вот пример того, как может выглядеть выходной файл:

```bash
zone > zone
zoned > zoned
zoning > zoning
```

## wordbreaker

Инструмент `wordbreaker` предназначен для разбиения сложных слов, часто встречающихся в URL, на отдельные компоненты. Например, он может разложить "lordoftherings" на четыре отдельных слова или разбить `http://manofsteel.warnerbros.com` на "man of steel warner bros". Эта возможность улучшает работу поиска, устраняя необходимость в префиксах или инфиксах. Для иллюстрации, поиск по слову "sphinx" не выдаст результат для "sphinxsearch". Однако, если применить `wordbreaker` для разбиения сложного слова и индексировать раздельные элементы, поиск будет успешным без увеличения размера файла, связанного с использованием префиксов или инфиксов в полнотекстовом индексировании.

Вот несколько примеров использования `wordbreaker`:

```bash
echo manofsteel | bin/wordbreaker -dict dict.txt split
man of steel
```

Файл словаря `-dict` используется для разделения входного потока на отдельные слова. Если файл словаря не указан, Wordbreaker будет искать файл с именем `wordbreaker-dict.txt` в текущем рабочем каталоге. (Убедитесь, что файл словаря соответствует языку сложного слова, с которым вы работаете.) Команда `split` разбивает слова из стандартного входа и передаёт результаты в стандартный вывод. Также доступны команды `test` и `bench` для оценки качества разбиения и измерения производительности функции разбиения соответственно.

Wordbreaker использует словарь для выявления отдельных подстрок в заданной строке. Чтобы различать несколько возможных разбиений, он учитывает относительную частоту каждого слова в словаре. Более высокая частота указывает на большую вероятность разбиения по слову. Для создания такого файла вы можете использовать инструмент `indexer`:


```bash
indexer --buildstops dict.txt 100000 --buildfreqs myindex -c /path/to/manticore.conf
```

который создаст текстовый файл с именем `dict.txt`, содержащий 100 000 наиболее часто встречающихся слов из `myindex` с их соответствующими счётчиками. Поскольку этот выходной файл является простым текстовым документом, вы можете вручную редактировать его в любое время. Не стесняйтесь добавлять или удалять слова по мере необходимости.

<!-- proofread -->

