# Профиль запроса

<!-- example SHOW PROFILE -->

Оператор SQL `SHOW PROFILE` и опция интерфейса JSON `"profile": true` предоставляют подробный профиль выполнения выполняемого запроса. В случае SQL профилирование должно быть включено в текущей сессии **до** выполнения операторa, который необходимо инструментарить. Это можно сделать с помощью оператора `SET profiling=1`. По умолчанию профилирование отключено, чтобы избежать возможных влияний на производительность, в результате чего профиль будет пустым, если оно не включено.

Каждый результат профилирования включает следующие поля:
* Столбец `Status` кратко описывает конкретное состояние, в котором было затрачено время. См. ниже.
* Столбец `Duration` показывает фактическое время (в секундах).
* Столбец `Switches` отображает количество раз, когда движок запроса переключался на указанное состояние. Это лишь логические переключения состояния движка и **не** являются переключениями контекста на уровне ОС или вызовами функций (хотя некоторые разделы могут соответствовать вызовам функций), и они **не** оказывают прямого влияния на производительность. В некотором смысле, количество переключений — это просто число попаданий в соответствующую точку инструментария.
* Столбец `Percent` показывает процент времени, затраченного в данном состоянии.

Состояния в профиле возвращаются в заранее записанном порядке, который примерно совпадает (но **не** идентичен) с фактическим порядком выполнения запроса.

Список состояний может (и будет) изменяться со временем по мере уточнения состояний. Ниже приведено краткое описание текущих профилируемых состояний.

* `unknown`: универсальное состояние-ловушка. Учитывает неинструментированный пока код или мелкие разовые задачи, которые не подходят ни для какого другого состояния, но слишком малы, чтобы выделять отдельное состояние.
* `net_read`: чтение запроса из сети (то есть от приложения).
* `io`: общее время файлового ввода-вывода.
* `dist_connect`: соединение с удалёнными агентами в случае распределённой таблицы.
* `sql_parse`: разбор синтаксиса SQL.
* `dict_setup`: настройка словаря и токенизатора.
* `parse`: разбор синтаксиса полнотекстового запроса.
* `transforms`: преобразования полнотекстового запроса (подстановки с подстановочными символами, другие расширения, упрощения и т.п.).
* `init`: инициализация оценки запроса.
* `open`: открытие файлов таблицы.
* `read_docs`: время ввода-вывода при чтении списков документов.
* `read_hits`: время ввода-вывода при чтении позиций ключевых слов.
* `get_docs`: вычисление совпадающих документов.
* `get_hits`: вычисление совпадающих позиций.
* `filter`: фильтрация полнотекстовых совпадений.
* `rank`: вычисление релевантности (ранжирование).
* `sort`: сортировка совпадений.
* `finalize`: финализация результата поиска по таблице (заключительные выражения и т.п.).
* `dist_wait`: ожидание удалённых результатов от агентов в случае распределённой таблицы.
* `aggregate`: агрегирование нескольких наборов результатов.
* `net_write`: запись набора результатов в сеть.

<!-- intro -->
##### SQL:
<!-- request SQL -->

```sql
SET profiling=1;

SELECT id FROM forum WHERE MATCH('the best') LIMIT 1;

SHOW PROFILE;
```

<!-- response SQL -->

```sql
Query OK, 0 rows affected (0.00 sec)

+--------+
| id     |
+--------+
| 241629 |
+--------+
1 row in set (0.35 sec)

+--------------+----------+----------+---------+
| Status       | Duration | Switches | Percent |
+--------------+----------+----------+---------+
| unknown      | 0.000557 | 5        | 0.16    |
| net_read     | 0.000016 | 1        | 0.00    |
| local_search | 0.000076 | 1        | 0.02    |
| sql_parse    | 0.000121 | 1        | 0.03    |
| dict_setup   | 0.000003 | 1        | 0.00    |
| parse        | 0.000072 | 1        | 0.02    |
| transforms   | 0.000331 | 2        | 0.10    |
| init         | 0.001945 | 3        | 0.56    |
| read_docs    | 0.001257 | 76       | 0.36    |
| read_hits    | 0.002598 | 186      | 0.75    |
| get_docs     | 0.089328 | 2691     | 25.80   |
| get_hits     | 0.189626 | 2799     | 54.78   |
| filter       | 0.009369 | 2613     | 2.71    |
| rank         | 0.029669 | 7760     | 8.57    |
| sort         | 0.019070 | 2531     | 5.51    |
| finalize     | 0.000001 | 1        | 0.00    |
| clone_attrs  | 0.002009 | 1        | 0.58    |
| aggregate    | 0.000054 | 2        | 0.02    |
| net_write    | 0.000076 | 2        | 0.02    |
| eval_post    | 0.000001 | 1        | 0.00    |
| total        | 0.346179 | 18678    | 0       |
+--------------+----------+----------+---------+
21 rows in set (0.00 sec)
```

<!-- request JSON -->

```json
POST /search
{
  "table": "test",
  "profile": true,
  "query":
  {
    "match_phrase": { "_all" : "had grown quite" }
  }
}
```

<!-- response JSON -->

```json
 "profile": {
    "query": [
      {
        "status": "unknown",
        "duration": 0.000141,
        "switches": 8,
        "percent": 2.17
      },
      {
        "status": "local_df",
        "duration": 0.000870,
        "switches": 1,
        "percent": 13.40
      },
      {
        "status": "local_search",
        "duration": 0.001038,
        "switches": 2,
        "percent": 15.99
      },
      {
        "status": "setup_iter",
        "duration": 0.000154,
        "switches": 14,
        "percent": 2.37
      },
      {
        "status": "dict_setup",
        "duration": 0.000026,
        "switches": 3,
        "percent": 0.40
      },
      {
        "status": "parse",
        "duration": 0.000205,
        "switches": 3,
        "percent": 3.15
      },
      {
        "status": "transforms",
        "duration": 0.000974,
        "switches": 4,
        "percent": 15.01
      },
      {
        "status": "init",
        "duration": 0.002931,
        "switches": 20,
        "percent": 45.16
      },
      {
        "status": "get_docs",
        "duration": 0.000007,
        "switches": 7,
        "percent": 0.10
      },
      {
        "status": "rank",
        "duration": 0.000002,
        "switches": 14,
        "percent": 0.03
      },
      {
        "status": "finalize",
        "duration": 0.000013,
        "switches": 7,
        "percent": 0.20
      },
      {
        "status": "aggregate",
        "duration": 0.000128,
        "switches": 1,
        "percent": 1.97
      },
      {
        "status": "total",
        "duration": 0.006489,
        "switches": 84,
        "percent": 100.00
      }
    ]
  }
```
<!-- end -->

<!-- proofread -->

