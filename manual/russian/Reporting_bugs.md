# Сообщение об ошибках

К сожалению, Manticore еще не на 100% свободен от ошибок, хотя команда разработчиков усердно работает над этой целью. Вы можете время от времени сталкиваться с некоторыми проблемами. 
Важно сообщать как можно больше информации об каждой ошибке, чтобы исправить ее эффективно.
Чтобы исправить ошибку, необходимо либо воспроизвести ее и исправить, либо выяснить ее причину на основе предоставленной вами информации. Для этого, пожалуйста, следуйте приведенным ниже инструкциям.

### Система отслеживания ошибок
Ошибки и запросы на новые функции отслеживаются на [Github](https://github.com/manticoresoftware/manticore/issues). Вы можете создать новый тикет и подробно описать свою ошибку, чтобы сэкономить время как себе, так и разработчикам.

### Обновление документации
Обновления документации (то, что вы читаете сейчас) также проводятся на [Github](https://github.com/manticoresoftware/manticoresearch/tree/master/manual).

### Системные сбои

Manticore Search написан на C++, что является языком низкого уровня, позволяющим напрямую взаимодействовать с компьютером для повышения производительности. Однако есть и недостаток этого подхода, так как в редких случаях может оказаться невозможным элегантно обработать ошибку, записав ее в журнал и пропустив обработку команды, вызвавшей проблему. Вместо этого программа может завершиться аварийно, в результате чего она полностью остановится и ее необходимо будет перезапустить.

Когда Manticore Search аварийно завершает работу, важно сообщить команде Manticore, отправив [сообщение об ошибке](https://github.com/manticoresoftware/manticoresearch/issues/new?assignees=&labels=&template=bug_report.md&title=) на GitHub или через профессиональные услуги Manticore в вашем личном справочном центре. Команда Manticore требует следующую информацию:

1. Журнал searchd
2. Образ памяти (coredump)
3. Журнал запросов

Кроме того, будет полезно, если вы сможете сделать следующее:
1. Запустите gdb для проверки образа памяти:
```
gdb /usr/bin/searchd </path/to/coredump>
```
2. Найдите ID потока с ошибкой в имени файла образа памяти (убедитесь, что у вас есть `%p` в /proc/sys/kernel/core_pattern), например, `core.work_6.29050.server_name.1637586599` означает thread_id=29050
3. В gdb выполните:
```
set pagination off
info threads
# найдите номер потока по его ID (например, для `LWP 29050` это будет номер потока 8)
thread apply all bt
thread <номер потока>
bt full
info locals
quit
```
4. Предоставьте выводы

### Что делать, когда Manticore Search зависает?

Если Manticore Search зависает, вам нужно собрать некоторую информацию, которая может оказаться полезной для понимания причины. Вот как вы можете это сделать:

1. Выполните `show threads option format=all` через [VIP порт](https://manual.manticoresearch.com/Connecting_to_the_server/HTTP#VIP-connection)
2. Соберите вывод lsof, поскольку зависание может быть вызвано слишком большим количеством соединений или открытых дескрипторов файлов.
```
lsof -p `cat /var/run/manticore/searchd.pid`
```
3. Сохраните образ памяти:
```
gcore `cat /var/run/manticore/searchd.pid`
```
(Это сохранит дамп в текущем каталоге.)

4. Установите и запустите gdb:
```
gdb /usr/bin/searchd `cat /var/run/manticore/searchd.pid`
```
Обратите внимание, что это остановит ваш работающий searchd, но если он уже завис, это не должно стать проблемой.
5. В gdb выполните:
```
set pagination off
info threads
thread apply all bt
quit
```
6. Соберите все выводы и файлы и предоставьте их в сообщении об ошибке.

Для экспертов: макросы, добавленные в [этом коммите](https://github.com/manticoresoftware/manticoresearch/commit/e317f7aa30aad51cb19d34595458bb7c8811be21), могут быть полезны для отладки.

### Как включить сохранение образов памяти при сбое?

* убедитесь, что вы запускаете searchd с `--coredump`. Чтобы избежать изменения скриптов, вы можете использовать метод https://manual.manticoresearch.com/Starting_the_server/Linux#Custom-startup-flags-using-systemd. Например::

```
[root@srv lib]# systemctl set-environment _ADDITIONAL_SEARCHD_PARAMS='--coredump'
[root@srv lib]# systemctl restart manticore
[root@srv lib]# ps aux|grep searchd
mantico+  1955  0.0  0.0  61964  1580 ?        S    11:02   0:00 /usr/bin/searchd --config /etc/manticoresearch/manticore.conf --coredump
mantico+  1956  0.6  0.0 392744  2664 ?        Sl   11:02   0:00 /usr/bin/searchd --config /etc/manticoresearch/manticore.conf --coredump
```

* Убедитесь, что ваша операционная система позволяет вам сохранять образы памяти, проверив, что: `/proc/sys/kernel/core_pattern` не пуст. Это место, куда будут сохраняться образы памяти. Чтобы сохранить образы памяти в файл, такой как `core.searchd.1773.centos-4gb-hel1-1.1636454937`, выполните следующую команду:
```
echo "/cores/core.%e.%p.%h.%t" > /proc/sys/kernel/core_pattern
```

* searchd должен быть запущен с `ulimit -c unlimited`. Если вы запускаете Manticore с помощью systemctl, это автоматически установит лимит в бесконечность, как указано в следующей строке файла manticore.service:
```
[root@srv lib]# grep CORE /lib/systemd/system/manticore.service
LimitCORE=infinity
```

### Как установить отладочные символы?

Manticore Search и Manticore Columnar Library написаны на C++, что приводит к созданию скомпилированных бинарных файлов, которые оптимально выполняются на вашей операционной системе. Однако при запуске бинарного файла ваша система не имеет полного доступа к именам переменных, функций, методов и классов. Эта информация предоставляется в отдельных "debuginfo" или "symbol packages."

Отладочные символы необходимы для устранения неполадок и отладки, так как они позволяют вам визуализировать состояние системы в момент сбоя, включая имена функций. Manticore Search предоставляет трассировку стека в журнале searchd и генерирует образ памяти, если запущен с флагом --coredump. Без символов вы увидите только внутренние смещения, что затруднит или сделает невозможным расшифровку причины сбоя. Если вам нужно сделать отчет об ошибке из-за сбоя, команде Manticore часто понадобятся отладочные символы, чтобы помочь вам.
Для установки отладочных символов Manticore Search/Manticore Columnar Library вам необходимо установить пакет `*debuginfo*` для CentOS, пакет `*dbgsym*` для Ubuntu и Debian, или пакет `*dbgsymbols*` для Windows и macOS. Эти пакеты должны быть той же версии, что и установленный Manticore. Например, если вы установили Manticore Search в CentOS 8 из пакета https://repo.manticoresearch.com/repository/manticoresearch/release/centos/8/x86_64/manticore-4.0.2_210921.af497f245-1.el8.x86_64.rpm , соответствующий пакет с символами будет https://repo.manticoresearch.com/repository/manticoresearch/release/centos/8/x86_64/manticore-debuginfo-4.0.2_210921.af497f245-1.el8.x86_64.rpm

Обратите внимание, что оба пакета имеют одинаковый идентификатор коммита `af497f245`, который соответствует коммиту, от которого была собрана эта версия.

Если вы установили Manticore из репозитория APT/YUM Manticore, вы можете использовать один из следующих инструментов:
* `debuginfo-install` в CentOS 7
* `dnf debuginfo-install` в CentOS 8
* `find-dbgsym-packages` в Debian и Ubuntu

чтобы найти пакет отладочных символов для вас.

### Как проверить, существуют ли отладочные символы?

1. Найдите идентификатор сборки в выводе `file /usr/bin/searchd`:

```
[root@srv lib]# file /usr/bin/searchd
/usr/bin/searchd: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), динамически слинкованный (использует общие библиотеки), для GNU/Linux 2.6.32, BuildID[sha1]=2c582e9f564ea1fbeb0c68406c271ba27034a6d3, очищенный
```

В этом случае идентификатор сборки - 2c582e9f564ea1fbeb0c68406c271ba27034a6d3.

2. Найдите символы в `/usr/lib/debug/.build-id` следующим образом:

```
[root@srv ~]# ls -la /usr/lib/debug/.build-id/2c/582e9f564ea1fbeb0c68406c271ba27034a6d3*
lrwxrwxrwx. 1 root root 23 Nov  9 10:42 /usr/lib/debug/.build-id/2c/582e9f564ea1fbeb0c68406c271ba27034a6d3 -> ../../../../bin/searchd
lrwxrwxrwx. 1 root root 27 Nov  9 10:42 /usr/lib/debug/.build-id/2c/582e9f564ea1fbeb0c68406c271ba27034a6d3.debug -> ../../usr/bin/searchd.debug
```

### Загрузка ваших данных

<!-- example s3 -->
Чтобы исправить вашу ошибку, разработчикам часто необходимо воспроизвести её локально. Для этого им нужен ваш файл конфигурации, файлы таблиц, binlog (если имеется), и иногда исходные данные (например, данные из внешних хранилищ или XML/CSV файлы) и запросы. 

Прикрепите ваши данные, когда вы [создаете заявку на GitHub](https://github.com/manticoresoftware/manticoresearch/issues/new). Если данные слишком большие или конфиденциальные, вы можете загрузить их в наше только для записи S3 хранилище по адресу `s3://s3.manticoresearch.com/write-only/`. 

Чтобы сделать это просто, мы предоставляем механизм загрузки с использованием образа Docker. Этот образ создается из нашего открытого репозитория на [github.com/manticoresoftware/s3-upload](https://github.com/manticoresoftware/s3-upload) и помогает вам легко загружать данные в только для записи S3 хранилище Manticore. Вот как вы можете это сделать:
1. Перейдите в каталог, содержащий файлы, которые вы хотите загрузить, и выполните:
   ```bash
   docker run -it --rm -v $(pwd):/upload manticoresearch/upload
   ```
2. Это произойдет:
   - Попросит вас ввести URL-адрес/номер соответствующей проблемы
   - Загрузит **все файлы в текущем каталоге** в наше только для записи S3 хранилище
   - В конце вы увидите путь загрузки. Пожалуйста, поделитесь этим путем с разработчиками.

<!-- intro -->
Пример:

<!-- request Example -->
```bash
docker run -it --rm -v $(pwd):/upload manticoresearch/upload
```

<!-- response Example -->
```bash
🚀 Добро пожаловать в инструмент загрузки Manticore Search! 🚀

📂 Файлы для загрузки:
  tt (800)

🔗 Пожалуйста, введите URL-адрес/номер соответствующей проблемы
(например, https://github.com/manticoresoftware/manticoresearch/issues/123 или просто 123):
123

📤 Начало процесса загрузки...
INFO: Файл кэша не найден или пуст, создаем/заполняем его.
INFO: Составление списка локальных файлов...
INFO: Выполняется stat() и чтение/расчет значений MD5 на 23 файлах, это может занять некоторое время...
INFO: Результат: 23 локальных файла для загрузки
upload: './tt/tt.0.spa' -> 's3://write-only/issue-20250219-123/tt/tt.0.spa'  [1 из 23]
 40 из 40   100% за    2s    15.03 B/s  выполнено
upload: './tt/tt.0.spd' -> 's3://write-only/issue-20250219-123/tt/tt.0.spd'  [2 из 23]
 1 из 1   100% за    0s     1.99 B/s  выполнено
upload: './tt/tt.0.spe' -> 's3://write-only/issue-20250219-123/tt/tt.0.spe'  [3 из 23]
 1 из 1   100% за    0s     2.02 B/s  выполнено
upload: './tt/tt.0.sph' -> 's3://write-only/issue-20250219-123/tt/tt.0.sph'  [4 из 23]
 420 из 420   100% за    0s   895.32 B/s  выполнено
upload: './tt/tt.0.sphi' -> 's3://write-only/issue-20250219-123/tt/tt.0.sphi'  [5 из 23]
 66 из 66   100% за    0s   142.67 B/s  выполнено
upload: './tt/tt.0.spi' -> 's3://write-only/issue-20250219-123/tt/tt.0.spi'  [6 из 23]
 18 из 18   100% за    0s    39.13 B/s  выполнено
upload: './tt/tt.0.spidx' -> 's3://write-only/issue-20250219-123/tt/tt.0.spidx'  [7 из 23]
 145 из 145   100% за    0s   313.38 B/s  выполнено
upload: './tt/tt.0.spm' -> 's3://write-only/issue-20250219-123/tt/tt.0.spm'  [8 из 23]
 4 из 4   100% за    0s     8.36 B/s  выполнено
upload: './tt/tt.0.spp' -> 's3://write-only/issue-20250219-123/tt/tt.0.spp'  [9 из 23]
 1 из 1   100% за    0s     2.15 B/s  выполнено
upload: './tt/tt.0.spt' -> 's3://write-only/issue-20250219-123/tt/tt.0.spt'  [10 из 23]
 36 из 36   100% за    0s    78.35 B/s  выполнено
upload: './tt/tt.1.spa' -> 's3://write-only/issue-20250219-123/tt/tt.1.spa'  [11 из 23]
 48 из 48   100% за    0s    81.35 B/s  выполнено
upload: './tt/tt.1.spd' -> 's3://write-only/issue-20250219-123/tt/tt.1.spd'  [12 из 23]
 1 из 1   100% за    0s     1.65 B/s  выполнено
upload: './tt/tt.1.spe' -> 's3://write-only/issue-20250219-123/tt/tt.1.spe'  [13 из 23]
 1 из 1   100% за    0s     1.95 B/s  выполнено
upload: './tt/tt.1.sph' -> 's3://write-only/issue-20250219-123/tt/tt.1.sph'  [14 из 23]
 420 из 420   100% за    0s   891.58 B/s  выполнено
upload: './tt/tt.1.sphi' -> 's3://write-only/issue-20250219-123/tt/tt.1.sphi'  [15 из 23]
 82 из 82   100% за    0s   166.42 B/s  выполнено
upload: './tt/tt.1.spi' -> 's3://write-only/issue-20250219-123/tt/tt.1.spi'  [16 из 23]
 18 из 18   100% за    0с    39.46 B/c  завершено
upload: './tt/tt.1.spidx' -> 's3://write-only/issue-20250219-123/tt/tt.1.spidx'  [17 из 23]
 183 из 183   100% за    0с   374.04 B/c  завершено
upload: './tt/tt.1.spm' -> 's3://write-only/issue-20250219-123/tt/tt.1.spm'  [18 из 23]
 4 из 4   100% за    0с     8.42 B/c  завершено
upload: './tt/tt.1.spp' -> 's3://write-only/issue-20250219-123/tt/tt.1.spp'  [19 из 23]
 1 из 1   100% за    0с     1.28 B/c  завершено
upload: './tt/tt.1.spt' -> 's3://write-only/issue-20250219-123/tt/tt.1.spt'  [20 из 23]
 50 из 50   100% за    1с    34.60 B/c  завершено
upload: './tt/tt.lock' -> 's3://write-only/issue-20250219-123/tt/tt.lock'  [21 из 23]
 0 из 0     0% за    0с     0.00 B/c  завершено
upload: './tt/tt.meta' -> 's3://write-only/issue-20250219-123/tt/tt.meta'  [22 из 23]
 456 из 456   100% за    0с   923.34 B/c  завершено
upload: './tt/tt.settings' -> 's3://write-only/issue-20250219-123/tt/tt.settings'  [23 из 23]
 3 из 3   100% за    0с     6.41 B/c  завершено

✅ Загрузка завершена!
📋 Пожалуйста, поделитесь этим путем с разработчиками:
issue-20250219-123

💡 Подсказка: Обязательно включите этот путь при общении с командой Manticore
```
<!-- end -->

В качестве альтернативы вы можете использовать S3 [Minio client](https://min.io/docs/minio/linux/reference/minio-mc.html) или инструмент Amazon [s3cmd](https://s3tools.org/s3cmd) для выполнения тех же действий, например:

1. Установите клиент https://min.io/docs/minio/linux/reference/minio-mc.html#install-mc
Например, на 64-битном Linux:
   ```
   curl https://dl.min.io/client/mc/release/linux-amd64/mc \
   --create-dirs \
   -o $HOME/minio-binaries/mc
   chmod +x $HOME/minio-binaries/mc
   export PATH=$PATH:$HOME/minio-binaries/
   ```
2. Добавьте наш хост s3 (используйте полный путь к исполняемому файлу или перейдите в его каталог): `cd $HOME/minio-binaries` и затем `./mc config host add manticore http://s3.manticoresearch.com:9000 manticore manticore`
3. Скопируйте ваши файлы (используйте полный путь к исполняемому файлу или перейдите в его каталог): `cd $HOME/minio-binaries` и затем `./mc cp -r issue-1234/ manticore/write-only/issue-1234` . Убедитесь, что имя папки уникально и лучше всего соответствует проблеме на GitHub, где вы описали ошибку.

### ОТЛАДКА

```sql
ОТЛАДКА [ подкоманда ]
```

Команда `ОТЛАДКА` предназначена для разработчиков и тестировщиков для вызова различных внутренних или VIP-команд. Однако она не предназначена для использования в производственной среде, так как синтаксис компонента `подкоманда` может свободно изменяться в любой сборке.

Чтобы просмотреть список полезных команд и подкоманд для команды `ОТЛАДКА`, доступных в текущем контексте, просто вызовите `ОТЛАДКА` без каких-либо параметров.

```sql
mysql> debug;
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
| команда                                                                 | значение                                                                                |
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
| сбросить логи                                                            | эмулировать сигнал USR1                                                                |
| перезагрузить индексы                                                    | эмулировать сигнал HUP                                                                  |
| отладка токена <пароль>                                                  | вычислить токен для пароля                                                            |
| отладка malloc_stats                                                      | выполнить 'malloc_stats', результат в searchd.log                                       |
| отладка malloc_trim                                                       | выполнить вызов 'malloc_trim'                                                          |
| отладка сон <N>                                                         | спать в течение <N> секунд                                                              |
| отладка задачи                                                           | отобразить глобальную статистику задач (используйте select from @@system.tasks вместо) |
| отладка расписания                                                       | отобразить расписание планировщика задач (используйте select from @@system.sched вместо) |
| отладка слияния <TBL> [часть] <X> [в] [часть] <Y> [опция sync=1,byid=0] | Для RT таблицы <TBL> слить диск часть X в диск часть Y                                 |
| отладка удаления [часть] <X> [из] <TBL> [опция sync=1]                   | Для RT таблицы <TBL> удалить диск часть X                                            |
| отладка файлы <TBL> [опция формат=all|external]                         | перечислить файлы, принадлежащие <TBL>. 'all' - включая внешние (словоформы, стоп-слова и др.) |
| отладка закрыть                                                          | попросить сервер закрыть соединение с его стороны                                     |
| отладка сжатие <TBL> [часть] <X> [опция sync=1]                        | Сжать диск часть X RT таблицы <TBL> (удалить удаленные документы)                      |
| отладка разделить <TBL> [часть] <X> на @<uservar> [опция sync=1]         | Разделить диск часть X RT таблицы <TBL>, используя набор DocIDs из @uservar           |
| отладка ожидать <кластер> [как 'xx'] [опция timeout=3]                 | ожидать, пока <кластер> будет готов, но не более 3 секунд.                           |
| отладка ожидать <кластер> статус <N> [как 'xx'] [опция timeout=13]     | ожидать, пока <кластер> достигнет коммита <N>, но не более 13 секунд                   |
| debug meta                                                              | Покажите max_matches/pseudo_shards. Требуется установить profiling=1                     |
| debug trace OFF|'path/to/file' [<N>]                                    | трассировать поток в файл до записи N байт или 'trace OFF'                             |
| debug curl <URL>                                                        | запросить данный URL с помощью libcurl                                                |
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
19 rows in set (0.00 sec)
```

То же самое от подключения VIP:
```sql
mysql> debug;
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
| command                                                                 | meaning                                                                                |
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
| flush logs                                                              | эмулировать сигнал USR1                                                                |
| reload indexes                                                          | эмулировать сигнал HUP                                                                  |
| debug shutdown <password>                                               | эмулировать сигнал TERM                                                                 |
| debug crash <password>                                                  | аварийное завершение демона (сделать действие SIGSEGV)                                 |
| debug token <password>                                                  | вычислить токен для пароля                                                             |
| debug malloc_stats                                                      | выполнить 'malloc_stats', результат в searchd.log                                      |
| debug malloc_trim                                                       | выполнить вызов 'malloc_trim'                                                           |
| debug procdump                                                          | попросить контрольного процесса сбросить нас                                            |
| debug setgdb on|off                                                     | включить или отключить потенциально опасный сброс при аварии с gdb                      |
| debug setgdb status                                                     | показать текущий режим сброса gdb                                                      |
| debug sleep <N>                                                         | спать <N> секунд                                                                        |
| debug tasks                                                             | отобразить глобальную статистику задач (используйте выбор из @@system.tasks вместо)     |
| debug sched                                                             | отобразить расписание менеджера задач (используйте выбор из @@system.sched вместо)     |
| debug merge <TBL> [chunk] <X> [into] [chunk] <Y> [option sync=1,byid=0] | Для RT таблицы <TBL> объединить диск чанк X в диск чанк Y                            |
| debug drop [chunk] <X> [from] <TBL> [option sync=1]                     | Для RT таблицы <TBL> удалить диск чанк X                                             |
| debug files <TBL> [option format=all|external]                          | перечислить файлы, принадлежащие <TBL>. 'all' - включая внешние (формы слов, стоп-слова и т.д.) |
| debug close                                                             | попросить сервер закрыть соединение с его стороны                                      |
| debug compress <TBL> [chunk] <X> [option sync=1]                        | Сжать диск чанк X таблицы RT <TBL> (удалить удаленные документы)                       |
| debug split <TBL> [chunk] <X> on @<uservar> [option sync=1]             | Разделить диск чанк X таблицы RT <TBL> с использованием набора DocIDs из @uservar       |
| debug wait <cluster> [like 'xx'] [option timeout=3]                     | ждать, пока <cluster> будет готов, но не более 3 секунд.                             |
| debug wait <cluster> status <N> [like 'xx'] [option timeout=13]         | ждать, пока <cluster> достигнет коммита <N>, но не более 13 секунд                    |
| debug meta                                                              | Покажите max_matches/pseudo_shards. Требуется установить profiling=1                     |
| debug trace OFF|'path/to/file' [<N>]                                    | трассировать поток в файл до записи N байт или 'trace OFF'                             |
| debug curl <URL>                                                        | запросить данный URL с помощью libcurl                                                |
+-------------------------------------------------------------------------+----------------------------------------------------------------------------------------+
24 rows in set (0.00 sec)
```

Все команды `debug XXX` следует рассматривать как нестабильные и подлежащие модификации в любое время, поэтому не удивляйтесь, если они изменятся. Этот пример вывода может не отражать фактические доступные команды, поэтому попробуйте на вашей системе, чтобы увидеть, что доступно на вашем экземпляре. Кроме того, подробной документации, кроме этого короткого столбца 'значение', не предоставлено.
В качестве быстрого примера ниже описаны две команды, доступные только клиентам VIP - shutdown и crash. Обе требуют токен, который может быть сгенерирован с помощью подкоманды debug token и добавлен в параметр [shutdown_token](Server_settings/Searchd.md#shutdown_token) в разделе searchd файла конфигурации. Если такой раздел не существует, или если предоставленный хеш пароля не соответствует токену, хранящемуся в конфигурации, подкоманды ничего не сделают.

```sql
mysql> debug token hello;
+-------------+------------------------------------------+
| command     | result                                   |
+-------------+------------------------------------------+
| debug token | aaf4c61ddcc5e8a2dabede0f3b482cd9aea9434d |
+-------------+------------------------------------------+
1 row in set (0,00 sec)
```

Подкоманда `shutdown` отправит сигнал TERM серверу, что приведет к его отключению. Это может быть опасно, так как никто не хочет случайно остановить рабочий сервис. Поэтому она требует VIP-соединения и использования пароля.

Подкоманда `crash` буквально вызывает сбой. Она может использоваться в тестовых целях, например, чтобы протестировать, как менеджер системы поддерживает работоспособность сервиса или протестировать возможность отслеживания дампов памяти.

Если некоторые команды окажутся полезными в более общем контексте, они могут быть перемещены из подкоманд отладки в более стабильное и общее место (как это показано на примере `debug tasks` и `debug sched` в таблице).

<!-- proofread -->


