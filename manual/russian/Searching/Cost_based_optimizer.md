# Оптимизатор на основе стоимости

Когда Manticore выполняет запрос полного сканирования, он может либо использовать обычное сканирование для проверки каждого документа на соответствие фильтрам, либо применять дополнительные данные и/или алгоритмы для ускорения выполнения запроса. Manticore использует оптимизатор на основе стоимости (CBO), также известный как "оптимизатор запросов", чтобы определить, какой подход использовать.

CBO также может улучшить производительность полнотекстовых запросов. См. ниже для получения дополнительных деталей.

CBO может решить заменить один или несколько фильтров запроса на один из следующих объектов, если он определит, что это улучшит производительность:

1. **индекс docid** использует специальный вторичный индекс только для docid, хранящийся в файлах с расширением `.spt`. Помимо улучшения фильтров по идентификаторам документов, индекс docid также используется для ускорения поиска идентификатора документа по идентификатору строки и для ускорения применения больших списков исключения во время запуска демона.
2. **колоночное сканирование** основывается на колонковом хранении и может использоваться только для колонкового атрибута. Оно сканирует каждое значение и проверяет его на соответствие фильтру, но оно сильно оптимизировано и обычно быстрее, чем стандартный подход.
3. **вторичные индексы** создаются для всех атрибутов (кроме JSON) по умолчанию. Они используют [индекс PGM](https://pgm.di.unipi.it/) вместе с самим построенным обращенным индексом Manticore для извлечения списка идентификаторов строк, соответствующих значению или диапазону значений. Вторичные индексы хранятся в файлах с расширениями `.spidx` и `.spjidx`.
Для получения информации о том, как генерировать вторичные индексы для атрибутов JSON, смотрите [json_secondary_indexes](../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#json_secondary_indexes).

Оптимизатор оценивает стоимость каждого пути выполнения, используя различные статистические данные атрибутов, включая:

1. Информацию о распределении данных внутри атрибута (гистограммы, хранящиеся в файлах `.sphi`). Гистограммы создаются автоматически при индексации данных и служат основным источником информации для CBO.
2. Информацию из PGM (вторичные индексы), которая помогает оценить количество списков документов для чтения. Это помогает оценить производительность объединения списков документов и выбрать соответствующий алгоритм объединения (объединение с приоритетной очередью или объединение по битовой карте).
3. Статистику кодирования колонок, используемую для оценки производительности декомпрессии колонковых данных.
4. Дерево мин-макс для колонок. Хотя CBO использует гистограммы для оценки количества документов, оставшихся после применения фильтра, ему также необходимо определить, сколько документов фильтр должен был обработать. Для колонковых атрибутов частичная оценка дерева мин-макс выполняет эту задачу.
5. Словарь полнотекстового поиска. CBO использует статистику терминов для оценки стоимости оценки дерева полнотекстового поиска.

Оптимизатор вычисляет стоимость выполнения для каждого фильтра, используемого в запросе. Поскольку определенные фильтры могут быть заменены несколькими различными объектами (например, для идентификатора документа Manticore может использовать обычное сканирование, поиск по индексу docid, колонковое сканирование (если идентификатор документа является колонковым) и вторичный индекс), оптимизатор оценивает все доступные комбинации. Однако существует максимальный предел в 1024 комбинации.

Чтобы оценить затраты на выполнение запроса, оптимизатор вычисляет оценочные затраты наиболее значительных операций, выполняемых при выполнении запроса. Он использует предустановленные константы для представления стоимости каждой операции.

Оптимизатор сравнивает затраты каждого пути выполнения и выбирает путь с наименьшими затратами для выполнения запроса.

При работе с полнотекстовыми запросами, имеющими фильтры по атрибутам, оптимизатор запросов решает между двумя возможными путями выполнения. Один из них - выполнять полнотекстовый запрос, извлекать совпадения и использовать фильтры. Другой - заменить фильтры одним или несколькими объектами, описанными выше, извлечь идентификаторы строк из них и внедрить их в дерево совпадений полнотекстового поиска. Таким образом, результаты полнотекстового поиска будут пересекаться с результатами полного сканирования. Оптимизатор запросов оценивает стоимость оценки дерева полнотекстового поиска и наилучший возможный путь для вычисления результатов фильтра. Используя эту информацию, оптимизатор выбирает путь выполнения.

Другим фактором, который следует учитывать, является многопоточное выполнение запросов (когда `pseudo_sharding` включен). CBO осведомлен о том, что некоторые запросы могут выполняться в нескольких потоках и учитывает это. CBO приоритизирует более короткое время выполнения запросов (т.е. задержку) над пропускной способностью. Например, если запрос, использующий колонковое сканирование, может выполняться в нескольких потоках (и занимать несколько ядер ЦП), и быстрее, чем запрос, выполняемый в одном потоке с использованием вторичных индексов, предпочтение будет отдано многопоточному выполнению.

Запросы, использующие вторичные индексы и индексы docid, всегда выполняются в одном потоке, поскольку тесты показывают, что выгода от многопоточного выполнения практически отсутствует.

В настоящее время оптимизатор использует только затраты на ЦП и не учитывает использование памяти или диска.

<!-- proofread -->
