# Оптимизатор на основе стоимости

Когда Manticore выполняет запрос с полным сканированием, он может либо использовать простой скан для проверки каждого документа по фильтрам, либо применять дополнительные данные и/или алгоритмы для ускорения выполнения запроса. Manticore использует оптимизатор на основе стоимости (CBO), также известный как "оптимизатор запросов", чтобы определить, какой подход выбрать.

CBO также может улучшать производительность полнотекстовых запросов. Подробнее см. ниже.

CBO может решить заменить один или несколько фильтров запроса на одну из следующих сущностей, если это улучшит производительность:

1. **docid индекс** использует специальный вторичный индекс, содержащий только docid, который хранится в файлах с расширением `.spt`. Кроме улучшения фильтров по идентификаторам документов, индекс docid также используется для ускорения поиска соответствия ID документа строковому ID и для ускорения применения больших списков удаления (killlists) при запуске демона.
2. **колоночное сканирование** основано на колонковом хранении и может использоваться только для колоночного атрибута. Оно сканирует каждое значение и проверяет его по фильтру, но сильно оптимизировано и обычно быстрее стандартного подхода.
3. **вторичные индексы** создаются по всем атрибутам (кроме JSON) по умолчанию. Они используют [PGM индекс](https://pgm.di.unipi.it/) вместе с встроенным обратным индексом Manticore для получения списка строковых ID, соответствующих значению или диапазону значений. Вторичные индексы хранятся в файлах с расширениями `.spidx` и `.spjidx`.
Для информации о том, как создавать вторичные индексы для JSON-атрибутов, см. [json_secondary_indexes](../Creating_a_table/Local_tables/Plain_and_real-time_table_settings.md#json_secondary_indexes).

Оптимизатор оценивает стоимость каждого варианта исполнения, используя различные статистики атрибутов, включая:

1. Информация о распределении данных в атрибуте (гистограммы, хранящиеся в файлах `.sphi`). Гистограммы создаются автоматически при индексации данных и служат основным источником информации для CBO.
2. Данные из PGM (вторичные индексы), которые помогают оценить количество списков документов для чтения. Это помогает оценить производительность слияния списков документов и выбрать подходящий алгоритм слияния (слияние с приоритетной очередью или слияние битмапов).
3. Статистика колонкового кодирования, используемая для оценки производительности декомпрессии колонковых данных.
4. Колонковое дерево min-max. В то время как CBO использует гистограммы для оценки количества документов, оставшихся после применения фильтра, ему также нужно определить, сколько документов пришлось обработать фильтру. Для колоночных атрибутов частичная оценка дерева min-max служит этой цели.
5. Полнотекстовый словарь. CBO использует статистику терминов для оценки стоимости оценки полнотекстового дерева.

Оптимизатор вычисляет стоимость выполнения для каждого фильтра, используемого в запросе. Поскольку некоторые фильтры могут быть заменены несколькими разными сущностями (например, для id документа Manticore может использовать простой скан, поиск по docid индексу, колоночное сканирование (если id документа колоночный) и вторичный индекс), оптимизатор оценивает все доступные комбинации. Однако существует максимальный предел в 1024 комбинации.

Для оценки стоимости выполнения запроса оптимизатор рассчитывает оценочные затраты на самые значимые операции при выполнении запроса. Для представления стоимости каждой операции используются заданные константы.

Оптимизатор сравнивает стоимости каждого варианта исполнения и выбирает путь с наименьшей стоимостью для выполнения запроса.

При работе с полнотекстовыми запросами, имеющими фильтры по атрибутам, оптимизатор запроса выбирает между двумя возможными путями исполнения. Первый — выполнить полнотекстовый запрос, получить совпадения и применить фильтры. Второй — заменить фильтры одной или несколькими вышеописанными сущностями, получить rowid из них и внедрить их в дерево полнотекстового поиска. Таким образом, результаты полнотекстового поиска будут пересекаться с результатами полного сканирования. Оптимизатор оценивает стоимость оценки полнотекстового дерева и наилучший возможный путь вычисления результатов фильтра. Используя эту информацию, оптимизатор выбирает путь исполнения.

Еще один фактор — многопоточное выполнение запроса (когда включен `pseudo_sharding`). CBO учитывает, что некоторые запросы могут выполняться в нескольких потоках и принимает это в расчет. CBO отдает приоритет сокращению времени выполнения запроса (т.е. задержке) над пропускной способностью. Например, если запрос с колоночным сканированием может быть выполнен в нескольких потоках (и использовать несколько ядер процессора) и выполняется быстрее, чем запрос, исполняемый в одном потоке с использованием вторичных индексов, будет предпочтено многопоточное выполнение.

Запросы с использованием вторичных индексов и индексов docid всегда выполняются в одном потоке, так как бенчмарки показывают, что многопоточность не дает заметного преимущества.

В настоящее время оптимизатор учитывает только затраты ЦПУ и не принимает во внимание использование памяти или диска.

<!-- proofread -->

