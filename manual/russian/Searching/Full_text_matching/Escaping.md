# Экранирование символов в строке запроса

Поскольку определённые символы выполняют функции операторов в строке запроса, их необходимо экранировать, чтобы предотвратить ошибки запроса или нежелательные условия совпадения.

Следующие символы следует экранировать с помощью обратного слэша (`\`):

```
!    "    $    '    (    )    -    /    <    @    \    ^    |    ~
```

## В командной строке MySQL

Чтобы экранировать одинарную кавычку ('), используйте один обратный слэш:
```sql
SELECT * FROM your_index WHERE MATCH('l\'italiano');
```


Для остальных символов из списка выше, которые являются операторами или конструкциями запроса, они должны рассматриваться движком как простые символы с предшествующим символом экранирования.
Обратный слэш также необходимо экранировать, используя два обратных слэша:

```sql
SELECT * FROM your_index WHERE MATCH('r\\&b | \\(official video\\)');
```

Чтобы использовать обратный слэш как символ, нужно экранировать и обратный слэш как символ, и обратный слэш как оператор экранирования, что требует четырёх обратных слэшей:

```sql
SELECT * FROM your_index WHERE MATCH('\\\\ABC');
```

Когда вы работаете с JSON-данными в Manticore Search и нужно включить двойную кавычку (`"`) в строку JSON, важно правильно её экранировать. В JSON двойная кавычка внутри строки экранируется обратным слэшем (`\`). Однако при вставке JSON-данных через SQL-запрос Manticore Search интерпретирует обратный слэш (`\`) как символ экранирования внутри строк.

Чтобы двойная кавычка корректно вставилась в JSON-данные, нужно экранировать сам обратный слэш. Это приводит к использованию двух обратных слэшей (`\\`) перед двойной кавычкой. Например:

```sql
insert into tbl(j) values('{"a": "\\"abc\\""}');
```

## Использование драйверов MySQL

Драйверы MySQL предоставляют функции экранирования (например, `mysqli_real_escape_string` в PHP или `conn.escape_string` в Python), но они экранируют только определённые символы.
Вам всё равно нужно добавить экранирование для символов из ранее упомянутого списка, которые не экранируются соответствующими функциями.
Поскольку эти функции экранируют обратный слэш за вас, вам нужно добавить только один обратный слэш.

Это также применимо к драйверам, поддерживающим (на стороне клиента) подготовленные выражения. Например, при использовании подготовленных выражений PHP PDO необходимо добавить обратный слэш для символа `$`:

```php
$statement = $ln_sph->prepare( "SELECT * FROM index WHERE MATCH(:match)");
$match = '\$manticore';
$statement->bindParam(':match',$match,PDO::PARAM_STR);
$results = $statement->execute();
```

Это приводит к окончательному запросу `SELECT * FROM index WHERE MATCH('\\$manticore');`

## В HTTP JSON API

Правила для протокола SQL применимы аналогично, за исключением того, что для JSON двойная кавычка должна экранироваться одним обратным слэшем, а остальные символы требуют двойного экранирования.

При использовании JSON-библиотек или функций, преобразующих структуры данных в JSON-строки, двойная кавычка и одиночный обратный слэш автоматически экранируются этими функциями и не требуют явного экранирования.



## В клиентах

[Официальные клиенты](https://github.com/manticoresoftware/) используют общие JSON-библиотеки/функции, доступные в соответствующих языках программирования. Применяются те же правила экранирования, описанные выше.


## Экранирование звёздочки

Звёздочка (`*`) — уникальный символ, который выполняет две функции:
* в качестве подстановочного символа (префикса/суффикса)
* как модификатор для любого термина в поиске фраз.

В отличие от других специальных символов, которые выступают операторами, звёздочку нельзя экранировать, когда она выполняет одну из своих функций.

В запросах без подстановочных символов звёздочка не требует экранирования, независимо от того, находится ли она в `charset_table`.

В запросах с подстановочными символами звёздочка в середине слова не требует экранирования. В качестве оператора подстановки (в начале или конце слова) звёздочка всегда будет интерпретироваться как оператор подстановки, даже если применяется экранирование.

## Экранирование имён JSON-узлов в SQL

Чтобы экранировать специальные символы в JSON-узлах, используйте обратные кавычки. Например:

```sql
MySQL [(none)]> select * from t where json.`a=b`=234;
+---------------------+-------------+------+
| id                  | json        | text |
+---------------------+-------------+------+
| 8215557549554925578 | {"a=b":234} |      |
+---------------------+-------------+------+

MySQL [(none)]> select * from t where json.`a:b`=123;
+---------------------+-------------+------+
| id                  | json        | text |
+---------------------+-------------+------+
| 8215557549554925577 | {"a:b":123} |      |
+---------------------+-------------+------+
```
<!-- proofread -->

