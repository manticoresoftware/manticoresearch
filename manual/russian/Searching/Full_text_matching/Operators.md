# Операторы полнотекстового поиска

Строка запроса может включать специальные операторы, определяющие условия сопоставления слов из строки запроса.

### Логические операторы

#### Оператор AND

Подразумеваемый логический оператор AND всегда присутствует, поэтому "hello world" означает, что в подходящем документе должны быть найдены как "hello", так и "world".

```sql
hello  world
```

Примечание: Явного оператора `AND` нет.

#### Оператор OR

Логический оператор OR `|` имеет более высокий приоритет, чем AND, поэтому `looking for cat | dog | mouse` означает `looking for (cat | dog | mouse)`, а не `(looking for cat) | dog | mouse`.

```sql
hello | world
```

Примечание: Оператора `OR` не существует. Используйте для этого `|`.

### Оператор MAYBE

```sql
hello MAYBE world
```

Оператор `MAYBE` работает аналогично оператору `|`, но не возвращает документы, которые соответствуют только правому поддереву выражения.

### Оператор отрицания

```sql
hello -world
hello !world
```

Оператор отрицания накладывает условие отсутствия слова.

Запросы, содержащие **только** отрицания, по умолчанию **не поддерживаются**. Для включения используйте опцию сервера [not_terms_only_allowed](../../Server_settings/Searchd.md#not_terms_only_allowed).

### Оператор поиска по полю

```sql
@title hello @body world
```

Оператор ограничения по полю ограничивает последующий поиск указанным полем. По умолчанию запрос завершится ошибкой, если указанное имя поля отсутствует в таблице. Однако это поведение можно подавить, указав опцию `@@relaxed` в начале запроса:

```sql
@@relaxed @nosuchfield my query
```

Это может быть полезно при поиске по неоднородным таблицам с разными схемами.

Ограничение по позиции в поле дополнительно ограничивает поиск первыми N позициями в выбранном поле (или полях). Например, `@body [50] hello` не будет находить документы, где ключевое слово `hello` находится на позиции 51 или позже в поле body.

```sql
@body[50] hello
```

Оператор поиска по нескольким полям:

```sql
@(title,body) hello world
```

Игнорирование оператора поиска по полю (игнорирует любые совпадения `hello world` из поля `title`):

```sql
@!title hello world
```

Игнорирование оператора поиска по нескольким полям (если есть поля `title`, `subject` и `body`, то `@!(title)` эквивалентно `@(subject,body)`):

```sql
@!(title,body) hello world
```

Оператор поиска по всем полям:

```sql
@* hello
```

### Оператор поиска по фразе

```sql
"hello world"
```

Оператор фразы требует, чтобы слова были расположены рядом друг с другом.

Оператор фразы может включать модификатор `match any term`. В пределах оператора фразы значения слов учитывают позицию. При использовании модификатора «match any term» позиции следующих слов в этом запросе сдвигаются. В результате модификатор «match any» не влияет на производительность поиска.

```sql
"exact * phrase * * for terms"
```

### Оператор поиска по близости

```sql
"hello world"~10
```

Расстояние близости измеряется в словах и применяется ко всем словам в кавычках. Например, запрос `"cat dog mouse"~5` означает, что должен быть отрезок меньше 8 слов, содержащий все 3 слова. Поэтому документ с `CAT aaa bbb ccc DOG eee fff MOUSE` не будет соответствовать этому запросу, поскольку отрезок ровно 8 слов.

### Оператор кворума

```sql
"the world is a wonderful place"/3
```

Оператор кворума задает тип нечеткого сопоставления. Он находит только такие документы, которые содержат заданный порог слов. В приведенном примере (`"the world is a wonderful place"/3`) будут найдены все документы, содержащие как минимум 3 из 6 указанных слов. Оператор ограничен 255 ключевыми словами. Вместо абсолютного числа можно указать значение от 0.0 до 1.0 (от 0% до 100%), и Manticore найдет документы, содержащие не менее указанного процента из заданных слов. Тот же пример можно записать как `"the world is a wonderful place"/0.5`, и он будет находить документы с хотя бы 50% из 6 слов.

### Оператор строгого порядка

```sql
aaa << bbb << ccc
```

Оператор строгого порядка (также известный как оператор «before») совпадает с документом только тогда, когда ключевые слова его аргумента появляются в документе ровно в том порядке, который указан в запросе. Например, запрос `black << cat` совпадет с документом "black and white cat", но не с документом "that cat was black". Оператор порядка имеет самый низкий приоритет. Его можно применять как к отдельным ключевым словам, так и к более сложным выражениям. Например, следующий запрос является допустимым:

```sql
(bag of words) << "exact phrase" << red|green|blue
```

### Модификатор точной формы

```sql
raining =cats and =dogs
="exact phrase"
```

Модификатор точной формы ключевого слова совпадает с документом только если слово в точной форме указано в запросе. По умолчанию считается совпадением документ, где совпало слово после стемминга/лемматизации. Например, запрос "runs" совпадает и с документом, где есть "runs", и с документом, где есть "running", так как обе формы сводятся к "run". Однако запрос `=runs` совпадает только с первым документом. Для работы модификатора точной формы должна быть включена опция [index_exact_words](../../Creating_a_table/NLP_and_tokenization/Morphology.md#index_exact_words).

Еще один сценарий использования – запрет [расширения](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expand_keywords) ключевого слова до вида `*keyword*`. Например, при `index_exact_words=1` + `expand_keywords=1/star`, запрос `bcd` найдет документ с `abcde`, а `=bcd` — нет.

Как модификатор ключевого слова, он может использоваться внутри таких операторов, как фраза, близость и кворум. Применение модификатора точной формы к оператору фразы добавляет точную форму ко всем словам этой фразы.

### Операторы с подстановочными знаками (wildcard)

```sql
nation* *nation* *national
```

Требуется [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) для префиксного (расширение в конце) и/или суффиксного (расширение в начале) поиска. Если требуется только префиксный поиск, можно использовать [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len).

Поиск попытается найти все расширения подстановочных токенов, и каждое расширение будет зафиксировано как совпавшее попадание. Количество расширений для токена можно контролировать с помощью настройки таблицы [expansion_limit](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expansion_limit). Подстановочные токены могут значительно влиять на время поиска запроса, особенно когда токены имеют короткую длину. В таких случаях желательно использовать лимит расширений.

Оператор подстановки может быть автоматически применён, если используется настройка таблицы [expand_keywords](../../Searching/Options.md#expand_keywords).

Кроме того, поддерживаются следующие встроенные операторы подстановки:

* `?` может сопоставлять любой один символ: `t?st` совпадёт с `test`, но не с `teast`
* `%` может сопоставлять ноль или один символ: `tes%` совпадёт с `tes` или `test`, но не с `testing`

Встроенные операторы требуют `dict=keywords` (включено по умолчанию) и включение префиксов/инфиксных совпадений.

### Оператор REGEX

```sql
REGEX(/t.?e/)
```

Требует установки опций [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) или [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len) и [dict](../../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#dict)=keywords (что является настройкой по умолчанию).

Аналогично [операторам с подстановками](../../Searching/Full_text_matching/Operators.md#Wildcard-operators), оператор REGEX пытается найти все токены, которые совпадают с предоставленным шаблоном, и каждое расширение фиксируется как совпавшее. Обратите внимание, что это может существенно повлиять на время поиска запроса, так как весь словарь сканируется, и каждый термин в словаре проверяется на соответствие REGEX-шаблону.

Шаблоны должны соответствовать синтаксису [RE2](https://github.com/google/re2/wiki/Syntax). Разделителем выражения REGEX является первый символ после открывающей скобки. Другими словами, весь текст между открывающей скобкой, за которой следует разделитель, и разделителем, за которым следует закрывающая скобка, считается выражением RE2.
Обратите внимание, что термины, хранящиеся в словаре, подвергаются преобразованию через `charset_table`, то есть, например, REGEX может не сопоставлять заглавные символы, если все символы приведены к нижнему регистру согласно `charset_table` (что происходит по умолчанию). Для успешного сопоставления термина с использованием выражения REGEX шаблон должен соответствовать всему токену. Для частичного совпадения поместите `.*` в начале и/или в конце вашего шаблона.

```sql
REGEX(/.{3}t/)
REGEX(/t.*\d*/)
```

### Модификатор начала и конца поля

```sql
^hello world$
```

Модификаторы ключевых слов начала поля и конца поля обеспечивают совпадение ключевого слова только если оно появляется в самом начале или самом конце полного текстового поля соответственно. Например, запрос `"^hello world$"` (заключенный в кавычки для объединения оператора фразы с модификаторами начала/конца) будет совпадать исключительно с документами, содержащими по крайней мере одно поле с этими двумя конкретными ключевыми словами.

### Модификатор усиления IDF

```sql
boosted^1.234 boostedfieldend$^1.234
```

Модификатор усиления повышает [IDF](../../Searching/Options.md#idf)_оценку слова на указанный коэффициент в рейтинговых оценках, которые учитывают IDF в своих вычислениях. Он не влияет на процесс сопоставления каким-либо образом.

### Оператор NEAR

```sql
hello NEAR/3 world NEAR/4 "my test"
```

Оператор `NEAR` является более обобщённой версией оператора близости. Его синтаксис — `NEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NEAR`, знаком слэша и значением расстояния.

В то время как исходный оператор близости работает только с наборами ключевых слов, `NEAR` является более универсальным и может принимать произвольные подвыражения в качестве своих двух аргументов. Он сопоставляет документ, когда оба подвыражения находятся друг от друга на расстоянии не более N слов, независимо от их порядка. `NEAR` является левосторонне ассоциативным и имеет тот же (низший) приоритет, что и [BEFORE](../../Searching/Full_text_matching/Operators.md#Strict-order-operator).

Важно отметить, что `one NEAR/7 two NEAR/7 three` не полностью эквивалентно `"one two three"~7`. Ключевое отличие состоит в том, что оператор близости допускает до 6 несовпадающих слов между всеми тремя совпадающими словами, тогда как версия с `NEAR` менее ограничительна: она допускает до 6 слов между `one` и `two`, а затем еще до 6 слов между этим двухсловным совпадением и `three`.

### Оператор NOTNEAR

```sql
Church NOTNEAR/3 street
```
Оператор `NOTNEAR` служит негативным утверждением. Он сопоставляет документ, когда левый аргумент присутствует, а либо правый аргумент отсутствует в документе, либо правый аргумент находится на указанном расстоянии от конца левого совпавшего аргумента. Расстояние указано в словах. Синтаксис — `NOTNEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NOTNEAR`, знаком слэша и значением расстояния. Оба аргумента этого оператора могут быть терминами, любыми операторами или группой операторов.

### Операторы SENTENCE и PARAGRAPH

```sql
all SENTENCE words SENTENCE "in one sentence"
```


```sql
"Bill Gates" PARAGRAPH "Steve Jobs"
```
Операторы `SENTENCE` и `PARAGRAPH` сопоставляют документ, когда оба их аргумента находятся в одном и том же предложении или одном и том же абзаце текста соответственно. Эти аргументы могут быть ключевыми словами, фразами или экземплярами того же оператора.

Порядок аргументов внутри предложения или абзаца не имеет значения. Эти операторы работают только с таблицами, построенными с включенной функцией [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp) (функция индексирования предложений и абзацев) и в противном случае сводятся к простому оператору AND. Для информации о том, что считать предложением и абзацем, смотрите документацию по директиве [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp).


### Оператор ограничения ZONE

```sql
ZONE:(h3,h4)

only in these titles
```

Оператор `ZONE limit` очень похож на оператор ограничения поля, но ограничивает совпадение в указанной зоне внутри поля или списке зон. Важно отметить, что последующие подвыражения не обязательно должны совпадать в одном непрерывном промежутке заданной зоны и могут совпадать через несколько промежутков. Например, запрос `(ZONE:th hello world)` будет соответствовать следующему примеру документа:

```html
<th>Table 1. Local awareness of Hello Kitty brand.</th>
.. some table data goes here ..
<th>Table 2. World-wide brand awareness.</th>
```

Оператор `ZONE` воздействует на запрос до следующего оператора ограничения поля или `ZONE`, либо до закрывающей скобки. Он работает исключительно с таблицами, построенными с поддержкой зон (см. [index_zones](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_zones)), и в противном случае будет игнорироваться.

### Оператор ограничения ZONESPAN

```sql
ZONESPAN:(h2)

only in a (single) title
```

Оператор ограничения `ZONESPAN` похож на оператор `ZONE`, но требует, чтобы совпадение происходило в одном непрерывном промежутке. В приведённом ранее примере `ZONESPAN:th hello world` не совпадёт с документом, так как "hello" и "world" не находятся в одном и том же промежутке.

<!-- proofread -->

