# Полнотекстовые операторы

Строка запроса может включать определённые операторы, которые задают условия для того, как слова из строки запроса должны сопоставляться.

### Булевы операторы

#### Оператор AND

Неявный логический оператор AND всегда присутствует, поэтому "hello world" подразумевает, что в сопоставляемом документе должны быть найдены как "hello", так и "world".

```sql
hello  world
```

Примечание: явного оператора `AND` нет.

#### Оператор OR

Логический оператор OR `|` имеет более высокий приоритет, чем AND, поэтому `looking for cat | dog | mouse` означает `looking for (cat | dog | mouse)`, а не `(looking for cat) | dog | mouse`.

```sql
hello | world
```

Примечание: оператора `OR` не существует. Используйте `|`.

### Оператор MAYBE

```sql
hello MAYBE world
```

Оператор `MAYBE` работает аналогично оператору `|`, но он не возвращает документы, которые совпадают только с выражением справа.

### Оператор отрицания

```sql
hello -world
hello !world
```

Оператор отрицания накладывает правило, что слово не должно присутствовать.

Запросы, содержащие **только** операторы отрицания, по умолчанию **не поддерживаются**. Для включения используйте опцию сервера [not_terms_only_allowed](../../Server_settings/Searchd.md#not_terms_only_allowed).

### Оператор поиска по полю

```sql
@title hello @body world
```

Оператор ограничения по полю ограничивает последующий поиск указанным полем. По умолчанию запрос завершится ошибкой, если указанное имя поля отсутствует в искомой таблице. Однако это поведение можно отключить, указав опцию `@@relaxed` в начале запроса:

```sql
@@relaxed @nosuchfield my query
```

Это может быть полезно при поиске по гетерогенным таблицам с разными схемами.

Ограничения по позициям внутри поля дополнительно сужают поиск к первым N позициям в заданном поле (или полях). Например, `@body [50] hello` не будет совпадать с документами, где ключевое слово `hello` находится на позиции 51 или позже в поле body.

```sql
@body[50] hello
```

Оператор поиска по нескольким полям:

```sql
@(title,body) hello world
```

Игнорирование оператора поиска по полю (игнорирует любые совпадения 'hello world' из поля 'title'):

```sql
@!title hello world
```

Игнорирование оператора поиска по нескольким полям (если поля 'title', 'subject' и 'body' существуют, то `@!(title)` эквивалентно `@(subject,body)`):

```sql
@!(title,body) hello world
```

Оператор поиска по всем полям:

```sql
@* hello
```

### Оператор поиска фразы

```sql
"hello world"
```

Оператор фразы требует, чтобы слова находились рядом друг с другом.

Оператор поиска фразы может содержать модификатор `match any term` (совпадение любого термина). Внутри оператора фразы термины позиционно значимы. При использовании модификатора «совпадения любого» позиции последующих терминов в запросе с фразой будут смещены. Следовательно, модификатор «совпадения любого» не влияет на производительность поиска.

```sql
"exact * phrase * * for terms"
```

Вы также можете использовать оператор OR внутри кавычек. Оператор OR (`|`) должен быть заключён в скобки `()`, если используется внутри фраз. Каждая опция проверяется на той же позиции, и фраза совпадает, если любая из опций подходит для этой позиции.

**Корректные примеры** (со скобками):
```sql
"( a | b ) c"
"( ( a b c ) | d ) e"
"man ( happy | sad ) but all ( ( as good ) | ( as fast ) )"
```

**Некорректные примеры** (без скобок — они не будут работать):
```sql
"a | b c"
"happy | sad"
```

### Оператор приближённого поиска

```sql
"hello world"~10
```

Расстояние приближённого поиска измеряется в словах, с учётом их количества, и применяется ко всем словам внутри кавычек. Например, запрос `"cat dog mouse"~5` означает, что должен быть фрагмент длиной менее 8 слов, содержащий все 3 слова. Следовательно, документ с `CAT aaa bbb ccc DOG eee fff MOUSE` не будет соответствовать этому запросу, так как интервал ровно из 8 слов.

Вы также можете использовать оператор OR внутри приближённого поиска. Оператор OR (`|`) должен быть заключён в скобки `()`, если используется внутри приближённого поиска. Каждая опция проверяется отдельно.

**Корректный пример** (со скобками):
```sql
"( two | four ) fish chips"~5
```

**Некорректный пример** (без скобок — не будет работать):
```sql
"two | four fish chips"~5
```

### Оператор кворума совпадений

```sql
"the world is a wonderful place"/3
```

Оператор кворума совпадений вводит тип нечёткого сопоставления. Он совпадает только с теми документами, которые удовлетворяют заданному порогу указанного количества слов. В приведённом выше примере (`"the world is a wonderful place"/3`) он совпадёт со всеми документами, содержащими как минимум 3 из 6 заданных слов. Оператор ограничен 255 ключевыми словами. Вместо абсолютного числа можно также указать значение от 0.0 до 1.0 (представляющее 0% и 100%), и Manticore будет совпадать только с документами, содержащими не менее указанного процента слов. Тот же пример можно записать как `"the world is a wonderful place"/0.5`, и он будет совпадать с документами, содержащими не менее 50% из 6 слов.

Оператор кворума поддерживает оператор OR (`|`). Оператор OR (`|`) должен быть окружён скобками `()`, когда используется внутри кворума совпадений. К совпадению засчитывается только одно слово из каждой группы OR.

**Корректные примеры** (со скобками):
```sql
"( ( a b c ) | d ) e f g"/0.5
"happy ( sad | angry ) man"/2
```

**Некорректный пример** (без скобок — не будет работать):
```sql
"a b c | d e f g"/0.5
```

### Оператор строгого порядка

```sql
aaa << bbb << ccc
```

Оператор строгого порядка (также известный как оператор "before") совпадает с документом только в том случае, если ключевые слова его аргумента появляются в документе именно в том порядке, в каком они указаны в запросе. Например, запрос `black << cat` совпадёт с документом "black and white cat", но не с документом "that cat was black". Оператор порядка имеет самый низкий приоритет. Он может применяться как к отдельным ключевым словам, так и к более сложным выражениям. Например, это валидный запрос:

```sql
(bag of words) << "exact phrase" << red|green|blue
```

### Модификатор точной формы

```sql
raining =cats and =dogs
="exact phrase"
```

Модификатор точной формы ключевого слова совпадает с документом только если ключевое слово встречается в точной форме, указанной в запросе. По умолчанию документ считается совпадающим, если совпадает основная/лемматизированная форма ключевого слова. Например, запрос "runs" совпадёт с документом, содержащим "runs", и с документом, содержащим "running", потому что обе формы сводятся к основе "run". Однако запрос `=runs` совпадёт только с первым документом. Модификатор точной формы требует включения опции [index_exact_words](../../Creating_a_table/NLP_and_tokenization/Morphology.md#index_exact_words).

Еще один сценарий использования — предотвращение [расширения](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expand_keywords) ключевого слова до его формы `*keyword*`. Например, при `index_exact_words=1` + `expand_keywords=1/star`, `bcd` найдет документ, содержащий `abcde`, но `=bcd` — нет.

Как модификатор, влияющий на ключевое слово, он может использоваться внутри операторов, таких как операторы фразы, близости и кворума. Применение модификатора точной формы к оператору фразы возможно, и в этом случае он внутренне добавляет модификатор точной формы ко всем терминам в фразе.

### Операторы с подстановочными знаками

```sql
nation* *nation* *national
```

Требует [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) для префикса (расширение в конце) и/или суффикса (расширение в начале). Если требуется только префиксное расширение, можно использовать [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len).

Поиск попытается найти все расширения токенов с подстановочными знаками, и каждое расширение фиксируется как совпадение. Количество расширений для токена можно контролировать с помощью настройки таблицы [expansion_limit](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expansion_limit). Токены с подстановочными знаками могут значительно увеличить время поиска запроса, особенно если длина токенов мала. В таких случаях желательно использовать лимит расширения.

Оператор с подстановочным знаком может быть применен автоматически, если используется настройка таблицы [expand_keywords](../../Searching/Options.md#expand_keywords).

Кроме того, поддерживаются следующие встроенные операторы с подстановочными знаками:

* `?` может совпадать с любым одним символом: `t?st` совпадет с `test`, но не с `teast`
* `%` может совпадать с нулем или одним символом: `tes%` совпадет с `tes` или `test`, но не с `testing`

Встроенные операторы требуют `dict=keywords` (включено по умолчанию) и включенного префиксного/инфиксного расширения.

### Оператор REGEX

```sql
REGEX(/t.?e/)
```

Требует, чтобы были установлены параметры [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) или [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len) и [dict](../../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#dict)=keywords (что является значением по умолчанию).

Аналогично [операторам с подстановочными знаками](../../Searching/Full_text_matching/Operators.md#Wildcard-operators), оператор REGEX пытается найти все токены, совпадающие с заданным шаблоном, и каждое расширение фиксируется как совпадение. Обратите внимание, это может существенно увеличить время поиска запроса, так как происходит сканирование всего словаря, и каждый термин словаря проверяется на соответствие шаблону REGEX.

Шаблоны должны соответствовать [синтаксису RE2](https://github.com/google/re2/wiki/Syntax). Разделителем выражения REGEX является первый символ после открывающей скобки. Другими словами, весь текст между открывающей скобкой со следующим за ней разделителем и таким же разделителем с закрывающей скобкой считается выражением RE2.
Обратите внимание, что термины, хранящиеся в словаре, подвергаются преобразованию согласно `charset_table`, что означает, например, что REGEX может не суметь найти совпадения с заглавными символами, если все символы приведены к нижнему регистру по `charset_table` (что происходит по умолчанию). Чтобы успешно найти термин с помощью выражения REGEX, шаблон должен соответствовать всему токену целиком. Для частичного совпадения разместите `.*` в начале и/или в конце вашего шаблона.

```sql
REGEX(/.{3}t/)
REGEX(/t.*\d*/)
```

### Модификаторы начала и конца поля

```sql
^hello world$
```

Модификаторы ключевого слова начала и конца поля гарантируют, что ключевое слово совпадет только в случае его появления ровно в начале или ровно в конце полного текстового поля соответственно. Например, запрос `"^hello world$"` (в кавычках, чтобы совместить оператор фразы с модификаторами начала/конца) будет соответствовать исключительно документам, содержащим хотя бы одно поле с этими двумя конкретными ключевыми словами.

### Модификатор повышения IDF

```sql
boosted^1.234 boostedfieldend$^1.234
```

Модификатор повышения повышает [IDF](../../Searching/Options.md#idf)_оценку слова в ранжировании на указанный коэффициент, если расчет ранжирования учитывает IDF. Он не влияет на процесс сопоставления.

### Оператор NEAR

```sql
hello NEAR/3 world NEAR/4 "my test"
```

Оператор `NEAR` является более общей версией оператора близости. Его синтаксис — `NEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NEAR`, косой чертой и значением расстояния.

В то время как исходный оператор близости работает только с наборами ключевых слов, `NEAR` более универсален и может принимать произвольные подвыражения в качестве двух аргументов. Он соответствует документу, когда оба подвыражения найдены в пределах N слов друг от друга, независимо от их порядка. `NEAR` связывается слева и имеет такой же (низший) приоритет, как и [BEFORE](../../Searching/Full_text_matching/Operators.md#Strict-order-operator).

Важный момент: выражение `one NEAR/7 two NEAR/7 three` не совсем равно `"one two three"~7`. Главное отличие в том, что оператор близости допускает до 6 несопоставляющихся слов между всеми тремя совпадающими словами, тогда как версия с `NEAR` менее строгая: она разрешает до 6 слов между `one` и `two`, а затем еще до 6 слов между этим совпадением из двух слов и словом `three`.

### Оператор NOTNEAR

```sql
Church NOTNEAR/3 street
```
Оператор `NOTNEAR` служит отрицательным утверждением. Он соответствует документу, если левый аргумент присутствует, а правый отсутствует в документе или правый аргумент находится на заданном расстоянии от конца совпавшего левого аргумента. Расстояние измеряется в словах. Синтаксис — `NOTNEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NOTNEAR`, косой чертой и значением расстояния. Оба аргумента этого оператора могут быть терминами, любыми операторами или группами операторов.

### Операторы SENTENCE и PARAGRAPH

```sql
all SENTENCE words SENTENCE "in one sentence"
```


```sql
"Bill Gates" PARAGRAPH "Steve Jobs"
```
Операторы `SENTENCE` и `PARAGRAPH` соответствуют документу, когда оба их аргумента находятся в одном предложении или одном абзаце текста соответственно. Эти аргументы могут быть ключевыми словами, фразами или экземплярами одного и того же оператора.

Порядок аргументов внутри предложения или абзаца не имеет значения. Эти операторы работают только с таблицами, построенными с включенной функцией [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp) (индексация предложений и абзацев), и в противном случае возвращаются к простой операции AND. Для получения информации о том, что составляет предложение и абзац, обратитесь к документации директивы [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp).


### Оператор ограничения ZONE

```sql
ZONE:(h3,h4)

only in these titles
```

Оператор `ZONE limit` сильно напоминает оператор ограничения поля, но ограничивает соответствие заданной зоне в поле или списку зон. Важно отметить, что последующие подвыражения не обязательно должны соответствовать в пределах одного непрерывного промежутка одной и той же зоны и могут соответствовать через несколько промежутков. Например, запрос `(ZONE:th hello world)` будет соответствовать следующему образцу документа:

```html
<th>Table 1. Local awareness of Hello Kitty brand.</th>
.. some table data goes here ..
<th>Table 2. World-wide brand awareness.</th>
```

Оператор `ZONE` влияет на запрос до следующего оператора ограничения поля или `ZONE`, или до закрывающей скобки. Он функционирует исключительно с таблицами, построенными с поддержкой зон (обратитесь к [index_zones](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_zones)), и будет проигнорирован в противном случае.

### Оператор ограничения ZONESPAN

```sql
ZONESPAN:(h2)

only in a (single) title
```

Оператор ограничения `ZONESPAN` напоминает оператор `ZONE`, но требует, чтобы соответствие происходило в пределах одного непрерывного промежутка. В приведенном ранее примере `ZONESPAN:th hello world` не будет соответствовать документу, так как "hello" и "world" не появляются в одном промежутке.

<!-- proofread -->

