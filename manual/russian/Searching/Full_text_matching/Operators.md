# Полнотекстовые операторы

Строка запроса может включать специальные операторы, которые определяют условия того, как слова из строки запроса должны сопоставляться.

### Булевы операторы

#### Оператор AND

Неявный логический оператор AND всегда присутствует, поэтому "hello world" означает, что в совпадающем документе должны быть найдены и "hello", и "world".

```sql
hello  world
```

Примечание: явного оператора `AND` нет.

#### Оператор OR

Логический оператор OR `|` имеет более высокий приоритет, чем AND, поэтому `looking for cat | dog | mouse` означает `looking for (cat | dog | mouse)`, а не `(looking for cat) | dog | mouse`.

```sql
hello | world
```

Примечание: оператора `OR` нет. Пожалуйста, используйте `|`.

### Оператор MAYBE

```sql
hello MAYBE world
```

Оператор `MAYBE` работает аналогично оператору `|`, но не возвращает документы, которые совпадают только с выражением правого поддерева.

### Оператор отрицания

```sql
hello -world
hello !world
```

Оператор отрицания задаёт правило, что слово не должно присутствовать.

Запросы, содержащие **только** отрицания, по умолчанию **не поддерживаются**. Чтобы включить поддержку, используйте опцию сервера [not_terms_only_allowed](../../Server_settings/Searchd.md#not_terms_only_allowed).

### Оператор поиска по полю

```sql
@title hello @body world
```

Оператор ограничения поля ограничивает последующий поиск указанным полем. По умолчанию запрос завершится ошибкой, если указанное имя поля отсутствует в таблице поиска. Однако это поведение можно подавить, указав опцию `@@relaxed` в начале запроса:

```sql
@@relaxed @nosuchfield my query
```

Это может быть полезно при поиске по гетерогенным таблицам с разными схемами.

Ограничения по позиции в поле дополнительно ограничивают поиск первыми N позициями в указанном поле (или полях). Например, `@body [50] hello` не совпадёт с документами, где ключевое слово `hello` встречается на позиции 51 или позже в поле body.

```sql
@body[50] hello
```

Оператор поиска по нескольким полям:

```sql
@(title,body) hello world
```

Оператор игнорирования поиска по полю (игнорирует любые совпадения 'hello world' из поля 'title'):

```sql
@!title hello world
```

Оператор игнорирования поиска по нескольким полям (если есть поля 'title', 'subject' и 'body', то `@!(title)` эквивалентен `@(subject,body)`):

```sql
@!(title,body) hello world
```

Оператор поиска по всем полям:

```sql
@* hello
```

### Оператор поиска фразы

```sql
"hello world"
```

Оператор фразы требует, чтобы слова шли подряд.

Оператор поиска фразы может включать модификатор `match any term`. Внутри оператора фразы термины имеют позиционное значение. При использовании модификатора 'match any term' позиции последующих терминов в запросе с фразой будут сдвинуты. В результате модификатор 'match any' не влияет на производительность поиска.

```sql
"exact * phrase * * for terms"
```

Также можно использовать оператор OR внутри кавычек. Оператор OR (`|`) должен быть заключён в скобки `()` при использовании внутри фраз. Каждая опция проверяется на той же позиции, и фраза совпадает, если любая из опций подходит для этой позиции.

**Правильные примеры** (со скобками):
```sql
"( a | b ) c"
"( ( a b c ) | d ) e"
"man ( happy | sad ) but all ( ( as good ) | ( as fast ) )"
```

**Неправильные примеры** (без скобок — не будут работать):
```sql
"a | b c"
"happy | sad"
```

### Оператор поиска по близости

```sql
"hello world"~10
```

Расстояние близости измеряется в словах, учитывая количество слов, и применяется ко всем словам в кавычках. Например, запрос `"cat dog mouse"~5` означает, что должен быть интервал менее 8 слов, содержащий все 3 слова. Следовательно, документ с `CAT aaa bbb ccc DOG eee fff MOUSE` не совпадёт с этим запросом, так как интервал ровно 8 слов.

Также можно использовать оператор OR внутри поиска по близости. Оператор OR (`|`) должен быть заключён в скобки `()` при использовании внутри поиска по близости. Каждая опция проверяется отдельно.

**Правильный пример** (со скобками):
```sql
"( two | four ) fish chips"~5
```

**Неправильный пример** (без скобок — не будет работать):
```sql
"two | four fish chips"~5
```

### Оператор кворума

```sql
"the world is a wonderful place"/3
```

Оператор кворума вводит тип нечеткого совпадения. Он будет совпадать только с теми документами, которые удовлетворяют заданному порогу по количеству указанных слов. В приведённом выше примере (`"the world is a wonderful place"/3`) он совпадёт со всеми документами, содержащими как минимум 3 из 6 указанных слов. Оператор ограничен 255 ключевыми словами. Вместо абсолютного числа можно указать значение от 0.0 до 1.0 (представляющее 0% и 100%), и Manticore будет совпадать только с документами, содержащими не менее указанного процента данных слов. Тот же пример можно записать как `"the world is a wonderful place"/0.5`, и он совпадёт с документами, содержащими не менее 50% из 6 слов.

Оператор кворума поддерживает оператор OR (`|`). Оператор OR (`|`) должен быть заключён в скобки `()` при использовании внутри кворума. Для совпадения учитывается только одно слово из каждой группы OR.

**Правильные примеры** (со скобками):
```sql
"( ( a b c ) | d ) e f g"/0.5
"happy ( sad | angry ) man"/2
```

**Неправильный пример** (без скобок — не будет работать):
```sql
"a b c | d e f g"/0.5
```

### Оператор строгого порядка

```sql
aaa << bbb << ccc
```

Оператор строгого порядка (также известный как оператор "before") совпадает с документом только если ключевые слова аргумента появляются в документе именно в том порядке, который указан в запросе. Например, запрос `black << cat` совпадёт с документом "black and white cat", но не с документом "that cat was black". Оператор порядка имеет самый низкий приоритет. Его можно применять как к отдельным ключевым словам, так и к более сложным выражениям. Например, это валидный запрос:

```sql
(bag of words) << "exact phrase" << red|green|blue
```

### Модификатор точной формы

```sql
raining =cats and =dogs
="exact phrase"
```

Модификатор точной формы ключевого слова совпадает с документом только если ключевое слово встречается в точной форме, указанной в запросе. По умолчанию документ считается совпадающим, если совпадает слово в его основе/лемматизированной форме. Например, запрос "runs" совпадёт как с документом, содержащим "runs", так и с документом, содержащим "running", потому что обе формы сводятся к основе "run". Однако запрос `=runs` совпадёт только с первым документом. Модификатор точной формы требует включения опции [index_exact_words](../../Creating_a_table/NLP_and_tokenization/Morphology.md#index_exact_words).

Другой вариант использования — предотвратить [расширение](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expand_keywords) ключевого слова до его формы `*keyword*`. Например, при `index_exact_words=1` + `expand_keywords=1/star`, `bcd` найдет документ, содержащий `abcde`, но `=bcd` — нет.

В качестве модификатора, влияющего на ключевое слово, он может использоваться внутри операторов, таких как оператор фразы, операторы близости и кворума. Применение модификатора точной формы к оператору фразы возможно, и в этом случае он внутренне добавляет модификатор точной формы ко всем терминам в фразе.

### Операторы подстановочных знаков

```sql
nation* *nation* *national
```

Требует [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) для префикса (расширение в конце) и/или суффикса (расширение в начале). Если требуется только префикс, можно использовать [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len).

Поиск попытается найти все расширения токенов с подстановочными знаками, и каждое расширение фиксируется как совпавшее попадание. Количество расширений для токена можно контролировать с помощью настройки таблицы [expansion_limit](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#expansion_limit). Токены с подстановочными знаками могут значительно влиять на время поиска запроса, особенно когда токены имеют короткую длину. В таких случаях желательно использовать ограничение расширения.

Оператор подстановочного знака может применяться автоматически, если используется настройка таблицы [expand_keywords](../../Searching/Options.md#expand_keywords).

Кроме того, поддерживаются следующие встроенные операторы подстановочных знаков:

* `?` может соответствовать любому одному символу: `t?st` совпадет с `test`, но не с `teast`
* `%` может соответствовать нулю или одному символу: `tes%` совпадет с `tes` или `test`, но не с `testing`

Встроенные операторы требуют `dict=keywords` (включено по умолчанию) и включенного префиксного/инфиксного поиска.

### Оператор REGEX

```sql
REGEX(/t.?e/)
```

Требует установки опций [min_infix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_infix_len) или [min_prefix_len](../../Creating_a_table/NLP_and_tokenization/Wildcard_searching_settings.md#min_prefix_len) и [dict](../../Creating_a_table/NLP_and_tokenization/Low-level_tokenization.md#dict)=keywords (что является значением по умолчанию).

Аналогично [операторам подстановочных знаков](../../Searching/Full_text_matching/Operators.md#Wildcard-operators), оператор REGEX пытается найти все токены, соответствующие заданному шаблону, и каждое расширение фиксируется как совпавшее попадание. Обратите внимание, что это может значительно повлиять на время поиска запроса, так как сканируется весь словарь, и каждый термин в словаре проверяется на соответствие шаблону REGEX.

Шаблоны должны соответствовать [синтаксису RE2](https://github.com/google/re2/wiki/Syntax). Разделителем выражения REGEX является первый символ после открывающей скобки. Другими словами, весь текст между открывающей скобкой с последующим разделителем и разделителем с закрывающей скобкой считается выражением RE2.
Обратите внимание, что термины, хранящиеся в словаре, подвергаются преобразованию `charset_table`, что означает, например, что REGEX может не совпадать с заглавными символами, если все символы приведены к нижнему регистру согласно `charset_table` (что происходит по умолчанию). Чтобы успешно сопоставить термин с помощью выражения REGEX, шаблон должен соответствовать всему токену. Для частичного совпадения поместите `.*` в начале и/или в конце вашего шаблона.

```sql
REGEX(/.{3}t/)
REGEX(/t.*\d*/)
```

### Модификатор начала и конца поля

```sql
^hello world$
```

Модификаторы ключевых слов начала и конца поля гарантируют, что ключевое слово совпадает только если оно появляется в самом начале или самом конце поля полнотекстового поиска соответственно. Например, запрос `"^hello world$"` (в кавычках, чтобы объединить оператор фразы с модификаторами начала/конца) будет совпадать исключительно с документами, содержащими хотя бы одно поле с этими двумя конкретными ключевыми словами.

### Модификатор усиления IDF

```sql
boosted^1.234 boostedfieldend$^1.234
```

Модификатор усиления повышает значение [IDF](../../Searching/Options.md#idf)_оценки слова на указанный коэффициент в рейтинговых оценках, которые включают IDF в свои вычисления. Он не влияет на процесс сопоставления.

### Оператор NEAR

```sql
hello NEAR/3 world NEAR/4 "my test"
```

Оператор `NEAR` является более общей версией оператора близости. Его синтаксис — `NEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NEAR`, знаком слэша и значением расстояния.

В то время как исходный оператор близости работает только с наборами ключевых слов, `NEAR` более универсален и может принимать произвольные подвыражения в качестве своих двух аргументов. Он совпадает с документом, когда оба подвыражения найдены в пределах N слов друг от друга, независимо от их порядка. `NEAR` является левосторонне ассоциативным и имеет такой же (низший) приоритет, как и [BEFORE](../../Searching/Full_text_matching/Operators.md#Strict-order-operator).

Важно отметить, что `one NEAR/7 two NEAR/7 three` не совсем эквивалентно `"one two three"~7`. Ключевое отличие в том, что оператор близости допускает до 6 слов, не совпадающих между всеми тремя совпадающими словами, тогда как версия с `NEAR` менее ограничительна: она позволяет до 6 слов между `one` и `two`, а затем еще до 6 между этим двухсловным совпадением и `three`.

### Оператор NOTNEAR

```sql
Church NOTNEAR/3 street
```
Оператор `NOTNEAR` служит отрицательным утверждением. Он совпадает с документом, когда левый аргумент присутствует, а правый аргумент либо отсутствует в документе, либо находится на указанном расстоянии от конца совпавшего левого аргумента. Расстояние указывается в словах. Синтаксис — `NOTNEAR/N`, чувствителен к регистру и не допускает пробелов между ключевым словом `NOTNEAR`, знаком слэша и значением расстояния. Оба аргумента этого оператора могут быть терминами или любыми операторами либо группами операторов.

### Операторы SENTENCE и PARAGRAPH

```sql
all SENTENCE words SENTENCE "in one sentence"
```


```sql
"Bill Gates" PARAGRAPH "Steve Jobs"
```
Операторы `SENTENCE` и `PARAGRAPH` соответствуют документу, когда оба их аргумента находятся в одном предложении или в одном абзаце текста соответственно. Эти аргументы могут быть ключевыми словами, фразами или экземплярами того же оператора.

Порядок аргументов внутри предложения или абзаца не имеет значения. Эти операторы работают только с таблицами, построенными с включённой функцией [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp) (индексация предложений и абзацев) и в противном случае сводятся к простой операции AND. Для информации о том, что считается предложением и абзацем, обратитесь к документации директивы [index_sp](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_sp).


### Оператор ограничения ZONE

```sql
ZONE:(h3,h4)

only in these titles
```

Оператор ограничения `ZONE` очень похож на оператор ограничения поля, но ограничивает совпадение указанной зоной внутри поля или списком зон. Важно отметить, что последующие подвыражения не обязаны совпадать в одном непрерывном участке заданной зоны и могут совпадать в нескольких участках. Например, запрос `(ZONE:th hello world)` будет соответствовать следующему примеру документа:

```html
<th>Table 1. Local awareness of Hello Kitty brand.</th>
.. some table data goes here ..
<th>Table 2. World-wide brand awareness.</th>
```

Оператор `ZONE` действует на запрос до следующего оператора ограничения поля или `ZONE`, либо до закрывающей скобки. Он работает исключительно с таблицами, построенными с поддержкой зон (см. [index_zones](../../Creating_a_table/NLP_and_tokenization/Advanced_HTML_tokenization.md#index_zones)) и в противном случае игнорируется.

### Оператор ограничения ZONESPAN

```sql
ZONESPAN:(h2)

only in a (single) title
```

Оператор ограничения `ZONESPAN` похож на оператор `ZONE`, но требует, чтобы совпадение происходило в одном непрерывном участке. В приведённом ранее примере `ZONESPAN:th hello world` не будет соответствовать документу, так как "hello" и "world" не находятся в одном и том же участке.

<!-- proofread -->

