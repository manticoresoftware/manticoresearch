# Геопоиск

Одна из самых выдающихся особенностей Manticore Search — это возможность совмещать полнотекстовый поиск с геолокацией. Например, розничный продавец может предложить поиск, при котором пользователь ищет продукт, а набор результатов показывает ближайший магазин с его наличием, чтобы пользователь мог прийти в магазин и забрать товар. Туристический сайт может предоставлять результаты на основе поиска, ограниченного определенной областью, и сортировать их по расстоянию от заданной точки (например, «поиск музеев возле отеля»). 

Для выполнения геопоиска документ должен содержать пары координат широты/долготы. Координаты могут храниться как атрибуты с плавающей точкой. Если документ содержит несколько местоположений, может быть удобно использовать атрибут JSON для хранения пар координат.



```ini
table myrt
{
    ...
    rt_attr_float = lat
    rt_attr_float = lon
    ...
}
```

Координаты могут храниться в градусах или радианах.

Если создаются вторичные индексы для атрибутов широты и долготы, они могут автоматически использоваться для ускорения геопоиска, если [оптимизатор на основе стоимости](../Searching/Cost_based_optimizer.md) решит их использовать.

## Вычисление расстояния

Чтобы узнать расстояние между двумя точками, можно использовать функцию [GEODIST()](../Functions/Geo_spatial_functions.md#GEODIST%28%29). `GEODIST` требует две пары координат в качестве первых четырех параметров.

Пятый параметр в упрощенном формате JSON может настраивать некоторые аспекты функции. По умолчанию `GEODIST` ожидает, что координаты заданы в радианах, но можно добавить `in=degrees`, чтобы использовать градусы в качестве входных значений. Координаты, для которых выполняется георасчет, должны иметь тот же тип (градусы или радианы), что и те, что сохранены в таблице, иначе результаты будут вводить в заблуждение.

Вычисленное расстояние по умолчанию задается в метрах, но с помощью опции `out` его можно преобразовать в километры, футы или мили. Наконец, по умолчанию используется метод расчета с названием `adaptive`. Доступен альтернативный метод, основанный на алгоритме `haversine`, однако он медленнее и менее точен.

Результат функции — расстояние — может быть использован в операторе`ORDER BY` для сортировки результатов:

```sql
SELECT *, GEODIST(40.7643929, -73.9997683, lat, lon, {in=degrees, out=miles}) AS distance FROM myindex WHERE MATCH('...') ORDER BY distance ASC, WEIGHT() DESC;
```

Или чтобы ограничить результаты радиальным интервалом вокруг точки:

```sql
SELECT *,GEODIST(40.7643929, -73.9997683, lat,lon, {in=degrees, out=miles}) AS distance FROM myindex WHERE MATCH('...') AND distance <1000 ORDER BY WEIGHT(), DISTANCE ASC;
```

## Поиск в полигонах

Еще одна функция геопоиска — возможность определить, находится ли точка в заданной области. Специальная функция создает объект полигона, который затем используется другой функцией для проверки, содержатся ли заданные координаты внутри этого полигона или нет.

Существует две функции для создания полигона:

*   [GEOPOLY2D()](../Functions/Geo_spatial_functions.md#GEOPOLY2D%28%29) - создает полигон, учитывающий кривизну Земли
*   [POLY2D()](../Functions/Geo_spatial_functions.md#POLY2D%28%29) - создает простой полигон в плоском пространстве

`POLY2D` подходит для геопоиска, когда стороны области меньше 500 км (для полигонов с 3-4 сторонами; для полигонов с большим числом сторон следует учитывать меньшие значения). Для областей с более длинными сторонами необходимо использовать `GEOPOLY2D` для обеспечения точных результатов. `GEOPOLY2D` ожидает координаты в виде пар широты/долготы в градусах; использование радиан даст результаты в плоском пространстве (аналогично `POLY2D`).

[CONTAINS()](../Functions/Arrays_and_conditions_functions.md#CONTAINS%28%29) принимает полигон и набор координат в качестве входных данных и возвращает `1`, если точка находится внутри полигона, или `0` в противном случае.

```sql
SELECT *,CONTAINS(GEOPOLY2D(40.76439, -73.9997, 42.21211, -73.999,  42.21211, -76.123, 40.76439, -76.123), 41.5445, -74.973) AS inside FROM myindex WHERE MATCH('...') AND inside=1;
```
<!-- proofread -->
