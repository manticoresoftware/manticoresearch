# Гео поиск

Одной из великолепных функций Manticore Search является возможность комбинировать полнотекстовый поиск с геолокацией. Например, розничный продавец может предложить поиск, где пользователь ищет продукт, а результат может указать ближайший магазин, в котором есть продукт в наличии, чтобы пользователь мог зайти в магазин и забрать его. Тревел-сайт может предоставлять результаты на основе поиска, ограниченного определённой областью, и сортировать результаты по расстоянию от точки (например, «поиск музеев рядом с отелем»).

Для выполнения гео-поиска документ должен содержать пары координат широты/долготы. Координаты могут храниться как атрибуты с плавающей точкой. Если в документе несколько локаций, может быть удобно использовать JSON-атрибут для хранения пар координат.



```ini
table myrt
{
    ...
    rt_attr_float = lat
    rt_attr_float = lon
    ...
}
```

Координаты могут храниться в градусах или радианах.

Если для атрибутов широты и долготы сгенерированы вторичные индексы, они могут автоматически использоваться для ускорения гео-поиска, если [оптимизатор на основе стоимости](../Searching/Cost_based_optimizer.md) решит их применить.

## Выполнение вычисления расстояния

Для определения расстояния между двумя точками можно использовать функцию [GEODIST()](../Functions/Geo_spatial_functions.md#GEODIST%28%29). `GEODIST` требует две пары координат в качестве первых четырёх параметров.

Пятый параметр в упрощённом JSON формате может конфигурировать некоторые аспекты функции. По умолчанию `GEODIST` ожидает координаты в радианах, но можно добавить `in=degrees`, чтобы использовать входные данные в градусах. Координаты, для которых выполняется вычисление гео-расстояния, должны иметь тот же тип (градусы или радианы), что и в таблице; в противном случае результаты будут некорректными.

Вычисленное расстояние по умолчанию измеряется в метрах, но с опцией `out` его можно преобразовать в километры, футы или мили. Наконец, по умолчанию используется метод вычисления `adaptive`. Доступен альтернативный метод, основанный на алгоритме `haversine`; однако он медленнее и менее точен.

Результат функции — расстояние — может использоваться в предложении `ORDER BY` для сортировки результатов:

```sql
SELECT *, GEODIST(40.7643929, -73.9997683, lat, lon, {in=degrees, out=miles}) AS distance FROM myindex WHERE MATCH('...') ORDER BY distance ASC, WEIGHT() DESC;
```

Или для ограничения результатов радиальной областью вокруг точки:

```sql
SELECT *,GEODIST(40.7643929, -73.9997683, lat,lon, {in=degrees, out=miles}) AS distance FROM myindex WHERE MATCH('...') AND distance <1000 ORDER BY WEIGHT(), DISTANCE ASC;
```

## Поиск внутри полигонов

Ещё одна функция гео-поиска — возможность определить, находится ли локация внутри указанной области. Специальная функция создаёт объект полигона, который затем используется другой функцией, чтобы проверить, содержится ли набор координат внутри этого полигона.

Доступны две функции для создания полигона:

*   [GEOPOLY2D()](../Functions/Geo_spatial_functions.md#GEOPOLY2D%28%29) — создаёт полигон с учётом кривизны Земли
*   [POLY2D()](../Functions/Geo_spatial_functions.md#POLY2D%28%29) — создаёт простой полигон в плоском пространстве

`POLY2D` подходит для гео-поиска, когда стороны области короче 500 км (для полигонов с 3-4 сторонами; для полигонов с большим числом сторон следует рассматривать меньшие значения). Для областей с более длинными сторонами необходимо использовать `GEOPOLY2D` для поддержания точности результатов. `GEOPOLY2D` ожидает координаты в виде пар широта/долгота в градусах; использование радиан даст результаты в плоском пространстве (аналогично `POLY2D`).

[CONTAINS()](../Functions/Arrays_and_conditions_functions.md#CONTAINS%28%29) принимает полигон и набор координат на вход и возвращает `1`, если точка внутри полигона, или `0` в противном случае.

```sql
SELECT *,CONTAINS(GEOPOLY2D(40.76439, -73.9997, 42.21211, -73.999,  42.21211, -76.123, 40.76439, -76.123), 41.5445, -74.973) AS inside FROM myindex WHERE MATCH('...') AND inside=1;
```
<!-- proofread -->

