# Поиск векторов k-ближайших соседей

Manticore Search поддерживает возможность добавления вложений, сгенерированных вашими моделями машинного обучения, к каждому документу, а затем выполнения поиска ближайших соседей по ним. Это позволяет вам создавать функции, такие как поиск по сходству, рекомендации, семантический поиск и ранжирование релевантности на основе алгоритмов обработки естественного языка, среди прочего, включая поиски по изображениям, видео и звуку.

## Что такое вложение?

Вложение — это метод представления данных, таких как текст, изображения или звук, в виде векторов в многомерном пространстве. Эти векторы созданы таким образом, чтобы расстояние между ними отражало сходство данных, которые они представляют. Этот процесс обычно использует алгоритмы, такие как вложения слов (например, Word2Vec, BERT) для текста или нейронные сети для изображений. Многомерный характер векторного пространства, с множеством компонентов на вектор, позволяет представлять сложные и тонкие отношения между элементами. Их сходство измеряется по расстоянию между этими векторами, часто с использованием методов, таких как евклидово расстояние или косинусное сходство.

Manticore Search позволяет выполнять поиск векторов k-ближайших соседей (KNN) с использованием библиотеки HNSW. Эта функция является частью [Manticore Columnar Library](https://github.com/manticoresoftware/columnar).

<!-- example KNN -->

### Конфигурация таблицы для поиска KNN

Чтобы выполнять KNN-поиски, необходимо сначала настроить вашу таблицу. Она должна иметь по крайней мере один атрибут float_vector, который служит вектором данных. Вы должны указать следующие свойства:
* `knn_type`: Обязательная настройка; в настоящее время поддерживается только `hnsw`.
* `knn_dims`: Обязательная настройка, определяющая размеры индексируемых векторов.
* `hnsw_similarity`: Обязательная настройка, определяющая функцию расстояния, используемую индексом HNSW. Допустимые значения:
  - `L2` - Квадратное L2
  - `IP` - Скалярное произведение
  - `COSINE` - Косинусное сходство
* `hnsw_m`: Необязательная настройка, определяющая максимальное количество исходящих соединений в графе. Значение по умолчанию — 16.
* `hnsw_ef_construction`: Необязательная настройка, определяющая компромисс между временем построения и точностью.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
create table test ( title text, image_vector float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2' );
```
<!-- response -->

```sql
Query OK, 0 rows affected (0.01 sec)
```
<!-- end -->

<!-- example knn_insert -->

### Вставка векторных данных

После создания таблицы вам необходимо вставить ваши векторные данные, убедившись, что они соответствуют размерам, которые вы указали при создании таблицы.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
insert into test values ( 1, 'yellow bag', (0.653448,0.192478,0.017971,0.339821) ), ( 2, 'white bag', (-0.148894,0.748278,0.091892,-0.095406) );
```
<!-- response SQL -->

```sql
Query OK, 2 rows affected (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /insert
{
	"table":"test_vec",
	"id":1,
	"doc": 	{ "title" : "yellow bag", "image_vector" : [0.653448,0.192478,0.017971,0.339821] }
}

POST /insert
{
	"table":"test_vec",
	"id":2,
	"doc": 	{ "title" : "white bag", "image_vector" : [-0.148894,0.748278,0.091892,-0.095406] }
}
```

<!-- response JSON -->

```json
{
	"table":"test",
	"_id":1,
	"created":true,
	"result":"created",
	"status":201
}

{
	"table":"test",
	"_id":2,
	"created":true,
	"result":"created",
	"status":201
}
```

<!-- end -->

<!-- example knn_search -->

### Поиск векторов KNN

Теперь вы можете выполнить поиск KNN с помощью операции `knn` как в формате SQL, так и в формате JSON. Оба интерфейса поддерживают одни и те же основные параметры, обеспечивая единообразный опыт, независимо от выбранного формата:

- SQL: `select ... from <table name> where knn ( <field>, <k>, <query vector> [,<ef>] )`
- JSON:
  ```
  POST /search
  {
      "table": "<table name>",
      "knn":
      {
          "field": "<field>",
          "query_vector": [<query vector>],
          "k": <k>,
          "ef": <ef>
      }
  }
  ```

Параметры:
* `field`: Это название атрибута вектора float, содержащего векторные данные.
* `k`: Это количество документов, которые нужно вернуть, и это ключевой параметр для иерархических навигируемых малых миров (HNSW) индексов. Он указывает количество документов, которые должен вернуть один индекс HNSW. Однако фактическое количество документов, включенных в окончательные результаты, может варьироваться. Например, если система работает с таблицами реального времени, разбитыми на дисковые чанки, каждый чанк может вернуть `k` документов, что приведет к общему количеству, превышающему указанное `k` (поскольку суммарное количество будет равно `num_chunks * k`). С другой стороны, окончательное количество документов может быть меньше `k`, если после запроса `k` документов некоторые из них отфильтровываются на основе определенных атрибутов. Важно отметить, что параметр `k` не применим к ramchunks. В контексте ramchunks процесс извлечения работает иначе, и, следовательно, влияние параметра `k` на количество возвращаемых документов не применимо.
* `query_vector`: Это вектор поиска.
* `ef`: необязательный размер динамического списка, используемого во время поиска. Более высокий `ef` ведет к более точному, но более медленному поиску.

Документы всегда сортируются по расстоянию до вектора поиска. Любые дополнительные критерии сортировки, которые вы укажете, будут применены после этого первоначального условия сортировки. Для извлечения расстояния имеется встроенная функция под названием [knn_dist()](../Functions/Other_functions.md#KNN_DIST%28%29).

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926), 2000 );
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    1 | 0.28146550 |
|    2 | 0.81527930 |
+------+------------+
2 rows in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
	"table": "test",
	"knn":
	{
		"field": "image_vector",
		"query_vector": [0.286569,-0.031816,0.066684,0.032926],
		"k": 5,
		"ef": 2000
	}
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":2,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 1,
				"_score":1,
				"_knn_dist":0.28146550,
				"_source":
				{
					"title":"жёлтая сумка",
					"image_vector":[0.653448,0.192478,0.017971,0.339821]
				}
			},
			{
				"_id": 2,
				"_score":1,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"белая сумка",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- Example knn_similar_docs -->


### Найти похожие документы по id

> ПРИМЕЧАНИЕ: Поиск похожих документов по id требует [Manticore Buddy](../Installation/Manticore_Buddy.md). Если это не работает, убедитесь, что Buddy установлен.

Поиск документов, похожих на конкретный, основанный на его уникальном ID, является распространённой задачей. Например, когда пользователь просматривает определённый элемент, Manticore Search может эффективно идентифицировать и отображать список элементов, которые наиболее похожи на него в векторном пространстве. Вот как это можно сделать:

- SQL: `select ... from <table name> where knn ( <field>, <k>, <document id> )`
- JSON:
  ```
  POST /search
  {
      "table": "<table name>",
      "knn":
      {
          "field": "<field>",
          "doc_id": <document id>,
          "k": <k>
      }
  }
  ```

Параметры:
* `field`: Это название атрибута векторного типа float, содержащего векторные данные.
* `k`: Это количество документов, которые необходимо вернуть, и является ключевым параметром для индексирования Hierarchical Navigable Small World (HNSW). Он задаёт количество документов, которое должен вернуть один индекс HNSW. Однако фактическое количество документов, включённых в окончательные результаты, может варьироваться. Например, если система работает с таблицами реального времени, разделёнными на дисковые куски, каждый кусок может вернуть `k` документов, что приведёт к общему количеству, превышающему указанное `k` (так как накопительное количество будет `num_chunks * k`). С другой стороны, окончательное количество документов может быть меньше, чем `k`, если после запроса `k` документов некоторые из них отфильтровываются на основе определённых атрибутов. Важно отметить, что параметр `k` не применяется к ramchunks. В контексте ramchunks процесс получения работает иначе, и таким образом, эффект параметра `k` на количество возвращаемых документов не применим.
* `document id`: ID документа для поиска KNN по схожести.


<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, 1 );
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    2 | 0.81527930 |
+------+------------+
1 row in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
  "table": "test",
  "knn":
  {
    "field": "image_vector",
    "doc_id": 1,
    "k": 5
  }
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":1,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 2,
				"_score":1643,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"белая сумка",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- Example knn_filtering -->

### Фильтрация результатов векторного поиска KNN

Manticore также поддерживает дополнительную фильтрацию документов, возвращаемых по результатам поиска KNN, как по полнотекстовому соответствию, так и по фильтрам атрибутов, или комбинации того и другого.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926) ) and match('white') and id < 10;
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    2 | 0.81527930 |
+------+------------+
1 row in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
	"table": "test",
	"knn":
	{
		"field": "image_vector",
		"query_vector": [0.286569,-0.031816,0.066684,0.032926],
		"k": 5,
		"filter":
		{
			"bool":
			{
				"must":
				[
					{ "match": {"_all":"white"} },
			        { "range": { "id": { "lt": 10 } } }
				]
			}
		}
	}
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":1,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 2,
				"_score":1643,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"белая сумка",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- proofread -->
