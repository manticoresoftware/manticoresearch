# Поиск по векторам методом ближайших соседей (K-nearest neighbor)

Manticore Search поддерживает возможность добавления embeddings, созданных вашими моделями машинного обучения, к каждому документу, а затем выполнения поиска ближайших соседей по ним. Это позволяет создавать такие функции, как поиск по подобию, рекомендации, семантический поиск и ранжирование релевантности на основе алгоритмов обработки естественного языка (NLP), а также, среди прочего, поиск по изображениям, видео и звуку.

## Что такое embedding?

Embedding — это метод представления данных — таких как текст, изображения или звук — в виде векторов в пространстве высокой размерности. Эти векторы создаются таким образом, чтобы расстояние между ними отражало сходство представленных данных. Обычно этот процесс использует алгоритмы, такие как векторные представления слов (например, Word2Vec, BERT) для текста или нейронные сети для изображений. Высокая размерность векторного пространства, с множеством компонентов в каждом векторе, позволяет отражать сложные и тонкие взаимосвязи между объектами. Сходство измеряется расстоянием между этими векторами, часто с помощью таких метрик, как евклидово расстояние или косинусное сходство.

Manticore Search позволяет выполнять поиск K-ближайших соседей (KNN) по векторам с использованием библиотеки HNSW. Эта функциональность входит в состав [Manticore Columnar Library](https://github.com/manticoresoftware/columnar).

<!-- example KNN -->

### Настройка таблицы для поиска KNN

Для выполнения поиска KNN сначала необходимо настроить таблицу. Векторы с плавающей точкой и поиск KNN поддерживаются только в таблицах реального времени (не в обычных таблицах). Таблица должна содержать как минимум один атрибут типа float_vector, который служит вектором данных. Необходимо задать следующие свойства:
* `knn_type`: обязательный параметр; в настоящее время поддерживается только `hnsw`.
* `knn_dims`: обязательный параметр, задающий размерность индексируемых векторов.
* `hnsw_similarity`: обязательный параметр, определяющий функцию расстояния, используемую индексом HNSW. Допустимые значения:
  - `L2` - квадрат евклидова расстояния (Squared L2)
  - `IP` - внутреннее произведение (Inner product)
  - `COSINE` - косинусное сходство
* `hnsw_m`: необязательный параметр, задающий максимальное количество исходящих связей в графе. По умолчанию — 16.
* `hnsw_ef_construction`: необязательный параметр, определяющий компромисс между временем построения и точностью.

<!-- intro -->
##### SQL

<!-- request SQL -->
```sql
create table test ( title text, image_vector float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2' );
```

<!-- response SQL -->

```sql
Query OK, 0 rows affected (0.01 sec)
```

<!-- intro -->
##### Режим Plain (с использованием конфигурационного файла):

<!-- request Config -->
```ini
table test_vec {
    type = rt
	...
    rt_attr_float_vector = image_vector
    knn = {"attrs":[{"name":"image_vector","type":"hnsw","dims":4,"hnsw_similarity":"L2","hnsw_m":16,"hnsw_ef_construction":200}]}
}
```

<!-- end -->

<!-- example knn_insert -->

### Вставка векторных данных

После создания таблицы нужно вставить свои векторные данные, убедившись, что они соответствуют размерности, заданной при создании таблицы. Также можно вставить пустой вектор; это означает, что документ будет исключён из результатов поиска по векторам.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
insert into test values ( 1, 'yellow bag', (0.653448,0.192478,0.017971,0.339821) ), ( 2, 'white bag', (-0.148894,0.748278,0.091892,-0.095406) );
```
<!-- response SQL -->

```sql
Query OK, 2 rows affected (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /insert
{
	"table":"test_vec",
	"id":1,
	"doc": 	{ "title" : "yellow bag", "image_vector" : [0.653448,0.192478,0.017971,0.339821] }
}

POST /insert
{
	"table":"test_vec",
	"id":2,
	"doc": 	{ "title" : "white bag", "image_vector" : [-0.148894,0.748278,0.091892,-0.095406] }
}
```

<!-- response JSON -->

```json
{
	"table":"test",
	"_id":1,
	"created":true,
	"result":"created",
	"status":201
}

{
	"table":"test",
	"_id":2,
	"created":true,
	"result":"created",
	"status":201
}
```

<!-- end -->

<!-- example knn_search -->

### Поиск по векторам KNN

Теперь вы можете выполнять поиск KNN с помощью оператора `knn` как в SQL, так и в JSON-формате. Обе интерфейса поддерживают одинаковые основные параметры, обеспечивая единообразный опыт независимо от выбранного формата:

- SQL: `select ... from <table name> where knn ( <field>, <k>, <query vector> [,<options>] )`
- JSON:
  ```
  POST /search
  {
      "table": "<table name>",
      "knn":
      {
          "field": "<field>",
          "query_vector": [<query vector>],
          "k": <k>,
          "ef": <ef>,
  "rescore": <rescore>,
  "oversampling": <oversampling>
      }
  }
  ```

Параметры:
* `field`: имя атрибута float_vector, содержащего векторные данные.
* `k`: количество документов для возвращения — ключевой параметр индексирования Hierarchical Navigable Small World (HNSW). Он задаёт количество документов, которые должен вернуть один индекс HNSW. Однако фактическое число документов в итоговых результатах может отличаться. Например, если система работает с таблицами реального времени, разделёнными на дисковые чанки, каждый чанк может вернуть `k` документов, что приведёт к общему числу, превышающему заданное `k` (поскольку общее количество будет `num_chunks * k`). С другой стороны, итоговое число документов может быть меньше `k`, если после запроса `k` документов некоторые из них будут отфильтрованы по определённым атрибутам. Важно отметить, что параметр `k` не применяется к ramchunks. Для ramchunks процесс извлечения работает иначе, и эффект параметра `k` на количество возвращаемых документов не применяется.
* `query_vector`: вектор запроса.
* `ef`: необязательный размер динамического списка, используемого при поиске. Более высокий `ef` обеспечивает более точный, но более медленный поиск.
* `rescore`: включает пересчёт баллов KNN (по умолчанию отключено). Устанавливается в `1` в SQL или в `true` в JSON для включения пересчёта. После завершения поиска KNN с использованием квантованных векторов (с возможным оверсемплингом) расстояния пересчитываются с использованием исходных (полной точности) векторов, и результаты переупорядочиваются для улучшения точности ранжирования.
* `oversampling`: задаёт фактор (число с плавающей точкой), на который умножается `k` при выполнении KNN-поиска, что приводит к получению большего числа кандидатов, чем требуется, с использованием квантованных векторов. По умолчанию оверсемплинг не применяется. Эти кандидаты могут быть перепроверены позже, если включён пересчёт баллов. Оверсемплинг также работает с неквантованными векторами. Поскольку он увеличивает `k`, что влияет на работу индекса HNSW, возможны небольшие изменения в точности результатов.

Документы всегда сортируются по расстоянию до вектора запроса. Любые дополнительные критерии сортировки, которые вы укажете, применяются после этого первичного условия сортировки. Для получения расстояния есть встроенная функция [knn_dist()](../Functions/Other_functions.md#KNN_DIST%28%29).

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926), { ef=2000, oversampling=3.0, rescore=1 } );
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    1 | 0.28146550 |
|    2 | 0.81527930 |
+------+------------+
2 rows in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
	"table": "test",
	"knn":
	{
		"field": "image_vector",
		"query_vector": [0.286569,-0.031816,0.066684,0.032926],
		"k": 5,
		"ef": 2000, 
		"rescore": true,
		"oversampling": 3.0
	}
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":2,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 1,
				"_score":1,
				"_knn_dist":0.28146550,
				"_source":
				{
					"title":"yellow bag",
					"image_vector":[0.653448,0.192478,0.017971,0.339821]
				}
			},
			{
				"_id": 2,
				"_score":1,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"white bag",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->















































































































































































































