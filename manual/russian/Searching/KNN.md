# Поиск векторов по K-ближайшим соседям

Manticore Search поддерживает возможность добавления эмбеддингов, сгенерированных вашими моделями машинного обучения, к каждому документу, а затем выполнения поиска ближайших соседей по ним. Это позволяет создавать такие функции, как поиск по сходству, рекомендации, семантический поиск и ранжирование релевантности на основе алгоритмов обработки естественного языка (NLP), а также, среди прочего, поиск по изображениям, видео и звуку.

## Что такое эмбеддинг?

Эмбеддинг — это метод представления данных — таких как текст, изображения или звук — в виде векторов в высокоразмерном пространстве. Эти векторы создаются так, чтобы расстояние между ними отражало сходство представляемых данных. Для этого обычно используются алгоритмы, такие как эмбеддинги слов (например, Word2Vec, BERT) для текста или нейронные сети для изображений. Высокая размерность векторного пространства, с множеством компонентов на вектор, позволяет представлять сложные и тонкие связи между объектами. Взаимное сходство оценивается по расстоянию между векторами, зачастую измеряемому с помощью таких методов, как евклидово расстояние или косинусное сходство.

Manticore Search позволяет выполнять поиск векторов по k-ближайшим соседям (KNN) с использованием библиотеки HNSW. Эта функциональность является частью [Manticore Columnar Library](https://github.com/manticoresoftware/columnar).

<!-- example KNN -->

### Настройка таблицы для поиска KNN

Чтобы выполнять поиск KNN, сначала нужно настроить таблицу. В ней должен быть как минимум один атрибут типа float_vector, служащий вектором данных. Необходимо указать следующие свойства:
* `knn_type`: обязательная настройка; в настоящее время поддерживается только `hnsw`.
* `knn_dims`: обязательная настройка, которая указывает размерность индексируемых векторов.
* `hnsw_similarity`: обязательная настройка, определяющая функцию расстояния, используемую индексом HNSW. Допустимые значения:
  - `L2` — квадратичное L2
  - `IP` — скалярное произведение
  - `COSINE` — косинусное сходство
* `hnsw_m`: необязательная настройка, задающая максимальное число исходящих связей в графе. По умолчанию 16.
* `hnsw_ef_construction`: необязательная настройка, определяющая компромисс между временем построения и точностью.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
create table test ( title text, image_vector float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2' );
```
<!-- response -->

```sql
Query OK, 0 rows affected (0.01 sec)
```
<!-- end -->

<!-- example knn_insert -->

### Вставка векторных данных

После создания таблицы необходимо вставить ваши векторные данные, убедившись, что их размерность соответствует той, что вы указали при создании таблицы.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
insert into test values ( 1, 'yellow bag', (0.653448,0.192478,0.017971,0.339821) ), ( 2, 'white bag', (-0.148894,0.748278,0.091892,-0.095406) );
```
<!-- response SQL -->

```sql
Query OK, 2 rows affected (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /insert
{
	"table":"test_vec",
	"id":1,
	"doc": 	{ "title" : "yellow bag", "image_vector" : [0.653448,0.192478,0.017971,0.339821] }
}

POST /insert
{
	"table":"test_vec",
	"id":2,
	"doc": 	{ "title" : "white bag", "image_vector" : [-0.148894,0.748278,0.091892,-0.095406] }
}
```

<!-- response JSON -->

```json
{
	"table":"test",
	"_id":1,
	"created":true,
	"result":"created",
	"status":201
}

{
	"table":"test",
	"_id":2,
	"created":true,
	"result":"created",
	"status":201
}
```

<!-- end -->

<!-- example knn_search -->

### Поиск векторов KNN

Теперь вы можете выполнять поиск KNN с помощью конструкции `knn` как в SQL, так и в JSON формате. Обе интерфейса поддерживают одинаковые основные параметры, что обеспечивает единый опыт, независимо от выбора формата:

- SQL: `select ... from <table name> where knn ( <field>, <k>, <query vector> [,<ef>] )`
- JSON:
  ```
  POST /search
  {
      "table": "<table name>",
      "knn":
      {
          "field": "<field>",
          "query_vector": [<query vector>],
          "k": <k>,
          "ef": <ef>
      }
  }
  ```

Параметры:
* `field`: имя атрибута типа float_vector, содержащего векторные данные.
* `k`: количество документов для возврата, ключевой параметр для индексов Hierarchical Navigable Small World (HNSW). Он определяет число документов, которые должен вернуть один индекс HNSW. Однако фактическое количество документов в итоговом результате может варьироваться. Например, если система работает с таблицами реального времени, разделёнными на дисковые чанки, каждый чанк может вернуть по `k` документов, что в сумме превысит заданное `k` (суммарное количество будет равно `num_chunks * k`). С другой стороны, итоговое число документов может быть меньше `k`, если после запроса `k` документов некоторые отфильтровываются по определённым атрибутам. Важно отметить, что параметр `k` не применяется к ramchunks. В контексте ramchunks процесс извлечения работает иначе, поэтому параметр `k` не влияет на количество возвращаемых документов.
* `query_vector`: вектор для поиска.
* `ef`: необязательный параметр, задающий размер динамического списка, используемого во время поиска. Больший `ef` обеспечивает более точный, но медленный поиск.

Документы всегда сортируются по расстоянию до вектора запроса. Любые дополнительные критерии сортировки применяются после этого первичного условия. Для получения расстояния доступна встроенная функция [knn_dist()](../Functions/Other_functions.md#KNN_DIST%28%29).

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926), 2000 );
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    1 | 0.28146550 |
|    2 | 0.81527930 |
+------+------------+
2 rows in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
	"table": "test",
	"knn":
	{
		"field": "image_vector",
		"query_vector": [0.286569,-0.031816,0.066684,0.032926],
		"k": 5,
		"ef": 2000
	}
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":2,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 1,
				"_score":1,
				"_knn_dist":0.28146550,
				"_source":
				{
					"title":"yellow bag",
					"image_vector":[0.653448,0.192478,0.017971,0.339821]
				}
			},
			{
				"_id": 2,
				"_score":1,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"white bag",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- Example knn_similar_docs -->


### Поиск похожих документов по id

> ПРИМЕЧАНИЕ: Поиск похожих документов по id требует [Manticore Buddy](../Installation/Manticore_Buddy.md). Если функция не работает, убедитесь, что Buddy установлен.

Нахождение документов, похожих на конкретный по его уникальному id — распространённая задача. Например, когда пользователь просматривает определённый элемент, Manticore Search может эффективно найти и показать список элементов, наиболее близких к нему в векторном пространстве. Вот как это выполняется:

- SQL: `select ... from <table name> where knn ( <field>, <k>, <document id> )`
- JSON:
  ```
  POST /search
  {
      "table": "<table name>",
      "knn":
      {
          "field": "<field>",
          "doc_id": <document id>,
          "k": <k>
      }
  }
  ```

Параметры:
* `field`: имя атрибута типа float_vector, содержащего векторные данные.
* `k`: Это число документов, которые нужно вернуть, и является ключевым параметром для иерархических навигационных маломировых (HNSW) индексов. Он указывает количество документов, которые должен вернуть один HNSW индекс. Однако фактическое количество документов в окончательных результатах может варьироваться. Например, если система работает с таблицами в реальном времени, разделёнными на дисковые чанки, каждый чанк может вернуть `k` документов, что приведёт к суммарному количеству, превышающему указанное `k` (так как суммарное количество будет равно `num_chunks * k`). С другой стороны, итоговое количество документов может быть меньше `k`, если после запроса `k` документов некоторые из них отфильтруются по определённым атрибутам. Важно отметить, что параметр `k` не применяется к ramchunks. В контексте ramchunks процесс извлечения работает иначе, и поэтому влияние параметра `k` на количество возвращаемых документов не применяется.
* `document id`: Идентификатор документа для поиска похожих документов KNN.


<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, 1 );
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    2 | 0.81527930 |
+------+------------+
1 row in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
  "table": "test",
  "knn":
  {
    "field": "image_vector",
    "doc_id": 1,
    "k": 5
  }
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":1,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 2,
				"_score":1643,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"white bag",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- Example knn_filtering -->

### Фильтрация результатов поиска по вектору KNN

Manticore также поддерживает дополнительную фильтрацию документов, возвращаемых поиском KNN, либо по полному текстовому совпадению, либо по фильтрам атрибутов, либо по обоим одновременно.

<!-- intro -->
##### SQL:

<!-- request SQL -->

```sql
select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926) ) and match('white') and id < 10;
```
<!-- response SQL -->

```sql
+------+------------+
| id   | knn_dist() |
+------+------------+
|    2 | 0.81527930 |
+------+------------+
1 row in set (0.00 sec)
```

<!-- intro -->
##### JSON:

<!-- request JSON -->

```json
POST /search
{
	"table": "test",
	"knn":
	{
		"field": "image_vector",
		"query_vector": [0.286569,-0.031816,0.066684,0.032926],
		"k": 5,
		"filter":
		{
			"bool":
			{
				"must":
				[
					{ "match": {"_all":"white"} },
			        { "range": { "id": { "lt": 10 } } }
				]
			}
		}
	}
}
```

<!-- response JSON -->

```json
{
	"took":0,
	"timed_out":false,
	"hits":
	{
		"total":1,
		"total_relation":"eq",
		"hits":
		[
			{
				"_id": 2,
				"_score":1643,
				"_knn_dist":0.81527930,
				"_source":
				{
					"title":"white bag",
					"image_vector":[-0.148894,0.748278,0.091892,-0.095406]
				}
			}
		]
	}
}
```

<!-- end -->

<!-- proofread -->

