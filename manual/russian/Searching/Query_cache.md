# Кэш запросов
Кэш запросов хранит сжатые результаты запросов в памяти и при возможности переиспользует их для последующих запросов. Вы можете настроить его с помощью следующих директив:
* [qcache_max_bytes](../Server_settings/Searchd.md#qcache_max_bytes), ограничение на использование оперативной памяти для хранения кэшированных запросов. По умолчанию 16 MB. Установка `qcache_max_bytes` в 0 полностью отключает кэш запросов.
* [qcache_thresh_msec](../Server_settings/Searchd.md#qcache_thresh_msec), минимальное время выполнения запроса для кэширования. Запросы, завершающиеся быстрее этого значения, *не* будут кэшироваться. По умолчанию 3000 мсек, или 3 секунды.
* [qcache_ttl_sec](../Server_settings/Searchd.md#qcache_ttl_sec), время жизни кэшированной записи (TTL). Запросы будут оставаться в кэше в течение этого времени. По умолчанию 60 секунд, или 1 минута.
Эти настройки могут быть изменены на лету с помощью оператора `SET GLOBAL`:
```sql
mysql> SET GLOBAL qcache_max_bytes=128000000;
```
Эти изменения применяются немедленно, и кэшированные наборы результатов, которые больше не удовлетворяют ограничениям, немедленно удаляются. При уменьшении размера кэша в режиме реального времени выигрывают наборы результатов MRU (most recently used).
Кэш запросов работает следующим образом. При включении каждый результат полнотекстового поиска полностью сохраняется в памяти. Это происходит после полнотекстового сопоставления, фильтрации и ранжирования, так что, по сути, мы храним пары `total_found` {docid,weight}. Сжатые совпадения могут занимать в среднем от 2 байт до 12 байт на совпадение, в основном в зависимости от разницы между последовательными docid. После завершения запроса мы проверяем пороги по времени и размеру и либо сохраняем сжатый набор результатов для повторного использования, либо удаляем его.
Обратите внимание, что влияние кэша запросов на ОЗУ не ограничивается параметром `qcache_max_bytes`! Если, например, запустить 10 параллельных запросов, каждый из которых соответствует до 1M совпадений (после фильтрации), то пиковое временное использование памяти будет в диапазоне от 40 MB до 240 MB, даже если запросы достаточно быстрые и не кэшируются.
Запросы могут использовать кэш, если таблица, полнотекстовый запрос (то есть, содержимое `MATCH()`) и ранжировщик полностью совпадают, а фильтры совместимы. Это означает:
*   Полнотекстовая часть внутри `MATCH()` должна совпадать побайтно. Если добавить лишний пробел, то для кэша запросов это будет уже другой запрос.
*   Ранжировщик (и его параметры, если таковые имеются, для пользовательских ранжировщиков) должен совпадать побайтно.
*   Фильтры должны быть надмножеством исходных фильтров. Вы можете добавить дополнительные фильтры и всё равно использовать кэш. (В этом случае дополнительные фильтры будут применены к кэшированному результату.) Но если удалить один из них, это снова будет новым запросом.
Записи в кэше истекают по TTL, а также сбрасываются при ротации таблицы, или при выполнении `TRUNCATE`, или при `ATTACH`. Обратите внимание, что в настоящее время записи не сбрасываются при произвольных записях в таблицы RT! Таким образом, кэшированный запрос может возвращать устаревшие результаты в течение срока действия TTL.
Вы можете проверить текущий статус кэша с помощью [SHOW STATUS](../Node_info_and_management/Node_status.md#SHOW-STATUS) через переменные `qcache_XXX`:
```sql
mysql> SHOW STATUS LIKE 'qcache%';
+-----------------------+----------+
| Counter               | Value    |
+-----------------------+----------+
| qcache_max_bytes      | 16777216 |
| qcache_thresh_msec    | 3000     |
| qcache_ttl_sec        | 60       |
| qcache_cached_queries | 0        |
| qcache_used_bytes     | 0        |
| qcache_hits           | 0        |
+-----------------------+----------+
6 rows in set (0.00 sec)
```
<!-- proofread -->












