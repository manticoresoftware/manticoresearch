# Подзапросы
Manticore поддерживает подзапросы SELECT в следующем формате:
```sql
SELECT * FROM (SELECT ... ORDER BY cond1 LIMIT X) ORDER BY cond2 LIMIT Y
```
Внешний запрос позволяет использовать только конструкции `ORDER BY` и `LIMIT`. В данный момент подзапросы имеют два случая использования:
1. Когда у вас есть запрос с двумя функциями ранжирования UDF, одна из которых очень быстрая, а другая медленная, и вы выполняете полнотекстовый поиск с большим набором результатов совпадения. Без подзапроса запрос будет выглядеть так:
    ```sql
    SELECT id,slow_rank() as slow,fast_rank() as fast FROM index
        WHERE MATCH(‘некоторые общие запросные термины’) ORDER BY fast DESC, slow DESC LIMIT 20
        OPTION max_matches=1000;
    ```
    С подзапросами запрос можно переписать так:
    ```sql
    SELECT * FROM
        (SELECT id,slow_rank() as slow,fast_rank() as fast FROM index WHERE
            MATCH(‘некоторые общие запросные термины’)
            ORDER BY fast DESC LIMIT 100 OPTION max_matches=1000)
    ORDER BY slow DESC LIMIT 20;
    ```
    В начальном запросе функция `slow_rank()` вычисляется для всего набора результатов совпадения. С подзапросами SELECT только `fast_rank()` вычисляется для всего набора результатов совпадения, в то время как `slow_rank()` вычисляется для ограниченного набора.
2. Второй случай полезен для больших наборов результатов, поступающих из распределенной таблицы.
    Для этого запроса:
    ```sql
    SELECT * FROM my_dist_index WHERE some_conditions LIMIT 50000;
    ```
    Если у вас 20 узлов, каждый узел может отправить назад мастеру максимум 50K записей, что в сумме составляет 20 x 50K = 1M записей. Однако, поскольку мастер возвращает только 50K (из 1M), может быть достаточно, чтобы узлы отправили только 10K лучших записей. С подзапросом вы можете переписать запрос так:
    ```sql
    SELECT * FROM
         (SELECT * FROM my_dist_index WHERE some_conditions LIMIT 10000)
     ORDER by some_attr LIMIT 50000;
    ```
    В этом случае узлы получают только внутренний запрос и выполняют его. Это означает, что мастер получит только 20x10K=200K записей. Мастер возьмет все полученные записи, переупорядочит их по внешнему условию и вернет лучшие 50K записей. Подзапрос помогает сократить трафик между мастером и узлами, а также уменьшить время вычислений мастера (поскольку он обрабатывает только 200K вместо 1M записей).
<!-- proofread -->














