# Резервное копирование и восстановление

Регулярное резервное копирование ваших таблиц является обязательным для восстановления в случае сбоев системы, аппаратных неисправностей или повреждения/потери данных. Также настоятельно рекомендуется делать резервные копии перед обновлением до новой версии Manticore Search или выполнением [ALTER TABLE](../Updating_table_schema_and_settings.md#Updating-table-schema-in-RT-mode).

Резервное копирование баз данных может осуществляться двумя уникальными способами: логическими и физическими резервными копиями. У каждого из этих методов есть свои плюсы и минусы, которые могут варьироваться в зависимости от конкретной среды базы данных и потребностей. Здесь мы углубимся в различия между этими двумя типами резервных копий.

### Логические резервные копии

Логические резервные копии предполагают экспорт схемы базы данных и данных в виде SQL-операторов или в форматах данных, специфичных для базы данных. Эта форма резервного копирования обычноReadable для человека и может использоваться для восстановления базы данных на различных системах или движках баз данных.

Плюсы и минусы логических резервных копий:
- ➕ **Переносимость:** Логические резервные копии, как правило, более переносимы, чем физические резервные копии, так как их можно использовать для восстановления базы данных на различном оборудовании или операционных системах.
- ➕ **Гибкость:** Логические резервные копии позволяют вам избирательно восстанавливать конкретные таблицы, индексы или другие объекты базы данных.
- ➕ **Совместимость:** Логические резервные копии могут использоваться для миграции данных между различными системами управления базами данных или версиями, при условии, что целевая система поддерживает экспортированный формат или SQL-операторы.
- ➖ **Более медленное резервное копирование и восстановление:** Логические резервные копии могут быть медленнее, чем физические резервные копии, так как они требуют от движка базы данных преобразования данных в SQL-операторы или другой формат экспорта.
- ➖ **Увеличенная нагрузка на систему:** Создание логических резервных копий может привести к большей нагрузке на систему, так как процесс требует больше ресурсов ЦП и памяти для обработки и экспорта данных.

Manticore Search поддерживает [mysqldump](../Securing_and_compacting_a_table/Backup_and_restore.md#Backup-and-restore-with-mysqldump) для логических резервных копий.

### Физические резервные копии

Физические резервные копии включают копирование необработанных файлов данных и системных файлов, которые составляют базу данных. Этот тип резервного копирования по сути создает снимок физического состояния базы данных в определенный момент времени.

Плюсы и минусы физических резервных копий:
- ➕ **Скорость:** Физические резервные копии, как правило, быстрее, чем логические резервные копии, поскольку они включают копирование необработанных файлов данных непосредственно с диска.
- ➕ **Согласованность:** Физические резервные копии обеспечивают согласованное резервное копирование всей базы данных, так как все связанные файлы копируются вместе.
- ➕ **Низкая нагрузка на систему:** Создание физических резервных копий, как правило, создает меньшую нагрузку на систему по сравнению с логическими резервными копиями, так как процесс не включает дополнительную обработку данных.
- ➖ **Переносимость:** Физические резервные копии обычно менее переносимы, чем логические резервные копии, так как они могут зависеть от конкретного оборудования, операционной системы или конфигурации движка базы данных.
- ➖ **Гибкость:** Физические резервные копии не позволяют избирательно восстанавливать конкретные объекты базы данных, так как резервная копия содержит все необработанные файлы базы данных.
- ➖ **Совместимость:** Физические резервные копии нельзя использовать для миграции данных между различными системами управления базами данных или версиями, так как необработанные файлы данных могут быть несовместимы на разных платформах или программном обеспечении.

Manticore Search имеет командный инструмент [manticore-backup](../Securing_and_compacting_a_table/Backup_and_restore.md#Using-manticore-backup-command-line-tool) для физических резервных копий.

В заключение, логические резервные копии обеспечивают большую гибкость, переносимость и совместимость, но могут быть медленнее и более ресурсоемкими, в то время как физические резервные копии быстрее, более согласованные и менее ресурсоемкие, но могут быть ограничены в плане переносимости и гибкости. Выбор между этими двумя методами резервного копирования будет зависеть от вашей конкретной среды базы данных, оборудования и требований.

## Использование командного инструмента manticore-backup

Инструмент `manticore-backup`, входящий в официальные [пакеты](https://manticoresearch.com/install) Manticore Search, автоматизирует процесс резервного копирования таблиц для экземпляра, работающего в [RT-режиме](../Read_this_first.md#Real-time-mode-vs-plain-mode).

### Установка

**Если вы следовали [официальным инструкциям по установке](https://manticoresearch.com/install/), вы уже должны иметь все установлено и не нужно беспокоиться.** В противном случае [`manticore-backup`](https://github.com/manticoresoftware/manticoresearch-backup) требует PHP 8.1.10 и [определенные модули](https://github.com/manticoresoftware/executor/blob/main/build-linux) или [`manticore-executor`](https://github.com/manticoresoftware/executor), который является частью пакета `manticore-extra`, и вам нужно убедиться, что один из них доступен.

Обратите внимание, что `manticore-backup` пока недоступен для Windows.

### Как использовать

Сначала убедитесь, что вы выполняете `manticore-backup` на том же сервере, где работает экземпляр Manticore, который вы собираетесь резервировать.

Во-вторых, мы рекомендуем запускать инструмент от имени пользователя `root`, чтобы инструмент мог передать право собственности на файлы, которые вы резервируете. В противном случае резервная копия также будет сделана, но без передачи права собственности. В любом случае вы должны убедиться, что `manticore-backup` имеет доступ к каталогу данных экземпляра Manticore.

<!-- example backup1 -->

Единственным обязательным аргументом для `manticore-backup` является `--backup-dir`, который указывает место назначения для резервной копии. Если вы не укажете никаких дополнительных аргументов, `manticore-backup` будет:
- находить экземпляр Manticore, работающий с конфигурацией по умолчанию
- создавать подкаталог в каталоге `--backup-dir` с именем, содержащим временную метку
- резервировать все таблицы, найденные в экземпляре

<!-- request Example -->
```bash
manticore-backup --config=path/to/manticore.conf --backup-dir=backupdir
```

<!-- response Example -->
```bash
Copyright (c) 2023-2024, Manticore Software LTD (https://manticoresearch.com)

Файл конфигурации Manticore: /etc/manticoresearch/manticore.conf
Таблицы для резервного копирования: все таблицы
Целевая директория: /mnt/backup/

Конфигурация Manticore
  endpoint =  127.0.0.1:9308

Версии Manticore:
  manticore: 5.0.2
  columnar: 1.15.4
  secondary: 1.15.4
2022-10-04 17:18:39 [Info] Начало резервного копирования...
2022-10-04 17:18:39 [Info] Резервное копирование конфигурационных файлов...
2022-10-04 17:18:39 [Info]   конфигурационные файлы - ОК
2022-10-04 17:18:39 [Info] Резервное копирование таблиц...
2022-10-04 17:18:39 [Info]   pq (percolate) [425B]...
2022-10-04 17:18:39 [Info]    ОК
2022-10-04 17:18:39 [Info]   products (rt) [512B]...
2022-10-04 17:18:39 [Info]    ОК
2022-10-04 17:18:39 [Info] Выполнение синхронизации
2022-10-04 17:18:42 [Info]  ОК
2022-10-04 17:18:42 [Info] Вы можете найти резервную копию здесь: /mnt/backup/backup-20221004171839
2022-10-04 17:18:42 [Info] Время потрачено: 2.76s
2022-10-04 17:18:42 [Info] Завершено
```
<!-- end -->

<!-- example backup2 -->
Чтобы сделать резервное копирование только определенных таблиц, используйте флаг `--tables`, за которым следует список таблиц, разделенных запятыми, например `--tables=tbl1,tbl2`. Это будет резервировать только указанные таблицы и игнорировать остальные.

<!-- request Example -->
```bash
manticore-backup --backup-dir=/mnt/backup/ --tables=products
```

<!-- response Example -->
```bash
Copyright (c) 2023-2024, Manticore Software LTD (https://manticoresearch.com)

Файл конфигурации Manticore: /etc/manticoresearch/manticore.conf
Таблицы для резервного копирования: products
Целевая директория: /mnt/backup/

Конфигурация Manticore
  endpoint =  127.0.0.1:9308

Версии Manticore:
  manticore: 5.0.3
  columnar: 1.16.1
  secondary: 0.0.0
2022-10-04 17:25:02 [Info] Начало резервного копирования...
2022-10-04 17:25:02 [Info] Резервное копирование конфигурационных файлов...
2022-10-04 17:25:02 [Info]   конфигурационные файлы - ОК
2022-10-04 17:25:02 [Info] Резервное копирование таблиц...
2022-10-04 17:25:02 [Info]   products (rt) [512B]...
2022-10-04 17:25:02 [Info]    ОК
2022-10-04 17:25:02 [Info] Выполнение синхронизации
2022-10-04 17:25:06 [Info]  ОК
2022-10-04 17:25:06 [Info] Вы можете найти резервную копию здесь: /mnt/backup/backup-20221004172502
2022-10-04 17:25:06 [Info] Время потрачено: 4.82s
2022-10-04 17:25:06 [Info] Завершено
```
<!-- end -->

### Аргументы

| Аргумент | Описание |
|-|-|
| `--backup-dir=path` | Это путь к директории резервного копирования, где будет храниться резервная копия. Директория должна уже существовать. Этот аргумент является обязательным и не имеет значения по умолчанию. При каждом запуске резервного копирования, manticore-backup создаст подпапку в указанной директории с отметкой времени в имени (`backup-[datetime]`), и скопирует все необходимые таблицы в нее. Таким образом, `--backup-dir` является контейнером для всех ваших резервных копий, и безопасно запускать скрипт несколько раз.|
| `--restore[=backup]` | Восстановить из `--backup-dir`. Просто --restore перечисляет доступные резервные копии. `--restore=backup` восстановит из `<--backup-dir>/backup`. |
| `--force` | Пропустить проверку версий при восстановлении и аккуратно восстановить резервную копию. |
| `--disable-telemetry` | Передайте этот флаг, если вы хотите отключить отправку анонимизированных метрик в Manticore. Вы также можете использовать переменную окружения TELEMETRY=0 |
| `--config=/path/to/manticore.conf` | Путь к конфигурации Manticore. Необязательно. Если не предоставлено, будет использована конфигурация по умолчанию для вашей операционной системы. Используется для определения хоста и порта для связи с демоном Manticore. Инструмент `manticore-backup` поддерживает [динамическую конфигурацию](../Server_settings/Scripted_configuration.md) файлов. Вы можете указать опцию `--config` несколько раз, если ваша конфигурация распределена по нескольким файлам. |
| `--tables=tbl1,tbl2, ...` | Список таблиц, которые вы хотите резервировать, разделенный запятыми. Чтобы резервировать все таблицы, опустите этот аргумент. Все указанные таблицы должны существовать в экземпляре Manticore, из которого вы делаете резервное копирование, или резервная копия не удастся. |
| `--compress` | Необходимо ли, чтобы резервируемые файлы были сжаты. Не включено по умолчанию. | необязательно |
| `--unlock` | В редких случаях, когда что-то идет не так, таблицы могут остаться в заблокированном состоянии. Используйте этот аргумент, чтобы разблокировать их. |
| `--version` | Показать текущую версию. |
| `--help` | Показать эту справку. |

## Справочник SQL команды BACKUP

Вы также можете резервировать свои данные через SQL, выполнив простую команду `BACKUP TO /path/to/backup`.

> ПРИМЕЧАНИЕ: `BACKUP` не поддерживается в Windows. Рассмотрите возможность использования [mysqldump](../Securing_and_compacting_a_table/Backup_and_restore.md#Backup-and-restore-with-mysqldump) вместо этого.

> ПРИМЕЧАНИЕ: `BACKUP` требует [Manticore Buddy](../Installation/Manticore_Buddy.md). Если это не работает, убедитесь, что Buddy установлен.

### Общий синтаксис BACKUP

```sql
BACKUP
  [{TABLE | TABLES} a[, b]]
  [{OPTION | OPTIONS}
    async = {on | off | 1 | 0 | true | false | yes | no}
    [, compress = {on | off | 1 | 0 | true | false | yes | no}]
  ]
  TO path_to_backup
```

Например, чтобы сделать резервное копирование таблиц `a` и `b` в директорию `/backup`, выполните следующую команду:

```sql
BACKUP TABLES a, b TO /backup
```

Существуют различные опции для управления и настройки процесса резервного копирования, такие как:

* `async`: делает резервное копирование неблокирующим, позволяя вам получать ответ с идентификатором запроса немедленно и выполнять другие запросы во время выполнения резервного копирования. Значение по умолчанию равно `0`.
* `compress`: включает сжатие файлов с помощью zstd. Значение по умолчанию равно `0`.
Например, чтобы выполнить резервное копирование всех таблиц в асинхронном режиме с включенным сжатием в директорию `/tmp`:

```sql
BACKUP OPTION async = yes, compress = yes TO /tmp
```

### Важные соображения

1. Путь не должен содержать специальные символы или пробелы, так как они не поддерживаются.
2. Убедитесь, что Manticore Buddy запущен (по умолчанию он есть).

### Как резервное копирование поддерживает целостность таблиц
Чтобы обеспечить согласованность таблиц во время резервного копирования, инструменты резервного копирования Manticore Search используют инновационные команды [FREEZE и UNFREEZE](../Securing_and_compacting_a_table/Freezing_a_table.md). В отличие от традиционной функции блокировки и разблокировки таблиц, например, MySQL, команда `FREEZE` предотвращает запись данных на диск, позволяя при этом писать (в некоторой степени) и выбирать обновленные данные из таблицы.

Однако, если размер вашего куска RAM превышает порог `rt_mem_limit` в процессе длинных операций резервного копирования с множеством вставок, данные могут быть сброшены на диск, и операции записи будут заблокированы до завершения сброса. Тем не менее, инструмент поддерживает баланс между блокировкой таблиц, согласованностью данных и доступностью записи в базе данных, пока таблица заморожена.

Когда вы используете `manticore-backup` или SQL-команду `BACKUP`, команда `FREEZE` выполняется один раз и замораживает все таблицы, которые вы резервируете одновременно. Процесс резервного копирования затем резервирует каждую таблицу по одной, снимая заморозку после успешного резервного копирования каждой таблицы.

Если резервное копирование не удалось или было прервано, инструмент пытается разморозить все таблицы.

## Восстановление с использованием инструмента manticore-backup

<!-- пример restore_list -->
Чтобы восстановить экземпляр Manticore из резервной копии, используйте команду `manticore-backup` с аргументами `--backup-dir` и `--restore`. Например: `manticore-backup --backup-dir=/path/to/backups --restore`. Если вы не укажете аргумент для `--restore`, он просто выведет список всех резервных копий в `--backup-dir`.

<!-- request Пример -->
```bash
manticore-backup --backup-dir=/mnt/backup/ --restore
```

<!-- response Пример -->

```bash
Copyright (c) 2023-2024, Manticore Software LTD (https://manticoresearch.com)

Конфигурационный файл Manticore:
Директория резервного копирования: /tmp/

Доступные резервные копии: 3
  backup-20221006144635 (06 окт 2022 14:46:35)
  backup-20221006145233 (06 окт 2022 14:52:33)
  backup-20221007104044 (07 окт 2022 10:40:44)
```

<!-- end -->

<!-- пример restore -->

Чтобы начать работу по восстановлению, выполните `manticore-backup` с флагом `--restore=backup name`, где `backup name` — это имя директории резервного копирования внутри `--backup-dir`. Обратите внимание на следующее:
1. На том же хосте и порту не должно быть работающего экземпляра Manticore, который восстанавливается.
2. Существование старого файла `manticore.json` недопустимо.
3. Существование старого конфигурационного файла недопустимо.
4. Старая директория данных должна существовать и быть пустой.

Если все условия выполнены, восстановление продолжится. Инструмент предоставит подсказки, чтобы вам не пришлось их запоминать. Важно избегать перезаписи существующих файлов, поэтому убедитесь, что вы удалили их перед восстановлением, если они все еще существуют. Следовательно, все условия.

<!-- request Пример -->
```bash
manticore-backup --backup-dir=/mnt/backup/ --restore=backup-20221007104044
```

<!-- response Пример -->

```bash
Copyright (c) 2023-2024, Manticore Software LTD (https://manticoresearch.com)

Конфигурационный файл Manticore:
Директория резервного копирования: /tmp/
2022-10-07 11:17:25 [Info] Начало восстановления...

Конфигурация Manticore
  endpoint =  127.0.0.1:9308
2022-10-07 11:17:25 [Info] Восстановление конфигурационных файлов...
2022-10-07 11:17:25 [Info]   конфигурационные файлы - ОК
2022-10-07 11:17:25 [Info] Восстановление файлов состояния...
2022-10-07 11:17:25 [Info]   конфигурационные файлы - ОК
2022-10-07 11:17:25 [Info] Восстановление файлов данных...
2022-10-07 11:17:25 [Info]   конфигурационные файлы - ОК
2022-10-07 11:17:25 [Info] Резервная копия '/tmp/backup-20221007104044' успешно восстановлена.
2022-10-07 11:17:25 [Info] Затраченное время: 0.02s
2022-10-07 11:17:25 [Info] Готово
```

<!-- end -->

## Резервное копирование и восстановление с mysqldump

<!-- пример mysqldump_backup -->

> СОВЕТ: некоторые версии `mysqldump` / `mariadb-dump` требуют [Manticore Buddy](../../Installation/Manticore_Buddy.md). Если дамп не работает, убедитесь, что Buddy установлен.

Чтобы создать резервную копию вашей базы данных Manticore Search, вы можете использовать команду `mysqldump`. В примерах мы будем использовать порт и хост по умолчанию.

Обратите внимание, что `mysqldump` поддерживается только для таблиц в реальном времени.

<!-- request Основной -->
```bash
mysqldump -h0 -P9306 manticore > manticore_backup.sql
mariadb-dump -h0 -P9306 manticore > manticore_backup.sql
```

Выполнение этой команды создаст резервный файл с именем `manticore_backup.sql`. Этот файл будет содержать все данные и схемы таблиц.

<!-- request Режим замены -->
```bash
mysqldump -h0 -P9306 --replace --net-buffer-length=16m -etc manticore tbl > tbl.sql
```

Это создаст резервный файл `tbl.sql` с командами `replace` вместо `insert`, с сохранением имен столбцов в каждой партии. Документы будут упакованы в группы размером до 16 мегабайт. Не будет команд `drop`/`create table`. Это полезно для полной повторной индексации текста после изменения настроек токенизации.

<!-- request Режим репликации -->
```bash
mysqldump -etc --replace -h0 -P9306 -ucluster manticore cluster:tbl | mysql -P9306 -h0
mariadb-dump -etc --replace -h0 -P9306 -ucluster manticore cluster:tbl | mysql -P9306 -h0
```

В этом случае `mysqldump` будет генерировать команды типа `REPLACE INTO cluster:table ...`, которые будут отправлены непосредственно в экземпляр Manticore, в результате чего документы будут пере вставлены.
Используйте пользователя `cluster` и флаг `-t`, чтобы включить режим репликации. См. подробности в примечаниях ниже.

<!-- end -->

<!-- пример mysqldump_restore -->
### Восстановление

Если вы хотите восстановить базу данных Manticore Search из файла резервной копии, клиент mysql — это ваш инструмент по выбору.

Обратите внимание, что если вы восстанавливаете в [Простом режиме](../Read_this_first.md#Real-time-mode-vs-plain-mode), вы не можете удалять и пересоздавать таблицы напрямую. Поэтому вам следует:
- Использовать `mysqldump` с опцией `-t`, чтобы исключить операторы `CREATE TABLE` из вашей резервной копии.
- Вручную [ОЧИСТИТЬ](../Emptying_a_table.md) таблицы перед тем, как продолжить восстановление.

<!-- request SQL -->
```bash
mysql -h0 -P9306 < manticore_backup.sql
mariadb -h0 -P9306 < manticore_backup.sql
```

Эта команда позволяет восстановить все из файла `manticore_backup.sql`.
<!-- end -->

### Дополнительные параметры

Вот некоторые дополнительные настройки, которые можно использовать с mysqldump для настройки вашей резервной копии:

- `-t` пропускает команды `drop`/`create` таблиц. Полезно для полной переиндексации таблицы после изменения настроек токенизации.
- `--no-data`: Эта настройка исключает данные таблицы из резервной копии, в результате чего файл резервной копии состоит только из схем таблиц.
- `--ignore-table=[database_name].[table_name]`: Эта опция позволяет пропустить конкретную таблицу во время операции резервного копирования. Обратите внимание, что имя базы данных должно быть `manticore`.
- `--replace`, чтобы выполнить `replace` вместо `insert`. Полезно для полной переиндексации таблицы после изменения настроек токенизации.
- `--net-buffer-length=16M`, чтобы сделать пакеты размером до 16 мегабайт для более быстрого восстановления.
- `-e`, чтобы пакетировать документы. Полезно для более быстрого восстановления.
- `-c`, чтобы сохранить имена столбцов. Полезно для переиндексации таблицы после изменения её схемы (например, изменение порядка полей).

Для получения исчерпывающего списка настроек и их подробных описаний, пожалуйста, обратитесь к официальной [документации MySQL](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html) или [документации MariaDB](https://mariadb.com/kb/en/mariadb-dump/).

### Примечания

* Чтобы создать дамп в режиме репликации (где дамп включает `INSERT/REPLACE INTO <cluster_name>:<table_name>`):
  - Используйте пользователя `cluster`. Например: `mysqldump -u cluster ...` или `mariadb-dump -u cluster ...`. Вы можете изменить имя пользователя, включающего режим репликации для `mysqldump`, выполнив `SET GLOBAL cluster_user = new_name`.
  - Используйте флаг `-t`.
  - При указании таблицы в режиме репликации необходимо следовать синтаксису `cluster_name:table_name`. Например: `mysqldump -P9306 -h0 -t -ucluster manticore cluster:tbl`.
* Рекомендуется явно указывать базу данных `manticore`, когда вы планируете создать резервную копию всех баз данных, вместо использования опции `--all-databases`.
* Обратите внимание, что `mysqldump` не поддерживает резервное копирование распределенных таблиц и не может создавать резервные копии таблиц, содержащих не сохраненные поля. В таких случаях рассмотрите возможность использования `manticore-backup` или SQL-команды `BACKUP`. Если у вас есть распределенные таблицы, рекомендуется всегда указывать таблицы для дампа.

<!-- proofread -->

