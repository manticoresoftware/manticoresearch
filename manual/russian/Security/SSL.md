# SSL

В многих случаях вы можете захотеть зашифровать трафик между вашим клиентом и сервером. Для этого вы можете указать, чтобы сервер использовал [протокол HTTPS](../Server_settings/Searchd.md#listen), а не HTTP.

<!-- example CA 1 -->

Чтобы включить HTTPS, должно быть установлено как минимум две следующие директивы в разделе [searchd](../Server_settings/Searchd.md) файла конфигурации, и должно быть как минимум одно [listener](../Server_settings/Searchd.md#listen), установленное на `https`

* [ssl_cert](../Server_settings/Searchd.md#ssl_cert) файл сертификата
* [ssl_key](../Server_settings/Searchd.md#ssl_key) файл ключа

В дополнение к этому вы можете указать сертификат центра сертификации (так называемый корневой сертификат) в:

* [ssl_ca](../Server_settings/Searchd.md#ssl_ca) файл сертификата центра сертификации


<!-- intro -->
##### с CA:

<!-- request with CA -->
Пример с CA:

```ini
ssl_ca = ca-cert.pem
ssl_cert = server-cert.pem
ssl_key = server-key.pem
```

<!-- request without CA -->
Пример без CA:

```ini
ssl_cert = server-cert.pem
ssl_key = server-key.pem
```
<!-- end -->

## Генерация SSL файлов

Эти шаги помогут вам сгенерировать SSL сертификаты с использованием инструмента 'openssl'.

Сервер может использовать центр сертификации для проверки подписи сертификатов, но он также может работать только с частным ключом и сертификатом (без сертификата CA).

#### Сгенерировать ключ CA

```bash
openssl genrsa 2048 > ca-key.pem
```

#### Сгенерировать сертификат CA из ключа CA

Чтобы сгенерировать самоподписанный сертификат CA (корневой) из частного ключа (убедитесь, что вы заполнили хотя бы "Общее имя"), используйте следующую команду:

```bash
openssl req -new -x509 -nodes -days 365 -key ca-key.pem -out ca-cert.pem
```

#### Серверный сертификат

Сервер использует серверный сертификат для обеспечения связи с клиентом. Чтобы сгенерировать запрос на сертификат и частный ключ сервера (убедитесь, что вы заполнили хотя бы "Общее имя" и что оно отличается от общего имени корневого сертификата), выполните следующие команды:

```bash
openssl req -newkey rsa:2048 -days 365 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 365 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
```

После завершения вы можете проверить, что файлы ключа и сертификата были сгенерированы правильно, выполнив:

```bash
openssl verify -CAfile ca-cert.pem server-cert.pem
```

## Поведение защищенного соединения

Когда ваша конфигурация SSL действительна, доступны следующие функции:

 * Вы можете подключиться к мульти-протокольному порту (когда тип [listener](../Server_settings/Searchd.md#listen) не указан) через HTTPS и выполнять запросы. Как запрос, так и ответ будут зашифрованы с использованием SSL.
 * Вы можете подключиться к выделенному https порту с помощью HTTP и выполнять запросы. Соединение будет защищено (попытка подключиться к этому порту через простой HTTP будет отклонена с кодом ошибки 400).
 * Вы можете подключиться к порту MySQL с помощью клиента MySQL, используя защищенное соединение. Сессия будет защищена. Обратите внимание, что клиент Linux `mysql` по умолчанию пытается использовать SSL, поэтому типичное соединение с Manticore с действительной конфигурацией SSL скорее всего будет защищено. Вы можете проверить это, выполнив SQL команду 'status' после подключения.

Если ваша конфигурация SSL недействительна по какой-то причине (что демон определяет по тому факту, что защищенное соединение не может быть установлено), помимо недействительной конфигурации могут быть и другие причины, такие как невозможность загрузить соответствующую библиотеку SSL. В этом случае следующие функции не будут работать или будут работать незащищенным образом:

* Вы не можете подключиться к мульти-протокольному порту через HTTPS. Соединение будет разорвано.
* Вы не можете подключиться к выделенному `https` порту. Соединения HTTPS будут разорваны.
* Подключение к порту `mysql` через клиента MySQL не поддержит защищенное соединение SSL. Если клиент требует SSL, соединение завершится с ошибкой. Если SSL не требуется, будет использоваться простой MySQL или сжатые соединения.

### Осторожно:

* Соединения бинарного API (например, соединения от старых клиентов или взаимодействие между демонами master-agent) не защищены.
* SSL для репликации необходимо настраивать отдельно. Однако поскольку этап SST репликации осуществляется через соединение бинарного API, оно также не защищено.
* Вы все еще можете использовать любые внешние прокси (например, SSH-туннелирование) для защиты ваших соединений.
<!-- proofread -->
