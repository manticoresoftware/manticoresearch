# SSL

В многих случаях вы можете захотеть зашифровать трафик между клиентом и сервером. Для этого можно указать, что сервер должен использовать [протокол HTTPS](../Server_settings/Searchd.md#listen) вместо HTTP.

<!-- example CA 1 -->

Чтобы включить HTTPS, в секции [searchd](../Server_settings/Searchd.md) конфигурационного файла должны быть заданы как минимум следующие две директивы, и должен быть как минимум один [listener](../Server_settings/Searchd.md#listen) с типом `https`

* [ssl_cert](../Server_settings/Searchd.md#ssl_cert) файл сертификата
* [ssl_key](../Server_settings/Searchd.md#ssl_key) файл ключа

В дополнение к этому можно указать сертификат удостоверяющего центра (также известного как корневой сертификат):

* [ssl_ca](../Server_settings/Searchd.md#ssl_ca) файл сертификата удостоверяющего центра


<!-- intro -->
##### с CA:

<!-- request with CA -->
Пример с CA:

```ini
ssl_ca = ca-cert.pem
ssl_cert = server-cert.pem
ssl_key = server-key.pem
```

<!-- request without CA -->
Пример без CA:

```ini
ssl_cert = server-cert.pem
ssl_key = server-key.pem
```
<!-- end -->

## Генерация SSL файлов

Эти шаги помогут вам сгенерировать SSL сертификаты с помощью инструмента 'openssl'.

Сервер может использовать удостоверяющий центр для проверки подписи сертификатов, но также может работать только с приватным ключом и сертификатом (без сертификата CA).

#### Генерация ключа CA

```bash
openssl genrsa 2048 > ca-key.pem
```

#### Генерация сертификата CA из ключа CA

Для генерации самоподписанного CA (корневого) сертификата из приватного ключа (обязательно заполните хотя бы поле "Common Name"), используйте следующую команду:

```bash
openssl req -new -x509 -nodes -days 365 -key ca-key.pem -out ca-cert.pem
```

#### Сертификат сервера

Сервер использует серверный сертификат для защиты связи с клиентом. Чтобы сгенерировать запрос на сертификат и приватный ключ сервера (обязательно заполните хотя бы поле "Common Name", и оно должно отличаться от общего имени корневого сертификата), выполните следующие команды:

```bash
openssl req -newkey rsa:2048 -days 365 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 365 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
```

По завершении вы можете проверить корректность сгенерированных файлов ключа и сертификата, запустив:

```bash
openssl verify -CAfile ca-cert.pem server-cert.pem
```

## Поведение защищённого соединения

Когда ваша SSL-конфигурация корректна, доступны следующие возможности:

 * Вы можете подключаться к мультипротокольному порту (когда не указан [тип listener](../Server_settings/Searchd.md#listen)) по HTTPS и выполнять запросы. И запрос, и ответ будут зашифрованы SSL.
 * Вы можете подключаться к выделенному https порту по HTTP и выполнять запросы. Соединение будет защищённым (попытка подключиться к этому порту по обычному HTTP будет отклонена с кодом ошибки 400).
 * Вы можете подключаться к порту MySQL с помощью MySQL клиента, используя защищённое соединение. Сессия будет зашифрована. Обратите внимание, что Linux клиент `mysql` по умолчанию пытается использовать SSL, так что типичное подключение к Manticore с валидной SSL-конфигурацией скорее всего будет защищённым. Это можно проверить, выполнив SQL-команду 'status' после подключения.

Если по какой-либо причине ваша SSL-конфигурация недействительна (что демон определяет по невозможности установить защищённое соединение), помимо неверной конфигурации могут существовать и другие причины, например невозможность загрузить соответствующую SSL-библиотеку. В этом случае следующие вещи не будут работать или будут работать без защиты:

* Подключение к мультипротокольному порту по HTTPS невозможно. Соединение будет прервано.
* Подключение к выделенному `https` порту невозможно. HTTPS соединения будут отклоняться.
* Подключение к порту `mysql` через MySQL клиент не будет поддерживать SSL. Если клиент требует SSL, соединение не установится. Если SSL не требуется, будет использовано обычное MySQL или сжатое соединение.

### Внимание:

* Бинарные API соединения (например, соединения от старых клиентов или коммуникация мастер-агент между демонами) не защищены.
* SSL для репликации должен быть настроен отдельно. Однако так как этап SST репликации осуществляется через бинарное API соединение, он тоже не защищён.
* Вы всё ещё можете использовать любые внешние прокси (например, туннелирование через SSH) для защиты соединений.
<!-- proofread -->

