# Запуск Manticore вручную

Вы также можете запустить Manticore Search, вызвав непосредственно `searchd` (исполняемый файл сервера Manticore Search):

```shell
searchd [OPTIONS]
```

Обратите внимание, что если не указать путь к файлу конфигурации, `searchd` попытается найти его в нескольких местах в зависимости от операционной системы.


## Опции командной строки searchd


Опции, доступные для `searchd` во всех операционных системах:

* `--help` (`-h` сокращённо) выводит список всех параметров, которые могут использоваться в вашей конкретной сборке `searchd`.
* `--version` (`-v` сокращённо) показывает информацию о версии Manticore Search.
* `--config <file>` (`-c <file>` сокращённо) указывает `searchd` использовать указанный файл в качестве конфигурации.
* `--stop` используется для асинхронной остановки `searchd`, используя данные PID файла, как указано в конфигурационном файле Manticore. Поэтому может потребоваться также указать `searchd`, какой файл конфигурации использовать с опцией `--config`. Пример:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --stop
  ```

* `--stopwait` используется для синхронной остановки `searchd`. `--stop` по сути посылает запущенному процессу сигнал завершения работы (SIGTERM) и сразу же возвращает управление. `--stopwait` также пытается дождаться, пока запущенный экземпляр `searchd` действительно завершит выключение (например, сохранит все ожидающие изменения атрибутов) и выйдет. Пример:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --stopwait
  ```
  Возможные коды выхода:
    * 0 — успех
    * 1 — не удалось подключиться к работающему серверу searchd
    * 2 — сервер сообщил об ошибке при завершении работы
    * 3 — сервер аварийно завершил работу при завершении

* Команда `--status` используется для запроса статуса запущенного экземпляра `searchd`, используя данные подключения из (опционально) предоставленного файла конфигурации. Она попытается подключиться к запущенному экземпляру, используя первый найденный UNIX-сокет или TCP-порт из файла конфигурации. В случае успеха она запросит ряд значений состояния и счетчиков производительности и выведет их. Вы также можете использовать команду [SHOW STATUS](../Node_info_and_management/Node_status.md#SHOW-STATUS) для доступа к тем же счетчикам через протокол SQL. Примеры:

  ```bash
  $ searchd --status
  $ searchd --config /etc/manticoresearch/manticore.conf --status
  ```

* `--pidfile` используется для явного принуждения к использованию PID файла (в котором хранится идентификатор процесса `searchd`), несмотря на любые другие опции отладки, которые могут предполагать иное (например, `--console`). Это опция для отладки.

  ```bash
  $ searchd --console --pidfile
  ```

* `--console` используется для принудительного запуска `searchd` в консольном режиме. Обычно Manticore работает как обычное серверное приложение и записывает информацию в лог-файлы (как указано в файле конфигурации). Однако при отладке проблем с конфигурацией или самим сервером или для диагностики сложных проблем может быть удобнее заставить сервер выводить информацию непосредственно в консоль/командную строку, из которой его вызывают. Запуск в консольном режиме также означает, что процесс не будет форкаться (поисковые запросы будут выполняться последовательно), и логи не будут записываться. (Следует отметить, что консольный режим не является рекомендуемым способом запуска `searchd`.) Вы можете запустить так:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --console
  ```

* Опции `--logdebug`, `--logreplication`, `--logdebugv` и `--logdebugvv` включают дополнительный отладочный вывод в лог сервера. Они отличаются уровнем подробности логирования. Это опции для отладки и обычно не должны быть включены, так как могут сильно "засорять" лог. Их используют временно по необходимости во время сложных сессий отладки.

* `--iostats` используется вместе с опциями логирования (должен быть активирован `query_log` в `manticore.conf`) для предоставления более подробной информации по каждой отдельной операции ввода/вывода, выполненной в ходе запроса, с небольшим снижением производительности и увеличением объема логов. Статистика ввода/вывода не включает данные об операциях ввода/вывода для атрибутов, так как они загружаются через mmap. Чтобы включить, можно запускать `searchd` так:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --iostats
  ```

* `--cpustats` используется для предоставления отчёта о фактическом времени процессорного ЦП (в дополнение к "реальному времени") в файле лога запросов (для каждого отдельного запроса) и в статусном отчёте (агрегированном). Зависит от системного вызова Linux `clock_gettime()` или использует менее точный аналог на некоторых системах. Запускать можно так:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --cpustats
  ```

* `--port portnumber` (`-p` для краткости) используется для указания порта, на котором Manticore будет слушать бинарные протокольные запросы, обычно для целей отладки. Обычно по умолчанию используется порт 9312, но иногда нужно запустить на другом порте. Указание на командной строке перекрывает настройки в файле конфигурации. Допустимый диапазон от 0 до 65535, но порты с номерами 1024 и ниже обычно требуют привилегированного пользователя.

  Пример использования:

  ```bash
  $ searchd --port 9313
  ```

* `--listen ( address ":" port | port | path ) [ ":" protocol ]` (или `-l` для краткости) работает аналогично `--port`, но позволяет указать не только порт, но и полный путь, IP-адрес и порт, или путь Unix-доменного сокета, на котором `searchd` будет слушать. Иными словами, можно указать IP-адрес (или имя хоста) и номер порта, только номер порта или путь Unix-сокета. Если указан только номер порта без адреса, searchd будет слушать на всех сетевых интерфейсах. Unix-путь определяется ведущим слешем. В качестве последнего параметра можно также указать используемый обработчик протокола (listener) для соединений на этом сокете. Поддерживаемые значения протоколов — 'sphinx' и 'mysql' (MySQL протокол, используемый с версии 4.1).

* `--force-preread` запрещает серверу обслуживать любые входящие подключения до завершения предварительной загрузки файлов таблиц. По умолчанию при запуске сервер принимает подключения, пока файлы таблиц загружаются лениво в память. Эта опция расширяет поведение и заставляет ждать загрузки файлов.

* `--index (--table) <table>` (или коротко `-i (-t) <table>`) заставляет этот экземпляр `searchd` обслуживать только указанную таблицу. Как и `--port`, выше, обычно используется для отладки; более долгосрочные изменения обычно вносятся в сам файл конфигурации.

* `--strip-path` удаляет пути из всех имен файлов, на которые ссылается таблица (стоп-слова, словоформы, исключения и т.д.). Это полезно для использования таблиц, собранных на другой машине с возможно разными путями.

* `--replay-flags=<OPTIONS>` переключатель может использоваться для указания списка дополнительных опций воспроизведения бинарного лога. Поддерживаемые опции:
    * `accept-desc-timestamp` — игнорировать убывающие временные метки транзакций и воспроизводить такие транзакции в любом случае (поведение по умолчанию — выйти с ошибкой).
    * `ignore-open-errors` — игнорировать отсутствующие файлы binlog (поведение по умолчанию — выйти с ошибкой).
    * `ignore-trx-errors` — игнорировать любые ошибки транзакций и пропускать текущий файл binlog (поведение по умолчанию — выйти с ошибкой).
    * `ignore-all-errors` — игнорировать любые описанные выше ошибки (поведение по умолчанию — выйти с ошибкой).

    Пример:

    ```bash
    $ searchd --replay-flags=accept-desc-timestamp
    ```

* `--coredump` используется для включения сохранения core-файла или минидампа сервера при сбое. По умолчанию отключено для ускорения перезапуска сервера после сбоя. Полезно для отладки.

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --coredump
  ```

* `--new-cluster` инициализирует кластер репликации и делает сервер узлом-эталоном с защитой от [перезапуска кластера](../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md). В Linux также можно запустить `manticore_new_cluster`. Он запустит Manticore в режиме `--new-cluster` через systemd.

* `--new-cluster-force` инициализирует кластер репликации и делает сервер узлом-эталоном, минуя защиту от [перезапуска кластера](../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md). В Linux также можно запустить `manticore_new_cluster --force`. Он запустит Manticore в режиме `--new-cluster-force` через systemd.

* `--mockstack` анализирует и выводит необходимые размеры стека для рекурсивной оценки выражений, операций сопоставления шаблонов и обработки фильтров. Эта опция отладки выводит рассчитанные требования к стеку в консоль для целей оптимизации. Вывод предоставляет переменные окружения, которые можно использовать для настройки требований к стеку для различных операций.

  Пример:
  ```bash
  $ searchd --mockstack
  Manticore 7.4.7 e90b5afbb@25032706 dev (columnar 4.1.2 15bbcc7@25031206) (secondary 4.1.2 15bbcc7@25031206) (knn 4.1.2 15bbcc7@25031206)
  Copyright (c) 2001-2016, Andrew Aksyonoff
  Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)
  Copyright (c) 2017-2025, Manticore Software LTD (https://manticoresearch.com)

  export MANTICORE_KNOWN_CREATE_SIZE=200
  export MANTICORE_START_KNOWN_CREATE_SIZE=4504
  export MANTICORE_KNOWN_EXPR_SIZE=16
  export MANTICORE_START_KNOWN_EXPR_SIZE=200
  export MANTICORE_NONE=32
  export MANTICORE_START_NONE=104
  export MANTICORE_KNOWN_FILTER_SIZE=224
  export MANTICORE_START_KNOWN_FILTER_SIZE=11192
  export MANTICORE_KNOWN_MATCH_SIZE=320
  export MANTICORE_START_KNOWN_MATCH_SIZE=14552
  export NO_STACK_CALCULATION=1
  ```

### Опции для Windows

Существуют некоторые опции для `searchd`, специфичные для платформ Windows, касающиеся работы как службы, и доступны только в бинарных файлах для Windows.

Обратите внимание, что в Windows `searchd` по умолчанию работает в режиме `--console`, если вы не установите его как службу.

* `--install` устанавливает `searchd` как службу в Microsoft Management Console (Панель управления / Администрирование / Службы). Любые другие параметры, указанные в командной строке вместе с `--install`, также будут частью командной строки при последующих запусках службы. Например, при вызове `searchd` вам, вероятно, также потребуется указать конфигурационный файл с помощью `--config`, и вы сделаете это вместе с указанием `--install`. После вызова станут доступны обычные средства запуска/остановки службы через консоль управления, поэтому любые методы запуска, остановки и перезапуска служб применимы также к `searchd`. Пример:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf
  ```

  Если вы хотите получать статистику I/O каждый раз при запуске `searchd`, необходимо указать опцию на той же строке, что и команда `--install`, например:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf --iostats
  ```
* `--delete` удаляет службу из Microsoft Management Console и других мест, где регистрируются службы, после того как она была установлена с помощью `--install`. Обратите внимание, что это не удаляет программное обеспечение и не удаляет таблицы. Это означает, что служба не будет вызываться из системы служб и не будет запускаться при следующем старте машины. Если в настоящее время служба запущена, текущий экземпляр не будет завершён (до следующей перезагрузки или до `--stop`). Если служба была установлена с пользовательским именем (через `--servicename`), то при удалении нужно указать то же имя с `--servicename`. Пример:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --delete
  ```

* `--servicename <name>` применяет указанное имя к `searchd` при установке или удалении службы, как оно будет отображаться в Консоли управления; по умолчанию это будет searchd, но при развертывании на серверах, где несколько администраторов могут входить в систему, или в системе с несколькими экземплярами `searchd`, может быть применимо более описательное имя. Обратите внимание, что если не объединить с `--install` или `--delete`, этот параметр ничего не делает. Пример:
  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf --servicename ManticoreSearch
  ```

* `--ntservice` - это параметр, который передается Консолью управления Microsoft в `searchd` для запуска его в качестве службы на платформах Windows. Обычно нет необходимости вызывать это напрямую; обычно это вызывается Windows при запуске службы, хотя теоретически можно вызвать это как обычную службу из командной строки (в дополнение к `--console`).

* `--safetrace` принудительно заставляет `searchd` использовать только системный вызов backtrace() в отчетах об аварийных ситуациях. В определенных (редких) сценариях это может быть "более безопасным" способом получения отчета. Это параметр отладки.

* Переключатель `--nodetach` (только для Linux) указывает `searchd` не отсоединяться в фоновый режим. Это также приведет к выводу записей журнала в консоль. Обработка запросов происходит как обычно. Это параметр отладки, который также может быть полезен при запуске Manticore в Docker-контейнере для захвата его вывода.

## Каталог плагинов

Manticore использует [plugin_dir](../Server_settings/Common.md#plugin_dir) для хранения и использования плагинов Manticore Buddy. По умолчанию это значение доступно пользователю "manticore" при стандартной установке. Однако если вы запускаете демон searchd вручную с другим пользователем, демон может не иметь доступа к `plugin_dir`. Чтобы решить эту проблему, убедитесь, что вы указываете `plugin_dir` в общем разделе, в который может записывать пользователь, запускающий демон searchd.

## Сигналы

`searchd` поддерживает ряд сигналов:

* `SIGTERM` - Инициирует чистое завершение работы. Новые запросы обрабатываться не будут, но уже начатые запросы не будут принудительно прерваны.
* `SIGHUP` - Инициирует ротацию таблиц. В зависимости от значения настройки [seamless_rotate](../Server_settings/Searchd.md#seamless_rotate), новые запросы могут быть кратковременно приостановлены; клиенты получат временные ошибки.
* `SIGUSR1` - Принудительно перезакрывает файлы журнала searchd и журнала запросов, позволяя выполнять ротацию файлов журнала.

## Переменные среды

* `MANTICORE_TRACK_DAEMON_SHUTDOWN=1` включает подробное протоколирование при завершении работы searchd. Это полезно в случае каких-либо проблем с завершением, например, когда Manticore слишком долго завершается или застревает в процессе завершения.
<!-- proofread -->

