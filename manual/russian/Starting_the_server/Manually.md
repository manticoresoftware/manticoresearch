# Запуск Manticore вручную

Вы также можете запустить Manticore Search, вызвав `searchd` (бинарный файл сервера Manticore Search) напрямую:

```shell
searchd [OPTIONS]
```

Имейте в виду, что если не указать путь к файлу конфигурации, `searchd` попытается найти его в нескольких местах в зависимости от операционной системы.


## параметры командной строки searchd


Доступные параметры для `searchd` во всех операционных системах:

* `--help` (`-h` кратко) перечисляет все параметры, которые можно использовать в вашей конкретной сборке `searchd`.
* `--version` (`-v` кратко) показывает информацию о версии Manticore Search.
* `--config <file>` (`-c <file>` кратко) указывает `searchd` использовать указанный файл в качестве своей конфигурации.
* `--stop` используется для асинхронной остановки `searchd`, используя данные PID файла, как указано в файле конфигурации Manticore. Поэтому вам также может потребоваться подтвердить `searchd`, какой файл конфигурации использовать с опцией `--config`. Пример:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --stop
  ```

* `--stopwait` используется для синхронной остановки `searchd`. `--stop` в основном говорит работающему экземпляру выйти (отправляя ему SIGTERM) и затем немедленно возвращается. `--stopwait` также попытается дождаться, пока работающий экземпляр `searchd` фактически завершит выключение (например, сохранит все изменения атрибутов на ожидании) и выйдет. Пример:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --stopwait
  ```
  Возможные коды выхода следующие:
    * 0 при успехе
    * 1 если соединение с работающим сервером searchd не удалось
    * 2 если сервер сообщил об ошибке во время завершения работы
    * 3 если сервер аварийно завершился во время завершения работы

* Команда `--status` используется для запроса статуса работающего экземпляра `searchd`, используя параметры подключения из (опционально) предоставленного файла конфигурации. Он попытается подключиться к работающему экземпляру, используя первый найденный UNIX сокет или TCP порт из файла конфигурации. При успешном подключении он запросит ряд значений статуса и производительности и выведет их. Вы также можете использовать команду [SHOW STATUS](../Node_info_and_management/Node_status.md#SHOW-STATUS), чтобы получить те же счетчики через SQL протокол. Примеры:

  ```bash
  $ searchd --status
  $ searchd --config /etc/manticoresearch/manticore.conf --status
  ```

* `--pidfile` используется для явного принуждения к использованию PID файла (где хранится идентификационный номер процесса `searchd`) независимо от любых других отладочных опций, которые говорят об обратном (например, `--console`). Это опция для отладки.

  ```bash
  $ searchd --console --pidfile
  ```

* `--console` используется, чтобы принудить `searchd` в режим консоли. Обычно Manticore работает как обычное серверное приложение и записывает информацию в журналы (как указано в файле конфигурации). Тем не менее, при отладке проблем в конфигурации или самом сервере, или при попытке диагностировать трудные проблемы, может быть проще заставить его выводить информацию непосредственно в консоль/командную строку, из которой он вызывается. Запуск в режиме консоли также означает, что процесс не будет разветвлен (поэтому поиски выполняются последовательно) и журналы не будут писаться. (Следует отметить, что режим консоли не является предполагаемым способом запуска `searchd`.) Вы можете вызвать его следующим образом:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --console
  ```

* Опции `--logdebug`, `--logreplication`, `--logdebugv` и `--logdebugvv` включают дополнительный вывод отладки в журнал сервера. Они различаются по уровню подробности ведения журнала. Это опции для отладки и не должны обычно включаться, так как могут сильно загрязнить журнал. Они могут быть временно использованы по запросу для помощи в сложных сессиях отладки.

* `--iostats` используется совместно с опциями ведения журнала (в `manticore.conf` должен быть активирован `query_log`), чтобы предоставить более подробную информацию о вводе/выводе на основе каждого запроса о вводе/выводе, проведенном в процессе этого запроса, с небольшими потерями производительности и немного большими журналами. Статистика IO не включает информацию об операциях IO для атрибутов, так как они загружаются с помощью mmap. Чтобы включить это, вы можете запустить `searchd` следующим образом:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --iostats
  ```

* `--cpustats` используется для предоставления отчета фактического времени CPU (в дополнение к времени на стене) как в файле журнала запросов (для каждого данного запроса), так и в отчете о статусе (агрегированном). Это зависит от системного вызова `clock_gettime()` в Linux или возвращается к менее точному вызову на некоторых системах. Вы можете запустить `searchd` следующим образом:

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --cpustats
  ```

*  `--port portnumber` (`-p` кратко) используется для указания порта, на котором Manticore должен слушать, чтобы принимать запросы по бинарному протоколу, обычно для отладки. Обычно это по умолчанию 9312, но иногда вам нужно запустить его на другом порту. Указание его в командной строке переопределит то, что указано в файле конфигурации. Допустимый диапазон - от 0 до 65535, но порты с номерами 1024 и ниже обычно требуют привилегированной учетной записи для запуска.

  Пример использования:

  ```bash
  $ searchd --port 9313
  ```
* `--listen ( адрес ":" порт | порт | путь ) [ ":" протокол ]` (или `-l` для короткой версии) Работает как `--port`, но позволяет указать не только порт, но и полный путь, IP-адрес и порт или путь сокета Unix, на котором `searchd` будет слушать. Другими словами, вы можете указать либо IP-адрес (или имя хоста) и номер порта, только номер порта или путь сокета Unix. Если вы укажете номер порта, но не адрес, searchd будет слушать на всех сетевых интерфейсах. Путь Unix определяется начальным слэшем. В качестве последнего параметра вы также можете указать обработчик протокола (прослушиватель), который будет использоваться для соединений на этом сокете. Поддерживаемые значения протокола: 'sphinx' и 'mysql' (протокол MySQL, используемый с версии 4.1).

* `--force-preread` запрещает серверу обслуживать любые входящие соединения до завершения предварительного чтения файлов таблиц. По умолчанию, при запуске, сервер принимает соединения, пока файлы таблиц загружаются в память лениво. Это расширяет поведение и заставляет его ждать, пока файлы будут загружены.

* `--index (--table) <table>` (или `-i (-t) <table>` для короткой версии) заставляет этот экземпляр `searchd` обслуживать только указанную таблицу. Как и `--port`, выше, это обычно используется для целей отладки; более долгосрочные изменения обычно будут применяться к самому конфигурационному файлу.

* `--strip-path` удаляет имена путей из всех имен файлов, упомянутых в таблице (стоп-слова, формы слов, исключения и т.д.). Это полезно для захвата таблиц, созданных на другой машине с возможными различиями в макетах путей.

* `--replay-flags=<OPTIONS>` переключатель может использоваться для указания списка дополнительных параметров воспроизведения двоичного журнала. Поддерживаемые параметры:
    * `accept-desc-timestamp`, игнорировать убывающие временные метки транзакций и воспроизводить такие транзакции в любом случае (поведение по умолчанию — выход с ошибкой).
    * `ignore-open-errors`, игнорировать отсутствующие файлы binlog (поведение по умолчанию — выход с ошибкой).
    * `ignore-trx-errors`, игнорировать любые ошибки транзакций и пропускать текущий файл binlog (поведение по умолчанию — выход с ошибкой).
    * `ignore-all-errors`, игнорировать любые ошибки, описанные выше (поведение по умолчанию — выход с ошибкой).

    Пример:

    ```bash
    $ searchd --replay-flags=accept-desc-timestamp
    ```

* `--coredump` используется для включения сохранения файла ядра или минидампа сервера при сбое. Отключен по умолчанию для ускорения перезапуска сервера при сбое. Это полезно для целей отладки.

  ```bash
  $ searchd --config /etc/manticoresearch/manticore.conf --coredump
  ```

* `--new-cluster` инициализирует кластер репликации и делает сервер узлом-референцией с защитой [перезапуска кластера](../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md). В Linux вы также можете запустить `manticore_new_cluster`. Это запустит Manticore в режиме `--new-cluster` через systemd.

* `--new-cluster-force` инициализирует кластер репликации и делает сервер узлом-референцией, обходя защиту [перезапуска кластера](../Creating_a_cluster/Setting_up_replication/Restarting_a_cluster.md). В Linux вы также можете запустить `manticore_new_cluster --force`. Это запустит Manticore в режиме `--new-cluster-force` через systemd.

* `--mockstack` анализирует и сообщает необходимые размеры стека для рекурсивной оценки выражений, операций сопоставления шаблонов и обработки фильтров. Этот параметр отладки выводит рассчитанные требования к стеку на консоль для целей оптимизации. Вывод предоставляет переменные среды, которые могут быть использованы для настройки требований к стеку для различных операций.

  Пример:
  ```bash
  $ searchd --mockstack
  Manticore 7.4.7 e90b5afbb@25032706 dev (columnar 4.1.2 15bbcc7@25031206) (secondary 4.1.2 15bbcc7@25031206) (knn 4.1.2 15bbcc7@25031206)
  Copyright (c) 2001-2016, Andrew Aksyonoff
  Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)
  Copyright (c) 2017-2025, Manticore Software LTD (https://manticoresearch.com)

  export MANTICORE_KNOWN_CREATE_SIZE=200
  export MANTICORE_START_KNOWN_CREATE_SIZE=4504
  export MANTICORE_KNOWN_EXPR_SIZE=16
  export MANTICORE_START_KNOWN_EXPR_SIZE=200
  export MANTICORE_NONE=32
  export MANTICORE_START_NONE=104
  export MANTICORE_KNOWN_FILTER_SIZE=224
  export MANTICORE_START_KNOWN_FILTER_SIZE=11192
  export MANTICORE_KNOWN_MATCH_SIZE=320
  export MANTICORE_START_KNOWN_MATCH_SIZE=14552
  export NO_STACK_CALCULATION=1
  ```

### Windows options

Существуют некоторые параметры для `searchd`, которые специфичны для платформ Windows, касающиеся обработки как службы, и доступны только в Windows-версиях.

Обратите внимание, что в Windows searchd по умолчанию будет работать в режиме `--console`, если вы не установите его как службу.

* `--install` устанавливает `searchd` как службу в Консоли управления Microsoft (Панель управления / Администрирование / Службы). Любые другие параметры, указанные в командной строке, где указано `--install`, также станут частью командной строки при последующих запусках службы. Например, как часть вызова `searchd`, вам, вероятно, также потребуется указать файл конфигурации с помощью `--config`, и вы сделаете это так же, как и указав `--install`. После вызова обычно доступные услуги запуска/остановки будут доступны через консоль управления, так что любые методы, которые вы можете использовать для запуска, остановки и перезапуска служб, также применимы к `searchd`. Пример:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf
  ```

  Если вы хотите иметь статистику ввода-вывода каждый раз, когда запускаете `searchd`, вам нужно указать параметр в той же строке, что и команда `--install`, таким образом:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf --iostats
  ```
* `--delete` удаляет службу из Консоли управления Microsoft и других мест, где зарегистрированы службы, после того как она была ранее установлена с помощью `--install`. Обратите внимание, что это не удаляет программное обеспечение и не удаляет таблицы. Это означает, что служба не будет вызываться из системы служб и не будет запущена при следующем запуске машины. Если в данный момент служба работает, текущий экземпляр не будет завершен (до следующей перезагрузки или до `--stop`). Если служба была установлена с пользовательским именем (с помощью `--servicename`), то то же имя необходимо будет указать с помощью `--servicename` при вызове для удаления. Пример:

  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --delete
  ```

* `--servicename <name>` применяет данное имя к `searchd` при установке или удалении службы, как оно будет отображаться в Консоли управления; по умолчанию это searchd, но если развертывается на серверах, на которые могут войти несколько администраторов, или на системе с несколькими экземплярами `searchd`, может потребоваться более описательное имя. Обратите внимание, что если не объединить с `--install` или `--delete`, этот параметр ничего не делает. Пример:
  ```bat
  C:\WINDOWS\system32> C:\Manticore\bin\searchd.exe --install
     --config C:\Manticore\manticore.conf --servicename ManticoreSearch
  ```

* `--ntservice` — это опция, которая передается Консоле управления Microsoft в `searchd`, чтобы вызвать его как службу на платформах Windows. Обычно не требуется вызывать это напрямую; это обычно вызывается Windows, когда служба запускается, хотя, если вы хотите вызвать это как обычную службу из командной строки (как дополнение к `--console`), вы можете сделать это в теории.

* `--safetrace` заставляет `searchd` использовать только системный вызов backtrace() в отчетах об аварийных завершениях. В некоторых (редких) сценариях это может быть "более безопасным" способом получения этого отчета. Это опция отладки.

* `--nodetach` переключатель (только для Linux) говорит `searchd`, чтобы не отсоединяться в фоновом режиме. Это также приведет к тому, что записи журнала будут выводиться в консоль. Обработка запросов работает как обычно. Это опция отладки и может быть полезна, когда вы запускаете Manticore в контейнере Docker, чтобы захватить его вывод.

## Директория плагинов

Manticore использует [plugin_dir](../Server_settings/Common.md#plugin_dir) для хранения и использования плагинов Manticore Buddy. По умолчанию это значение доступно пользователю "manticore" в стандартной установке. Однако, если вы вручную запускаете демона searchd с другим пользователем, демон может не иметь доступа к `plugin_dir`. Чтобы решить эту проблему, убедитесь, что вы указываете `plugin_dir` в общем разделе, который может записывать пользователь, запускающий демон searchd.

## Сигналы

`searchd` поддерживает ряд сигналов:

* `SIGTERM` - Инициирует корректное завершение работы. Новые запросы обрабатываться не будут, но запросы, которые уже начались, не будут принудительно прерываться.
* `SIGHUP` - Инициирует ротацию таблиц. В зависимости от значения параметра [seamless_rotate](../Server_settings/Searchd.md#seamless_rotate) новые запросы могут быть ненадолго приостановлены; клиенты получат временные ошибки.
* `SIGUSR1` - Принуждает к повторному открытию журнала searchd и файлов журнала запросов, позволяя ротацию файлов журнала.

## Переменные окружения

* `MANTICORE_TRACK_DAEMON_SHUTDOWN=1` включает детализированное логирование во время отключения searchd. Это полезно в случае каких-либо проблем с отключением, таких как когда Manticore слишком долго отключается или зависает во время процесса отключения.
<!-- proofread -->

