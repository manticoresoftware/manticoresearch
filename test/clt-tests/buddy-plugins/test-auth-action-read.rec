––– comment –––
Test READ permission enforcement.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: READ permission allows SELECT, DESCRIBE, SHOW TABLES
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create table and users –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE TABLE readtest(content text, tag integer);"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "INSERT INTO readtest(id, content, tag) VALUES(1, 'test data', 10);"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'reader' IDENTIFIED BY 'readerpass1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: reader
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'reader';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'noperm' IDENTIFIED BY 'nopermpass1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: noperm
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– comment –––
––– 4.1.1 SELECT with READ — success –––
EXPECTED: Success (GRANT should apply immediately)
––– comment –––
––– input –––
MYSQL_PWD=readerpass1 mysql -E -ureader -h0 -P9306 -e "SELECT * FROM readtest;"
––– output –––
*************************** 1. row ***************************
     id: 1
content: test data
    tag: 10
––– comment –––
––– 4.1.2 SELECT without READ — denied –––
EXPECTED per spec: Permission denied
––– comment –––
––– input –––
MYSQL_PWD=nopermpass1 mysql -unoperm -h0 -P9306 -e "SELECT * FROM readtest;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'noperm'
––– comment –––
––– 4.1.3 DESCRIBE with READ — success –––
EXPECTED: Success
––– comment –––
––– input –––
MYSQL_PWD=readerpass1 mysql -E -ureader -h0 -P9306 -e "DESCRIBE readtest;"
––– output –––
*************************** 1. row ***************************
     Field: id
      Type: bigint
Properties:
*************************** 2. row ***************************
     Field: content
      Type: text
Properties: indexed stored
*************************** 3. row ***************************
     Field: tag
      Type: uint
Properties:
––– comment –––
––– 4.1.4 SHOW TABLES with READ — success –––
EXPECTED: Success
––– comment –––
––– input –––
MYSQL_PWD=readerpass1 mysql -E -ureader -h0 -P9306 -e "SHOW TABLES;" | grep "Table:" | sort
––– output –––
Table: readtest
