––– comment –––
Test REPLICATION permission enforcement.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: REPLICATION permission allows cluster operations
Note: Cluster tests require multi-node setup, simplified test here
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create users –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'repluser' IDENTIFIED BY 'repluserpass';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: repluser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT replication ON * TO 'repluser';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'noperm' IDENTIFIED BY 'nopermpass1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: noperm
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– comment –––
––– 4.5.1 CREATE CLUSTER with REPLICATION — success –––
EXPECTED per spec: Success or cluster-specific error (GRANT should apply immediately)
––– comment –––
––– input –––
MYSQL_PWD=repluserpass mysql -urepluser -h0 -P9306 -e "CREATE CLUSTER testcluster;" 2>&1
––– output –––
––– comment –––
––– 4.5.2 CREATE CLUSTER without REPLICATION — denied –––
EXPECTED per spec: Permission denied
––– comment –––
––– input –––
MYSQL_PWD=nopermpass1 mysql -unoperm -h0 -P9306 -e "CREATE CLUSTER blocked;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'noperm'
––– comment –––
––– 4.5.3 SHOW STATUS requires SCHEMA (replication-only user denied) –––
EXPECTED per spec mapping: Permission denied (SHOW STATUS is schema action)
––– comment –––
––– input –––
MYSQL_PWD=repluserpass mysql -urepluser -h0 -P9306 -e "SHOW STATUS LIKE 'cluster%';"
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'repluser'
––– comment –––
––– 4.5.4 SHOW STATUS succeeds after granting SCHEMA –––
EXPECTED per spec mapping: Success after explicit schema grant
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT schema ON * TO 'repluser';"
––– output –––
––– input –––
MYSQL_PWD=repluserpass mysql -E -urepluser -h0 -P9306 -e "SHOW STATUS LIKE 'cluster%';"
––– output –––
*************************** 1. row ***************************
Counter: #!/cluster_.+/!#
 Value: #!/.*/!#
