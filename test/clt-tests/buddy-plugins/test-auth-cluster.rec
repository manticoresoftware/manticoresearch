––– comment –––
Test Cluster Commands with AS USER.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec:
- CREATE CLUSTER ... AS USER 'user' assigns replication user
- User must have REPLICATION permission
- ALTER CLUSTER ... USER='user' changes assigned user
BUG CRITICAL: AS USER syntax not implemented for cluster commands
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create users with different permissions –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'repluser' IDENTIFIED BY 'repluser1234';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: repluser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT replication ON * TO 'repluser';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'norepluser' IDENTIFIED BY 'norepluser1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: norepluser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'norepluser';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "RELOAD AUTH;"
––– output –––
––– comment –––
––– 8.2.1 CREATE CLUSTER AS USER: Valid user with replication –––
EXPECTED per spec: Command accepted
BUG CRITICAL: AS USER syntax not implemented - syntax error
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER mycluster AS USER 'repluser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected CLUSTER, expecting USER near 'CLUSTER mycluster AS USER 'repluser''
––– comment –––
––– 8.2.2 CREATE CLUSTER AS USER: Invalid user (no replication) –––
EXPECTED per spec: Error - user lacks replication permission
BUG CRITICAL: syntax error instead of permission validation
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER badcluster AS USER 'norepluser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected CLUSTER, expecting USER near 'CLUSTER badcluster AS USER 'norepluser''
––– comment –––
––– 8.2.3 CREATE CLUSTER AS USER: Non-existent user –––
EXPECTED per spec: Error - user does not exist
BUG CRITICAL: syntax error instead of user validation
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER fakecluster AS USER 'nonexistent';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected CLUSTER, expecting USER near 'CLUSTER fakecluster AS USER 'nonexistent''
––– comment –––
––– 8.2.4 ALTER CLUSTER USER: Change assigned user –––
EXPECTED per spec: Command accepted for valid user
BUG CRITICAL: ALTER CLUSTER ... USER syntax not implemented
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "ALTER CLUSTER mycluster USER='repluser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P03: syntax error, unexpected tablename, expecting ADD or DROP or UPDATE near 'USER='repluser''
––– comment –––
––– 8.2.5 JOIN CLUSTER AS USER: Syntax test –––
EXPECTED per spec: Command accepted
BUG CRITICAL: AS USER syntax not implemented
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "JOIN CLUSTER testcluster AT '127.0.0.1:9312' AS USER 'repluser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P03: syntax error, unexpected AS, expecting $end near 'AS USER 'repluser''
