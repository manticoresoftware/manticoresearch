––– comment –––
Test Cluster Commands with effective replication user option.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec:
- CREATE/JOIN CLUSTER support user option as "'<username>' AS user"
- Effective user must have REPLICATION permission
- ALTER CLUSTER supports "UPDATE user '<username>'"
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create users with different permissions –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'repluser' IDENTIFIED BY 'repluser1234';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: repluser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT replication ON * TO 'repluser';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'norepluser' IDENTIFIED BY 'norepluser1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: norepluser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'norepluser';"
––– output –––
––– comment –––
––– 8.2.1 CREATE CLUSTER with explicit effective user: valid replication user –––
EXPECTED: Command accepted
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER mycluster 'repluser' AS user;" 2>&1
––– output –––
––– comment –––
––– 8.2.2 CREATE CLUSTER with explicit effective user: no replication permission –––
EXPECTED: Error - user lacks replication permission
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER badcluster 'norepluser' AS user;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'norepluser'
––– comment –––
––– 8.2.3 CREATE CLUSTER with explicit effective user: non-existent user –––
EXPECTED: Error - user does not exist
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE CLUSTER fakecluster 'nonexistent' AS user;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: user 'nonexistent' not found
––– comment –––
––– 8.2.4 ALTER CLUSTER UPDATE user: change assigned user –––
EXPECTED: Command accepted for valid user
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "ALTER CLUSTER mycluster UPDATE user 'repluser';" 2>&1
––– output –––
––– comment –––
––– 8.2.5 JOIN CLUSTER with explicit effective user: no replication permission –––
EXPECTED: Error - user lacks replication permission
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "JOIN CLUSTER testcluster AT '127.0.0.1:9312' 'norepluser' AS user;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'norepluser'
