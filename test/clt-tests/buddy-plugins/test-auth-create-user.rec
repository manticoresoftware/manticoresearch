––– comment –––
Test CREATE USER command.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: CREATE USER 'username' IDENTIFIED BY 'password'
Returns: token, username, generated_at

BUG: No password length validation — accepts short passwords like "short"
BUG: Empty password causes syntax error instead of validation error
BUG: GRANT returns (null) error
BUG CRITICAL: User without ADMIN permission can CREATE USER — security vulnerability!
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– 2.1.1 Successful user creation, returns token –––
EXPECTED per spec: Returns token, username, generated_at
ACTUAL: OK — works correctly
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'testuser1' IDENTIFIED BY 'testpass123';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: testuser1
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– comment –––
––– 2.1.2 Error on duplicate username –––
EXPECTED per spec: Error — user already exists
ACTUAL: OK — correct error
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE USER 'testuser1' IDENTIFIED BY 'anotherpass';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: user 'testuser1' already exists
––– comment –––
––– 2.1.3 Error on short password (<8 chars) –––
EXPECTED per spec: Error — password too short
ACTUAL: BUG — creates user with short password, no validation!
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'shortpw' IDENTIFIED BY 'short';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: password must be at least 8 characters
––– comment –––
––– 2.1.4 Error on empty password –––
EXPECTED per spec: Error — password cannot be empty
ACTUAL: BUG — syntax error instead of validation error
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE USER 'emptypw' IDENTIFIED BY '';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: password is empty
––– comment –––
––– 2.1.5 Error without ADMIN permission –––
EXPECTED per spec: Permission denied
ACTUAL: BUG CRITICAL — user without ADMIN can create users!
Note: GRANT also fails with (null)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'nonadmin' IDENTIFIED BY 'nonadmin123';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: nonadmin
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT READ ON * TO 'nonadmin';" 2>&1
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "RELOAD AUTH;"
––– output –––
––– input –––
MYSQL_PWD=nonadmin123 mysql -E -unonadmin -h0 -P9306 -e "CREATE USER 'hacker' IDENTIFIED BY 'hacker12345';" 2>&1
––– output –––
ERROR 1045 (42000) at line 1: Permission denied for user 'nonadmin'
