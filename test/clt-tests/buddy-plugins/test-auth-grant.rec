––– comment –––
Test GRANT command.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: GRANT action ON target TO 'username' [WITH ALLOW 0|1 [BUDGET 'json'] | WITH BUDGET 'json']
Actions: read, write, schema, admin, replication
Target: '*' (all) or 'tablename'

IMPORTANT: Actions must be lowercase (read, write, schema, admin, replication)
BUG: UPPERCASE actions like READ, WRITE return (null) — should be case-insensitive
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create test user –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'grantuser' IDENTIFIED BY 'grantpass123';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: grantuser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– comment –––
––– 2.5.1 GRANT read ON * –––
EXPECTED per spec: Success (empty output)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser';"
––– output –––
––– comment –––
––– 2.5.2 GRANT write ON 'table' –––
EXPECTED per spec: Success (empty output)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT write ON 'testtable' TO 'grantuser';"
––– output –––
––– comment –––
––– 2.5.3 GRANT schema ON * –––
EXPECTED per spec: Success (empty output)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT schema ON * TO 'grantuser';"
––– output –––
––– comment –––
––– 2.5.4 GRANT admin ON * –––
EXPECTED per spec: Success (empty output)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT admin ON * TO 'grantuser';"
––– output –––
––– comment –––
––– 2.5.5 GRANT replication ON * –––
EXPECTED per spec: Success (empty output)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT replication ON * TO 'grantuser';"
––– output –––
––– comment –––
––– 2.5.6 GRANT WITH BUDGET –––
EXPECTED per spec: Success with budget saved
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'budgetuser' IDENTIFIED BY 'budgetpass1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: budgetuser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON 'reports' TO 'budgetuser' WITH BUDGET '{\"queries_per_minute\":100}';"
––– output –––
––– comment –––
––– 2.5.6.1 GRANT WITH ALLOW 0 and BUDGET –––
EXPECTED per spec: Success with explicit deny rule and budget saved
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON 'denied_tbl' TO 'budgetuser' WITH ALLOW 0 BUDGET '{\"queries_per_minute\":7}';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "SELECT action, target, allow, budget FROM system.auth_permissions WHERE username='budgetuser' AND target='denied_tbl';"
––– output –––
*************************** 1. row ***************************
action: read
target: denied_tbl
 allow: 0
budget: {"queries_per_minute":7}
––– comment –––
––– 2.5.6.2 GRANT WITH ALLOW 1 –––
EXPECTED per spec: Success with explicit allow rule
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON 'allowed_tbl' TO 'budgetuser' WITH ALLOW 1;"
––– output –––
––– comment –––
––– 2.5.7 Error on duplicate permission –––
EXPECTED per spec: Error — already has permission
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: user 'grantuser' already has 'read' permission on '*'
––– comment –––
––– 2.5.8 Error for non-existent user –––
EXPECTED per spec: Error — user does not exist
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'nonexistent';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: user 'nonexistent' not found
––– comment –––
––– 2.5.9 Error on invalid action –––
EXPECTED per spec: Error — invalid action
ACTUAL: BUG — syntax error instead of validation error
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT invalid ON * TO 'grantuser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: unknown action 'invalid'
––– comment –––
––– 2.5.10 Error without ADMIN permission –––
EXPECTED per spec: Permission denied
ACTUAL: BUG CRITICAL — nonadmin bypasses ADMIN check, gets duplicate error instead of Permission denied!
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'nonadmin' IDENTIFIED BY 'nonadmin1234';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: nonadmin
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=nonadmin1234 mysql -unonadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser';" 2>&1
––– output –––
ERROR 1045 (42000) at line 1: Permission denied for user 'nonadmin'
––– comment –––
––– 2.5.11 Error on invalid ALLOW value –––
EXPECTED per spec: Validation error for ALLOW not in 0|1
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser' WITH ALLOW 2;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: wrong allowed '2'
––– comment –––
––– 2.5.12 Error on ALLOW true –––
EXPECTED per spec: Parser error (only integer 0|1 allowed)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser' WITH ALLOW true;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected TRUE, expecting integer or '-' near 'true'
––– comment –––
––– 2.5.13 Error on unsupported order WITH BUDGET ... ALLOW –––
EXPECTED per spec: Parser error (fixed order only)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser' WITH BUDGET '{\"queries_per_minute\":11}' ALLOW 0;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected ALLOW, expecting $end near 'ALLOW 0'
––– comment –––
––– 2.5.14 Error on unsupported ALLOW=1 form –––
EXPECTED per spec: Parser error (ALLOW=1 is not supported)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantuser' WITH ALLOW=1;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected '=', expecting integer or '-' near '=1'
––– comment –––
––– Verify permissions were granted –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "SELECT COUNT(*) AS cnt FROM system.auth_permissions WHERE username='grantuser';"
––– output –––
*************************** 1. row ***************************
cnt: 5
