––– comment –––
Test HTTP Bearer Token authentication.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: Token via POST /token endpoint, then use Authorization: Bearer <token>

BUG CRITICAL: POST /token returns Access denied — cannot get token via HTTP API
     (depends on HTTP Basic Auth which is broken)
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– 1.3.1 Get token via POST /token –––
EXPECTED per spec: {"token": "<new_token>"}
ACTUAL: Implemented — token issued for authenticated user
––– comment –––
––– input –––
curl -s -u admin:adminpass -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
#!/\s*\{"token":"[0-9a-f]{64}"\}/!#
––– comment –––
––– 1.3.2 Successful request with Bearer token –––
EXPECTED per spec: 200 OK with JSON result
ACTUAL: Implemented — valid bearer token works
––– comment –––
––– input –––
TOK=$(curl -s -u admin:adminpass -X POST http://127.0.0.1:9308/token -d "{}" | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
curl -s -H "Authorization: Bearer $TOK" -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
#!/\s*\{"token":"[0-9a-f]{64}"\}/!#
––– comment –––
––– 1.3.3 Reject with invalid token –––
EXPECTED per spec: Access denied error
ACTUAL: Rejects with hash size error — acceptable
––– comment –––
––– input –––
curl -s -H "Authorization: Bearer invalid_token_12345" http://127.0.0.1:9308/sql -d "query=SELECT 1"
––– output –––
{"error":"Access denied for token 'invalid_token_12345', error: argument 'token' has wrong hash size 9, expected 32"}
––– comment –––
––– 1.3.4 Reject with regenerated token (old token invalid) –––
EXPECTED per spec: New token works, previous token is invalidated
––– comment –––
––– input –––
TOK1=$(curl -s -u admin:adminpass -X POST http://127.0.0.1:9308/token -d "{}" | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
TOK2=$(curl -s -u admin:adminpass -X POST http://127.0.0.1:9308/token -d "{}" | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
[ "$TOK1" != "$TOK2" ] && echo "tokens differ"
curl -s -H "Authorization: Bearer $TOK1" -X POST http://127.0.0.1:9308/token -d "{}"
echo
curl -s -H "Authorization: Bearer $TOK2" -X POST http://127.0.0.1:9308/token -d "{}"
echo
––– output –––
tokens differ
#!/\{"error":"Access denied for token '.*'"\}/!#
#!/\s*\{"token":"[0-9a-f]{64}"\}/!#
