––– comment –––
Test HTTP POST /token endpoint.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: POST /token with Basic Auth returns new token
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– 3.1.1 POST /token with Basic Auth — success –––
EXPECTED per spec: {"token": "<new_token>"}
––– comment –––
––– input –––
curl -s -u admin:adminpass -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
#!/\s*\{"token":"[0-9a-f]{64}"\}/!#
––– comment –––
––– 3.1.2 POST /token without authorization — error –––
EXPECTED per spec: Access denied
ACTUAL: OK — different message but correct behavior
––– comment –––
––– input –––
curl -s -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
{"error":"Authorization header field missed"}
––– comment –––
––– 3.1.3 POST /token for non-admin user — success –––
EXPECTED per spec: Any authenticated user can rotate own token
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'httpuser' IDENTIFIED BY 'httpuser1234';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: httpuser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
curl -s -u httpuser:httpuser1234 -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
#!/\s*\{"token":"[0-9a-f]{64}"\}/!#
––– comment –––
––– Daemon-first additional coverage –––
Per spec update:
- POST /token rotates token for authenticated user
- No ADMIN permission required
––– comment –––
––– 3.1.4 POST /token with Bearer token — success (implemented path) –––
––– input –––
USR_TOKEN=$(MYSQL_PWD=adminpass mysql -N -B -uadmin -h0 -P9306 -e "TOKEN 'httpuser';" | tail -n1)
curl -s -H "Authorization: Bearer $USR_TOKEN" -X POST http://127.0.0.1:9308/token -d "{}"
––– output –––
{"token":"#!/[0-9a-f]{64}/!#"}
