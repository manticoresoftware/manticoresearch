––– comment –––
Test auth logging: all auth changes should be recorded.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: Auth-related operations should be logged
BUG: Operations are NOT logged to searchd.log
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– 7.1.1 CREATE USER is logged –––
EXPECTED per spec: CREATE USER operation appears in log
BUG: Operation is NOT logged
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'loguser' IDENTIFIED BY 'loguser12345';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: loguser
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– input –––
sleep 1; grep -c "loguser" /var/log/manticore/searchd.log
––– output –––
#!/[1-9][0-9]*/!#
––– comment –––
––– 7.1.2 DROP USER is logged –––
EXPECTED per spec: DROP USER operation appears in log
BUG: Operation is NOT logged
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "DROP USER 'loguser';"
––– output –––
––– input –––
sleep 1; grep -c "loguser" /var/log/manticore/searchd.log
––– output –––
#!/[1-9][0-9]*/!#
––– comment –––
––– 7.1.3 GRANT/REVOKE is logged –––
EXPECTED per spec: GRANT operation appears in log
BUG: Operation is NOT logged
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'grantlog' IDENTIFIED BY 'grantlog123';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: grantlog
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'grantlog';"
––– output –––
––– input –––
sleep 1; grep -ic "grant\|grantlog" /var/log/manticore/searchd.log
––– output –––
#!/[1-9][0-9]*/!#
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "DROP USER 'grantlog';"
––– output –––
––– comment –––
––– 7.1.4 Failed authentication is logged –––
EXPECTED per spec: Failed login attempts appear in log
––– comment –––
––– input –––
MYSQL_PWD=wrongpass mysql -ufakeuser -h0 -P9306 -e "SELECT 1;" 2>&1
––– output –––
ERROR 1047 (08S01): Access denied for user 'fakeuser' (using password: NO)
––– input –––
timeout 5 bash -c 'until [ "$(grep -ic "denied\|fakeuser\|auth" /var/log/manticore/searchd.log)" -ge 2 ]; do sleep 0.2; done'; grep -ic "denied\|fakeuser\|auth" /var/log/manticore/searchd.log
––– output –––
2
