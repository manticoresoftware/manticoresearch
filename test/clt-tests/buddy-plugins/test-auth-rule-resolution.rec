––– comment –––
Test Rule Resolution.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec:
- Deny overrides allow
- Specific target beats wildcard
- Default deny (no rules = denied)
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create tables –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE TABLE allowed_tbl(content text);"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "CREATE TABLE denied_tbl(content text);"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "INSERT INTO allowed_tbl(id, content) VALUES(1, 'allowed data');"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "INSERT INTO denied_tbl(id, content) VALUES(1, 'denied data');"
––– output –––
––– comment –––
––– 5.1.1 Deny overrides allow –––
EXPECTED per spec: explicit deny overrides wildcard allow
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'denyuser' IDENTIFIED BY 'denyuserpass';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: denyuser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON * TO 'denyuser';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON 'denied_tbl' TO 'denyuser' WITH ALLOW 0;"
––– output –––
––– input –––
MYSQL_PWD=denyuserpass mysql -E -udenyuser -h0 -P9306 -e "SELECT * FROM allowed_tbl;"
––– output –––
*************************** 1. row ***************************
     id: 1
content: allowed data
––– input –––
MYSQL_PWD=denyuserpass mysql -udenyuser -h0 -P9306 -e "SELECT * FROM denied_tbl;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'denyuser'
––– comment –––
––– 5.1.2 Specific target beats wildcard –––
EXPECTED per spec: Grant on specific table works, other tables denied
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'specificuser' IDENTIFIED BY 'specificpass';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: specificuser
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT read ON 'allowed_tbl' TO 'specificuser';"
––– output –––
––– input –––
MYSQL_PWD=specificpass mysql -E -uspecificuser -h0 -P9306 -e "SELECT * FROM allowed_tbl;"
––– output –––
*************************** 1. row ***************************
     id: 1
content: allowed data
––– input –––
MYSQL_PWD=specificpass mysql -uspecificuser -h0 -P9306 -e "SELECT * FROM denied_tbl;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'specificuser'
––– comment –––
––– 5.1.3 Default deny (no rules = denied) –––
EXPECTED per spec: User without any grants is denied everything
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'norules' IDENTIFIED BY 'norulespass1';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: norules
generated_at: #!/([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}|[A-Z][a-z]{2} [A-Z][a-z]{2} [ 0-9][0-9] [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} [0-9]{4})/!#
––– input –––
MYSQL_PWD=norulespass1 mysql -unorules -h0 -P9306 -e "SELECT * FROM allowed_tbl;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'norules'
