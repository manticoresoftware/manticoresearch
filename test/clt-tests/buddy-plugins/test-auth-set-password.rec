––– comment –––
Test SET PASSWORD command.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: SET PASSWORD 'newpass' [FOR 'username']
- Without FOR: changes own password
- With FOR: admin changes another user's password

BUG: Login with new password fails — user gets Permission denied after admin changed password
BUG CRITICAL: User without ADMIN permission can change other users' passwords — security vulnerability!
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create test user –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'pwuser' IDENTIFIED BY 'oldpass12345';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: pwuser
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– comment –––
––– 2.3.1 Change own password (without FOR) –––
EXPECTED per spec: Success
––– comment –––
––– input –––
MYSQL_PWD=oldpass12345 mysql -upwuser -h0 -P9306 -e "SET PASSWORD 'newpass12345';"
––– output –––
––– comment –––
––– 2.3.2 Admin changes another user's password –––
EXPECTED per spec: Success
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "SET PASSWORD 'adminset123' FOR 'pwuser';"
––– output –––
––– comment –––
––– 2.3.3 Login with old password — should fail –––
EXPECTED per spec: Access denied
––– comment –––
––– input –––
MYSQL_PWD=oldpass12345 mysql -upwuser -h0 -P9306 -e "SELECT 1;" 2>&1
––– output –––
ERROR 1047 (08S01): Access denied for user 'pwuser' (using password: YES)
––– comment –––
––– 2.3.4 Login with new password — should succeed –––
EXPECTED per spec: Success
ACTUAL: BUG — Permission denied even with correct new password
––– comment –––
––– input –––
MYSQL_PWD=adminset123 mysql -upwuser -h0 -P9306 -e "SELECT 1 AS test;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'pwuser'
––– comment –––
––– 2.3.5 Error on short password –––
EXPECTED per spec: Error — password too short
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "SET PASSWORD 'short' FOR 'pwuser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Password must be at least 8 characters
––– comment –––
––– 2.3.6 Error without ADMIN when changing other's password –––
EXPECTED per spec: Permission denied
ACTUAL: BUG CRITICAL — pwuser without ADMIN can change other user's password!
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'other' IDENTIFIED BY 'other1234567';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: other
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– input –––
MYSQL_PWD=adminset123 mysql -upwuser -h0 -P9306 -e "SET PASSWORD 'hacked123' FOR 'other';"
––– output –––
