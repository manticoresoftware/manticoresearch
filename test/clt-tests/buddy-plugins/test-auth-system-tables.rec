––– comment –––
Test direct access protection of system.auth_users and system.auth_permissions tables.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: system.auth_* tables should be protected from direct modification
- Regular users CANNOT INSERT/REPLACE/DELETE into system.auth_* tables
- Admin also cannot directly modify (only via SQL commands like CREATE USER)
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create a non-admin user with write permission –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'regular' IDENTIFIED BY 'regular1234';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: regular
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "GRANT write ON * TO 'regular';"
––– output –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "RELOAD AUTH;"
––– output –––
––– comment –––
––– 6.1.1 User cannot INSERT into system.auth_users –––
EXPECTED per spec: Permission denied for user 'regular'
BUG: User gets validation error instead of Permission denied
(Permission check should happen BEFORE data validation)
––– comment –––
––– input –––
MYSQL_PWD=regular1234 mysql -uregular -h0 -P9306 -e "INSERT INTO system.auth_users(username, salt, hashes) VALUES('hacker', 'aabb', '{\"password_sha1_no_salt\":\"aabb\"}');" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'regular'
––– comment –––
––– 6.1.2 User cannot DELETE from system.auth_permissions –––
EXPECTED per spec: Permission denied for user 'regular'
––– comment –––
––– input –––
MYSQL_PWD=regular1234 mysql -uregular -h0 -P9306 -e "DELETE FROM system.auth_permissions WHERE username='admin';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'regular'
––– comment –––
––– 6.1.3 Admin also cannot directly modify system.auth_users –––
EXPECTED per spec: Permission denied - only Buddy can modify via internal secure_hash
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "INSERT INTO system.auth_users(username, salt, hashes) VALUES('hacker', 'aabb', '{\"password_sha1_no_salt\":\"aabb\"}');" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'admin'
