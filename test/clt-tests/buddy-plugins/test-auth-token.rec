––– comment –––
Test TOKEN command.
Spec: https://github.com/manticoresoftware/manticoresearch/blob/wip_auth/src/auth/spec.md
Issue: https://github.com/manticoresoftware/manticoresearch/issues/2983
Admin credentials: admin / adminpass (bootstrap via auth.json)

Per spec: TOKEN ['username']
- Without username: regenerate own token
- With username: admin regenerates token for another user
Returns: token, username, generated_at

BUG CRITICAL: TOKEN command is NOT IMPLEMENTED — returns syntax error for all cases!
––– comment –––
––– block: ../base/start-searchd-with-auth –––
––– comment –––
––– Setup: create test user –––
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'tokenuser' IDENTIFIED BY 'tokenpass123';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: tokenuser
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– comment –––
––– 2.4.1 Generate own token (without username) –––
EXPECTED per spec: Returns token, username, generated_at
ACTUAL: BUG CRITICAL — syntax error, TOKEN not implemented
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "TOKEN;" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P02: syntax error, unexpected identifier near 'TOKEN'
––– comment –––
––– 2.4.2 Admin generates token for another user –––
EXPECTED per spec: Returns token, username, generated_at for tokenuser
ACTUAL: BUG CRITICAL — syntax error, TOKEN not implemented
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "TOKEN 'tokenuser';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P02: syntax error, unexpected identifier near 'TOKEN 'tokenuser''
––– comment –––
––– 2.4.3 Repeated TOKEN returns different token –––
EXPECTED per spec: New token each time, old token invalidated
ACTUAL: SKIPPED — TOKEN not implemented
––– comment –––
––– input –––
echo "SKIPPED: TOKEN command not implemented"
––– output –––
SKIPPED: TOKEN command not implemented
––– comment –––
––– 2.4.4 Error for non-existent user –––
EXPECTED per spec: Error — user does not exist
ACTUAL: BUG — syntax error instead of user validation (TOKEN not implemented)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "TOKEN 'nonexistent';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P02: syntax error, unexpected identifier near 'TOKEN 'nonexistent''
––– comment –––
––– 2.4.5 Error without ADMIN when generating other's token –––
EXPECTED per spec: Permission denied
ACTUAL: BUG — syntax error instead of permission check (TOKEN not implemented)
––– comment –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "CREATE USER 'other' IDENTIFIED BY 'other1234567';"
––– output –––
*************************** 1. row ***************************
       token: #!/[0-9a-f]{64}/!#
    username: other
generated_at: #!/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/!#
––– input –––
MYSQL_PWD=tokenpass123 mysql -utokenuser -h0 -P9306 -e "TOKEN 'other';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P02: syntax error, unexpected identifier near 'TOKEN 'other''
––– comment –––
––– Daemon-first additional coverage –––
––– comment –––
––– 2.4.6 Generate own token (implemented path) –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "TOKEN;"
––– output –––
*************************** 1. row ***************************
Username: admin
Token: #!/[0-9a-f]{64}/!#
––– comment –––
––– 2.4.7 Admin generates token for another user (implemented path) –––
––– input –––
MYSQL_PWD=adminpass mysql -E -uadmin -h0 -P9306 -e "TOKEN 'tokenuser';"
––– output –––
*************************** 1. row ***************************
Username: tokenuser
Token: #!/[0-9a-f]{64}/!#
––– comment –––
––– 2.4.8 Repeated TOKEN returns different token (implemented path) –––
––– input –––
TOK1=$(MYSQL_PWD=adminpass mysql -N -uadmin -h0 -P9306 -e "TOKEN;" | awk '{print $2}')
TOK2=$(MYSQL_PWD=adminpass mysql -N -uadmin -h0 -P9306 -e "TOKEN;" | awk '{print $2}')
[ "$TOK1" != "$TOK2" ] && echo "tokens differ"
––– output –––
tokens differ
––– comment –––
––– 2.4.9 Error for non-existent user (implemented path) –––
––– input –––
MYSQL_PWD=adminpass mysql -uadmin -h0 -P9306 -e "TOKEN 'nonexistent';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: user 'nonexistent' not found
––– comment –––
––– 2.4.10 Error without ADMIN when generating other's token (implemented path) –––
––– input –––
MYSQL_PWD=tokenpass123 mysql -utokenuser -h0 -P9306 -e "TOKEN 'other';" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: Permission denied for user 'tokenuser'
