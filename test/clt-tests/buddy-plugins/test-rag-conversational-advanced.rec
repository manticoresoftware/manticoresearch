––– comment –––
This test verifies advanced ConversationalRag plugin features:
- Multiple RAG models with different configurations
- Multiple content fields handling
- Conversation tracking across multiple queries
- Complex document structures with multiple text fields
––– input –––
export SEARCHD_FLAGS="--iostats --cpustats"
––– output –––
––– block: ../base/start-searchd-with-buddy –––
––– comment –––
Clean up any existing data
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS knowledge_base;"
––– output –––
––– comment –––
Create a complex table with multiple text fields and auto-embeddings
––– input –––
mysql -h0 -P9306 << EOF
CREATE TABLE knowledge_base (
    id BIGINT,
    title TEXT,
    summary TEXT,
    content TEXT,
    category TEXT,
    tags TEXT,
    embedding_vector FLOAT_VECTOR
    knn_type='hnsw'
    hnsw_similarity='cosine'
    model_name='sentence-transformers/all-MiniLM-L6-v2'
    from='content'
    api_key='\${OPENAI_API_KEY}'
) TYPE='rt';
EOF
––– output –––
––– comment –––
Insert test documents with rich content
––– input –––
mysql -h0 -P9306 << 'EOF'
INSERT INTO knowledge_base (id, title, summary, content, category, tags)
VALUES
(1, 'Getting Started with Manticore', 'Quick start guide', 'Install Manticore Search and configure your first index', 'Tutorial', 'installation,quickstart'),
(2, 'Vector Search Explained', 'Understanding vectors', 'Vector search uses embeddings to find semantically similar documents', 'Concepts', 'vectors,knn,similarity'),
(3, 'Full-Text Search Guide', 'Text search basics', 'Use MATCH() operator for full-text search with ranking', 'Tutorial', 'fulltext,match,ranking'),
(4, 'RAG Architecture', 'RAG pattern overview', 'Retrieval-Augmented Generation combines search with LLM for intelligent responses', 'Advanced', 'rag,llm,ai'),
(5, 'Clustering Setup', 'Distributed search', 'Configure replication and sharding for high availability', 'Advanced', 'cluster,replication,sharding');
EOF
––– output –––
––– comment –––
Verify all documents are inserted
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM knowledge_base;"
––– output –––
+----------+
| count(*) |
+----------+
|        5 |
+----------+
––– comment –––
Create multiple RAG models with different configurations
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL fast_assistant (llm_provider='openai', llm_model='gpt-3.5-turbo', settings='{\"temperature\":0.5, \"max_tokens\":1000, \"k_results\":3}');"
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL detailed_assistant (llm_provider='openai', llm_model='gpt-4o', style_prompt='You are an expert technical writer. Provide detailed, accurate explanations.', settings='{\"temperature\":0.3, \"max_tokens\":4000, \"k_results\":5}');"
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL creative_assistant (llm_provider='openai', llm_model='gpt-4o-mini', style_prompt='You are a helpful and friendly assistant. Use simple language.', settings='{\"temperature\":0.7, \"max_tokens\":2000, \"k_results\":4}');"
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– comment –––
Verify all models are created
––– input –––
mysql -h0 -P9306 -e "SHOW RAG MODELS;"
––– output –––
+--------------------------------------+--------------------+--------------+---------------+------------+
| uuid                                 | name               | llm_provider | llm_model     | created_at |
+--------------------------------------+--------------------+--------------+---------------+------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# | detailed_assistant | openai       | gpt-4o        | %{NUMBER} |
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# | creative_assistant | openai       | gpt-4o-mini   | %{NUMBER} |
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# | fast_assistant     | openai       | gpt-3.5-turbo | %{NUMBER} |
+--------------------------------------+--------------------+--------------+---------------+------------+
––– comment –––
Test with single content field
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Tell me about vector search', 'knowledge_base', 'fast_assistant', 'content')\G;"
––– output –––
*************************** 1. row ***************************
conversation_uuid: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
         response: #!/.*[Vv]ector.*[Ss]earch.*/!#
          sources: #!/\[.*/!#
––– comment –––
Test with two content fields (title, content)
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Explain vector search', 'knowledge_base', 'detailed_assistant', 'title,content')\G;"
––– output –––
*************************** 1. row ***************************
conversation_uuid: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
         response: #!/.*[Vv]ector.*[Ss]earch.*/!#
          sources: #!/\[.*/!#
––– comment –––
Test with multiple content fields (title, summary, content)
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Tell me about RAG architecture', 'knowledge_base', 'creative_assistant', 'title,summary,content')\G;" | grep -E "conversation_uuid:|response:|sources:"
––– output –––
conversation_uuid: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
         response: #!/.*(RAG|[Rr]etrieval|[Gg]eneration).*/!#
          sources: #!/\[.*/!#
––– comment –––
Test conversation tracking - first message in a new conversation
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('What is clustering?', 'knowledge_base', 'fast_assistant', 'title,content', 'conv-test-1234-5678-90ab-cdef12345678')\G;"
––– output –––
*************************** 1. row ***************************
conversation_uuid: conv-test-1234-5678-90ab-cdef12345678
         response: #!/.*[Cc]luster.*/!#
          sources: #!/\[.*/!#
––– comment –––
Test conversation tracking - follow-up message (should maintain context)
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('How do I configure it?', 'knowledge_base', 'fast_assistant', 'title,content', 'conv-test-1234-5678-90ab-cdef12345678')\G;"
––– output –––
*************************** 1. row ***************************
conversation_uuid: conv-test-1234-5678-90ab-cdef12345678
         response: #!/.+/!#
          sources: #!/\[.*/!#
––– comment –––
Test different model on same conversation
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('What are best practices?', 'knowledge_base', 'detailed_assistant', 'title,summary,content', 'conv-test-1234-5678-90ab-cdef12345678')\G;" | grep -E "conversation_uuid:|response:|sources:"
––– output –––
conversation_uuid: conv-test-1234-5678-90ab-cdef12345678
         response: #!/.+/!#
          sources: #!/\[.*/!#
––– comment –––
Test independent conversation - different context
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Show me tutorials', 'knowledge_base', 'creative_assistant', 'content', 'conv-other-aaaa-bbbb-cccc-dddddddddddd')\G;"
––– output –––
*************************** 1. row ***************************
conversation_uuid: conv-other-aaaa-bbbb-cccc-dddddddddddd
         response: #!/.+/!#
          sources: #!/\[.*\]/!#
––– comment –––
Cleanup - drop all models
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL fast_assistant;"
––– output –––
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL detailed_assistant;"
––– output –––
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL creative_assistant;"
––– output –––
––– comment –––
Verify all models are dropped
––– input –––
mysql -h0 -P9306 -e "SHOW RAG MODELS;"
––– output –––
––– comment –––
Cleanup table
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS knowledge_base;"
––– output –––
