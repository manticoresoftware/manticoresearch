––– comment –––
This test verifies the basic functionality of the ConversationalRag plugin.
It tests model creation, management, and conversational RAG queries.
The plugin combines vector search with LLM capabilities for intelligent responses.
Based on schema.sql and setup_rag_test.sh from issue #3978
––– input –––
export SEARCHD_FLAGS="--iostats --cpustats"
––– output –––
––– block: ../base/start-searchd-with-buddy –––
––– comment –––
Clean up any existing RAG data
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS docs;"
––– output –––
––– comment –––
Create a test table with vector embeddings for RAG search
Note: knn_dims is NOT specified when using model_name - dimensions are auto-detected
API_KEY is required for remote OpenAI embedding models
––– input –––
mysql -h0 -P9306 << EOF
CREATE TABLE docs (
    id BIGINT,
    content TEXT,
    title TEXT,
    embedding_vector FLOAT_VECTOR
    knn_type='hnsw'
    hnsw_similarity='cosine'
    model_name='sentence-transformers/all-MiniLM-L6-v2'
    from='content,title'
    api_key='\${OPENAI_API_KEY}'
) TYPE='rt';
EOF
––– output –––
––– comment –––
Insert sample documents - vectors are generated automatically from content and title
––– input –––
mysql -h0 -P9306 -e "INSERT INTO docs (id, content, title) VALUES (1, 'Vector search uses embeddings to find semantically similar documents', 'Vector Search Guide');"
––– output –––
––– input –––
mysql -h0 -P9306 -e "INSERT INTO docs (id, content, title) VALUES (2, 'Full-text search and KNN capabilities for efficient retrieval', 'Manticore Features');"
––– output –––
––– input –––
mysql -h0 -P9306 -e "INSERT INTO docs (id, content, title) VALUES (3, 'Retrieval-Augmented Generation combines search with LLM for intelligent responses', 'RAG Introduction');"
––– output –––
––– comment –––
Wait for auto-embeddings generation (async via Buddy)
––– input –––
mysql -h0 -P9306 -e "debug sleep 20;" > /dev/null 2>&1
––– output –––
––– comment –––
Verify documents are inserted
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM docs;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Test CREATE RAG MODEL - basic configuration
––– input –––
mysql -h0 -P9306 << 'EOF'
CREATE RAG MODEL test_assistant (
    llm_provider='openai',
    llm_model='gpt-4o-mini'
);
EOF
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– comment –––
Test CREATE RAG MODEL - advanced configuration with custom settings
––– input –––
mysql -h0 -P9306 << 'EOF'
CREATE RAG MODEL advanced_assistant (
    llm_provider='openai',
    llm_model='gpt-4o',
    style_prompt='You are a helpful assistant specializing in search technology',
    settings='{"temperature":0.3, "max_tokens":2000, "k_results":5}'
);
EOF
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– comment –––
Test SHOW RAG MODELS - should display created models
––– input –––
mysql -h0 -P9306 -e "SHOW RAG MODELS;"
––– output –––
+--------------------------------------+--------------------+--------------+-------------+------------+
| uuid                                 | name               | llm_provider | llm_model   | created_at |
+--------------------------------------+--------------------+--------------+-------------+------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# | advanced_assistant | openai       | gpt-4o      | %{NUMBER} |
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# | test_assistant     | openai       | gpt-4o-mini | %{NUMBER} |
+--------------------------------------+--------------------+--------------+-------------+------------+
––– comment –––
Test DESCRIBE RAG MODEL - verify model configuration
––– input –––
mysql -h0 -P9306 -e "DESCRIBE RAG MODEL test_assistant\G"
––– output –––
*************************** 1. row ***************************
property: id
   value: %{NUMBER}
*************************** 2. row ***************************
property: llm_provider
   value: openai
*************************** 3. row ***************************
property: llm_model
   value: gpt-4o-mini
*************************** 4. row ***************************
property: style_prompt
   value:
*************************** 5. row ***************************
property: uuid
   value: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
*************************** 6. row ***************************
property: name
   value: test_assistant
*************************** 7. row ***************************
property: created_at
   value: %{NUMBER}
*************************** 8. row ***************************
property: updated_at
   value: %{NUMBER}
––– input –––
mysql -h0 -P9306 -e "DESCRIBE RAG MODEL advanced_assistant\G"
––– output –––
*************************** 1. row ***************************
property: id
   value: %{NUMBER}
*************************** 2. row ***************************
property: llm_provider
   value: openai
*************************** 3. row ***************************
property: llm_model
   value: gpt-4o
*************************** 4. row ***************************
property: style_prompt
   value: You are a helpful assistant specializing in search technology
*************************** 5. row ***************************
property: uuid
   value: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
*************************** 6. row ***************************
property: name
   value: advanced_assistant
*************************** 7. row ***************************
property: created_at
   value: %{NUMBER}
*************************** 8. row ***************************
property: updated_at
   value: %{NUMBER}
––– comment –––
Test CALL CONVERSATIONAL_RAG - basic query without conversation UUID
This should succeed with OPENAI_API_KEY set
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('What is vector search?', 'docs', 'test_assistant', 'content')\G"
––– output –––
*************************** 1. row ***************************
conversation_uuid: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
         response: #!/.*[Vv]ector.*[Ss]earch.*/!#
          sources: #!/\[.*/!#
––– comment –––
Test CALL CONVERSATIONAL_RAG - with multiple content fields
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Tell me about RAG', 'docs', 'test_assistant', 'title,content')\G"
––– output –––
*************************** 1. row ***************************
conversation_uuid: #!/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}/!#
         response: #!/.+/!#
          sources: #!/\[.*/!#
––– comment –––
Test CALL CONVERSATIONAL_RAG - with conversation UUID for context tracking
––– input –––
mysql -h0 -P9306 -e "CALL CONVERSATIONAL_RAG('Can you explain more?', 'docs', 'test_assistant', 'content', 'test-conv-12345678-1234-1234-1234-123456789abc')\G"
––– output –––
*************************** 1. row ***************************
conversation_uuid: test-conv-12345678-1234-1234-1234-123456789abc
         response: #!/.+/!#
          sources: #!/\[.*/!#
––– comment –––
Test DROP RAG MODEL - cleanup
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL test_assistant;"
––– output –––
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL advanced_assistant;"
––– output –––
––– comment –––
Verify models are dropped
––– input –––
mysql -h0 -P9306 -e "SHOW RAG MODELS;"
––– output –––
––– comment –––
Cleanup test table
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS docs;"
––– output –––
