––– comment –––
This test verifies error handling in the ConversationalRag plugin.
It tests various invalid scenarios to ensure proper validation and error messages.
––– input –––
export SEARCHD_FLAGS="--iostats --cpustats"
––– output –––
––– block: ../base/start-searchd-with-buddy –––
––– comment –––
Setup: Create a test table with auto-embeddings for negative tests
––– input –––
mysql -h0 -P9306 << EOF
CREATE TABLE test_docs (
    id BIGINT,
    content TEXT,
    title TEXT,
    embedding_vector FLOAT_VECTOR
    knn_type='hnsw'
    hnsw_similarity='cosine'
    model_name='sentence-transformers/all-MiniLM-L6-v2'
    from='content'
    api_key='\${OPENAI_API_KEY}'
) TYPE='rt';
EOF
––– output –––
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_docs (id, content, title) VALUES (1, 'Test document for error handling', 'Test Doc');"
––– output –––
––– comment –––
Create a valid model for testing
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL valid_model (llm_provider='openai', llm_model='gpt-4o-mini');"
––– output –––
+--------------------------------------+
| uuid                                 |
+--------------------------------------+
| #!/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/!# |
+--------------------------------------+
––– comment –––
Test 1: CREATE RAG MODEL with invalid provider
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_provider_model (llm_provider='invalid_provider', llm_model='gpt-4o-mini');"
––– output –––
ERROR 1064 (42000) at line 1: Invalid LLM provider: invalid_provider. Only 'openai' is supported.
––– comment –––
Test 2: CREATE RAG MODEL with missing required parameter
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL incomplete_model (llm_provider='openai');"
––– output –––
ERROR 1064 (42000) at line 1: Required field 'llm_model' is missing or empty
––– comment –––
Test 3: CREATE RAG MODEL with duplicate name
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL valid_model (llm_provider='openai', llm_model='gpt-4o-mini');"
––– output –––
ERROR 1064 (42000) at line 1: RAG model 'valid_model' already exists
––– comment –––
Test 4: DESCRIBE RAG MODEL that doesn't exist
––– input –––
mysql -h0 -P9306 -e "DESCRIBE RAG MODEL nonexistent_model;"
––– output –––
ERROR 1064 (42000) at line 1: RAG model 'nonexistent_model' not found
––– comment –––
Test 5: CALL CONVERSATIONAL_RAG with non-existent model
––– input –––
mysql -h0 -P9306 << 'EOF'
CALL CONVERSATIONAL_RAG(
    'test query',
    'test_docs',
    'nonexistent_model',
    'content'
);
EOF
––– output –––
ERROR 1064 (42000) at line 1: RAG model 'nonexistent_model' not found
––– comment –––
Test 6: CALL CONVERSATIONAL_RAG with non-existent table
––– input –––
mysql -h0 -P9306 << 'EOF'
CALL CONVERSATIONAL_RAG(
    'test query',
    'nonexistent_table',
    'valid_model',
    'content'
);
EOF
––– output –––
ERROR 1064 (42000) at line 1: Schema detection failed: no such table 'nonexistent_table'
––– comment –––
Test 8: CALL CONVERSATIONAL_RAG with missing required parameters (too few arguments)
––– input –––
mysql -h0 -P9306 << 'EOF'
CALL CONVERSATIONAL_RAG(
    'test query',
    'test_docs'
);
EOF
––– output –––
ERROR 1064 (42000) at line 1: content_fields parameter is required (position 4)
––– comment –––
Test 9: DROP non-existent RAG MODEL
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL nonexistent_model;"
––– output –––
ERROR 1064 (42000) at line 1: RAG model 'nonexistent_model' not found
––– comment –––
Test 10: CREATE RAG MODEL with invalid temperature (below 0)
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_temp_low_model (llm_provider='openai', llm_model='gpt-4o-mini', temperature='-0.5');"
––– output –––
ERROR 1064 (42000) at line 1: Temperature must be between 0 and 2
––– comment –––
Test 11: CREATE RAG MODEL with out-of-range temperature (above 2)
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_temp_model (llm_provider='openai', llm_model='gpt-4o-mini', temperature='3.0');"
––– output –––
ERROR 1064 (42000) at line 1: Temperature must be between 0 and 2
––– comment –––
Test 12: CREATE RAG MODEL with invalid max_tokens (above 32768)
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_tokens_model (llm_provider='openai', llm_model='gpt-4o-mini', max_tokens='100000');"
––– output –––
ERROR 1064 (42000) at line 1: max_tokens must be between 1 and 32768
––– comment –––
Test 13: CREATE RAG MODEL without llm_provider parameter
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL no_provider_model (llm_model='gpt-4o-mini');"
––– output –––
ERROR 1064 (42000) at line 1: Required field 'llm_provider' is missing or empty
––– comment –––
Test 14: CREATE RAG MODEL with k_results less than 1
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_k_low_model (llm_provider='openai', llm_model='gpt-4o-mini', k_results='0');"
––– output –––
ERROR 1064 (42000) at line 1: k_results must be between 1 and 50
––– comment –––
Test 15: CREATE RAG MODEL with k_results greater than 50
––– input –––
mysql -h0 -P9306 -e "CREATE RAG MODEL invalid_k_high_model (llm_provider='openai', llm_model='gpt-4o-mini', k_results='51');"
––– output –––
ERROR 1064 (42000) at line 1: k_results must be between 1 and 50
––– comment –––
Cleanup
––– input –––
mysql -h0 -P9306 -e "DROP RAG MODEL valid_model;"
––– output –––
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_docs;"
––– output –––
