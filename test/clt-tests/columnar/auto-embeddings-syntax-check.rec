Test vector search with MODEL_NAME and FROM clause for automatic vector generation from text fields

––– comment –––
Start Manticore Search with Buddy
––– block: ../base/start-searchd-with-buddy –––
––– comment –––
Test successful table creation with MODEL_NAME and FROM
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test (title1 TEXT, title2 TEXT, strattr STRING, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'title1, title2, strattr') engine = 'columnar'"; echo $?
––– output –––
0
––– comment –––
Verify table structure shows the vector field with proper configuration
––– input –––
mysql -h0 -P9306 -e "SHOW CREATE TABLE test"
––– output –––
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                             |
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| test  | CREATE TABLE test (
id bigint,
title1 text,
title2 text,
strattr string attribute,
image_vector float_vector knn_type='hnsw' knn_dims='384' hnsw_similarity='L2' model_name='sentence-transformers/all-MiniLM-L6-v2'
) engine='columnar' |
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
––– comment –––
Test insert with auto-generated vectors using empty parentheses
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test VALUES(1,'sample title','another title','string attribute',())"; echo $?
––– output –––
0
––– comment –––
Test insert with more data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test VALUES(2,'machine learning','deep learning','AI technology',())"; echo $?
––– output –––
0
––– comment –––
Verify data was inserted
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) as total_rows FROM test"
––– output –––
+------------+
| total_rows |
+------------+
|          2 |
+------------+
––– comment –––
Test that vectors were generated by checking specific ID
––– input –––
mysql -h0 -P9306 -e "SELECT id FROM test WHERE id=1"
––– output –––
+------+
| id   |
+------+
|    1 |
+------+
––– comment –––
Test error case: invalid model name
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid (title1 TEXT, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'invalid-model-name' FROM = 'title1') engine = 'columnar'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_invalid': prealloc: Failed to download model configuration
––– comment –––
Test error case: FROM clause without MODEL_NAME
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_no_model (title1 TEXT, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' FROM = 'title1') engine = 'columnar'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P03: knn_dims and hnsw_similarity are required if knn_type='hnsw' near ') engine = 'columnar''
––– comment –––
Test case: MODEL_NAME without FROM clause (should fail)
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_no_from (title1 TEXT, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2') engine = 'columnar'"
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_no_from': 'from' setting empty for KNN attribute 'image_vector'
––– comment –––
Test insert without FROM clause (should fail)
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_no_from VALUES(1,'test title',())"
––– output –––
––– comment –––
ERROR 1064 (42000) at line 1: Cannot create table with column names missing
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid_field (title1 TEXT, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'nonexistent_field') engine = 'columnar'" 2>&1
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– comment –––
Test successful case with single field in FROM
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_single_field (title TEXT, image_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'title') engine = 'columnar'"; echo $?
––– output –––
0
––– comment –––
Test insert into single field table with vector specified
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field VALUES(1,'natural language processing',())"; echo $?
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– comment –––
Test insert into single field table with ONLY vector specified
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (image_vector) VALUES(())"; echo $?
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (image_vector) VALUES('(1, 2, 3)')"
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– comment –––
Test insert into single field table with vector specified and some real vector
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (image_vector) VALUES((0, 1, 2))"
––– output –––
ERROR 1064 (42000) at line 1: attribute 'image_vector' has model_name=sentence-transformers/all-MiniLM-L6-v2 specified, but vector contents with 3 values is provided
––– comment –––
Verify single field data exists
––– input –––
mysql -h0 -P9306 -e "SELECT count(*) FROM test_single_field WHERE id=1"
––– output –––
+----------+
| count(*) |
+----------+
|        1 |
+----------+
––– comment –––
Clean up test tables
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test"; echo $?
––– output –––
0
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_no_from"; echo $?
––– output –––
0
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_single_field"; echo $?
––– output –––
0
