Test vector search with MODEL_NAME and FROM clause for automatic vector generation from text fields

––– comment –––
Start Manticore Search
––– block: ../base/start-searchd –––
––– comment –––
Test successful table creation with MODEL_NAME and FROM
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test (title1 TEXT, title2 TEXT, strattr STRING, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'title1, title2, strattr') engine = 'columnar'"; echo $?
––– output –––
0
––– comment –––
Verify table structure shows the vector field with proper configuration
––– input –––
mysql -h0 -P9306 -e "SHOW CREATE TABLE test"
––– output –––
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                 |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| test  | CREATE TABLE test (
id bigint,
title1 text,
title2 text,
strattr string attribute,
embedding_vector float_vector knn_type='hnsw' knn_dims='384' hnsw_similarity='L2' model_name='sentence-transformers/all-MiniLM-L6-v2'
) engine='columnar' |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
––– comment –––
Test insert with auto-generated vectors using empty parentheses
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test (id, title1, title2, strattr) VALUES(1,'sample title','another title','string attribute')"; echo $?
––– output –––
0
––– comment –––
Test insert with more data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test VALUES(2,'machine learning','deep learning','AI technology',())"; echo $?
––– output –––
0
––– comment –––
Verify data was inserted
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) as total_rows FROM test"
––– output –––
+------------+
| total_rows |
+------------+
|          2 |
+------------+
––– comment –––
Test that vectors were generated by checking specific ID
––– input –––
mysql -h0 -P9306 -e "SELECT embedding_vector FROM test WHERE id = 1"
––– output –––
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| embedding_vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0.02042130,0.05944461,0.06327793,-0.00121582,-0.04334636,0.02471391,0.07740194,-0.01504283,-0.01519437,-0.08074104,-0.01502374,-0.07719759,0.07453239,0.00091795,0.07124192,0.02222962,0.00987938,0.03166835,-0.03030158,0.01243124,-0.00483535,-0.00112359,-0.00157158,-0.01327984,0.00497050,-0.01426700,0.02998245,0.09663171,-0.00125822,-0.08141510,0.10028270,-0.03887446,-0.01191358,0.00508886,0.07037175,-0.04051396,-0.09818212,0.06958764,0.03692960,0.02639321,0.06389525,-0.08338158,0.01082655,-0.02116713,0.02830742,0.02500284,0.03445172,-0.01817514,0.04275205,0.01994498,0.00714723,-0.07960974,0.00258017,0.01152171,0.04932253,0.09368628,-0.04045217,0.00155263,-0.03701833,0.02013842,-0.01465538,0.03126000,-0.00019828,0.02211439,0.08137806,-0.07924304,-0.00136925,0.04645100,-0.08458054,-0.03132745,0.06685703,0.02677736,0.05165647,0.07876533,-0.01633554,0.03873879,-0.08523756,-0.00510733,0.02689815,-0.00749425,-0.02428135,-0.05039726,-0.08725546,0.08206551,-0.02749541,0.10013355,-0.01754671,0.00180180,-0.15830536,-0.03160090,-0.03624199,-0.06772207,0.11066279,0.04748158,-0.05959650,0.03079490,-0.08165251,-0.07203977,-0.00042621,0.04877613,-0.00996634,0.03418523,-0.00116265,0.00448029,-0.03565048,0.00759268,0.01882255,-0.00988844,-0.01041633,-0.04222360,-0.01407524,0.05577620,-0.04839723,0.00748251,0.00596068,0.02080992,0.05391288,-0.01182423,0.04835992,-0.07400291,0.04840597,-0.03576962,-0.06474657,-0.01887083,-0.04013047,-0.03549207,0.04904668,0.00000000,0.01734706,-0.00423694,-0.02265886,0.02716194,0.00690317,-0.05083643,-0.02081925,0.04168214,-0.02062734,0.01985519,0.01589979,-0.10106229,-0.00411315,-0.12226892,-0.05595134,-0.02198790,0.02417077,0.11235046,-0.02086302,0.04048324,0.00424735,0.12621181,0.04498125,-0.01082262,-0.00900215,-0.05687901,-0.05615648,0.01132270,0.01377319,0.00727437,0.04896567,-0.07350481,-0.01147243,-0.00334410,-0.01524801,0.00313136,-0.00238662,-0.02000903,-0.01754690,0.01995178,0.03452621,-0.03356494,0.04662966,-0.00969565,-0.02593128,0.00514244,-0.02111839,-0.03504301,-0.03245668,0.01388007,0.03832524,0.02393079,-0.00643355,0.02986948,-0.00492466,0.08653356,0.00818377,0.04628770,-0.02507279,-0.03655861,-0.11689639,0.07732803,-0.04880257,0.05041034,0.02660699,0.04650424,0.12959439,-0.08174665,0.01402733,0.00666727,-0.03100461,-0.09031413,-0.09039474,-0.01312939,0.02474418,-0.04214528,-0.04574975,0.03519779,0.04199692,0.02813562,-0.05351821,0.00601486,0.00667756,0.03543899,-0.02165755,0.00112314,0.02073095,-0.06045496,0.01150071,-0.09074089,0.01065373,-0.02395292,-0.18231033,0.00436790,0.03746093,-0.00000000,0.07279464,-0.06423479,0.03502401,-0.00445594,0.04380607,-0.03810991,0.06504212,0.01015344,-0.06367812,-0.01492856,-0.04375746,-0.03615766,-0.03213198,-0.02436459,0.02827360,0.00384701,-0.01233487,-0.00239703,0.01430917,0.01221122,-0.08857891,0.10097659,-0.01996819,-0.03294281,0.08149092,0.01848285,0.03319430,0.01986045,0.04737762,-0.02476711,-0.03388619,-0.02037844,0.00102316,0.09854234,-0.07132828,0.00390843,0.10969344,-0.10603297,0.03590241,0.07660341,0.00094806,0.02159456,0.12007631,-0.03183017,0.02749832,0.015916,-0.02847881,-0.02457493,0.03376393,0.04049348,-0.00461926,-0.03416440,-0.12380387,0.06803225,0.01194452,-0.03248364,-0.00832332,0.05580093,-0.07618830,0.02021890,0.00975809,0.03237668,-0.05117250,0.04543211,-0.01462757,-0.04330264,0.01357888,-0.091404,-0.01382164,-0.11161043,0.00066191,-0.02251420,-0.00788099,0.00820710,-0.03219604,0.05069286,0.04873540,0.06185417,-0.05349341,-0.05684252,-0.10261237,-0.02525608,0.00248758,0.10460461,0.07193796,0.05790770,-0.00577884,0.02923373,0.03851598,-0.02151096,0.02175765,0.07900031,0.04254562,0.05889553,-0.04250378,-0.00000002,-0.09925542,0.01585706,0.03253942,0.05629285,-0.03710588,0.09650476,-0.06527982,-0.13674842,0.03407489,0.01537760,-0.02930378,0.01538474,-0.03435830,-0.06903534,-0.05516165,-0.02866799,-0.06377661,0.09285507,0.01223030,-0.02885106,0.03603718,0.04110245,-0.06427936,-0.11836290,-0.03062978,0.03041095,-0.09769265,-0.02812632,0.04961367,0.07844134,0.06508890,0.05191421,-0.03318872,-0.00166374,0.04964568,-0.02262444,0.05368087,-0.01889225,0.06476814,0.06253468,0.03437960,0.03690295,-0.07778652,0.05110380,0.08222683,-0.00545043,-0.01729447,-0.03662104,0.04652448,-0.02602941,0.07370027,-0.11022760,-0.01353214,-0.05219830,-0.01570222,0.02178298,0.08061638,0.04713897,-0.06393386,-0.02522635,0.04342254,0.00048845,0.02890545,0.02589099 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
––– comment –––
Testing selecting and expecting an empty vector because when we add a vector as (), its expected behavior is to have an empty vector and prioritize it in front of auto embeddings.
––– input –––
mysql -h0 -P9306 -e "SELECT embedding_vector FROM test WHERE id = 2"
––– output –––
+------------------+
| embedding_vector |
+------------------+
|                  |
+------------------+
––– comment –––
Test error case: invalid model name
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid (title1 TEXT, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'invalid-model-name' FROM = 'title1') engine = 'columnar'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_invalid': prealloc: Failed to download model configuration
––– comment –––
Test error case: FROM clause without MODEL_NAME
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_no_model (title1 TEXT, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' FROM = 'title1') engine = 'columnar'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: P03: knn_dims and hnsw_similarity are required if knn_type='hnsw' near ') engine = 'columnar''
––– comment –––
Test case: MODEL_NAME without FROM clause (should fail)
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_no_from (title1 TEXT, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2') engine = 'columnar'"
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_no_from': 'from' setting empty for KNN attribute 'embedding_vector'
––– comment –––
ERROR 1064 (42000) at line 1: Cannot create table with column names missing
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid_field (title1 TEXT, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'nonexistent_field') engine = 'columnar'" 2>&1
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– comment –––
Test successful case with single field in FROM
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_single_field (title TEXT, embedding_vector FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME = 'sentence-transformers/all-MiniLM-L6-v2' FROM = 'title') engine = 'columnar'"; echo $?
––– output –––
0
––– comment –––
Test insert into single field table with vector specified as empty (should succeed)
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field VALUES(1,'natural language processing',())"; echo $?
––– output –––
0
––– comment –––
Test insert into single field table with ONLY vector specified (should succeed)
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (embedding_vector) VALUES(())"; echo $?
––– output –––
0
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (embedding_vector) VALUES('(1, 2, 3)')"
––– output –––
#!/.*ERROR.*(field|column|nonexistent).*/!#
––– comment –––
Test insert into single field table with vector specified and some real vector
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_single_field (embedding_vector) VALUES((0, 1, 2))"
––– output –––
ERROR 1064 (42000) at line 1: attribute 'embedding_vector' has model_name=sentence-transformers/all-MiniLM-L6-v2 specified, but vector contents with 3 values is provided
––– comment –––
Testing that replace will succeed
––– input –––
mysql -h0 -P9306 -e "REPLACE INTO test_single_field (id, title) VALUES(1,'natural language processing')"; echo $?
––– output –––
––– comment –––
Verify single field data exists
––– input –––
mysql -h0 -P9306 -e "SELECT count(*) FROM test_single_field WHERE id=1"
––– output –––
+----------+
| count(*) |
+----------+
|        1 |
+----------+