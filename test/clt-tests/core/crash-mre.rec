––– input –––
apt-get install -y jq > /dev/null; echo $?
––– output –––
debconf: delaying package configuration, since apt-utils is not installed
0
––– input –––
export INSTANCE=1
––– output –––
––– input –––
mkdir -p /var/{run,lib,log}/manticore-${INSTANCE}
––– output –––
––– input –––
stdbuf -oL searchd -c test/clt-tests/base/searchd-with-flexible-ports.conf > /dev/null
––– output –––
––– input –––
if timeout 10 grep -qm1 '\[BUDDY\] started' <(tail -n 1000 -f /var/log/manticore-${INSTANCE}/searchd.log); then echo 'Buddy started!'; else echo 'Timeout or failed!'; cat /var/log/manticore-${INSTANCE}/searchd.log;fi
––– output –––
Buddy started!
––– input –––
export INSTANCE=2
––– output –––
––– input –––
mkdir -p /var/{run,lib,log}/manticore-${INSTANCE}
––– output –––
––– input –––
stdbuf -oL searchd -c test/clt-tests/base/searchd-with-flexible-ports.conf > /dev/null
––– output –––
––– input –––
if timeout 10 grep -qm1 '\[BUDDY\] started' <(tail -n 1000 -f /var/log/manticore-${INSTANCE}/searchd.log); then echo 'Buddy started!'; else echo 'Timeout or failed!'; cat /var/log/manticore-${INSTANCE}/searchd.log;fi
––– output –––
Buddy started!
––– input –––
export CLUSTER_NAME=replication
––– output –––
––– input –––
mysql -h0 -P1306 -e "CREATE CLUSTER ${CLUSTER_NAME}"
––– output –––
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_${CLUSTER_NAME}_status'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_replication_status
  Value: primary
––– input –––
for n in `seq 2 $INSTANCE`; do mysql -h0 -P${n}306 -e "JOIN CLUSTER ${CLUSTER_NAME} AT '127.0.0.1:1312'"; done;
––– output –––
––– input –––
mysql -h0 -P${INSTANCE}306 -e "SHOW STATUS LIKE 'cluster_${CLUSTER_NAME}_status'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_replication_status
  Value: primary
––– input –––
for port in 1306 2306; do echo "Checking status for port $port:"; timeout 10 bash -c "while ! mysql -h0 -P$port -e \"SHOW STATUS LIKE 'cluster_replication_node_state'\G\" | grep -q 'Value: synced'; do sleep 1; done" && echo "Port $port: Node is synced." || echo "Port $port: Node is not synced (Value: closed or other)."; done
––– output –––
Checking status for port 1306:
Port 1306: Node is synced.
Checking status for port 2306:
Port 2306: Node is synced.
––– input –––
mysql -h0 -P1306 -e "CREATE TABLE replication:test2 (id BIGINT, name TEXT) SHARDS='3' RF='2';"; echo $?
––– output –––
0
––– input –––
mysql -h0 -P1306 -e "show create table test2 option force=1"
––– output –––
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                            |
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| test2 | CREATE TABLE test2 type='distributed' agent='127.0.0.1:1312:system.test2_s0|127.0.0.1:2312:system.test2_s0' agent='127.0.0.1:1312:system.test2_s1|127.0.0.1:2312:system.test2_s1' agent='127.0.0.1:1312:system.test2_s2|127.0.0.1:2312:system.test2_s2' |
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
––– input –––
mysql -h0 -P1306 -e "SHOW TABLES FROM SYSTEM\G" | grep Table | cut -d' ' -f2
––– output –––
system.sharding_queue
system.sharding_state
system.sharding_table
system.test2_s0
system.test2_s1
system.test2_s2
––– input –––
mysql -h0 -P2306 -e "SHOW TABLES FROM SYSTEM\G" | grep Table | cut -d' ' -f2
––– output –––
system.sharding_queue
system.sharding_state
system.sharding_table
system.test2_s0
system.test2_s1
system.test2_s2
––– input –––
curl -s -X POST http://localhost:1308/insert -d '{"cluster": "replication", "table": "test2", "id": 1, "doc": {"name": "iPhone 13 Pro"}}' | jq '.result'
––– output –––
"created"
––– input –––
curl -s -X POST http://localhost:1308/insert -d '{"cluster": "replication", "table": "test2", "id": 2, "doc": {"name": "iPhone 14 Pro"}}' | jq '.result'
––– output –––
"created"
––– input –––
mysql -h0 -P1306 -e "SELECT * FROM test2 ORDER BY id ASC;"
––– output –––
+------+---------------+
| id   | name          |
+------+---------------+
|    1 | iPhone 13 Pro |
|    2 | iPhone 14 Pro |
+------+---------------+
––– input –––
mysql -h0 -P1306 -e "SELECT count(*) FROM test2;"
––– output –––
+----------+
| count(*) |
+----------+
|        2 |
+----------+
––– input –––
mysql -h0 -P2306 -e 'DESC system.test2_s2 OPTION force=1'
––– output –––
+-------+--------+----------------+
| Field | Type   | Properties     |
+-------+--------+----------------+
| id    | bigint |                |
| name  | text   | indexed stored |
+-------+--------+----------------+
––– input –––
mysql -h0 -P2306 -e "SHOW STATUS LIKE 'cluster_e3d112439806feecd6da4d4cb4544210_status'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_e3d112439806feecd6da4d4cb4544210_status
  Value: primary
––– input –––
cp /var/log/manticore-2/query.log /tmp/query.log
––– output –––
––– input –––
curl -s -X POST http://localhost:1308/update -d '{"cluster": "replication", "table": "test2", "id": 2, "doc": {"name": "iPhone 15 Pro"}}'
––– output –––
––– comment –––
Get lines that added to query log after snapshot on the crash
––– input –––
tail -n +$(wc -l /tmp/query.log | awk '{print $1}') /var/log/manticore-2/query.log
––– output –––
––– input –––
mysql -h0 -P2306 -e "SHOW STATUS LIKE 'cluster_e3d112439806feecd6da4d4cb4544210_status'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_e3d112439806feecd6da4d4cb4544210_status
  Value: primary
––– input –––
sleep 1; grep -ia 'FATAL' -A1000 /var/log/manticore-2/searchd.log
––– output –––
––– input –––
cat /var/log/manticore-2/query.log
––– output –––
––– input –––
mysql -h0 -P2306 -e 'DESC system.test2_s2 OPTION force=1'
––– output –––
+-------+--------+----------------+
| Field | Type   | Properties     |
+-------+--------+----------------+
| id    | bigint |                |
| name  | text   | indexed stored |
+-------+--------+----------------+
