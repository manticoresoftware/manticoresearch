Test: Check that requests from User-Agent ‘Manticore Buddy’ are not logged in the request log,
while requests from other User-Agents (including an empty User-Agent) are logged.
This test covers:
1. Creating a table and inserting test data.
2. Sending requests with User-Agent ‘Manticore Buddy’ and ensuring that they are not logged.
3. Sending queries with other User-Agents (including an empty User-Agent) and ensuring that they are registered.
4. Verifying that the request log does not contain entries for ‘Manticore Buddy’ requests,
but does contain entries for requests from other User-Agents.

––– input –––
echo -e "searchd {\n    listen = 127.0.0.1:9312\n    listen = 127.0.0.1:9306:mysql\n    listen = 127.0.0.1:9308:http\n    log = /var/log/manticore/searchd.log\n    query_log = /var/log/manticore/query.log\n    pid_file = /var/run/manticore/searchd.pid\n    data_dir = /var/lib/manticore\n    buddy_path = # disables Manticore Buddy\n}" > nobuddy.conf
––– output –––
––– input –––
cat nobuddy.conf
––– output –––
searchd {
listen = %{IPADDR}:9312
listen = %{IPADDR}:9306:mysql
listen = %{IPADDR}:9308:http
log = /var/log/manticore/searchd.log
query_log = /var/log/manticore/query.log
pid_file = /var/run/manticore/searchd.pid
data_dir = /var/lib/manticore
buddy_path = # disables Manticore Buddy
}
––– input –––
rm -f /var/log/manticore/searchd.log; searchd --stopwait > /dev/null; searchd -c nobuddy.conf; if timeout 10 grep -qm1 '\[BUDDY\] started' <(tail -n 1000 -f /var/log/manticore/searchd.log); then echo 'Buddy started!'; else echo 'Timeout or failed!'; cat /var/log/manticore/searchd.log;fi
––– output –––
Manticore %{SEMVER} %{COMMITDATE}#!/(\sdev)?\s/!#(columnar %{SEMVER} %{COMMITDATE}) (secondary %{SEMVER} %{COMMITDATE}) (knn %{SEMVER} %{COMMITDATE})
Copyright (c) 2001-2016, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)
Copyright (c) 2017-%{YEAR}, Manticore Software LTD (https://manticoresearch.com)
[#!/[0-9]{1,2}:[0-9]{1,2}.[0-9]{3}/!#] [%{NUMBER}] using config file '/.clt/nobuddy.conf' (317 chars)...
starting daemon version '%{SEMVER} %{COMMITDATE}#!/(\sdev)?\s/!#(columnar %{SEMVER} %{COMMITDATE}) (secondary %{SEMVER} %{COMMITDATE}) (knn %{SEMVER} %{COMMITDATE})' ...
listening on %{IPADDR}:9312 for sphinx and http(s)
listening on %{IPADDR}:9306 for mysql
listening on %{IPADDR}:9308 for sphinx and http(s)
Timeout or failed!
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] watchdog: main process %{NUMBER} forked ok
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] Using local time zone '/etc/localtime'
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] starting daemon version '%{SEMVER} %{COMMITDATE}#!/(\sdev)?\s/!#(columnar %{SEMVER} %{COMMITDATE}) (secondary %{SEMVER} %{COMMITDATE}) (knn %{SEMVER} %{COMMITDATE})' ...
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] listening on %{IPADDR}:9312 for sphinx and http(s)
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] listening on %{IPADDR}:9306 for mysql
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] listening on %{IPADDR}:9308 for sphinx and http(s)
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] prereading 0 tables
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] preread 0 tables in 0.000 sec
[#!/[A-Za-z]{3}\s+[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}\s+[0-9]{4}/!#] [%{NUMBER}] accepting connections
––– input –––
mysql -h0 -P9306 -e "create table test (id BIGINT, model TEXT);"; echo $?
––– output –––
0
––– input –––
curl -X POST http://localhost:9308/insert -d '{"index":"test","id":1,"doc":{"model":"Test message"}}' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from test; show meta' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep -i "Manticore Buddy" /var/log/manticore/query.log
––– output –––
––– input –––
grep -E "select \* from test|show meta" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent: Other-Agent/1.0' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "Other-Agent" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=delete from test where id=1' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "delete from test" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent:' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep -i "User-Agent" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from non_existent_table' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "non_existent_table" /var/log/manticore/query.log
––– output –––
––– input –––
rm -f nobuddy.conf
––– output –––
