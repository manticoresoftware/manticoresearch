# Test: Check that requests from User-Agent ‘Manticore Buddy’ are not logged in the request log,
# while requests from other User-Agents (including an empty User-Agent) are logged.
# This test covers:
# 1. Creating a table and inserting test data.
# 2. Sending requests with User-Agent ‘Manticore Buddy’ and ensuring that they are not logged.
# 3. Sending queries with other User-Agents (including an empty User-Agent) and ensuring that they are registered.
# 4. Verifying that the request log does not contain entries for ‘Manticore Buddy’ requests,
# but does contain entries for requests from other User-Agents.

––– block: ../base/start-searchd –––
––– input –––
mysql -h0 -P9306 -e "create table test (id BIGINT, model TEXT);"; echo $?
––– output –––
0
––– input –––
curl -X POST http://localhost:9308/insert -d '{"index":"test","id":1,"doc":{"model":"Test message"}}' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from test; show meta' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep -i "Manticore Buddy" /var/log/manticore/query.log
––– output –––
––– input –––
grep -E "select \* from test|show meta" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent: Other-Agent/1.0' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "Other-Agent" /var/log/manticore/query.log
––– output –––
[Expected output: Log entry with "Other-Agent"]
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=delete from test where id=1' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "delete from test" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent:' -d 'query=select * from test' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep -i "User-Agent" /var/log/manticore/query.log
––– output –––
––– input –––
curl -H 'User-agent: Manticore Buddy/1.0.0' -d 'query=select * from non_existent_table' 'localhost:9308/sql?mode=raw' > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
grep "non_existent_table" /var/log/manticore/query.log
––– output –––
