––– input –––
export INSTANCE=1
––– output –––
––– block: ../base/replication/start-searchd-precach –––
––– input –––
export INSTANCE=2
––– output –––
––– block: ../base/replication/start-searchd-precach –––
––– input –––
export INSTANCE=3
––– output –––
––– block: ../base/replication/start-searchd-precach –––
––– input –––
export CLUSTER_NAME=replication
––– output –––
––– input –––
mysql -h0 -P1306 -e "create cluster ${CLUSTER_NAME}"
––– output –––
––– input –––
for n in `seq 2 $INSTANCE`; do mysql -h0 -P${n}306 -e "join cluster ${CLUSTER_NAME} at '127.0.0.1:1312'"; done;
––– output –––
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_replication_status'\G"
––– output –––
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_replication_nodes_set'\G;"
––– output –––
––– input –––
mysql -h0 -P2306 -e "SHOW STATUS LIKE 'cluster_replication_status'\G"
––– output –––
––– input –––
mysql -h0 -P2306 -e "SHOW STATUS LIKE 'cluster_replication_nodes_set'\G;"
––– output –––
––– input –––
mysql -h0 -P3306 -e "SHOW STATUS LIKE 'cluster_replication_status'\G"
––– output –––
––– input –––
mysql -h0 -P3306 -e "SHOW STATUS LIKE 'cluster_replication_nodes_set'\G;"
––– output –––
––– input –––
php -d memory_limit=2G ./test/clt-tests/scripts/load_names_attr.php --batch-size=5000 --concurrency=1 --docs=1000000 --start-id=01 --rt-mem-limit=256M --min-infix-len=2 --drop-table --port=2306
––– output –––
––– input –––
mysql -h0 -P2306 -e "ALTER CLUSTER replication ADD name;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SELECT COUNT(*) FROM name;"
––– output –––
+----------+
| count(*) |
+----------+
|  1100000 |
+----------+
––– input –––
mysql -P1306 -h0 -e "DESCRIBE name;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SELECT * FROM name limit 10;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SELECT id, s FROM name LIMIT 10;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SHOW CREATE TABLE name\G;"
––– output –––
––– input –––
mysql -P2306 -h0 -e "SHOW CREATE TABLE name\G;"
––– output –––
––– input –––
mysql -P3306 -h0 -e "SHOW CREATE TABLE name\G;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SELECT COUNT(*) FROM name;"
––– output –––
+----------+
| count(*) |
+----------+
|  1000000 |
+----------+
––– input –––
rm -f /tmp/update.sql; for n in `seq 01 100`; do echo "UPDATE replication:name SET s='b' WHERE id=$n;" >> /tmp/update.sql; done; while true; do mysql -P1306 -h0 < /tmp/update.sql; done & UPDATE_PID=$!
––– output –––
[%{NUMBER}] %{NUMBER}
––– input –––
mysql -P1306 -h0 -e "DESCRIBE name;"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SELECT id FROM replication:name WHERE MATCH('@s value1');"
––– output –––
––– input –––
mysql -P1306 -h0 -e "SHOW CREATE TABLE replication:name\G;"
––– output –––
––– input –––
sleep 10; mysql -P1306 -h0 -e "SELECT * FROM replication:name limit 10;"
––– output –––
––– input –––
mysql -P2306 -h0 -e "SELECT * FROM replication:name limit 10;"
––– output –––
––– input –––
mysql -P3306 -h0 -e "SELECT * FROM replication:name limit 10;"
––– output –––
––– input –––
sleep 1; mysql -P9306 -h0 -e "freeze replication:name"
––– output –––
+------------------------+------------------------+
| file                   | normalized             |
+------------------------+------------------------+
| /tmp/data/t/t.0.spa    | /tmp/data/t/t.0.spa    |
| /tmp/data/t/t.0.spb    | /tmp/data/t/t.0.spb    |
| /tmp/data/t/t.0.spd    | /tmp/data/t/t.0.spd    |
| /tmp/data/t/t.0.spe    | /tmp/data/t/t.0.spe    |
| /tmp/data/t/t.0.sph    | /tmp/data/t/t.0.sph    |
| /tmp/data/t/t.0.sphi   | /tmp/data/t/t.0.sphi   |
| /tmp/data/t/t.0.spi    | /tmp/data/t/t.0.spi    |
| /tmp/data/t/t.0.spidx  | /tmp/data/t/t.0.spidx  |
| /tmp/data/t/t.0.spm    | /tmp/data/t/t.0.spm    |
| /tmp/data/t/t.0.spp    | /tmp/data/t/t.0.spp    |
| /tmp/data/t/t.0.spt    | /tmp/data/t/t.0.spt    |
| /tmp/data/t/t.meta     | /tmp/data/t/t.meta     |
| /tmp/data/t/t.ram      | /tmp/data/t/t.ram      |
| /tmp/data/t/t.settings | /tmp/data/t/t.settings |
+------------------------+------------------------+
––– input –––
sleep 1; kill $UPDATE_PID; wait $UPDATE_PID 2>/dev/null;
––– output –––
0
––– input –––
(sleep 1; mysql -P1306 -h0 -e "drop table if exists replication:name;" && mysql -P1306 -h0 -e "CREATE TABLE name(a string); insert into name values(1, 'a'); flush ramchunk ; freeze t"; mysql -P1306 -h0 -e "update name set a='b' where id = 1" 2>&1 &)
––– output –––
––– input –––
if timeout 5 mysql -P1306 -h0 -e 'SELECT * FROM t'; then echo 'Query executed'; else echo 'Query not executed'; fi
––– output –––
