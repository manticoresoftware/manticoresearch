# Test LOCK TABLES compatibility with mysqldump
# Ensures mysqldump can create a dump and restore it correctly
# Issue: https://github.com/manticoresoftware/manticoresearch/issues/3047

––– block: ../base/start-searchd –––
––– comment –––
Create test table with sample data
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_dump; CREATE TABLE test_dump (id BIGINT, name TEXT, value INTEGER);"
––– output –––
––– comment –––
Insert sample data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_dump VALUES (1, 'first', 100), (2, 'second', 200), (3, 'third', 300);"
––– output –––
––– comment –––
Verify initial data
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM test_dump;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Check if mysqldump is available
––– input –––
which mysqldump
––– output –––
#!/.*mysqldump/!#
––– comment –––
Test 1: mysqldump WITH LOCK TABLES (default behavior)
This tests that LOCK TABLES works correctly with mysqldump
––– input –––
mysqldump -h0 -P9306 manticore test_dump > /tmp/test_dump_with_locks.sql 2>/dev/null
––– output –––
––– comment –––
Drop the table and restore from dump created WITH locks
––– input –––
mysql -h0 -P9306 -e "DROP TABLE test_dump;"
––– output –––
––– comment –––
Restore from dump that was created WITH LOCK TABLES
––– input –––
mysql -h0 -P9306 < /tmp/test_dump_with_locks.sql 2>/dev/null
––– output –––
––– comment –––
Verify all data was restored correctly from dump WITH locks
––– input –––
mysql -h0 -P9306 -e "SELECT * FROM test_dump;"
––– output –––
+------+--------+-------+
| id   | name   | value |
+------+--------+-------+
|    1 | first  |   100 |
|    2 | second |   200 |
|    3 | third  |   300 |
+------+--------+-------+
––– comment –––
Cleanup first dump file
––– input –––
rm -f /tmp/test_dump_with_locks.sql
––– output –––
––– comment –––
Test 2: mysqldump WITHOUT LOCK TABLES (using --skip-lock-tables)
This tests the alternative approach when LOCK TABLES is not desired
––– input –––
mysqldump -h0 -P9306 --skip-lock-tables manticore test_dump > /tmp/test_dump.sql 2>/dev/null
––– output –––
––– comment –––
Drop the table again and restore from dump WITHOUT locks
––– input –––
mysql -h0 -P9306 -e "DROP TABLE test_dump;"
––– output –––
––– comment –––
Restore from dump that was created WITHOUT LOCK TABLES
––– input –––
mysql -h0 -P9306 < /tmp/test_dump.sql 2>/dev/null
––– output –––
––– comment –––
Verify all data was restored correctly from dump WITHOUT locks
––– input –––
mysql -h0 -P9306 -e "SELECT * FROM test_dump;"
––– output –––
+------+--------+-------+
| id   | name   | value |
+------+--------+-------+
|    1 | first  |   100 |
|    2 | second |   200 |
|    3 | third  |   300 |
+------+--------+-------+
––– comment –––
Cleanup
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_dump;"
rm -f /tmp/test_dump.sql
––– output –––
