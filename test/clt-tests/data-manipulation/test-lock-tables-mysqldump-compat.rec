# Test LOCK TABLES compatibility with mysqldump
# Ensures mysqldump can create a dump and restore it correctly
# Issue: https://github.com/manticoresoftware/manticoresearch/issues/3047

––– block: ../base/start-searchd –––
––– comment –––
Create test table with sample data
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_dump; CREATE TABLE test_dump (id BIGINT, name TEXT, value INTEGER);"
––– output –––
––– comment –––
Insert sample data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_dump VALUES (1, 'first', 100), (2, 'second', 200), (3, 'third', 300);"
––– output –––
––– comment –––
Verify initial data
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM test_dump;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Check if mysqldump is available
––– input –––
which mysqldump
––– output –––
#!/.*mysqldump/!#
––– comment –––
Test 1: mysqldump WITH LOCK TABLES (default behavior - lock-tables is ON by default)
This tests that LOCK TABLES works correctly with mysqldump
––– input –––
mysqldump -h0 -P9306 --no-tablespaces --compact manticore test_dump > /tmp/test_dump_with_locks.sql 2>&1
echo "Dump with locks created"
––– output –––
Dump with locks created
––– comment –––
Verify the dump file was created and contains expected data
––– input –––
grep -c "INSERT INTO" /tmp/test_dump_with_locks.sql
––– output –––
1
––– comment –––
Drop the table and restore from dump created WITH locks
––– input –––
mysql -h0 -P9306 -e "DROP TABLE test_dump;"
––– output –––
––– comment –––
Restore from dump that was created WITH LOCK TABLES
––– input –––
mysql -h0 -P9306 < /tmp/test_dump_with_locks.sql 2>&1
echo "Table restored from dump with locks"
––– output –––
Table restored from dump with locks
––– comment –––
Verify data after restore from dump WITH locks
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM test_dump;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Cleanup first dump file
––– input –––
rm -f /tmp/test_dump_with_locks.sql
––– output –––
––– comment –––
Test 2: mysqldump WITHOUT LOCK TABLES (using --skip-lock-tables)
This tests the recommended approach for Manticore
––– input –––
mysqldump -h0 -P9306 --no-tablespaces --skip-lock-tables --compact manticore test_dump > /tmp/test_dump.sql 2>&1
echo "Dump without locks created"
––– output –––
Dump without locks created
––– comment –––
Drop the table again and restore from dump WITHOUT locks
––– input –––
mysql -h0 -P9306 -e "DROP TABLE test_dump;"
––– output –––
––– comment –––
Restore from dump that was created WITHOUT LOCK TABLES
––– input –––
mysql -h0 -P9306 < /tmp/test_dump.sql 2>&1
echo "Table restored from dump without locks"
––– output –––
Table restored from dump without locks
––– comment –––
Verify data after restore from dump WITHOUT locks
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM test_dump;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Verify specific data values
––– input –––
mysql -h0 -P9306 -e "SELECT * FROM test_dump WHERE id = 1;"
––– output –––
+------+-------+-------+
| id   | name  | value |
+------+-------+-------+
|    1 | first |   100 |
+------+-------+-------+
––– comment –––
Cleanup
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_dump;"
rm -f /tmp/test_dump.sql
––– output –––
