# Test LOCK TABLES and UNLOCK TABLES functionality
# Validates MySQL-compatible table locking for READ operations
# NOTE: WRITE locks are not implemented - syntax accepted but shows warning and has no effect
# Issue: https://github.com/manticoresoftware/manticoresearch/issues/3047

––– block: ../base/start-searchd –––
––– comment –––
Create test table with sample product data
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS products; CREATE TABLE products (id BIGINT, title TEXT, price FLOAT);"
––– output –––
––– comment –––
Insert initial test data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO products VALUES (1, 'iPhone 15', 999.99), (2, 'Samsung Galaxy S24', 899.99), (3, 'Google Pixel 8', 799.99);"
––– output –––
––– comment –––
Verify initial data count
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM products;"
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Lock table with READ lock and read from it (should work in same session)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ; SELECT * FROM products WHERE id = 1;"
––– output –––
+------+-----------+------------+
| id   | title     | price      |
+------+-----------+------------+
|    1 | iPhone 15 | 999.989990 |
+------+-----------+------------+
––– comment –––
Release READ lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Test WRITE lock syntax (Manticore accepts syntax but does not implement WRITE locks)
Manticore shows warning and treats WRITE lock as no-op (table remains unlocked)
All commands in same session to test WRITE lock behavior
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES products WRITE;
SHOW WARNINGS;
INSERT INTO products VALUES (4, 'OnePlus 12', 699.99);
SELECT COUNT(*) FROM products;
UNLOCK TABLES;
EOF
––– output –––
+---------+------+--------------------------------+
| Level   | Code | Message                        |
+---------+------+--------------------------------+
| warning | 1000 | Write lock is not implemented. |
+---------+------+--------------------------------+
+----------+
| count(*) |
+----------+
|        4 |
+----------+
––– comment –––
Verify data persisted after unlock
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM products;"
––– output –––
+----------+
| count(*) |
+----------+
|        4 |
+----------+
––– comment –––
Test locking multiple tables with READ
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS products2; CREATE TABLE products2 (id BIGINT, name TEXT);"
––– output –––
––– comment –––
Insert test data into second table
––– input –––
mysql -h0 -P9306 -e "INSERT INTO products2 VALUES (1, 'test1'), (2, 'test2');"
––– output –––
––– comment –––
Lock both tables for READ
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ, products2 READ;"
––– output –––
––– comment –––
Verify we can read from both locked tables
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM products; SELECT COUNT(*) FROM products2;"
––– output –––
+----------+
| count(*) |
+----------+
|        4 |
+----------+
+----------+
| count(*) |
+----------+
|        2 |
+----------+
––– comment –––
Release locks
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Create second table for multi-table lock test
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS orders; CREATE TABLE orders (id BIGINT, product_id BIGINT, quantity INTEGER);"
––– output –––
––– comment –––
Insert data into orders table
––– input –––
mysql -h0 -P9306 -e "INSERT INTO orders VALUES (1, 1, 2), (2, 2, 1);"
––– output –––
––– comment –––
Lock multiple tables with different lock types (products READ, orders WRITE) in same session
NOTE: WRITE lock has no effect, but READ lock on products will block modifications
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES products READ, orders WRITE;
SELECT * FROM products WHERE id = 1;
INSERT INTO orders VALUES (3, 1, 5);
SELECT COUNT(*) FROM orders;
UNLOCK TABLES;
EOF
––– output –––
+------+-----------+------------+
| id   | title     | price      |
+------+-----------+------------+
|    1 | iPhone 15 | 999.989990 |
+------+-----------+------------+
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Read from table after lock released (previous session closed)
––– input –––
mysql -h0 -P9306 -e "SELECT * FROM products WHERE id = 1;"
––– output –––
+------+-----------+------------+
| id   | title     | price      |
+------+-----------+------------+
|    1 | iPhone 15 | 999.989990 |
+------+-----------+------------+
––– comment –––
Insert into table after lock released (previous session closed, WRITE lock not implemented anyway)
––– input –––
mysql -h0 -P9306 -e "INSERT INTO orders VALUES (4, 2, 3);"
––– output –––
––– comment –––
Verify insert succeeded
––– input –––
mysql -h0 -P9306 -e "SELECT COUNT(*) FROM orders;"
––– output –––
+----------+
| count(*) |
+----------+
|        4 |
+----------+
––– comment –––
Test WRITE lock with UPDATE and DELETE in same session (WRITE lock has no effect)
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES products WRITE;
UPDATE products SET price = 1099.99 WHERE id = 1;
DELETE FROM products WHERE id = 4;
SELECT COUNT(*) FROM products;
UNLOCK TABLES;
EOF
––– output –––
+----------+
| count(*) |
+----------+
|        3 |
+----------+
––– comment –––
Test REPLACE INTO with WRITE lock (WRITE lock has no effect)
All commands in same session
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES products WRITE;
REPLACE INTO products VALUES (2, 'Samsung Galaxy S24 Ultra', 1199.99);
SELECT * FROM products WHERE id = 2;
UNLOCK TABLES;
EOF
––– output –––
+------+--------------------------+-------------+
| id   | title                    | price       |
+------+--------------------------+-------------+
|    2 | Samsung Galaxy S24 Ultra | 1199.989990 |
+------+--------------------------+-------------+
––– comment –––
Create distributed table for testing lock compatibility
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS dist_products; CREATE TABLE dist_products type='distributed' local='products';"
––– output –––
––– comment –––
Lock distributed table with READ (should fail - distributed tables don't support locks)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES dist_products READ;"
––– output –––
ERROR 1064 (42000) at line 1: Table dist_products absent, or not suitable for lock
––– comment –––
Verify we can still query distributed table even though locking failed
––– input –––
mysql -h0 -P9306 -e "SELECT * FROM dist_products WHERE id = 1;"
––– output –––
+------+-----------+-------------+
| id   | title     | price       |
+------+-----------+-------------+
|    1 | iPhone 15 | 1099.989990 |
+------+-----------+-------------+
––– comment –––
Test SHOW TABLES works while table is locked (must be in same session)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ; SHOW TABLES; UNLOCK TABLES;"
––– output –––
+---------------+-------------+
| Table         | Type        |
+---------------+-------------+
| dist_products | distributed |
| orders        | rt          |
| products      | rt          |
| products2     | rt          |
+---------------+-------------+
––– comment –––
Verify SHOW TABLES works without locks
––– input –––
mysql -h0 -P9306 -e "SHOW TABLES;"
––– output –––
+---------------+-------------+
| Table         | Type        |
+---------------+-------------+
| dist_products | distributed |
| orders        | rt          |
| products      | rt          |
| products2     | rt          |
+---------------+-------------+
––– comment –––
Test re-locking (LOCK replaces previous lock)
Lock WRITE first, then re-lock with READ in same session
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES products WRITE;
LOCK TABLES products READ;
SELECT * FROM products WHERE id = 1;
UNLOCK TABLES;
EOF
––– output –––
+------+-----------+-------------+
| id   | title     | price       |
+------+-----------+-------------+
|    1 | iPhone 15 | 1099.989990 |
+------+-----------+-------------+
––– comment –––
Lock table with WRITE lock and verify warning (WRITE lock is not implemented)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products WRITE; SHOW WARNINGS;"
––– output –––
+---------+------+--------------------------------+
| Level   | Code | Message                        |
+---------+------+--------------------------------+
| warning | 1000 | Write lock is not implemented. |
+---------+------+--------------------------------+
––– comment –––
WRITE lock doesn't block modifications (not implemented), test within same session
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products WRITE; INSERT INTO products VALUES (4, 'OnePlus 12', 699.99); SELECT COUNT(*) FROM products; UNLOCK TABLES;"
––– output –––
+----------+
| count(*) |
+----------+
|        4 |
+----------+
––– comment –––
Test SHOW LOCKS displays active locks (must be in same session)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ; SHOW LOCKS; UNLOCK TABLES;"
––– output –––
+------+----------+-----------+-----------------+
| Type | Name     | Lock Type | Additional Info |
+------+----------+-----------+-----------------+
| rt   | products | read      | Count: 1        |
+------+----------+-----------+-----------------+
––– comment –––
Test SHOW LOCKS with multiple tables locked
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ, products2 READ; SHOW LOCKS; UNLOCK TABLES;"
––– output –––
+------+-----------+-----------+-----------------+
| Type | Name      | Lock Type | Additional Info |
+------+-----------+-----------+-----------------+
| rt   | products  | read      | Count: 1        |
| rt   | products2 | read      | Count: 1        |
+------+-----------+-----------+-----------------+
––– comment –––
Duplicate table names are allowed (increment lock counter, aliases not supported)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES products READ, products READ; SHOW LOCKS; UNLOCK TABLES;"
––– output –––
+------+----------+-----------+-----------------+
| Type | Name     | Lock Type | Additional Info |
+------+----------+-----------+-----------------+
| rt   | products | read      | Count: 2        |
+------+----------+-----------+-----------------+
––– comment –––
Final cleanup - drop all test tables
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS products; DROP TABLE IF EXISTS products2; DROP TABLE IF EXISTS orders; DROP TABLE IF EXISTS dist_products;"
––– output –––
