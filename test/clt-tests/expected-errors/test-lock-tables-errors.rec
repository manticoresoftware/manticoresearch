# Negative tests for LOCK TABLES and UNLOCK TABLES
# Validates error handling for incorrect usage and lock violations
# Issue: https://github.com/manticoresoftware/manticoresearch/issues/3047

––– block: ../base/start-searchd –––
––– comment –––
Create test table for error validation
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_locks; CREATE TABLE test_locks (id BIGINT, title TEXT);"
––– output –––
––– comment –––
Insert test data
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_locks VALUES (1, 'test');"
––– output –––
––– comment –––
Error: Lock non-existent table
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES nonexistent_table READ;"
––– output –––
ERROR 1064 (42000) at line 1: no such table 'nonexistent_table'
––– comment –––
Error: Invalid lock mode
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks INVALID_MODE;"
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected $undefined near 'INVALID_MODE'
––– comment –––
Error: LOCK TABLES without table name
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES;"
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected $end near ''
––– comment –––
Error: UNLOCK TABLES with table name (incorrect syntax)
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES test_locks;"
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected IDENT, expecting $end near 'test_locks'
––– comment –––
Error: Wrong command (LOCK TABLE instead of LOCK TABLES)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLE test_locks READ;"
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected IDENT, expecting $end near 'test_locks READ'
––– comment –––
Error: Cannot specify both READ and WRITE
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ WRITE;"
––– output –––
ERROR 1064 (42000) at line 1: P01: syntax error, unexpected WRITE near 'WRITE'
––– comment –––
Valid: Lock same table twice with different aliases (should work)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ, test_locks READ;"
––– output –––
––– comment –––
Release locks
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Try to DROP table with READ lock (write operation on READ-locked table)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ; DROP TABLE test_locks;"
––– output –––
ERROR 1064 (42000) at line 1: Table 'test_locks' was locked with a READ lock and can't be updated
––– comment –––
Release lock after error
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Try to INSERT into READ-locked table
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ; INSERT INTO test_locks VALUES (2, 'forbidden');"
––– output –––
ERROR 1064 (42000) at line 1: Table 'test_locks' was locked with a READ lock and can't be updated
––– comment –––
Release lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Try to UPDATE READ-locked table
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ; UPDATE test_locks SET title = 'new' WHERE id = 1;"
––– output –––
ERROR 1064 (42000) at line 1: Table 'test_locks' was locked with a READ lock and can't be updated
––– comment –––
Release lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Try to DELETE from READ-locked table
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ; DELETE FROM test_locks WHERE id = 1;"
––– output –––
ERROR 1064 (42000) at line 1: Table 'test_locks' was locked with a READ lock and can't be updated
––– comment –––
Release lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Create second table for lock scope testing
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS other_table; CREATE TABLE other_table (id BIGINT);"
––– output –––
––– comment –––
Error: Access unlocked table when another table is locked (READ)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks READ; SELECT * FROM other_table;"
––– output –––
ERROR 1100 (HY000) at line 1: Table 'other_table' was not locked with LOCK TABLES
––– comment –––
Release lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Access unlocked table when another table is locked (WRITE)
––– input –––
mysql -h0 -P9306 -e "LOCK TABLES test_locks WRITE; SELECT * FROM other_table;"
––– output –––
ERROR 1100 (HY000) at line 1: Table 'other_table' was not locked with LOCK TABLES
––– comment –––
Release lock
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Error: Try to CREATE TABLE while locks are active
––– input –––
mysql -h0 -P9306 << 'EOF'
LOCK TABLES test_locks READ;
CREATE TABLE new_table (id BIGINT);
EOF
––– output –––
ERROR 1100 (HY000) at line 2: Table 'new_table' was not locked with LOCK TABLES
––– comment –––
Release any remaining locks
––– input –––
mysql -h0 -P9306 -e "UNLOCK TABLES;"
––– output –––
––– comment –––
Cleanup test tables
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_locks, other_table;"
––– output –––
