––– block: ../base/start-searchd-with-buddy –––
––– input –––
set -b
––– output –––
––– input –––
export PATH=/usr/bin:/usr/local/bin:/usr/sbin:/sbin:/bin
––– output –––
––– input –––
apt-get update > /dev/null 2>&1 && apt-get install -y gnupg openjdk-11-jre-headless curl jq mysql-client > /dev/null 2>&1; echo $?
––– output –––
0
––– input –––
cat << 'EOF' > /tmp/logstash-single-test.sh
#!/bin/bash
set -euo pipefail

# Disable debug output
set +x

# Check version argument
if [ $# -ne 1 ]; then
    echo "✗ Usage: $0 <logstash_version>" >&2
    echo "✗ Example: $0 8.14" >&2
    exit 1
fi
version="$1"

echo ">>> Testing Logstash version: $version"

# Check Manticore Search availability before operations
if ! curl -s localhost:9308/cli_json -d 'show status' > /dev/null; then
    echo "✗ Error: Manticore Search unavailable before starting test" >&2
    exit 1
fi

# Check system resources
free -m > /tmp/resource_check.log 2>&1
nproc >> /tmp/resource_check.log 2>&1

# Attempt to drop table with retries
for attempt in {1..3}; do
    mysql -h0 -P9306 -e "DROP TABLE IF EXISTS dpkg_log" > /dev/null 2>/tmp/mysql_error.log && break
    echo "✗ Warning: Attempt $attempt to drop table dpkg_log failed" >&2
    cat /tmp/mysql_error.log >&2
    if [ $attempt -eq 3 ]; then
        echo "✗ Error: Failed to drop table dpkg_log after 3 attempts" >&2
        exit 1
    fi
    sleep 2
done

# Create table
mysql -h0 -P9306 -e "CREATE TABLE dpkg_log (id bigint, message string attribute indexed, host string attribute indexed, path string attribute indexed, \`@version\` string attribute indexed, \`@timestamp\` timestamp)" > /dev/null 2>/tmp/mysql_error.log || { echo "✗ Error: Failed to create table dpkg_log" >&2; cat /tmp/mysql_error.log >&2; exit 1; }

mkdir -p /usr/share/logstash && cd /usr/share/logstash > /dev/null

# Use cached archive
if [ -f "/tmp/logstash_cache/logstash-${version}.0-linux-x86_64.tar.gz" ]; then
    cp "/tmp/logstash_cache/logstash-${version}.0-linux-x86_64.tar.gz" . > /dev/null 2>&1
else
    wget -q "https://artifacts.elastic.co/downloads/logstash/logstash-${version}.0-linux-x86_64.tar.gz" -O "logstash-${version}.0-linux-x86_64.tar.gz" || { echo "✗ Error: Failed to download Logstash $version" >&2; exit 1; }
fi
tar -xzf "logstash-${version}.0-linux-x86_64.tar.gz" > /dev/null 2>&1
ln -sf "/usr/share/logstash/logstash-${version}.0/bin/logstash" /usr/bin/logstash > /dev/null 2>&1

# Create Logstash configuration
cat << 'CONF' > /usr/share/logstash/logstash.conf
input {
  file {
    path => ["/var/log/dpkg.log"]
    start_position => "beginning"
    sincedb_path => "/dev/null"
    mode => "read"
    exit_after_read => true
    file_completed_action => "delete"
  }
}
filter {
  mutate {
    replace => {
      "@version" => "1"
      "host" => "logstash"
      "path" => "/var/log/dpkg.log"
    }
    remove_field => ["event", "log"]
  }
  ruby {
    code => "event.set('id', (Time.now.to_f * 1000000).to_i)"
  }
}
output {
  elasticsearch {
    hosts => ["http://localhost:9308"]
    index => "dpkg_log"
    ilm_enabled => false
    manage_template => false
    action => "index"
    silence_errors_in_log => []
  }
  stdout { codec => rubydebug }
}
CONF

# Create test log
echo -e "2023-05-31 10:42:55 trigproc systemd:amd64 245.4-4ubuntu3.21 <none>\n2023-05-31 10:42:55 trigproc libc-bin:amd64 2.31-0ubuntu9.9 <none>\n2023-05-31 10:42:55 status triggers-awaited ca-certificates-java:all 20190405ubuntu1.1\n2023-05-31 10:42:55 status installed libc-bin:amd64 2.31-0ubuntu9.9\n2023-05-31 10:42:55 status half-configured libc-bin:amd64 2.31-0ubuntu9.9" > /var/log/dpkg.log

# Check number of lines in log
log_lines=$(wc -l < /var/log/dpkg.log)
if [ "$log_lines" -eq 5 ]; then
    echo "✓ Log file has 5 lines"
else
    echo "✗ Error: Expected 5 lines, got $log_lines" >&2
    exit 1
fi

# Check Manticore Search availability
curl -s localhost:9308/cli_json -d 'show status' > /dev/null || { echo "✗ Error: Manticore Search unavailable" >&2; exit 1; }
echo "✓ Manticore Search available"

# Create logstash user
if ! id logstash >/dev/null 2>&1; then
    useradd -m -s /bin/bash logstash > /dev/null 2>&1
fi
chown -R logstash:logstash /usr/share/logstash /var/log/dpkg.log > /dev/null 2>&1

# Create log directory
mkdir -p /var/log > /dev/null 2>&1
touch /var/log/logstash.log > /dev/null 2>&1
chown logstash:logstash /var/log/logstash.log > /dev/null 2>&1

# Run Logstash
timeout 600 su - logstash -c "logstash -f /usr/share/logstash/logstash.conf --log.level debug --pipeline.batch.size 5 --pipeline.ecs_compatibility v1 > /var/log/logstash.log 2>&1 && sleep 15" || {
    echo "✗ Error: Logstash $version failed to run" >&2
    cat /var/log/logstash.log >&2
    exit 1
}
echo "✓ Logstash $version started and processed logs"

# Check table structure
response=$(curl -s -w "\n%{http_code}" localhost:9308/cli_json -d 'describe dpkg_log')
http_code=$(echo "$response" | tail -n1)
response_body=$(echo "$response" | sed '$d')
if [ "$http_code" != "200" ]; then
    echo "✗ Error: Manticore returned HTTP $http_code" >&2
    echo "$response_body" >&2
    exit 1
fi

structure=$(echo "$response_body" | jq -cM '.[].data | sort_by(.Field)')
expected='[{"Field":"@timestamp","Type":"timestamp","Properties":""},{"Field":"@version","Type":"string","Properties":"indexed attribute"},{"Field":"host","Type":"string","Properties":"indexed attribute"},{"Field":"id","Type":"bigint","Properties":""},{"Field":"message","Type":"string","Properties":"indexed attribute"},{"Field":"path","Type":"string","Properties":"indexed attribute"}]'
if [ "$structure" = "$expected" ]; then
    echo "✓ Structure check for $version: passed"
else
    echo "✗ Error: Structure mismatch for $version" >&2
    echo "$structure" >&2
    exit 1
fi

# Check row count
row_count=$(mysql -h0 -P9306 -N -B -e "SELECT COUNT(*) FROM dpkg_log" | grep -o '[0-9]\+')
if [[ "$row_count" =~ ^[0-9]+$ ]] && [ "$row_count" -eq 5 ]; then
    echo "✓ Row count check for $version: $row_count rows"
else
    echo "✗ Error: Expected 5 rows, got $row_count" >&2
    echo "Table contents for debugging:" >&2
    mysql -h0 -P9306 -e "SELECT * FROM dpkg_log\G" >&2
    cat /var/log/logstash.log >&2
    exit 1
fi

# Record result
echo "$version: Success" >> /tmp/logstash_results.txt

# Save log for debugging
cp /var/log/logstash.log "/tmp/logstash-$version.log"

# Cleanup
rm -rf /usr/share/logstash/* /var/log/dpkg.log /usr/share/logstash/logstash.conf /var/log/logstash.log /tmp/mysql_error.log > /dev/null 2>&1
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS dpkg_log" > /dev/null 2>&1
cd /usr/local/src > /dev/null 2>&1

echo "✓ Logstash version $version tested successfully"
EOF
––– output –––
––– input –––
chmod +x /tmp/logstash-single-test.sh; echo $?
––– output –––
0
––– input –––
bash /tmp/logstash-single-test.sh 7.17
––– output –––
>>> Testing Logstash version: 7.17
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 7.17 started and processed logs
✓ Structure check for 7.17: passed
✓ Row count check for 7.17: 5 rows
✓ Logstash version 7.17 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.0
––– output –––
>>> Testing Logstash version: 8.0
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.0 started and processed logs
✓ Structure check for 8.0: passed
✓ Row count check for 8.0: 5 rows
✓ Logstash version 8.0 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.1
––– output –––
>>> Testing Logstash version: 8.1
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.1 started and processed logs
✓ Structure check for 8.1: passed
✓ Row count check for 8.1: 5 rows
✓ Logstash version 8.1 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.2
––– output –––
>>> Testing Logstash version: 8.2
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.2 started and processed logs
✓ Structure check for 8.2: passed
✓ Row count check for 8.2: 5 rows
✓ Logstash version 8.2 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.3
––– output –––
>>> Testing Logstash version: 8.3
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.3 started and processed logs
✓ Structure check for 8.3: passed
✓ Row count check for 8.3: 5 rows
✓ Logstash version 8.3 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.4
––– output –––
>>> Testing Logstash version: 8.4
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.4 started and processed logs
✓ Structure check for 8.4: passed
✓ Row count check for 8.4: 5 rows
✓ Logstash version 8.4 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.5
––– output –––
>>> Testing Logstash version: 8.5
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.5 started and processed logs
✓ Structure check for 8.5: passed
✓ Row count check for 8.5: 5 rows
✓ Logstash version 8.5 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.6
––– output –––
>>> Testing Logstash version: 8.6
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.6 started and processed logs
✓ Structure check for 8.6: passed
✓ Row count check for 8.6: 5 rows
✓ Logstash version 8.6 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.7
––– output –––
>>> Testing Logstash version: 8.7
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.7 started and processed logs
✓ Structure check for 8.7: passed
✓ Row count check for 8.7: 5 rows
✓ Logstash version 8.7 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.8
––– output –––
>>> Testing Logstash version: 8.8
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.8 started and processed logs
✓ Structure check for 8.8: passed
✓ Row count check for 8.8: 5 rows
✓ Logstash version 8.8 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.9
––– output –––
>>> Testing Logstash version: 8.9
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.9 started and processed logs
✓ Structure check for 8.9: passed
✓ Row count check for 8.9: 5 rows
✓ Logstash version 8.9 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.10
––– output –––
>>> Testing Logstash version: 8.10
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.10 started and processed logs
✓ Structure check for 8.10: passed
✓ Row count check for 8.10: 5 rows
✓ Logstash version 8.10 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.11
––– output –––
>>> Testing Logstash version: 8.11
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.11 started and processed logs
✓ Structure check for 8.11: passed
✓ Row count check for 8.11: 5 rows
✓ Logstash version 8.11 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.12
––– output –––
>>> Testing Logstash version: 8.12
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.12 started and processed logs
✓ Structure check for 8.12: passed
✓ Row count check for 8.12: 5 rows
✓ Logstash version 8.12 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.13
––– output –––
>>> Testing Logstash version: 8.13
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.13 started and processed logs
✓ Structure check for 8.13: passed
✓ Row count check for 8.13: 5 rows
✓ Logstash version 8.13 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.14
––– output –––
>>> Testing Logstash version: 8.14
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.14 started and processed logs
✓ Structure check for 8.14: passed
✓ Row count check for 8.14: 5 rows
✓ Logstash version 8.14 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.15
––– output –––
>>> Testing Logstash version: 8.15
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.15 started and processed logs
✓ Structure check for 8.15: passed
✓ Row count check for 8.15: 5 rows
✓ Logstash version 8.15 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.16
––– output –––
>>> Testing Logstash version: 8.16
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.16 started and processed logs
✓ Structure check for 8.16: passed
✓ Row count check for 8.16: 5 rows
✓ Logstash version 8.16 tested successfully
––– input –––
bash /tmp/logstash-single-test.sh 8.17
––– output –––
>>> Testing Logstash version: 8.17
✓ Log file has 5 lines
✓ Manticore Search available
✓ Logstash 8.17 started and processed logs
✓ Structure check for 8.17: passed
✓ Row count check for 8.17: 5 rows
✓ Logstash version 8.17 tested successfully
