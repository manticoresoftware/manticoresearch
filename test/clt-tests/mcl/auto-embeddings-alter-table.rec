ALTER TABLE testing for API_URL, API_TIMEOUT, and API_KEY parameters

This test validates ALTER TABLE operations for modifying API_URL, API_TIMEOUT, and API_KEY parameters on embedding columns. It tests adding parameters to tables that previously didn't have them, changing existing parameter values, removing parameters by setting them to empty or default values, and error handling for invalid values. The test uses mock servers for custom endpoint testing and validates that changes take effect immediately and are reflected in SHOW CREATE TABLE output.

––– comment –––
MOCK SERVER SETUP FOR ALTER TABLE TESTING

To test ALTER TABLE with a local mock server:

Start mock server: php test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai
Start second mock server: php test/clt-tests/mcl/mock-embeddings-server.php --port 8081 --provider openai
The mock server returns deterministic random embeddings seeded by input text
API Key Validation: All keys are valid except "wrong" (returns 401 error)
––– comment –––
Start Manticore Search
––– block: ../base/start-searchd –––
––– comment –––
MOCK SERVER STARTUP
––– comment –––
Start mock server for OpenAI provider on port 8080
––– input –––
php /manticore/test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai > /tmp/mock-server-8080.log 2>&1 &
MOCK_PID_8080=$!
echo "Mock server started on port 8080 (PID: $MOCK_PID_8080)"
sleep 1
––– output –––
Mock server started on port 8080 (PID: #!/[0-9]+/!#)
––– comment –––
Start second mock server for OpenAI provider on port 8081 (for testing API_URL changes)
––– input –––
php /manticore/test/clt-tests/mcl/mock-embeddings-server.php --port 8081 --provider openai > /tmp/mock-server-8081.log 2>&1 &
MOCK_PID_8081=$!
echo "Mock server started on port 8081 (PID: $MOCK_PID_8081)"
sleep 1
––– output –––
Mock server started on port 8081 (PID: #!/[0-9]+/!#)
––– comment –––
Add API_URL (Previously Not Specified)

Test: Create table without API_URL, then ALTER to add it
Expected: ALTER succeeds, new API_URL used for subsequent requests, SHOW CREATE TABLE displays api_url
Setup: Requires mock server running: php test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai
––– comment –––
Create table without API_URL
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_add_api_url (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to add API_URL
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_add_api_url MODIFY COLUMN embedding API_URL='http://localhost:8080/v1/embeddings'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE displays api_url
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_add_api_url" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_add_api_url
Create Table: CREATE TABLE test_alter_add_api_url (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title' api_url='http://localhost:8080/v1/embeddings'
)
––– comment –––
Change API_URL (Previously Specified)

Test: Create table with API_URL, then ALTER to change it
Expected: ALTER succeeds, new API_URL used for subsequent requests, SHOW CREATE TABLE displays new api_url
Setup: Requires two mock servers: port 8080 and port 8081
––– comment –––
Create table with first API_URL
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_change_api_url (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='test-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to change API_URL
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_change_api_url MODIFY COLUMN embedding API_URL='http://localhost:8081/v1/embeddings'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE displays new api_url
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_change_api_url" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_change_api_url
Create Table: CREATE TABLE test_alter_change_api_url (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title' api_url='http://localhost:8081/v1/embeddings'
)
––– comment –––
Remove API_URL (Set to Empty)

Test: Create table with API_URL, then ALTER to remove it (set to empty)
Expected: ALTER succeeds (reverts to default endpoint), default endpoint used, SHOW CREATE TABLE does NOT display api_url
––– comment –––
Create table with API_URL
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_remove_api_url (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to remove API_URL (set to empty)
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_remove_api_url MODIFY COLUMN embedding API_URL=''" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE does NOT display api_url
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_remove_api_url" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_remove_api_url
Create Table: CREATE TABLE test_alter_remove_api_url (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title'
)
––– comment –––
ALTER API_URL with Invalid URL

Test: ALTER TABLE ... MODIFY COLUMN embedding API_URL='not-a-url'
Expected: ALTER fails during validation (validation makes a real API request which requires a valid URL)
Note: API key validation happens during ALTER, so invalid URLs are caught immediately
––– comment –––
First create table with valid API_URL
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_invalid_url (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='test-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER with invalid URL
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_invalid_url MODIFY COLUMN embedding API_URL='not-a-url'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_invalid_url: Failed to send request to remote model
––– comment –––
ALTER API_URL with Inaccessible URL

Test: ALTER TABLE ... MODIFY COLUMN embedding API_URL='http://192.0.2.0:8080/v1/embeddings'
Expected: ALTER fails during validation with connection error
––– comment –––
First create table with valid API_URL
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_inaccessible_url (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='test-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER with inaccessible URL
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_inaccessible_url MODIFY COLUMN embedding API_URL='http://192.0.2.0:8080/v1/embeddings'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_inaccessible_url: Failed to send request to remote model
––– comment –––
ALTER API_URL with Invalid API Key (Removing Custom URL)

Test: Create table with custom API_URL and test-key, then ALTER to remove API_URL (reverts to default)
Expected: ALTER fails with clear error message explaining that removing api_url requires valid api_key for default endpoint
Note: Default endpoint requires valid key format (e.g., sk-... for OpenAI)
––– comment –––
Create table with custom API_URL and test-key
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_remove_url_invalid_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='test-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to remove API_URL (reverts to default, which requires valid OpenAI key format)
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_remove_url_invalid_key MODIFY COLUMN embedding API_URL=''" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_remove_url_invalid_key: cannot remove API_URL: API key validation failed for the default endpoint. The API key may be invalid, expired, or not authorized for the default provider endpoint. To remove API_URL, first update the API key to a valid key that works with the default endpoint, or keep using a custom API_URL
––– comment –––
Add API_TIMEOUT (Previously Not Specified)

Test: Create table without API_TIMEOUT, then ALTER to add it
Expected: ALTER succeeds, new timeout used for subsequent requests, SHOW CREATE TABLE displays api_timeout='30'
––– comment –––
Create table without API_TIMEOUT
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_add_api_timeout (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to add API_TIMEOUT
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_add_api_timeout MODIFY COLUMN embedding API_TIMEOUT='30'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE displays api_timeout='30'
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_add_api_timeout" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_add_api_timeout
Create Table: CREATE TABLE test_alter_add_api_timeout (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title' api_timeout='30'
)
––– comment –––
Change API_TIMEOUT (Previously Specified)

Test: Create table with API_TIMEOUT, then ALTER to change it
Expected: ALTER succeeds, new timeout used for subsequent requests, SHOW CREATE TABLE displays api_timeout='60'
––– comment –––
Create table with API_TIMEOUT='30'
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_change_api_timeout (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}' API_TIMEOUT='30')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to change API_TIMEOUT
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_change_api_timeout MODIFY COLUMN embedding API_TIMEOUT='60'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE displays api_timeout='60'
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_change_api_timeout" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_change_api_timeout
Create Table: CREATE TABLE test_alter_change_api_timeout (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title' api_timeout='60'
)
––– comment –––
Remove API_TIMEOUT (Set to 0)

Test: Create table with API_TIMEOUT, then ALTER to remove it (set to 0)
Expected: ALTER succeeds (reverts to default timeout), default timeout (10s) used, SHOW CREATE TABLE does NOT display api_timeout
––– comment –––
Create table with API_TIMEOUT='30'
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_remove_api_timeout (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}' API_TIMEOUT='30')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to remove API_TIMEOUT (set to 0)
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_remove_api_timeout MODIFY COLUMN embedding API_TIMEOUT='0'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE does NOT display api_timeout
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_alter_remove_api_timeout" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_alter_remove_api_timeout
Create Table: CREATE TABLE test_alter_remove_api_timeout (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title'
)
––– comment –––
ALTER API_TIMEOUT with Negative Value

Test: ALTER TABLE ... MODIFY COLUMN embedding API_TIMEOUT='-1'
Expected: ALTER fails with validation error
Verify: Error message: "API_TIMEOUT must be a non-negative integer"
––– comment –––
First create table
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_negative_timeout (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER with negative timeout
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_negative_timeout MODIFY COLUMN embedding API_TIMEOUT='-1'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_negative_timeout: API_TIMEOUT must be a non-negative integer (0 means use default, positive value is timeout in seconds)
––– comment –––
ALTER API_TIMEOUT with Non-Integer

Test: ALTER TABLE ... MODIFY COLUMN embedding API_TIMEOUT='abc'
Expected: ALTER fails with validation error
Verify: Error message: "API_TIMEOUT must be a non-negative integer"
––– comment –––
First create table
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_nonint_timeout (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER with non-integer timeout
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_nonint_timeout MODIFY COLUMN embedding API_TIMEOUT='abc'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_nonint_timeout: API_TIMEOUT must be a non-negative integer (0 means use default, positive value is timeout in seconds)
––– comment –––
Add API_KEY (Previously Not Specified)

Test: Create table without API_KEY (for local model), then ALTER to add it
Expected: ALTER succeeds, new API_KEY validated, new key used for subsequent requests
Note: For remote models, table creation without API_KEY should fail, so this test uses local model
––– comment –––
Create table with local model (no API_KEY required)
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_add_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='sentence-transformers/all-MiniLM-L6-v2' FROM='title')" 2>&1; echo $?
––– output –––
0
––– comment –––
Change API_KEY (Previously Specified)

Test: Create table with API_KEY, then ALTER to change it
Expected: ALTER succeeds, new API_KEY validated, new key used for subsequent requests
Setup: Requires mock server running: php test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai
––– comment –––
Create table with old API_KEY
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_change_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='old-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to change API_KEY
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_change_api_key MODIFY COLUMN embedding API_KEY='new-key'" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify new key works with INSERT
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_alter_change_api_key (id, title) VALUES (1, 'test document')" 2>&1; echo $?
––– output –––
0
––– comment –––
Remove API_KEY (Set to Empty)

Test: Create table with API_KEY, then ALTER to remove it (set to empty)
Expected: ALTER fails during validation (empty key rejected)
Verify: Error message indicates invalid API key
––– comment –––
Create table with valid API_KEY
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_remove_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='valid-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
ALTER to remove API_KEY (set to empty)
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_remove_api_key MODIFY COLUMN embedding API_KEY=''" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_remove_api_key: Invalid API key for remote model
––– comment –––
ALTER API_KEY with Invalid Key

Test: ALTER TABLE ... MODIFY COLUMN embedding API_KEY='wrong'
Expected: ALTER fails during validation with "Invalid API key" error
Verify: Real API validation occurs
Setup: Requires mock server running: php test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai
––– comment –––
First create table with valid key
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_alter_invalid_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='test-key' API_URL='http://localhost:8080/v1/embeddings')" 2>&1; echo $?
––– output –––
0
––– comment –––
Try to change to invalid key
––– input –––
mysql -h0 -P9306 -e "ALTER TABLE test_alter_invalid_api_key MODIFY COLUMN embedding API_KEY='wrong'" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: table test_alter_invalid_api_key: Invalid API key for remote model (HTTP status code 401)
