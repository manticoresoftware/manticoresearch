API_KEY validation testing for embeddings

This test validates API_KEY parameter handling for embedding generation in CREATE TABLE statements. The system validates API keys by making actual API requests instead of format-based checks. When creating a table with embeddings, a minimal test API request is made to validate the key. This ensures invalid keys are caught immediately at table creation time, works with any API key format, validates actual API connectivity and authentication, and provides authoritative error messages from the API provider. The test covers scenarios including missing API keys, empty keys, invalid keys, keys with valid format but invalid values, and valid keys. Each table creation makes one API request for validation, and network timeouts default to 10 seconds but can be configured via API_TIMEOUT parameter.

––– comment –––
MOCK SERVER SETUP FOR API_KEY VALIDATION TESTING

To test API_KEY validation with a local mock server:

Start mock server: php test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai
The mock server validates API keys: all keys are valid except "wrong" (returns 401 error)
IMPORTANT: API key validation now uses real API requests instead of format checks
When creating a table, the system makes a minimal test API request to validate the key
This ensures the API key is actually valid before allowing table creation
Removed Format Validation: The previous format-based validation (e.g., "sk-" prefix for OpenAI) has been removed
––– comment –––
Start Manticore Search
––– block: ../base/start-searchd –––
––– comment –––
MOCK SERVER STARTUP
––– comment –––
Start mock server for OpenAI provider on port 8080
––– input –––
php /manticore/test/clt-tests/mcl/mock-embeddings-server.php --port 8080 --provider openai > /tmp/mock-server-8080.log 2>&1 &
MOCK_PID_8080=$!
echo "Mock server started on port 8080 (PID: $MOCK_PID_8080)"
sleep 1
––– output –––
Mock server started on port 8080 (PID: #!/[0-9]+/!#)
––– comment –––
API_KEY Not Specified (Remote Model)

Test: Create table with remote model without API_KEY
Expected: Table creation fails with error about missing API key
Verify: Error message indicates API key is required
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_no_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title')" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_no_api_key': prealloc: Invalid API key for remote model
––– comment –––
API_KEY Specified as Empty String

Test: CREATE TABLE ... API_KEY=''
Expected: Table creation fails during validation (empty key rejected by API)
Verify: Error message indicates invalid API key
Note: Testing with default OpenAI endpoint (API_URL not specified)
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_empty_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='')" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_empty_api_key': prealloc: Invalid API key for remote model
––– comment –––
API_KEY = "wrong" (Invalid Key)

Test: CREATE TABLE ... API_KEY='wrong' with real OpenAI API
Expected: Table creation fails with "Invalid API key" error
Verify: Error occurs during validation (real API request), error message: "Invalid API key" or similar
Note: Testing with default OpenAI endpoint using an invalid key
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='wrong')" 2>&1
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_invalid_api_key': prealloc: Invalid API key for remote model (HTTP status code 401)
––– comment –––
API_KEY Valid Format but Invalid (Expired/Revoked)

Test: CREATE TABLE ... API_KEY='sk-invalid-key-format' with real OpenAI API
Expected: Table creation fails with authentication error
Verify: Error message from API indicates invalid/expired key
Note: Using default OpenAI endpoint to test actual API validation. Invalid keys are correctly rejected.
––– input –––
mysql -h0 -P9306 -e "DROP TABLE IF EXISTS test_invalid_format_api_key" 2>&1
––– output –––
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_invalid_format_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='sk-proj-invalid-key-12345')" 2>&1; echo $?
––– output –––
ERROR 1064 (42000) at line 1: error adding table 'test_invalid_format_api_key': prealloc: Invalid API key for remote model (HTTP status code 401)
1
––– comment –––
API_KEY Valid

Test: CREATE TABLE ... API_KEY='valid-key' with real OpenAI API
Expected: Table creation succeeds, SHOW CREATE TABLE does NOT display api_key (security)
Verify: Full workflow works correctly
Note: Using real OpenAI API key and default endpoint
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE test_valid_api_key (title TEXT, embedding FLOAT_VECTOR KNN_TYPE='hnsw' HNSW_SIMILARITY='l2' MODEL_NAME='openai/text-embedding-ada-002' FROM='title' API_KEY='${OPENAI_API_KEY}')" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify SHOW CREATE TABLE does NOT display api_key (security requirement)
––– input –––
mysql -h0 -P9306 -E -e "SHOW CREATE TABLE test_valid_api_key" 2>&1
––– output –––
*************************** 1. row ***************************
       Table: test_valid_api_key
Create Table: CREATE TABLE test_valid_api_key (
id bigint,
title text,
embedding float_vector knn_type='hnsw' knn_dims='1536' hnsw_similarity='L2' model_name='openai/text-embedding-ada-002' from='title'
)
––– comment –––
Test data insertion with valid API key
––– input –––
mysql -h0 -P9306 -e "INSERT INTO test_valid_api_key (id, title) VALUES (1, 'test document')" 2>&1; echo $?
––– output –––
0
––– comment –––
Verify data was inserted and embedding vector was generated
––– input –––
mysql -h0 -P9306 -E -e "SELECT id, embedding FROM test_valid_api_key WHERE id=1" 2>&1
––– output –––
*************************** 1. row ***************************
       id: 1
embedding: #!/[-0-9.,]+/!#
