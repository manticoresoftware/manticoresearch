––– comment –––
Test for SST (State Snapshot Transfer) progress monitoring during table replication
Issue: https://github.com/manticoresoftware/effyis/issues/390

Problem: When adding a large table to cluster via ALTER CLUSTER ADD, there was no way
to track replication progress. Users couldn't determine how much was copied or remaining.

Solution: Added SST progress variables to SHOW STATUS:
- cluster_<name>_sst_total: Overall progress (0-100)
- cluster_<name>_sst_stage: Current stage (e.g., "send files")
- cluster_<name>_sst_stage_total: Progress of current stage (0-100)
- cluster_<name>_sst_tables: Total tables being transferred
- cluster_<name>_sst_table: Current table being transferred (e.g., "3 (products)")
- cluster_<name>_node_state: Node state (donor/joiner/synced)

This test validates that SST progress variables exist in SHOW STATUS output.
––– input –––
apt-get update -y > /dev/null; echo $?
––– output –––
0
––– input –––
apt-get install -y iproute2 procps > /dev/null; echo $?
––– output –––
0
––– comment –––
Add watchdog = 0 to base config if not already present
––– input –––
grep -q "watchdog" test/clt-tests/base/searchd-with-flexible-ports.conf && echo "watchdog already exists" || { sed -i '/^searchd {/,/^}/ s/^\([[:space:]]*\)}$/\1\twatchdog = 0\n\1}/' test/clt-tests/base/searchd-with-flexible-ports.conf && echo "watchdog added"; }
––– output –––
#!/watchdog already exists|watchdog added/!#
––– comment –––
Start node 1
––– input –––
export INSTANCE=1
––– output –––
––– input –––
mkdir -p /var/{run,lib,log}/manticore-${INSTANCE}
––– output –––
––– input –––
stdbuf -oL searchd --logreplication -c test/clt-tests/base/searchd-with-flexible-ports.conf > /dev/null
––– output –––
––– input –––
if timeout 10 grep -qm1 '\[BUDDY\] started' <(tail -n 1000 -f /var/log/manticore-${INSTANCE}/searchd.log); then echo 'Buddy started!'; else echo 'Timeout or failed!'; cat /var/log/manticore-${INSTANCE}/searchd.log; fi
––– output –––
Buddy started!
––– comment –––
Create cluster on node 1
––– input –––
mysql -h0 -P1306 -e "CREATE CLUSTER sst_test"
––– output –––
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_status'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_status
  Value: primary
––– comment –––
Create simple table and add to cluster
––– input –––
mysql -h0 -P1306 -e "CREATE TABLE test_table (id bigint, title text)"
––– output –––
––– input –––
mysql -h0 -P1306 -e "ALTER CLUSTER sst_test ADD test_table"
––– output –––
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_indexes'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_indexes
  Value: test_table
––– comment –––
Start node 2
––– input –––
export INSTANCE=2
––– output –––
––– input –––
mkdir -p /var/{run,lib,log}/manticore-${INSTANCE}
––– output –––
––– input –––
stdbuf -oL searchd --logreplication -c test/clt-tests/base/searchd-with-flexible-ports.conf > /dev/null
––– output –––
––– input –––
if timeout 10 grep -qm1 '\[BUDDY\] started' <(tail -n 1000 -f /var/log/manticore-${INSTANCE}/searchd.log); then echo 'Buddy started!'; else echo 'Timeout or failed!'; cat /var/log/manticore-${INSTANCE}/searchd.log; fi
––– output –––
Buddy started!
––– comment –––
Join node 2 to cluster - this triggers SST
––– input –––
mysql -h0 -P2306 -e "JOIN CLUSTER sst_test AT '127.0.0.1:1312'"
––– output –––
––– comment –––
Verify SST progress variables exist on donor node
The main goal is to check that these variables are available, not their specific values
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_node_state'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_node_state
  Value: #!/.+/!#
––– comment –––
Verify all 5 SST progress variables exist
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_%'\G" | grep "Counter:" | wc -l
––– output –––
5
––– comment –––
Check that each individual SST variable exists
Values will be "-" if SST completed, or numbers/stage names if still active
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_total'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_sst_total
  Value: #!/.*/!#
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_stage'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_sst_stage
  Value: #!/.*/!#
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_stage_total'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_sst_stage_total
  Value: #!/.*/!#
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_tables'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_sst_tables
  Value: #!/.*/!#
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_sst_table'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_sst_table
  Value: #!/.*/!#
––– comment –––
Verify both nodes are synced
––– input –––
bash -c 'end=$((SECONDS+60)); while [ $SECONDS -lt $end ]; do all_synced=true; for port in 1306 2306; do mysql -h0 -P$port -e "SHOW STATUS LIKE '\''cluster_sst_test_status'\''\G" > /tmp/status_$port.log 2>/dev/null && grep -q "Value: primary" /tmp/status_$port.log || { all_synced=false; break; }; done; if $all_synced; then for port in 1306 2306; do echo "Port $port: Node synced"; done; exit 0; fi; sleep 1; done; echo "Timeout waiting for nodes to sync!"; exit 1'
––– output –––
Port 1306: Node synced
Port 2306: Node synced
––– comment –––
Verify table exists on both nodes
––– input –––
mysql -h0 -P1306 -e "SHOW STATUS LIKE 'cluster_sst_test_indexes'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_indexes
  Value: test_table
––– input –––
mysql -h0 -P2306 -e "SHOW STATUS LIKE 'cluster_sst_test_indexes'\G"
––– output –––
*************************** 1. row ***************************
Counter: cluster_sst_test_indexes
  Value: test_table
––– comment –––
Cleanup: Remove watchdog from base config to avoid affecting other tests
––– input –––
sed -i '/watchdog = 0/d' test/clt-tests/base/searchd-with-flexible-ports.conf; echo $?
––– output –––
0
