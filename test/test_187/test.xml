<?xml version="1.0" encoding="utf-8"?>
<test>

<name>ATTACH INDEX</name>

<requires>
<non-rt/>
</requires>

<config>
indexer
{
	mem_limit		= 16M
}

searchd
{
	<searchd_settings/>
}

source disk
{
	type			= mysql
	<sql_settings/>
	sql_query		= select * from test_table
	sql_attr_uint	= gid
}

index disk
{
	source			= disk
	path			= <data_path/>/disk
	charset_table	= a..z, A..Z->a..z
	html_strip = 1
	html_remove_elements = stuff
}

index rt
{
	type			= rt
	path			= <data_path/>/rt
	rt_attr_uint	= gid1
	rt_attr_uint	= gid2
	rt_field		= title
	rt_field		= content
	charset_table	= a..z, A..Z->a..z, _
} 

source src_plain
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id, title, 'dummy for' as str1, '55, 15, 20' as mva1, '' as mva2, gid from test_table
	sql_attr_string	= str1
	sql_attr_multi	= uint mva1 from field
	sql_attr_multi	= uint mva2 from field
	sql_attr_uint	= gid
}

index plain
{
	source			= src_plain
	path			= <data_path/>/plain
}

index rt_arena
{
	type			= rt
	path			= <data_path/>/rt_arena
	
	rt_field		= title
	rt_attr_string = str1
	rt_attr_multi = mva1
	rt_attr_uint	= gid
	
} 

source src_a1
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id, title, 'dummy' as body, gid from test_table
	sql_attr_uint	= gid
}

index a1
{
	source			= src_a1
	path			= <data_path/>/a1
}

index rt1
{
	type			= rt
	path			= <data_path/>/rt1
	rt_field		= title
	rt_field		= body
	rt_attr_uint	= gid
} 

index disk1
{
	source			= disk
	path			= <data_path/>/disk1
	charset_table	= a..z, A..Z->a..z
}

index disk2
{
	source			= disk
	path			= <data_path/>/disk2
	charset_table	= a..z, A..Z->a..z
}

index disk3
{
	source			= disk
	path			= <data_path/>/disk3
	charset_table	= a..z, A..Z->a..z
}

index rt_d1
{
	type			= rt
	path			= <data_path/>/rt_d1
	rt_field		= title
	rt_attr_uint	= gid
} 

index rt_trunc
{
	type			= rt
	path			= <data_path/>/rt_trunc
	rt_attr_uint	= gid1
	rt_attr_uint	= gid2
	rt_field		= title
	rt_field		= content
	charset_table	= a..z, A..Z->a..z, _
}

index disk_trunc
{
	source			= disk
	path			= <data_path/>/disk_trunc
	charset_table	= english, russian
}

index disk10
{
	source			= disk
	path			= <data_path/>/disk10
	charset_table	= english
}

index rt10
{
	type			= rt
	path			= <data_path/>/rt10
	rt_field		= title
	rt_attr_uint	= gid
} 

source src_d11
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id+10 as id, title, gid from test_table where id=1
	sql_attr_uint	= gid
}

source src_d12
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id+20 as id, title, gid from test_table where id=2
	sql_attr_uint	= gid
}

source src_d13
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id+30 as id, title, gid from test_table where id=3
	sql_attr_uint	= gid
}

source src_d14
{
	type			= mysql
	<sql_settings/>
	sql_query		= select id+40 as id, title, gid from test_table where id=4
	sql_attr_uint	= gid
}


index d11
{
	source			= src_d11
	path			= <data_path/>/d11
	charset_table	= a..z, A..Z->a..z
}

index d12
{
	source			= src_d12
	path			= <data_path/>/d12
	charset_table	= a..z, A..Z->a..z
}

index d13
{
	source			= src_d13
	path			= <data_path/>/d13
	charset_table	= a..z, A..Z->a..z
}

index d14
{
	source			= src_d14
	path			= <data_path/>/d14
	charset_table	= a..z, A..Z->a..z
}

</config>

<db_create>
CREATE TABLE test_table
(
	id INTEGER PRIMARY KEY NOT NULL,
	gid INTEGER NOT NULL,
	title VARCHAR(255) NOT NULL
);
</db_create>
<db_drop>DROP TABLE IF EXISTS test_table;</db_drop>
<db_insert><![CDATA[
INSERT INTO test_table VALUES
( 1, 11, 'Fare thee well' ),
( 2, 11, 'And if for ever got' ),
( 3, 11, 'Still for ever fare thee well' ),
( 4, 11, 'under_score <stuff>got removed</stuff>' )
]]></db_insert>

<queries><sphinxql>
SELECT * FROM rt;
SELECT * FROM disk;
SELECT * FROM disk WHERE MATCH('thee');
SELECT * FROM disk WHERE MATCH('under') order by id desc;
ATTACH INDEX disk TO RTINDEX rt;
SELECT * FROM rt;
SELECT * FROM disk;
SELECT * FROM rt WHERE MATCH('thee');
DESC rt like '_i%';
INSERT INTO rt ( id, gid, title ) VALUES ( 10, 22, 'I dub thee unforgiven' );
SELECT * FROM rt WHERE MATCH('thee');
<![CDATA[INSERT INTO rt ( id, gid, title ) VALUES ( 11, 22, 'under_score_again <stuff>but got here</stuff>' )]]>;
SELECT * FROM rt WHERE MATCH('under') order by id desc;
SELECT * FROM rt_arena;
ATTACH INDEX plain TO RTINDEX rt_arena;
SELECT * FROM rt_arena where mva1=15 order by id asc;
SELECT * FROM rt_arena where mva1=55 order by id desc;
SELECT * FROM rt_arena;
<!-- regression index settings have not been copied on attach -->
SELECT * FROM rt WHERE MATCH('got');
<!-- regression attach to existed RT index -->
INSERT INTO rt1 ( id, gid, title, body ) VALUES ( 1, 22, 'dust me', 'well' ), ( 5, 22, 'dure me', 'thee off' ), ( 6, 22, 'dub me', 'thee well' );
ATTACH INDEX a1 TO RTINDEX rt1;
SELECT * FROM rt1 order by id asc;
SELECT * FROM rt1 WHERE MATCH('well');
SELECT * FROM rt1 WHERE MATCH('me | thee');

<!-- regression duplicates passed from attached plain to existed RT index -->
ATTACH INDEX disk1 TO RTINDEX rt_d1;
ATTACH INDEX disk2 TO RTINDEX rt_d1;
ATTACH INDEX disk3 TO RTINDEX rt_d1;
SELECT * FROM rt_d1;

<!-- feature to trucate RT index with same ATTACH command -->
INSERT INTO rt_trunc ( id, gid1, gid2, title ) VALUES ( 10, 22, 33, 'I dub thee unforgiven' );
ATTACH INDEX disk_trunc TO RTINDEX rt_trunc;
SELECT * FROM rt_trunc;
ATTACH INDEX disk_trunc TO RTINDEX rt_trunc WITH TRUNCATE;
SELECT * FROM rt_trunc;

<!-- regression hung of daemon on attach index to itself -->
ATTACH INDEX disk10 TO RTINDEX disk10 WITH TRUNCATE;
ATTACH INDEX rt10 TO RTINDEX rt10 WITH TRUNCATE;
ATTACH INDEX disk10 TO RTINDEX rt10 WITH TRUNCATE;
SELECT * FROM rt10;

<!-- regression disk chunks replace prevoius -->
ATTACH INDEX d11 TO RTINDEX rt_d1;
ATTACH INDEX d12 TO RTINDEX rt_d1;
ATTACH INDEX d13 TO RTINDEX rt_d1;
ATTACH INDEX d14 TO RTINDEX rt_d1;
SELECT * FROM rt_d1 ORDER by id ASC;
OPTIMIZE INDEX rt option sync=1;
SELECT * FROM rt_d1 ORDER by id ASC;
</sphinxql></queries>

</test>
