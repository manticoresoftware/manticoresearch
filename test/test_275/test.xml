<?xml version="1.0" encoding="utf-8"?>
<test>

<name>knn index</name>

<requires>
	<knn/>
	<force-rt/>
</requires>

<skip_indexer/>

<config>
searchd
{
	<searchd_Settings/>
	data_dir = <data_path path="data0"/>
}
</config>

<queries>
<sphinxql>
	show tables;
	create table t (title text, tag integer, emp float_vector knn_type='hnsw' knn_dims='8' hnsw_similarity='l2' );
	show tables;
	desc t;
	show create table t;
	insert into t values (1, 'title1', 1, (0.2865696847438812,-0.03181683272123337,0.06668472290039062,0.03292645886540413,-0.008292825892567635,0.16873490810394287,-0.0008463106933049858,-0.36077880859375));
	insert into t values (2, 'title2', 1, (0.33916592597961426,0.3886975646018982,-0.41489771008491516,0.20758016407489777,-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877));
	insert into t values (3, 'title3', 2, (0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303,-0.029800616204738617,0.5721306800842285,-0.051111623644828796,-0.09547730535268784));
	insert into t values (4, 'title4', 2, (0.1097082868218422,-0.059516504406929016,-0.053682904690504074,0.23981636762619019,-0.33325839042663574,0.3685816824436188,0.18456950783729553,-0.05209290236234665));
	insert into t values (5, 'title5', 3, (-0.006129484623670578,0.5033777952194214,-0.5287379026412964,0.5231741070747375,0.022464150562882423,-0.04248378053307533,0.3180341124534607,-0.11792317032814026));
	insert into t values (6, 'title6', 3, (0.07446788251399994,0.24792802333831787,0.20263631641864777,-0.017194697633385658,0.3679729402065277,0.3847752511501312,0.1616753190755844,0.04726771265268326));
	insert into t values (7, 'title7', 4, (-0.03529544919729233,0.44717246294021606,-0.3653179109096527,-0.16520369052886963,-0.28060752153396606,0.024058140814304352,-0.6397897601127625,0.4281712472438812));
	insert into t values (8, 'title8', 4, (-0.1488940566778183,0.7482781410217285,0.09189224243164062,-0.09540678560733795,0.1863720566034317,-0.20858603715896606,-0.226043701171875,-0.06464707106351852));
	insert into t values (9, 'title9', 5, (0.6534488201141357,0.19247837364673615,0.017971690744161606,0.3398212492465973,0.26752832531929016,0.24325883388519287,-0.10399176180362701,0.1764550507068634));
	insert into t values (10, 'title10', 5, (0.4089451730251312,0.0306655615568161,-0.15218715369701385,-0.6105571389198303,-0.29428744316101074,-0.07567915320396423,0.3454975187778473,-0.49481201171875));
	select * from t where id=1;
	select id, knn_dist() from t where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303));
	flush ramchunk t;
	select id, knn_dist() from t where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303));
	select id, tag from t where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303)) facet tag;;
	select id, tag from t where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303)) facet tag order by @knn_dist asc;;
	select id, tag, knn_dist() d from t where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303)) facet tag order by d asc;;

	create table d type='distributed' agent='<agent0_address/>:t';
	select id, knn_dist() from d where knn(emp,3,(-0.11468425393104553,0.3873162567615509,-0.26252424716949463,0.007096240296959877,0.24166066944599152,-0.24653761088848114,0.060873936861753464,0.23045268654823303));
	
	drop table d;
	drop table t;

	<!-- regression for inserting wrong sized knn vectors -->
	create table t (title text, emp float_vector knn_type='hnsw' knn_dims='8' hnsw_similarity='l2' );
	insert into t values (1, 'title1', (0.4089451730251312,0.0306655615568161,-0.15218715369701385,-0.6105571389198303,-0.29428744316101074,-0.07567915320396423,0.3454975187778473,-0.49481201171875));
	insert into t values (2, 'title2', (0.4089451730251312,0.0306655615568161,-0.15218715369701385,-0.6105571389198303,-0.29428744316101074,-0.07567915320396423,0.3454975187778473));
	insert into t values (3, 'title3', ());
	select * from t;
	flush ramchunk t;
	select * from t;
	select id, knn_dist() from t;
	drop table t;

	create table test ( title text, image_vector float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2' );
	replace into test (id, title) values (1, 'test1');
	select * from test;
	drop table test;

	create table test ( title text, image_vector float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='cosine' );
	insert into test values ( 1, 'yellow bag', (0.653448,0.192478,0.017971,0.339821) ), ( 2, 'white bag', (-0.148894,0.748278,0.091892,-0.095406) );
	select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926) );
	flush ramchunk test;
	select id, knn_dist() from test where knn ( image_vector, 5, (0.286569,-0.031816,0.066684,0.032926) );
    
    <!-- regression knn option missed at alter table -->
    alter table test add column image_vecto2 float_vector knn_type='hnsw' knn_dims='7' hnsw_similarity='l2';
    show create table test;
    
	drop table test;
</sphinxql>
</queries>

</test>