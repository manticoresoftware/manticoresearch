<?xml version="1.0" encoding="utf-8"?>
<test>
<name>replication of external files</name>

<requires><replication/><non-windows/></requires>
<skip_indexer/>
<num_agents>2</num_agents>

<config>

<agent0>
searchd
{
	<searchd_settings/>
	data_dir = <data_path path="data0"></data_path>
	server_id = <agent_id/>
}
</agent0>
<agent1>
searchd
{
	<searchd_settings/>
	data_dir = <data_path path="data1"></data_path>
	server_id = <agent_id/>
}
</agent1>

</config>


<sphqueries>
<!-- request to node 0 -->
<sphinxql d="0">create table rt_wf11 (t1 text indexed stored, gid int) wordforms = '<this_test/>/wf1.txt <this_test/>/wf3.txt'</sphinxql>
<sphinxql d="0">create table rt_st1 (t1 text indexed stored, gid int) stopwords = '<this_test/>/stop1.txt <this_test/>/stop2.txt'</sphinxql>
<sphinxql d="0">create table rt_many1 (t1 text indexed stored, gid int) exceptions = '<this_test/>/ex1.txt' stopwords = '<this_test/>/stop2.txt' hitless_words = '<this_test/>/hw1.txt <this_test/>/hw3.txt'</sphinxql>
<sphinxql d="0">create cluster test</sphinxql>
<sphinxql d="0">ALTER CLUSTER test ADD rt_wf11</sphinxql>
<sphinxql d="0">ALTER CLUSTER test ADD rt_st1</sphinxql>
<sphinxql d="0">ALTER CLUSTER test ADD rt_many1</sphinxql>

<!-- request to node 1 -->
<sphinxql d="1" cluster_connect="0">join cluster test at '%addr_connect%'</sphinxql>

<!-- request to node 0 -->
<sphinxql d="0">insert into test:rt_wf11 (id,t1,gid) values (111, 'any color good for me', 1001), (112, 'large blue sky', 1002)</sphinxql>
<sphinxql d="0">insert into test:rt_st1 (id,t1,gid) values (111, 'me and you', 1001), (112, 'be like you', 1002)</sphinxql>
<sphinxql d="0">insert into test:rt_many1 (id,t1,gid) values (111, 'msw rulez', 1001), (112, 'ms windows many things considered', 1002), (113, 'msw be like no one', 1003)</sphinxql>

<!-- request to node 1 -->
<sphinxql d="1">SHOW TABLES</sphinxql> <!-- just to reconnect to agent1 -->
<sphinxql d="1" system="wait-status-cluster_test_last_committed" wait_value="5"/>
<sphinxql d="1">SELECT * FROM test:rt_wf11 where match ('blue'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_wf11 where match ('big sky'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_st1 where match ('and you'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_st1 where match ('be like'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_many1 where match ('windows rulez'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_many1 where match ('^many things'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_many1 where match ('windows be like'); SHOW META</sphinxql>

<!-- disk chunks -->
<sphinxql d="0">create table rt_many2 (t1 text indexed stored, gid int) exceptions = '<this_test/>/ex1.txt' stopwords = '<this_test/>/stop2.txt' hitless_words = '<this_test/>/hw1.txt <this_test/>/hw3.txt'</sphinxql>
<sphinxql d="0">insert into rt_many2 (id,t1,gid) values (111, 'msw rulez', 1001), (112, 'ms windows many things considered', 1002), (113, 'msw be like no one', 1003)</sphinxql>
<sphinxql d="0">flush ramchunk rt_many2</sphinxql>
<sphinxql d="0">insert into rt_many2 (id,t1,gid) values (211, 'msw rulez', 1001), (212, 'ms windows many things considered', 1002), (213, 'msw be like no one', 1003)</sphinxql>
<sphinxql d="0">flush ramchunk rt_many2</sphinxql>
<sphinxql d="0">ALTER CLUSTER test ADD rt_many2</sphinxql>

<!-- request to node 1 -->
<sphinxql d="1">SHOW TABLES</sphinxql> <!-- just to reconnect to agent1 -->
<sphinxql d="1" system="wait-status" status="cluster_test_last_committed" wait_value="6"/>
<sphinxql d="1">SELECT * FROM test:rt_many2 where match ('windows rulez'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_many2 where match ('^many things'); SHOW META</sphinxql>
<sphinxql d="1">SELECT * FROM test:rt_many2 where match ('windows be like'); SHOW META</sphinxql>

<!-- cleanup -->
<sphinxql d="0">ALTER CLUSTER test DROP rt_wf11</sphinxql>
<sphinxql d="0">ALTER CLUSTER test DROP rt_st1</sphinxql>
<sphinxql d="0">ALTER CLUSTER test DROP rt_many1</sphinxql>
<sphinxql d="0">ALTER CLUSTER test DROP rt_many2</sphinxql>
<sphinxql d="0">DROP TABLE rt_wf11</sphinxql>
<sphinxql d="0">DROP TABLE rt_st1</sphinxql>
<sphinxql d="0">DROP TABLE rt_many1</sphinxql>
<sphinxql d="0">DROP TABLE rt_many2</sphinxql>

</sphqueries>

</test>
