<?xml version="1.0" encoding="utf-8"?>
<test>
<name>attr_autoconv_strict mode validation</name>

<skip_indexer/>
<config>
    searchd
    {
        <searchd_settings/>
        attr_autoconv_strict = 1
    }

    index test_strict
    {
        type = rt
        path = <data_path/>/test_strict
        rt_field = title
        rt_attr_uint = attr_int
        rt_attr_bigint = attr_bigint
        rt_attr_bool = attr_bool
        rt_attr_timestamp = attr_timestamp
    }
</config>

<queries><sphinxql>

<!-- all valid conversions -->
INSERT INTO test_strict (id, title, attr_int, attr_bigint, attr_bool, attr_timestamp) VALUES (1, 'test', 123, 456789, 1, 1234567890);
SELECT * FROM test_strict WHERE id=1;

<!-- valid string-to-number conversions -->
INSERT INTO test_strict (id, title, attr_int, attr_bigint) VALUES (2, 'test', '123', '456789');
SELECT * FROM test_strict WHERE id=2;

<!-- empty string to int - fail -->
INSERT INTO test_strict (id, title, attr_int) VALUES (3, 'test', '');

<!-- empty string to bigint - fail-->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (4, 'test', '');

<!-- non-numeric to int - fail -->
INSERT INTO test_strict (id, title, attr_int) VALUES (5, 'test', 'a');

<!-- non-numeric to bigint - fail -->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (6, 'test', 'abc');

<!-- string with tail to integer - fail -->
INSERT INTO test_strict (id, title, attr_int) VALUES (7, 'test', '123abc');

<!-- string with tail to bigint - fail -->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (8, 'test', '456789xyz');

<!-- valid string with head space -->
INSERT INTO test_strict (id, title, attr_int) VALUES (9, 'test', ' 123');
SELECT * FROM test_strict WHERE id=9;

<!-- valid string with tail space-->
INSERT INTO test_strict (id, title, attr_int) VALUES (10, 'test', '123 ');
SELECT * FROM test_strict WHERE id=10;

<!-- valid negative bigint -->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (11, 'test', '-123456');
SELECT * FROM test_strict WHERE id=11;

<!-- valid zero -->
INSERT INTO test_strict (id, title, attr_int, attr_bigint) VALUES (12, 'test', '0', '0');
SELECT * FROM test_strict WHERE id=12;

<!-- valid bool conversions -->
INSERT INTO test_strict (id, title, attr_bool) VALUES (13, 'test', '1');
INSERT INTO test_strict (id, title, attr_bool) VALUES (14, 'test', '0');
SELECT * FROM test_strict WHERE id IN (13, 14);

<!-- invalid bool string - fail -->
INSERT INTO test_strict (id, title, attr_bool) VALUES (15, 'test', 'maybe');

<!-- valid timestamp -->
INSERT INTO test_strict (id, title, attr_timestamp) VALUES (16, 'test', '1234567890');
SELECT * FROM test_strict WHERE id=16;

<!-- invalid timestamp string - fail -->
INSERT INTO test_strict (id, title, attr_timestamp) VALUES (17, 'test', 'not-a-timestamp');

<!-- multiple rows - one invalid fail the batch -->
INSERT INTO test_strict (id, title, attr_int) VALUES (18, 'test1', '100'), (19, 'test2', 'invalid'), (20, 'test3', '200');

<!-- large valid numbers -->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (22, 'test', '9223372036854775807');
SELECT * FROM test_strict WHERE id=22;

<!-- very large number overflows - fail -->
INSERT INTO test_strict (id, title, attr_bigint) VALUES (23, 'test', '99999999999999999999');

</sphinxql></queries>
</test>

